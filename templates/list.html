{% extends "base.html" %}
{% block title %}Λίστα Παραστατικών{% endblock %}

{% block head_extra %}
<style>
.table-wrapper { width:100%; overflow:auto; max-height:70vh; border-radius:8px; background:#fff; padding:8px; }
.summary-table { width:100%; border-collapse:collapse; min-width:900px; table-layout: fixed; }
.summary-table th, .summary-table td { border:1px solid #e6e6e6; padding:8px; vertical-align:top; }
.summary-table th { background:#0d6efd; color:white; cursor: move; position: sticky; top:0; z-index:3; }
.cell-wrap { white-space:pre-wrap; word-break:break-word; max-width:360px; overflow:hidden; }
.small-btn { padding:8px 12px; border-radius:8px; color:#fff; background:#0d6efd; text-decoration:none; display:inline-block; }
.small-btn.secondary { background:#6c757d; }
.small-btn.danger { background:#dc3545; }
{{ css_numcols | safe }}
</style>

<!-- DataTables + ColReorder + ColResize -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/colreorder/1.6.2/css/colReorder.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables-colresize@1.0.0/dist/dataTables.colResize.min.css">
{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow p-4">
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-lg font-semibold">Λίστα Παραστατικών</h2>
    <div class="flex gap-2">
      {% if file_exists %}
        <a class="small-btn" href="{{ url_for('list_invoices') }}?download=1">⬇️ Κατέβασμα .xlsx</a>
      {% endif %}
      <a class="small-btn secondary" href="{{ url_for('fetch') }}">⬅ Bulk Fetch</a>
    </div>
  </div>

  <div class="mb-3 flex gap-2">
    <input id="globalSearch" type="search" placeholder="🔎 Αναζήτηση..." class="p-2 border rounded w-64">
    <button id="deleteBtn" class="small-btn danger">🗑️ Διαγραφή Επιλεγμένων</button>
  </div>

  {% if error %}
    <div class="p-3 mb-3 rounded bg-red-50 text-red-800">{{ error }}</div>
  {% endif %}

  <div class="table-wrapper">
    {% if table_html %}
      {{ table_html | safe }}
    {% else %}
      <div class="p-3 text-gray-600">Δεν υπάρχουν εγγραφές προς εμφάνιση.</div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/colreorder/1.6.2/js/dataTables.colReorder.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables-colresize@1.0.0/dist/dataTables.colResize.min.js"></script>

<script>
$(document).ready(function(){
  try {
    const dt = $('.summary-table').DataTable({
      paging: true,
      scrollY: '55vh',
      scrollX: true,
      scrollCollapse: true,
      fixedHeader: true,
      colReorder: true,
      autoWidth: false,
      columnDefs: [{ orderable: false, targets: 0 }] // checkbox column
    });

    // Resizable columns with sticky headers
    dt.colResize({ resizeMode: 'flex' });

    $('#globalSearch').on('input', function(){
      dt.search(this.value).draw();
    });
  } catch(e){
    console.warn("DataTables not initialized:", e);
    $('#globalSearch').on('input', function(){
      const q = this.value.toLowerCase();
      $('.summary-table tbody tr').each(function(){
        $(this).toggle($(this).text().toLowerCase().indexOf(q) !== -1);
      });
    });
  }

  // select-all checkbox
  $('#selectAll').on('change', function(){
    const checked = this.checked;
    $('input[type="checkbox"][name="delete_mark"]').prop('checked', checked);
  });

  $('#deleteBtn').on('click', function(){
    const selected = $('input[type="checkbox"][name="delete_mark"]:checked').map(function(){ return $(this).val(); }).get();
    if(!selected.length){
      alert('Επίλεξε πρώτα γραμμές για διαγραφή.');
      return;
    }
    if(!confirm(`Θες σίγουρα να διαγράψεις ${selected.length} εγγραφή(ες);`)) return;
    const form = $('<form method="POST" action="{{ url_for("delete_invoices") }}"></form>');
    selected.forEach(function(s){
      form.append($('<input>').attr('type','hidden').attr('name','delete_mark').val(s));
    });
    $('body').append(form);
    form.submit();
  });
});
</script>
{% endblock %}
