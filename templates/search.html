{% extends "base.html" %}
{% block title %}Αναζήτηση MARK{% endblock %}

{% block content %}

<div class="bg-white rounded shadow p-6">
    <h2 class="text-lg font-semibold mb-2">Αναζήτηση MARK</h2>

    {% if error %}
    <div class="mb-3 p-2 rounded bg-red-50 text-red-800">{{ error }}</div>
    {% endif %}

    <form method="post" class="flex gap-2 items-center" id="markSearchForm">
        <!-- Auto-submit segmented toggle (scoped to client) -->
        <div class="flex items-center gap-2 ml-4" id="autoSubmitGroup">
            <span class="text-sm">Auto‑submit</span>
            <div class="inline-flex rounded-md overflow-hidden border border-gray-300">
                <button type="button" id="autoSubmitBtnOff" class="px-2 py-1 text-sm focus:outline-none">Off</button>
                <button type="button" id="autoSubmitBtnOn" class="px-2 py-1 text-sm focus:outline-none">On</button>
            </div>
        </div>

        <input name="mark" id="markInput" type="text" placeholder="15ψήφιο MARK" class="p-2 border rounded w-2/4" value="{{ mark }}">
        <button type="submit" class="bg-sky-600 text-white px-3 py-2 rounded">Αναζήτηση</button>
        <div class="flex items-center gap-2 ml-4">
            <label for="useReceiptsSwitch" class="text-sm">
                Τιμολόγια<label>
                    <input type="checkbox" id="useReceiptsSwitch" role="switch" aria-checked="false" class="toggle-switch">
                    <label for="useReceiptsSwitch" class="text-sm">Αποδείξεις</label>
        </div>

        <!-- Toggle επαναληψιμης εισαγωγής + edit button -->
        <div class="flex items-center gap-2 ml-4">
            <div id="activeRepeatProfileHint" class="text-xs text-gray-500 mb-1" style="display:none"></div>

            <label for="repeatEntrySwitch" class="text-sm">Επαναληψιμη εισαγωγή</label>
            <input type="checkbox" id="repeatEntrySwitch" class="toggle-switch">
            <button type="button" id="editRepeatMappingBtn" class="ml-2 px-2 py-1 border rounded text-sm hidden">Επεξεργασία</button>
        </div>

        <!-- Toggle switch for receipts scrape -->

    </form>
</div>

{# ΣΗΜΕΙΩΣΗ: το στατικό confirmation modal που υπήρχε εδώ αφαιρέθηκε όπως ζήτησες. Χρησιμοποιείται πλέον το summaryModal για όλες τις περιπτώσεις. #}

{# --- Yellow box αν υπάρχει MARK ήδη στο Excel --- #}
{% if allow_edit_existing and not request.args.get('force_edit') %}
<div class="mt-4 p-4 bg-yellow-50 rounded border border-yellow-300 text-yellow-800" id="existingBanner">
    Το MARK <strong>{{ mark }}</strong> υπάρχει ήδη στο Excel. Θέλεις να τροποποιήσεις τον χαρακτηρισμό;
    <div class="mt-2 flex gap-2">
        <button id="forceEditBtn" type="button" class="bg-yellow-600 text-white px-3 py-2 rounded hover:bg-yellow-700">
            Επιβεβαίωση
        </button>
        <button id="dismissBannerBtn" type="button" onclick="this.parentElement.parentElement.style.display='none'"
                class="px-3 py-2 border rounded hover:bg-gray-50">
            Άκυρο
        </button>
    </div>
</div>
{% endif %}




{% if modal_summary and (request.args.get('force_edit') == '1' or not allow_edit_existing) %}
<!-- SUMMARY MODAL -->
<div id="summaryModal" class="fixed inset-0 flex items-center justify-center bg-black/40 z-50 overflow-auto p-4" style="display:none;">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6">

        <!-- HEADER -->
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">
                Περίληψη Παραστατικού - <span id="summaryModalMark">MARK</span>
            </h3>
            <button id="modalCloseX" class="text-gray-500 text-xl font-bold">✕</button>
        </div>

        <!-- SUMMARY INFO -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
            <div><strong>Α/Α Παραστατικού</strong><div id="summary_AA"></div></div>
            <div><strong>ΑΦΜ</strong><div id="summary_AFM"></div></div>
            <div><strong>Επωνυμία</strong><div id="summary_Name"></div></div>
            <div><strong>Ημερομηνία</strong><div id="summary_issueDate"></div></div>
            <div><strong>Τύπος Παραστατικού</strong><div id="summary_type_name"></div></div>
            <div><strong>Καθαρή Αξία</strong><div id="summary_totalNetValue"></div></div>
            <div><strong>ΦΠΑ</strong><div id="summary_totalVatAmount"></div></div>
            <div><strong>Σύνολο</strong><div id="summary_totalValue"></div></div>
        </div>

        <!-- LINES -->
        <h4 class="font-medium mt-4 mb-2">Γραμμές Παραστατικού (για χαρακτηρισμό)</h4>
        <div id="summaryLinesContainer" class="overflow-auto max-h-96 border rounded p-2"></div>



        <!-- FOOTER -->
        <div class="mt-4 flex justify-between items-center">
            <div class="text-sm text-gray-600">
                Σημείωση: οι κατηγορίες προέρχονται από τα settings του πελάτη. Μπορείτε να ορίσετε/επεξεργαστείτε αυτές τις επιλογές στη σελίδα Credentials.
            </div>

            <div class="flex justify-end gap-2">
                <form method="POST" action="{{ url_for('save_summary') }}" id="saveSummaryForm">
                    <input type="hidden" name="summary_json" id="summaryJsonInput" value='{{ modal_summary | tojson | safe if modal_summary else "{}" }}'>
                    <button type="submit" class="bg-sky-600 text-white px-3 py-2 rounded">Αποθήκευση στο Cache</button>
                    <input type="hidden" id="scrapeUrlField" name="scrape_url" value="">
                    <input type="hidden" id="scrapeCategoryField" name="scrape_category" value="">
                    <input type="hidden" id="scrapeForceField" name="scrape_force" value="false">
                </form>
                <button id="modalCloseBtn" class="px-3 py-2 border rounded">Κλείσιμο</button>
            </div>
        </div>

    </div>
</div>
{% endif %}


{# --- Repeat mapping modal (dynamic, populated by JS) --- #}
<!-- REPEAT MAPPING MODAL (CLEAN) -->
<div id="repeatMappingModal" class="fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4" style="display:none;">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Επαναληπτική αντιστοίχιση κατηγοριών</h3>
      <button id="repeatModalCloseX" class="text-gray-500 text-xl font-bold">✕</button>
    </div>

    <div class="space-y-3">
      <div class="text-sm text-gray-600">
        Επίλεξε για κάθε ΦΠΑ-κατηγορία ποια κατηγορία εξόδου θέλεις να χρησιμοποιείται επαναληπτικά. Μπορείς επίσης να ορίσεις <em>προεπιλογή</em>.
      </div>

      <!-- Επιλογή Προφίλ -->
      <div class="flex items-center gap-2">
        <label class="text-sm font-medium">Προφίλ</label>
        <select id="charProfileSelect" class="border rounded px-2 py-1"></select>
        <!-- redirect, όχι νέο tab -->
        <a href="{{ url_for('profiles_page', vat=vat) }}" class="px-2 py-1 border rounded">+</a>
      </div>

      <!-- Hint λαθών -->
      <div id="charMissingHint" class="text-sm text-red-600" style="display:none"></div>

      <!-- Εδώ αποδίδονται ΜΟΝΟ τα 5 dropdowns με JS -->
      <div id="repeatMappingList" class="space-y-2"></div>
    </div>

    <div class="mt-4 flex justify-end gap-2">
      <button id="repeatModalCancel" class="px-3 py-2 border rounded">Άκυρο</button>
      <button id="repeatModalSave" class="bg-sky-600 text-white px-3 py-2 rounded">Αποθήκευση</button>
    </div>
  </div>
</div>


{% if modal_warning %}
<div id="afmWarningModal" class="fixed inset-0 flex items-center justify-center bg-black/40 z-50 overflow-auto p-4" style="display:none;">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-red-600">Προειδοποίηση</h3>
        </div>
        <div id="afmWarningBody" class="mb-4 text-gray-700">
            {{ modal_warning }}
        </div>
        <div class="flex justify-end gap-2">
            <button id="afmModalConfirm" class="bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700">Κατάλαβα</button>
        </div>
    </div>
</div>
{% endif %}

{# Flash container (JS will inject messages here) #}
<div id="clientFlashContainer" class="fixed top-4 right-4 z-60"></div>

{% include 'list_inner.html' %}


{% endblock %}

{% block scripts %}

<script src="/static/loop_hard_guard.js"></script>
<script src="{{ url_for('static', filename='repeat_flow_guard.js') }}"></script>


<script>
function isReceiptsOn(){
  const r = document.getElementById('useReceiptsSwitch');
  return !!(r && r.checked);
}

function setActiveProfileHint(name){
  const el = document.getElementById('activeRepeatProfileHint');
  const sw = document.getElementById('repeatEntrySwitch');
  if(!el || !sw) return;

  // Δείξε μόνο όταν: επαναληψιμη ON ΚΑΙ ΔΕΝ είμαστε σε Αποδείξεις
  if (sw.checked && !isReceiptsOn()) {
    el.style.display = '';
    el.textContent = "Ενεργό προφίλ επαναληψιμης: " + (name || "Γενικό");
  } else {
    el.style.display = 'none';
    el.textContent = "";
  }
}


</script>
<script>
// Δέχεται είτε ποσοστά είτε kat_fpa_* και επιστρέφει ΠΑΝΤΑ ποσοστά σύμφωνα με: Α→0, Β→6, Γ→13, Δ→17, Ε→24
// ΚΑΝΟΝΑΣ: Α→0%, Β→6%, Γ→13%, Δ→17%, Ε→24%
function normalizeMapping(m){
  const pct = {"0%":"", "6%":"", "13%":"", "17%":"", "24%":""};
  if (!m) return pct;
  if ('kat_fpa_a' in m || 'kat_fpa_b' in m || 'kat_fpa_g' in m || 'kat_fpa_d' in m || 'kat_fpa_e' in m){
    pct["0%"]  = m.kat_fpa_a || "";
    pct["6%"]  = m.kat_fpa_b || "";
    pct["13%"] = m.kat_fpa_g || "";
    pct["17%"] = m.kat_fpa_d || "";
    pct["24%"] = m.kat_fpa_e || "";
    return pct;
  }
  for (const k in pct){ if (Object.prototype.hasOwnProperty.call(m,k)) pct[k] = m[k] || ""; }
  return pct;
}
function percentToKat(p){
  p = p || {};
  return {
    kat_fpa_a: p["0%"]  || "",
    kat_fpa_b: p["6%"]  || "",
    kat_fpa_g: p["13%"] || "",
    kat_fpa_d: p["17%"] || "",
    kat_fpa_e: p["24%"] || "",
  };
}
function katToPercent(k){
  k = k || {};
  return {
    "0%":  k.kat_fpa_a || "",
    "6%":  k.kat_fpa_b || "",
    "13%": k.kat_fpa_g || "",
    "17%": k.kat_fpa_d || "",
    "24%": k.kat_fpa_e || "",
  };
}

</script>

<script>
(() => {
  const VAT = "{{ vat or '' }}";
  const VAT_KEYS = ["0%","6%","13%","17%","24%"];

  // ενεργές κατηγορίες πελάτη (χωρίς «αποδειξακια»)
  let CUSTOMER_CATEGORIES = (function(){
    try {
      const arr = {{ (customer_categories or []) | tojson | safe }};
      return Array.isArray(arr) ? arr.filter(x => x !== 'αποδειξακια') : [];
    } catch(e){ return []; }
  })();

  
  async function fetchDefaultMapping() {
    try {
      const r = await fetch('/api/repeat_entry/get?vat=' + encodeURIComponent(VAT), {credentials:'same-origin'});
      if (!r.ok) return {};
      const j = await r.json();
      return normalizeMapping((j && j.repeat_entry && j.repeat_entry.mapping) || {});
    } catch { return {}; }
  }

  async function fetchProfilesAndTags() {
    try {
      const r = await fetch('/api/char_profiles?vat=' + encodeURIComponent(VAT), {credentials:'same-origin'});
      const j = await r.json();
      if (Array.isArray(j.expense_tags) && j.expense_tags.length) {
        CUSTOMER_CATEGORIES = j.expense_tags.filter(x => x !== 'αποδειξακια');
      }
      // κανονικοποίηση mapping κάθε προφίλ σε ποσοστά
      const profiles = Array.isArray(j.profiles) ? j.profiles.map(p => ({
        ...p, mapping: normalizeMapping(p.mapping || {})
      })) : [];
      return profiles;
    } catch { return []; }
  }

  // ---- DOM refs
  const modal      = document.getElementById('repeatMappingModal');
  const listBox    = document.getElementById('repeatMappingList');
  const selProfile = document.getElementById('charProfileSelect');
  const hint       = document.getElementById('charMissingHint');
  const btnSave    = document.getElementById('repeatModalSave');
  const btnCancel  = document.getElementById('repeatModalCancel');
  const btnX       = document.getElementById('repeatModalCloseX');
  const btnEdit    = document.getElementById('editRepeatMappingBtn');

  const show = () => modal.style.display = 'flex';
  const hide = () => modal.style.display = 'none';
  const setHint = (t) => { hint.textContent = t || ''; hint.style.display = t ? '' : 'none'; };

  // φτιάχνει μία γραμμή (label + select)
  function makeRow(pct, selected) {
    const wrap = document.createElement('div');
    wrap.className = 'flex items-center gap-3';
    const label = document.createElement('div');
    label.className = 'w-20 text-sm font-medium';
    label.textContent = pct;

    const sel = document.createElement('select');
    sel.className = 'p-1 border rounded flex-1';
    sel.dataset.vat = pct;

    const o0 = document.createElement('option'); o0.value = ''; o0.textContent = '— επίλεξε —'; sel.appendChild(o0);
    CUSTOMER_CATEGORIES.forEach(t => {
      const o = document.createElement('option'); o.value = t; o.textContent = t;
      if (t === selected) o.selected = true;
      sel.appendChild(o);
    });

    wrap.appendChild(label);
    wrap.appendChild(sel);
    return wrap;
  }

  function renderMapping(mapping = {}) {
    const m = normalizeMapping(mapping);
    listBox.innerHTML = '';                            // ← καθαρίζει ΠΑΝΤΑ (no duplicates)
    VAT_KEYS.forEach(k => listBox.appendChild(makeRow(k, m[k] || '')));
  }

  function readMappingFromUI() {
    const out = {};
    const missing = [];
    listBox.querySelectorAll('select[data-vat]').forEach(sel => {
      const k = sel.dataset.vat;
      const v = (sel.value || '').trim();
      if (!v) missing.push(k);
      out[k] = v;
    });
    return { out, missing };
  }

  // Global override ώστε άλλο code-path να ανοίγει το modal με έτοιμο mapping
  window._repeatMappingOverride = null;

  async function fillProfileSelect(profiles, defaultMapping) {
    selProfile.innerHTML = '';
    const o0 = document.createElement('option');
    o0.value = '';
    o0.textContent = 'Γενικό';
    o0.dataset.mapping = JSON.stringify(normalizeMapping(defaultMapping || {}));
    selProfile.appendChild(o0);

    profiles.forEach(p => {
      const o = document.createElement('option');
      o.value = p.id || p.name || '';
      o.textContent = p.name || '(χωρίς όνομα)';
      o.dataset.mapping = JSON.stringify(normalizeMapping(p.mapping || {}));
      selProfile.appendChild(o);
    });
  }

  selProfile.addEventListener('change', () => {
    const opt = selProfile.selectedOptions[0];
    const mapping = (opt && opt.dataset.mapping) ? JSON.parse(opt.dataset.mapping) : {};
    renderMapping(mapping);     // ← προ-συμπλήρωση ανά προφίλ ή «καμία»
    setHint('');
  });

  btnSave.addEventListener('click', async () => {
  const { out, missing } = readMappingFromUI();
  if (missing.length) { setHint('Συμπλήρωσε κατηγορία για: ' + missing.join(', ')); return; }
  setHint('');

  const profileName = selProfile?.value || "";   // "" = Γενικό

  try {
    const r = await fetch('/api/repeat_entry/save', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      credentials: 'same-origin',
      body: JSON.stringify({
        vat: "{{ vat or '' }}",
        enabled: true,
        mapping: out,                  // 0/6/13/17/24
        profile_name: profileName      // <-- ΣΗΜΑΝΤΙΚΟ
      })
    });
    const j = await r.json();
    if (!j.ok) { setHint(j.error || 'Αποτυχία αποθήκευσης'); return; }

    // Κλείσε modal
    document.getElementById('repeatMappingModal').style.display = 'none';

    // Flash επιτυχίας
    showFlash('Ενημερώθηκε η ρύθμιση επαναληπτικής εισαγωγής.', 'success', 3000);

    // Ενημέρωσε την ένδειξη πάνω από το toggle
    setActiveProfileHint(profileName);

    // Βάλε checked το switch & δείξε το κουμπί "Επεξεργασία"
    document.getElementById('repeatEntrySwitch')?.setAttribute('checked', 'checked');
    document.getElementById('editRepeatMappingBtn')?.classList.remove('hidden');
  } catch {
    setHint('Δικτυακό σφάλμα.');
  }
});


  [btnCancel, btnX].forEach(b => b && b.addEventListener('click', hide));
  async function fetchRepeatState(vat){
  // δεν πειράζουμε το δικό σου /api/repeat_entry/get
  // αν υπάρχει το νέο status endpoint, το προτιμάμε για να πάρουμε και profile_name
  try{
    const r = await fetch('/api/repeat_entry/status2' + (vat?('?vat='+encodeURIComponent(vat)):''),
                          {credentials:'same-origin'});
    if(r.ok){
      const j = await r.json();
      const repeat = j.repeat_entry || {};
      return {
        defaultMap: (repeat.mapping || {}),
        savedName: (repeat.profile_name || "")
      };
    }
  }catch(_){}
  // fallback: παλιό endpoint που ίσως δεν επιστρέφει profile_name
  try{
    const r = await fetch('/api/repeat_entry/get' + (vat?('?vat='+encodeURIComponent(vat)):''),
                          {credentials:'same-origin'});
    const j = await r.json();
    const repeat = j.repeat_entry || {};
    return {
      defaultMap: (repeat.mapping || {}),
      savedName: (repeat.profile_name || "")
    };
  }catch(_){}
  return { defaultMap:{}, savedName:"" };
}
  // Άνοιγμα modal: ΠΑΝΤΑ καθαρό render, χωρίς διπλο-append
  async function openModal(){
  const VAT = "{{ vat or '' }}";
  const hint = document.getElementById('charMissingHint');
  if(hint){ hint.style.display='none'; hint.textContent=''; }

  // 1) φέρνουμε προφίλ + tags + repeat state (mapping + ενεργό όνομα προφίλ)
  const [profiles, defaultFromGet, state] = await Promise.all([
    (async () => {
      try {
        const r = await fetch('/api/char_profiles?vat=' + encodeURIComponent(VAT), {credentials:'same-origin'});
        const j = await r.json();
        // αν επέστρεψε expense_tags, ανανέωσε τα διαθέσιμα (χωρίς "αποδειξακια")
        if (Array.isArray(j.expense_tags)) {
          window.CUSTOMER_CATEGORIES = j.expense_tags.filter(x => x !== 'αποδειξακια');
        }
        return (j.profiles || []).map(p => ({...p, mapping: normalizeMapping(p.mapping || p.map || {})}));
      } catch { return []; }
    })(),
    (async () => {
      try {
        const r = await fetch('/api/repeat_entry/get?vat=' + encodeURIComponent(VAT), {credentials:'same-origin'});
        const j = await r.json();
        return (j && j.repeat_entry && j.repeat_entry.mapping) || {};
      } catch { return {}; }
    })(),
    fetchRepeatState(VAT) // <-- φέρνει defaultMap + savedName
  ]);

  const defaultMap = Object.keys(state.defaultMap || {}).length ? state.defaultMap : defaultFromGet;
  const savedName  = state.savedName || "";

  // 2) γέμισε το dropdown των προφίλ (πρώτο = "Γενικό")
  const sel = document.getElementById('charProfileSelect');
  if(sel){
    sel.innerHTML = "";
    const o0 = document.createElement('option');
    o0.value = "";
    o0.textContent = "Γενικό";
    o0.dataset.mapping = JSON.stringify(normalizeMapping(defaultMap || {}));
    sel.appendChild(o0);

    profiles.forEach(p=>{
      const o = document.createElement('option');
      o.value = p.name || p.id || "";
      o.textContent = p.name || "(χωρίς όνομα)";
      o.dataset.id = p.id || "";
      o.dataset.mapping = JSON.stringify(normalizeMapping(p.mapping || p.map || {}));
      sel.appendChild(o);
    });

    // 3) αν έχει αποθηκευτεί ενεργό προφίλ, επίλεξέ το και προ-συμπλήρωσε
    if (savedName && Array.from(sel.options).some(o => o.value === savedName)){
      sel.value = savedName;
      try{
        const m = JSON.parse(sel.selectedOptions[0].dataset.mapping || "{}");
        renderMapping(m);
        setActiveProfileHint(savedName);

      }catch{
        renderMapping(defaultMap);
      }
    } else {
      sel.value = "";
      renderMapping(defaultMap); // "Γενικό"
      setActiveProfileHint("");

    }

    sel.onchange = () => {
      const opt = sel.selectedOptions[0];
      const m = (opt && opt.dataset.mapping) ? JSON.parse(opt.dataset.mapping) : defaultMap;
      renderMapping(m);
      setActiveProfileHint(sel.value || "");

      hint && (hint.style.display='none', hint.textContent='');
    };
  } else {
    // αν για κάποιο λόγο δεν υπάρχει το select, τουλάχιστον δείξε τα dropdowns
    renderMapping(defaultMap);
  }

  document.getElementById('repeatMappingModal').style.display = 'flex';
}
  
  document.getElementById('editRepeatMappingBtn')?.addEventListener('click', openModal);
  

  // Εξαγωγή για χρήση από αλλού
  window.openRepeatModal = openModal;
  // auto-open του modal όταν έρχομαι από profiles με ?open_repeat=1
try {
  const p = new URLSearchParams(location.search);
  if (p.get('open_repeat') === '1') {
    setTimeout(() => { window.openRepeatModal && window.openRepeatModal(); }, 0);
  }
} catch {}

})();
</script>

<script>
(function(){
  const VAT = "{{ vat or '' }}";

  // Διαβάζουμε το mapping που βλέπει ο χρήστης στο modal (0/6/13/17/24)
  function readPercentMappingFromUI(){
    // Αν υπάρχει ήδη helper στη σελίδα σου, χρησιμοποίησέ τον
    if (typeof window.readMappingFromUI === 'function') {
      try {
        const r = window.readMappingFromUI(); // συνήθως { out: { "0%": "...", ... } }
        return (r && (r.out || r.mapping)) || r || {};
      } catch(e) {}
    }
    // Fallback: δοκίμασε data-vat ή γνωστά ids
    const pick = (sel) => (document.querySelector(sel)?.value || "");
    return {
      "0%":  pick('[data-vat="0%"]')  || pick('#repeat_vat_0')  || pick('#vat_0'),
      "6%":  pick('[data-vat="6%"]')  || pick('#repeat_vat_6')  || pick('#vat_6'),
      "13%": pick('[data-vat="13%"]') || pick('#repeat_vat_13') || pick('#vat_13'),
      "17%": pick('[data-vat="17%"]') || pick('#repeat_vat_17') || pick('#vat_17'),
      "24%": pick('[data-vat="24%"]') || pick('#repeat_vat_24') || pick('#vat_24'),
    };
  }

  // Μετατροπή από ποσοστά -> kat_fpa_* για /api/profiles/save
  
  // Δένουμε hook στο κουμπί "Αποθήκευση" του modal χωρίς να πειράξουμε την υπάρχουσα ροή σου
  const saveBtn = document.getElementById('repeatModalSave');
  if (saveBtn && !saveBtn.dataset._profileUpdateBound){
    saveBtn.addEventListener('click', async function(){
      try{
        const sel = document.getElementById('charProfileSelect');
        if (!sel) return;

        const profileName = (sel.value || '').trim();
        // Αν είναι "Γενικό" (κενό value), δεν ενημερώνουμε profile στο credentials
        if (!profileName) return;

        const opt = sel.selectedOptions && sel.selectedOptions[0];
        const profileId = (opt && opt.dataset && opt.dataset.id) ? opt.dataset.id : "";

        // Διάβασε το mapping που έβαλε ο χρήστης στα dropdowns του modal τώρα
        const pctMap = readPercentMappingFromUI();      // 0/6/13/17/24
        const katMap = percentToKat(pctMap);            // kat_fpa_*

        if (profileId){
          // ΚΥΡΙΑ ΟΔΟΣ: Update στο credentials ΜΕ id -> δεν δημιουργεί νέο στο rename
          const r = await fetch('/api/profiles/save', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            credentials:'same-origin',
            body: JSON.stringify({ id: profileId, name: profileName, map: katMap })
          });
          const j = await r.json().catch(()=>null);
          if (!(j && j.ok)) {
            console.warn('profiles/save failed:', j);
            // Fallback (σπάνια χρειάζεται): legacy char_profiles με mapping σε ποσοστά
            await fetch('/api/char_profiles/save', {
              method:'POST',
              headers:{ 'Content-Type':'application/json' },
              credentials:'same-origin',
              body: JSON.stringify({ vat: VAT, name: profileName, mapping: pctMap })
            });
          }
        } else {
          // Δεν έχουμε id (παλιό/legacy profile) -> fallback σε char_profiles (ποσοστά)
          await fetch('/api/char_profiles/save', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            credentials:'same-origin',
            body: JSON.stringify({ vat: VAT, name: profileName, mapping: pctMap })
          });
        }
        // Δεν κάνουμε preventDefault: η δική σου αποθήκευση repeat_entry συνεχίζει κανονικά
      }catch(err){
        console.warn('modal profile update failed', err);
      }
    }, true); // capture ώστε να τρέξει ανεξάρτητα απ’ τους άλλους listeners
    saveBtn.dataset._profileUpdateBound = '1';
  }
})();
</script>


<script>

  (function () {
  const KEY = 'UI:useReceipts'; // '1' = Αποδείξεις, '0' = Τιμολόγια

  function fireChange(el){
    if(!el) return;
    try {
      el.dispatchEvent(new Event('change', { bubbles:true }));
    } catch {
      const evt = document.createEvent('Event');
      evt.initEvent('change', true, true);
      el.dispatchEvent(evt);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const sw = document.getElementById('useReceiptsSwitch');
    if (!sw) return;

    // Αν υπάρχει ?use_receipts=1/0 στο URL, γράψ’ το στο localStorage (authoritative)
    try {
      const q = new URLSearchParams(location.search);
      if (q.has('use_receipts')) {
        localStorage.setItem(KEY, q.get('use_receipts') === '1' ? '1' : '0');
      }
    } catch {}

    // Restore από localStorage
    const saved = localStorage.getItem(KEY);
    if (saved !== null) sw.checked = (saved === '1');

    // ΠΟΛΥ ΣΗΜΑΝΤΙΚΟ:
    // Τρέξε τον υπάρχοντα change handler του switch ώστε να εμφανίσει/κρύψει
    // τα σωστά inputs (MARK vs URL). Το κάνουμε 2 φορές (rAF + microtask)
    // για να “πιάσει” σε DOM που φτιάχνεται δυναμικά.
    requestAnimationFrame(() => {
      fireChange(sw);
      setTimeout(() => fireChange(sw), 0);
    });

    // Persist σε κάθε αλλαγή χρήστη
    sw.addEventListener('change', () => {
      try { localStorage.setItem(KEY, sw.checked ? '1' : '0'); } catch {}
      // Προαιρετικό: κρατάμε και ένα data-mode στο body αν το θες για CSS hooks
      document.body.dataset.mode = sw.checked ? 'receipts' : 'invoices';
    });

    // Όταν κάνεις submit/save απόδειξης, κλείδωσε το mode σε “Αποδείξεις”
    // ώστε στο redirect/refresh να παραμείνει.
    document.getElementById('saveSummaryForm')?.addEventListener('submit', () => {
      try {
        const raw = document.getElementById('summaryJsonInput')?.value || '';
        const s = raw ? JSON.parse(raw) : {};
        const isReceipt = s.is_receipt === true ||
                          /αποδει/i.test(`${s.type_name || ''} ${s.category || s.characteristic || ''}`);
        if (isReceipt) localStorage.setItem(KEY, '1');
      } catch {}
    });
  });
})();
// --- Reclass guard (yellow box -> ?force_edit=1) ---
const URL_PARAMS = (function(){ try { return new URL(window.location.href).searchParams; } catch(_) { return new URLSearchParams(''); } })();
const FORCE_EDIT = (function(){ try { return URL_PARAMS.get('force_edit') === '1'; } catch(_) { return false; } })();

const SEARCH_BASE_URL = "{{ url_for('search') }}";
const VAT = "{{ vat or '' }}"; // active vat from server
const INITIAL_MARK = "{{ mark|e }}"; // αρχική τιμή mark (αν υπήρχε)
const ACTIVE_YEAR = (function(){ try { return {{ active_year|default('null') }}; } catch(e){ return null; } })();
async function getActiveFiscalYear() {
  // Προτίμησε την τιμή που ήρθε από server-side render (Jinja)
  if (typeof ACTIVE_YEAR !== 'undefined' && ACTIVE_YEAR !== null) {
    try { return String(ACTIVE_YEAR); } catch(_) { /* noop */ }
  }
  // Fallback: ρώτα το backend (υπάρχει route)
  try {
    const r = await fetch('/get_fiscal_year', {credentials:'same-origin'});
    const j = await r.json();
    if (j && j.exists) return String(j.fiscal_year);
  } catch(_) {}
  return null;
}


(function(){
  // Ανεξάρτητο modal μόνο για Αποδείξεις (δεν ακουμπά το afmWarningModal)
  window.openReceiptWarning = function(message){
    var id='receiptWarn', m=document.getElementById(id);
    if(!m){
      var el=document.createElement('div');
      el.id=id;
      el.style.cssText='position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:9999';
      el.innerHTML =
        '<div style="background:#fff;border-radius:10px;max-width:480px;width:calc(100% - 32px);padding:20px;">'
        + '<h3 style="margin:0 0 10px;color:#b91c1c;font-weight:600;font-size:18px">Προειδοποίηση</h3>'
        + '<div id="receiptWarnBody" style="margin-bottom:14px;color:#374151;font-size:14px"></div>'
        + '<div style="text-align:right"><button id="receiptWarnOk" type="button"'
        + ' style="background:#b91c1c;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer">Κατάλαβα</button></div>'
        + '</div>';
      document.body.appendChild(el);
      el.addEventListener('click', function(e){ if(e.target===el) el.style.display='none'; });
      el.querySelector('#receiptWarnOk').addEventListener('click', function(){ el.style.display='none'; });
      m = el;
    }
    var body = m.querySelector('#receiptWarnBody');
    if(body) body.textContent = message || 'Προειδοποίηση.';
    m.style.display='flex';
  };
})();

    // Καθαρισμός ανά γραμμή (πολλαπλές γραμμές)
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.clear-row-btn');
    if (btn) {
      e.stopPropagation();
      const tr = btn.closest('tr');
      const sel = tr && tr.querySelector('select[name^="category["]');
      if (sel) sel.value = '';
    }
  });

  // Καθαρισμός στη single-line περίπτωση
  const singleClear = document.getElementById('single-clear');
  if (singleClear) {
    singleClear.addEventListener('click', function (e) {
      e.stopPropagation();
      const sel = document.querySelector('select[name^="category["]');
      if (sel) sel.value = '';
    });
  }

  // Προληπτικά: μην ξανα-ανοίγει δεύτερο modal στο click "Αποθήκευση"
  // (αν έχεις delegate listeners κάτω από το modal)
  document.addEventListener('submit', function(e){
    const form = e.target;
    if (form && form.closest('#summaryModal')) {
      const submitBtn = form.querySelector('[type="submit"]');
      if (submitBtn) submitBtn.disabled = true;
      e.stopPropagation(); // Μπλοκάρει bubbling που θα πυροδοτούσε κάτωθεν click handlers
    }
  }, true);
    // initial categories passed from server as fallback; will be overridden if API returns expense_tags
let CUSTOMER_CATEGORIES = (function(){ try { return {{ customer_categories | tojson | safe }} || []; } catch(e){ return []; } })();

// Helper: show transient flash (client-side)
/* ====== Render summary lines into modal and wire handlers ====== */
 function renderSummaryLinesFromObject(obj) {
  const receiptsMode = !!(document.getElementById('useReceiptsSwitch')?.checked) || !!obj?.is_receipt;
  const RECEIPT_CATEGORY = 'αποδειξακια';

  const container = document.getElementById('summaryLinesContainer');
  const summaryInput = document.getElementById('summaryJsonInput');
  if(!container || !summaryInput) return;

  container.innerHTML = '';
  const lines = Array.isArray(obj.lines) ? obj.lines : [];

  // helper to persist back to the hidden input
    (function(){
  function safeParseJson(s){
    try { return JSON.parse(s || '{}'); } catch(e){ return {}; }
  }

  const summaryInput = document.getElementById('summaryJsonInput');
  const container = document.getElementById('summaryLinesContainer');

  // fallback server-side object (if Jinja rendered modal_summary)
  const SERVER_MODAL_SUMMARY = (function(){
    try { return {{ modal_summary | tojson | safe if modal_summary else 'null' }}; } catch(e){ return null; }
  })()
  try {
    var __cc = document.getElementById('summaryLinesContainer');
    if (__cc && __cc.dataset && __cc.dataset.phase === 'iife') {
      // IIFE already rendered content -> skip second render path
      if (typeof persist === 'function') try{ persist(); }catch(e){}
      return;
    }
  } catch(e) {}
;

  // helper to get current summary object (prefer hidden input, fallback server var)
  function getSummaryObj(){
    if(summaryInput && summaryInput.value && summaryInput.value.trim() !== ''){
      const parsed = safeParseJson(summaryInput.value);
      if(parsed && typeof parsed === 'object') return parsed;
    }
    if(SERVER_MODAL_SUMMARY) return SERVER_MODAL_SUMMARY;
    return { lines: [] };
  }

  // ensure each line has id and normalized keys
  function normalizeSummary(summary){
    if(!summary) summary = {};
    const lines = Array.isArray(summary.lines) ? summary.lines.slice() : [];
    const norm = lines.map((l, idx) => {
      const id = (l && (l.id || l.line_id)) ? String(l.id || l.line_id) : ('l' + idx);
      return {
        id: id,
        description: l && (l.description || l.desc || '') || '',
        amount: l && (l.amount || l.lineTotal || l.total || '') || '',
        vat: l && (l.vat || l.vatRate || '') || '',
        vatCategory: l && (l.vatCategory || l.vat_category || '') || '',
        category: l && (l.category || l.cat || '') || ''
      };
    });
    return { ...summary, lines: norm };
  }

  // build DOM for multiple lines (table)
  function buildTableHTML(lines, categories){
    const table = document.createElement('table');
    table.className = 'w-full border-collapse';
    const thead = document.createElement('thead');
    thead.className = 'bg-gray-100 sticky top-0';
    thead.innerHTML = '<tr>' +
      '<th class="p-2 border text-left">#</th>' +
      '<th class="p-2 border text-left">ΦΠΑ Κατηγορία</th>' +
      '<th class="p-2 border text-right">Ποσό</th>' +
      '<th class="p-2 border text-right">ΦΠΑ</th>' +
      '<th class="p-2 border text-left">Κατηγορία Εξόδου</th>' +
      '</tr>';
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    tbody.id = 'renderedLinesTableBody';
    lines.forEach((ln, idx) => {
      const tr = document.createElement('tr');
      tr.dataset.lineId = ln.id || ('l' + idx);
      tr.dataset.vat = ln.vatCategory || ln.vat || '';

      tr.innerHTML = '<td class="p-2 border text-sm text-gray-600">' + (idx+1) + '</td>' +
        '<td class="p-2 border break-words">' + escapeHtml(ln.vatCategory || '') + '</td>' +
        '<td class="p-2 border text-right">' + escapeHtml(String(ln.amount || '')) + '</td>' +
        '<td class="p-2 border text-right">' + escapeHtml(String(ln.vat || '')) + '</td>' +
        '<td class="p-2 border"></td>';

      // create select
      const select = document.createElement('select');
      select.className = 'expense-category p-1 border rounded w-full';
      select.dataset.lineId = ln.id || ('l' + idx);
      select.name = `category[${select.dataset.lineId}]`;
      const emptyOpt = document.createElement('option'); emptyOpt.value=''; emptyOpt.innerText='-- επίλεξε --';
      select.appendChild(emptyOpt);
      (categories || []).forEach(c => {
        const o = document.createElement('option'); o.value = c; o.innerText = c;
        if(c === ln.category) o.selected = true;
        select.appendChild(o);
      });

      tr.querySelector('td:last-child').appendChild(select);
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    return table;
  }

  // build single-line buttons UI
  function buildSingleLineHTML(line, categories){
    const wrapper = document.createElement('div');
    wrapper.className = 'border rounded p-4';
    wrapper.dataset.lineId = line.id || 'l0';

    const grid = document.createElement('div');
    grid.className = 'mb-3 grid grid-cols-1 md:grid-cols-3 gap-3';
    grid.innerHTML = '<div><strong>ΦΠΑ Κατηγορία</strong><div>' + escapeHtml(line.vatCategory || '') + '</div></div>' +
      '<div><strong>Ποσό</strong><div>' + escapeHtml(String(line.amount || '')) + '</div></div>' +
      '<div><strong>ΦΠΑ</strong><div>' + escapeHtml(String(line.vat || '')) + '</div></div>';
    wrapper.appendChild(grid);

    const controls = document.createElement('div');
    controls.className = 'mb-3';
    const title = document.createElement('strong');
    title.innerText = 'Επίλεξε Κατηγορία Εξόδου';
    controls.appendChild(title);

    const btnwrap = document.createElement('div');
    btnwrap.id = 'renderedCategoryButtons';
    btnwrap.className = 'mt-2 flex flex-wrap gap-2';
    (categories || []).forEach(c => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'category-btn px-3 py-2 border rounded hover:bg-sky-50';
      btn.dataset.cat = c;
      btn.dataset.lineId = line.id || 'l0';
      btn.innerText = c;
      if(c === line.category){
        btn.classList.add('bg-sky-600');
        btn.classList.add('text-white');
      }
      btnwrap.appendChild(btn);
    });

    const clearBtn = document.createElement('button');
    clearBtn.type = 'button';
    clearBtn.className = 'px-3 py-2 border rounded text-sm ml-2 clear-category';
    clearBtn.innerText = 'Καθαρισμός';
    btnwrap.appendChild(clearBtn);

    controls.appendChild(btnwrap);
    wrapper.appendChild(controls);
    return wrapper;
  }

  function escapeHtml(s){
    if(!s && s !== 0) return '';
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  // read categories from server-provided global or from a safe default
  function getCategories(){
    try {
      const js = (function(){ try { return {{ customer_categories | tojson | safe }}; } catch(e){ return null; } })();
      if(Array.isArray(js) && js.length) return js;
    } catch(e){}
    return window.CUSTOMER_CATEGORIES || [];
  }

  // render everything into the container
  function renderSummaryLines(){
    if(!container) return;
    const summary = normalizeSummary(getSummaryObj());
    const lines = summary.lines || [];
    const categories = getCategories();

    // clear container
    container.innerHTML = '';

    // Title (optional)
    // const info = document.createElement('div'); info.className='mb-2 text-sm text-gray-700'; container.appendChild(info);

    if(lines.length === 0){
      const warn = document.createElement('div');
      warn.className = 'mt-4 p-3 bg-yellow-50 rounded';
      warn.innerText = 'Δεν βρέθηκαν γραμμές για αυτό το MARK.';
      container.appendChild(warn);
      wireInteractions();
    try{ container.dataset.phase = 'iife'; }catch(e){}
 // ensure handlers cleared
      return;
    }

    if(lines.length === 1){
      container.appendChild(buildSingleLineHTML(lines[0], categories));
    } else {
      container.appendChild(buildTableHTML(lines, categories));
    }

    // after building DOM, wire events
    wireInteractions();
  }

  // update hidden input from current DOM selections/buttons

  function wireInteractions(){
    // remove old handlers by cloning nodes if necessary (to avoid duplicate attachments)
    document.querySelectorAll('select.expense-category').forEach(sel => {
      sel.addEventListener('change', function(){
        updateSummaryFromDom();
      });
    });

    // category buttons (single-line)
    document.querySelectorAll('#renderedCategoryButtons .category-btn').forEach(btn => {
      btn.addEventListener('click', function(){
        const lineId = this.dataset.lineId || '';
        // toggle this button active/inactive
        document.querySelectorAll('#renderedCategoryButtons .category-btn').forEach(b => {
          if(b.dataset.lineId === lineId){
            b.classList.remove('bg-sky-600'); b.classList.remove('text-white');
          }
        });
        const isActive = !(this.classList.contains('bg-sky-600'));
        if(isActive){
          this.classList.add('bg-sky-600'); this.classList.add('text-white');
        } else {
          this.classList.remove('bg-sky-600'); this.classList.remove('text-white');
        }
        updateSummaryFromDom();
      });
    });

    // clear buttons
    document.querySelectorAll('.clear-category').forEach(cb => {
      cb.addEventListener('click', function(){
        const parent = cb.closest('[data-line-id]');
        if(!parent) return;
        const lid = parent.dataset.lineId || '';
        // clear UI
        document.querySelectorAll('#renderedCategoryButtons .category-btn').forEach(b => {
          if(b.dataset.lineId === lid){ b.classList.remove('bg-sky-600'); b.classList.remove('text-white'); }
        });
        // if there is a select for same line (unlikely in single-line view) clear it
        const sel = document.querySelector('select.expense-category[data-line-id="' + lid + '"]');
        if(sel) sel.value = '';
        updateSummaryFromDom();
      });
    });
  }

  // watch hidden input changes (some flows set it programmatically before opening modal)
  let lastSummaryValue = summaryInput ? summaryInput.value : '';
  function pollSummaryInput(){
    const now = summaryInput ? summaryInput.value : '';
    if(now !== lastSummaryValue){
      lastSummaryValue = now;
      // re-render so UI matches new data
      renderSummaryLines();
    }
  }
  let pollTimer = null;
  try {
    pollTimer = setInterval(pollSummaryInput, 250);
    window.addEventListener('beforeunload', ()=> { if(pollTimer) clearInterval(pollTimer); });
  } catch(e){ /* ignore */ }

  // ensure initial render on load (modal might be shown later)
  try { renderSummaryLines(); } catch(e){ console.warn('initial renderSummaryLines failed', e); }

  // also re-render whenever modal is shown (in case show logic sets display later)
  const modal = document.getElementById('summaryModal');
  if(modal){
    // intercept style changes to detect show
    const obs = new MutationObserver(muts => {
      muts.forEach(m => {
        if(m.attributeName === 'style' || m.attributeName === 'class'){
          const disp = window.getComputedStyle(modal).display;
          if(disp !== 'none'){
            // modal visible -> render (ensure DOM inside ready)
            setTimeout(renderSummaryLines, 10);
          }
        }
      });
    });
    try { obs.observe(modal, { attributes: true, attributeFilter:['style','class'] }); } catch(e){ /* ignore */ }
  }

  // expose for debug
  window._renderSummaryLines = renderSummaryLines;
})();
  function persist() {
    summaryInput.value = JSON.stringify(obj || {});
  }

  if (!lines || lines.length === 0) {
    container.innerHTML = '<div class="mt-4 p-3 bg-yellow-50 rounded">Δεν βρέθηκαν γραμμές για αυτό το MARK.</div>';
    persist();
    return;
  }

  if (lines.length > 1) {
    // build table
    const tbl = document.createElement('table');
    tbl.className = 'w-full border-collapse';
    tbl.innerHTML = `<thead class="bg-gray-100 sticky top-0">
      <tr>
        <th class="p-2 border text-left">#</th>
        <th class="p-2 border text-left">ΦΠΑ Κατηγορία</th>
        <th class="p-2 border text-right">Ποσό</th>
        <th class="p-2 border text-right">ΦΠΑ</th>
        <th class="p-2 border text-left">Κατηγορία Εξόδου</th>
      </tr>
    </thead>`;
    const tbody = document.createElement('tbody');
    lines.forEach((ln, idx) => {
      const lid = (ln.id !== undefined) ? String(ln.id) : ('l' + idx);
      const vat_cat = ln.vatCategory || ln.vat_category || ln.vat || '';
      const amt = ln.amount || ln.lineTotal || ln.total || '';
      const vatv = ln.vat || ln.vatRate || '';
      const tr = document.createElement('tr');
      tr.dataset.lineId = lid;
      tr.dataset.vat = vat_cat;
      tr.className = '';
      tr.innerHTML = `
        <td class="p-2 border text-sm text-gray-600">${idx+1}</td>
        <td class="p-2 border break-words">${vat_cat}</td>
        <td class="p-2 border text-right">${amt}</td>
        <td class="p-2 border text-right">${vatv}</td>
        <td class="p-2 border"></td>`;
      // build select
      const td = tr.querySelector('td:last-child');
      const sel = document.createElement('select');
      sel.className = 'expense-category p-1 border rounded w-full';
      sel.dataset.lineId = lid;
      const opt0 = document.createElement('option'); opt0.value = ''; opt0.innerText = '-- επίλεξε --'; sel.appendChild(opt0);
      (window.CUSTOMER_CATEGORIES || []).forEach(c => {
        const o = document.createElement('option'); o.value = c; o.innerText = c;
        if ((ln.category || '') === c) o.selected = true;
        sel.appendChild(o);
      });
      sel.addEventListener('change', function(){
        const val = this.value;
        // find line in obj and update
        const found = (obj.lines || []).find(x => String(x.id || x.line_id || '') === lid);
        if(found) found.category = val;
        persist();
      });
      td.appendChild(sel);
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);
    // wrap in container
    const wrapper = document.createElement('div');
    wrapper.className = 'overflow-auto max-h-96 border rounded';
    wrapper.appendChild(tbl);
    container.appendChild(wrapper);
    persist();
    return;
  }

  // single line case -> render buttons
  const single = lines[0];
  const lid = (single.id !== undefined) ? String(single.id) : (single.line_id !== undefined ? String(single.line_id) : 'l0');
  const amt = single.amount || single.lineTotal || '';
  const vatv = single.vat || single.vatRate || '';
  const vat_cat = single.vatCategory || single.vat_category || '';
  const selected_cat = single.category || '';

  const singleDiv = document.createElement('div');
  singleDiv.id = 'singleLine';
  singleDiv.className = 'border rounded p-4';
  singleDiv.dataset.lineId = lid;
  singleDiv.dataset.amount = amt;
  singleDiv.dataset.vat = vatv;
  singleDiv.dataset.vatcat = vat_cat;

  const infoHtml = document.createElement('div');
  infoHtml.className = 'mb-3 grid grid-cols-1 md:grid-cols-3 gap-3';
  infoHtml.innerHTML = `<div><strong>ΦΠΑ Κατηγορία</strong><div>${vat_cat}</div></div>
                        <div><strong>Ποσό</strong><div>${amt}</div></div>
                        <div><strong>ΦΠΑ</strong><div>${vatv}</div></div>`;
  singleDiv.appendChild(infoHtml);

  const chooseWrap = document.createElement('div');
  chooseWrap.className = 'mb-3';
  chooseWrap.innerHTML = `<strong>Επίλεξε Κατηγορία Εξόδου</strong>`;
  const btnRow = document.createElement('div');
  btnRow.id = 'categoryButtons';
  btnRow.className = 'mt-2 flex flex-wrap gap-2';

  (window.CUSTOMER_CATEGORIES || []).forEach(c => {
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'category-btn px-3 py-2 border rounded hover:bg-sky-50';
    b.dataset.cat = c;
    b.dataset.lineId = lid;
    b.innerText = c;
    if (c === selected_cat) { b.classList.add('bg-sky-600', 'text-white'); }
    b.addEventListener('click', function(){
      const cat = this.dataset.cat;
      // toggle selection
      const currently = (obj.lines[0].category || '');
      obj.lines[0].category = (currently === cat) ? '' : cat;
      // reflect UI
      Array.from(btnRow.querySelectorAll('button.category-btn')).forEach(bb=>{
        bb.classList.toggle('bg-sky-600', bb.dataset.cat === obj.lines[0].category);
        bb.classList.toggle('text-white', bb.dataset.cat === obj.lines[0].category);
      });
      persist();
    });
    btnRow.appendChild(b);
  });

  const clearBtn = document.createElement('button');
  clearBtn.type = 'button';
  clearBtn.id = 'clearCategory';
  clearBtn.className = 'px-3 py-2 border rounded text-sm ml-2';
  clearBtn.innerText = 'Καθαρισμός';
  clearBtn.addEventListener('click', function(){
    obj.lines[0].category = '';
    Array.from(btnRow.querySelectorAll('button.category-btn')).forEach(bb=>{
      bb.classList.remove('bg-sky-600', 'text-white');
    });
    persist();
  });

  btnRow.appendChild(clearBtn);
  chooseWrap.appendChild(btnRow);
  singleDiv.appendChild(chooseWrap);
  container.appendChild(singleDiv);
  persist();
}

/* Call this helper whenever you open the summary modal after you populated summaryJsonInput.
   Examples of call sites are below (where modal.style.display='flex' is set). */


function showFlash(message, type='info', timeout=3000){
  try {
    const container = document.getElementById('clientFlashContainer');
    if(!container) return;
    const el = document.createElement('div');
    el.className = 'mb-2 p-3 rounded shadow text-sm';
    if(type === 'success') el.classList.add('bg-green-50', 'text-green-800');
    else if(type === 'error') el.classList.add('bg-red-50', 'text-red-800');
    else el.classList.add('bg-gray-50', 'text-gray-800');
    el.innerText = message;
    container.appendChild(el);
    setTimeout(()=>{ try{ el.style.opacity='0'; setTimeout(()=>el.remove(), 300); }catch(e){} }, timeout);
  } catch(e){ console.warn('showFlash failed', e); }
}

// Helper API calls
async function apiGetRepeatEntry(vat){
  try {
    const url = '/api/repeat_entry/get' + (vat ? ('?vat=' + encodeURIComponent(vat)) : '');
    const res = await fetch(url, { credentials: 'same-origin' });
    if (!res.ok) return { ok: false };
    return await res.json();
  } catch(e){
    console.warn('apiGetRepeatEntry failed', e);
    return { ok: false };
  }
}
async function apiSaveRepeatEntry(enabled, mapping, vat){
  try {
    const res = await fetch('/api/repeat_entry/save', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'same-origin',
      body: JSON.stringify({ enabled: !!enabled, mapping: mapping || {}, vat: vat || VAT })
    });
    if(!res.ok) {
      const txt = await res.text().catch(()=>null);
      return { ok: false, status: res.status, body: txt };
    }
    return await res.json();
  } catch(e){
    console.warn('apiSaveRepeatEntry failed', e);
    return { ok: false, error: String(e) };
  }
}

function removeForceEditParamFromUrl(){
  try {
    const url = new URL(window.location.href);
    if (url.searchParams.has('force_edit')) {
      url.searchParams.delete('force_edit');
      history.replaceState(null, '', url.pathname + (url.search ? ('?' + url.searchParams.toString()) : '') + url.hash);
    }
  } catch(e){ console.warn('removeForceEditParamFromUrl failed', e); }
}

document.addEventListener('DOMContentLoaded', function(){
  // ---------- DOM references ----------
  const repeatSwitch = document.getElementById('repeatEntrySwitch');
  const editRepeatBtn = document.getElementById('editRepeatMappingBtn');
  const repeatModal = document.getElementById('repeatMappingModal');
  const repeatModalList = document.getElementById('repeatMappingList');
  const repeatModalSave = document.getElementById('repeatModalSave');
  const repeatModalCancel = document.getElementById('repeatModalCancel');
  const repeatModalCloseX = document.getElementById('repeatModalCloseX');
  const summaryInput = document.getElementById('summaryJsonInput'); // may be null
  const saveSummaryForm = document.getElementById('saveSummaryForm');

  // New: receipts switch + url input
  // ---------- Μικρή, local επιδιόρθωση για τα κουμπιά/Select στο modal summary ----------
// ----- Prefill modal fields & categories from summaryJsonInput -----
function prefillSummaryModal(){
  try {
    const input = document.getElementById('summaryJsonInput');
    if(!input) return;
    let data = {};
    try { data = JSON.parse(input.value || '{}'); } catch(e) { data = {}; }

    // Header fields mapping
    const map = {
      mark: 'summaryModalMark',
      AA: 'summary_AA',
      AFM_issuer: 'summary_AFM',
      AFM: 'summary_AFM',
      Name: 'summary_Name',
      issuer_name: 'summary_Name',
      issueDate: 'summary_issueDate',
      type_name: 'summary_type_name',
      totalNetValue: 'summary_totalNetValue',
      totalVatAmount: 'summary_totalVatAmount',
      totalValue: 'summary_totalValue'
    };
    Object.keys(map).forEach(k => {
      const el = document.getElementById(map[k]);
      if(!el) return;
      el.innerText = (data[k] !== undefined && data[k] !== null) ? String(data[k]) : (data[k.toUpperCase()] || '');
    });

    // Ensure container exists
    const container = document.getElementById('summaryLinesContainer') || document;
    const lines = Array.isArray(data.lines) ? data.lines : [];

    // For each line, set select/button states
    lines.forEach(line => {
      const lid = String(line.id || line.line_id || '').trim();
      if(!lid) return;

      // Try to find matching element inside modal (row or singleLine)
      let row = container.querySelector('[data-line-id="'+lid+'"]');
      if(!row){
        // fallback: global lookup
        row = document.querySelector('[data-line-id="'+lid+'"]');
      }
      if(!row) return;

      const cat = line.category || line.cat || '';
      // set select if present
      const sel = row.querySelector('select.expense-category[data-line-id="'+lid+'"]');
      if(sel){
        try { sel.value = cat || ''; } catch(e){ /* ignore */ }
      }
      // set button states if buttons present
      const btns = row.querySelectorAll('.category-btn[data-line-id="'+lid+'"]');
      if(btns && btns.length){
        btns.forEach(b => b.classList.remove('bg-sky-600','text-white'));
        if(cat){
          // try to find exact button
          const esc = (window.CSS && CSS.escape) ? CSS.escape(cat) : cat.replace(/"/g,'\\"');
          const target = row.querySelector('.category-btn[data-line-id="'+lid+'"][data-cat="'+cat+'"]') ||
                         row.querySelector('.category-btn[data-line-id="'+lid+'"][data-cat="'+esc+'"]');
          if(target) target.classList.add('bg-sky-600','text-white');
        }
      }
    });
  } catch(err){
    console.warn('prefillSummaryModal error', err);
  }
}

// Call prefill when modal gets shown by your existing code.
// Find the places where you do: modal.style.display = 'flex' and add prefillSummaryModal().

  (function(){
  // helper: ασφαλής update του hidden json από το DOM
  function updateSummaryFromDom(){
    try {
      const input = document.getElementById('summaryJsonInput');
      if(!input) return;
      let data = {};
      try { data = JSON.parse(input.value || '{}'); } catch(e){ data = {}; }
      data.lines = Array.isArray(data.lines) ? data.lines.slice() : [];

      // For every element that has data-line-id inside the modal container, read category
      const container = document.getElementById('summaryLinesContainer') || document;
      const __seen = new Set();
      container.querySelectorAll('[data-line-id]').forEach(el => {
        const lid = String(el.dataset.lineId || '').trim();
        if(!lid || __seen.has(lid)) return;
        __seen.add(lid);
        // prefer select.expense-category for this lineId (search in container)
        let chosen = '';
        const sel = container.querySelector('select.expense-category[data-line-id="'+lid+'"]');
        if(sel && sel.value) chosen = sel.value;
        else {
          // else look for active category button for that lineId
          const btn = container.querySelector('.category-btn.bg-sky-600[data-line-id="'+lid+'"]');
          if(btn) chosen = btn.dataset.cat || '';
        }
        // find or create line entry
        let found = data.lines.find(x => String(x.id) === lid);
        if(!found){
          found = { id: lid, category: '' };
          data.lines.push(found);
        }
        found.category = chosen || '';
      });

      input.value = JSON.stringify(data);
    } catch(err){
      console.warn('updateSummaryFromDom error', err);
    }
  }

  // only operate inside the modal area to avoid interfering globally
  const container = document.getElementById('summaryLinesContainer');
  if(!container) {
    // fallback: attach to document but remain minimal
    console.warn('summaryLinesContainer not found — fix handlers limitedly');
  }

  // Event delegation: capture clicks on category buttons and selects inside modal
  const targetRoot = container || document;
  // Use capture true so we intercept before other handlers
  targetRoot.addEventListener('click', function(e){
    const btn = e.target.closest && e.target.closest('.category-btn');
    if(btn && (container ? container.contains(btn) : true)){
      // Prevent bubbling to other global handlers that open the receipts-modal
      e.preventDefault();
      e.stopPropagation();

      // ensure it's not treated as a submit (defensive): set type=button if missing
      try { if(btn.tagName === 'BUTTON' && !btn.hasAttribute('type')) btn.setAttribute('type','button'); } catch(_) {}

      // determine line id: prefer dataset, else find closest ancestor with data-line-id
      const lineEl = btn.closest('[data-line-id]');
      const lineId = lineEl ? (lineEl.dataset.lineId || '') : (btn.dataset.lineId || '');

      // Toggle active class for buttons of the same line only
      if(lineId){
        const group = (container || document).querySelectorAll('.category-btn[data-line-id="'+lineId+'"]');
        group.forEach(b => { b.classList.remove('bg-sky-600','text-white'); });
      } else {
        // fallback: toggle only this button
      }
      const isActive = !btn.classList.contains('bg-sky-600');
      if(isActive) btn.classList.add('bg-sky-600','text-white');
      else btn.classList.remove('bg-sky-600','text-white');

      // if there's a select corresponding to this line, keep it in sync
      if(lineId){
        const sel = (container || document).querySelector('select.expense-category[data-line-id="'+lineId+'"]');
        if(sel) sel.value = isActive ? (btn.dataset.cat || '') : '';
      }

      // update hidden JSON immediately
      updateSummaryFromDom();
      return;
    }

    // if clicking on a select inside modal, prevent bubbling too
    const sel = e.target.closest && e.target.closest('select.expense-category');
    if(sel && (container ? container.contains(sel) : true)){
      e.stopPropagation();
      // let change event handle updating (below we also listen change)
      return;
    }
  }, true);

  // Listen change events on selects inside container and update JSON
  (container || document).addEventListener('change', function(e){
    const sel = e.target.closest && e.target.closest('select.expense-category');
    if(sel && (container ? container.contains(sel) : true)){
      e.stopPropagation();
      // sync any visual button states (remove active if select chosen)
      const lid = sel.dataset.lineId || (sel.closest('[data-line-id]') && sel.closest('[data-line-id]').dataset.lineId) || '';
      if(lid){
        // clear buttons for that line
        const group = (container || document).querySelectorAll('.category-btn[data-line-id="'+lid+'"]');
        group.forEach(b => b.classList.remove('bg-sky-600','text-white'));
      }
      updateSummaryFromDom();
    }
  }, true);

  // Ensure Save form updates JSON right before submit (defensive)
  const saveForm = document.getElementById('saveSummaryForm');
  if(saveForm){
    saveForm.addEventListener('submit', function(e){
      try {
        updateSummaryFromDom();
        // small synchronous update only; let the submit continue
      } catch(err){ console.warn('pre-submit update failed', err); }
    });
  }

  // Expose helper in case other code wants to call it
  window.updateSummaryFromDom = updateSummaryFromDom;
})();

  const useReceiptsSwitch = document.getElementById('useReceiptsSwitch');
  useReceiptsSwitch?.addEventListener('change', () => {
  // ποιο όνομα να δείξω στο hint; πάρε την τρέχουσα επιλογή από το select του modal,
  // αλλιώς άφησε κενό => θα εμφανιστεί "Γενικό"
  const name = (document.getElementById('charProfileSelect')?.value || "");
  setActiveProfileHint(name);
});

  // find or create an URL input (if not present in template we create one dynamically)
  let urlInput = document.getElementById('scrapeUrlInput');
  if(!urlInput){
    urlInput = document.createElement('input');
    urlInput.id = 'scrapeUrlInput';
    urlInput.placeholder = 'Εισάγετε URL παραστατικού (για αποδείξεις)';
    urlInput.className = 'p-2 border rounded w-2/4 hidden';
    urlInput.type = 'text';
    // insert after markInput
    const mi = document.getElementById('markInput');
    if(mi && mi.parentElement) mi.parentElement.insertBefore(urlInput, mi.nextSibling);
  }

  // --- ensure search icon behaves same as input clear/submit ---
  (function wireSearchIconBehavior(){
    const mi = document.getElementById('markInput');
    if (!mi) return;

    const possibleSelectors = [
      '.icon-search', '.btn-search', '#searchIcon', '.fa-search', '.magnifier',
      'button[aria-label="search"]', 'button[data-action="search"]'
    ];

    let found = null;
    for (const sel of possibleSelectors) {
      const el = document.querySelector(sel);
      if (el) { found = el; break; }
    }

    if (!found) {
      const delBtn = document.querySelector('button#deleteSelected, button.delete-selected, button[data-action="delete-selected"]');
      if (delBtn && delBtn.parentElement) {
        const sibling = delBtn.parentElement.querySelector('button, a, svg, i');
        if (sibling && sibling !== delBtn) found = sibling;
      }
    }

    if (!found) return;

    found.addEventListener('click', function(e){
      try {
        mi.value = '';
        mi.dispatchEvent(new Event('input', { bubbles: true }));
        mi.dispatchEvent(new KeyboardEvent('keyup', { bubbles: true, key: 'Backspace' }));
        if (window.jQuery && jQuery.fn && jQuery.fn.dataTable) {
          try {
            const dt = $('.summary-table').DataTable();
            dt.search('').columns().search('').draw();
          } catch(ignore){}
        }
      } catch(err){
        console.warn('search icon handler failed', err);
      }
    });
  })();


  // detect vat keys in summary
  function detectVatKeysFromSummary(){
  if(summaryInput && summaryInput.value){
    try {
      const obj = JSON.parse(summaryInput.value || '{}');
      const lines = Array.isArray(obj.lines) ? obj.lines : [];
      const found = new Set();
      lines.forEach(l => {
        const key = (l.vatCategory || l.vat_category || l.vat || '').toString().trim();
        if(key) found.add(key);
      });
      if(found.size) return Array.from(found);
    } catch(e){}
  }
  return ['0%','6%','13%','17%','24%'];
}

      async function getExpenseTagsForVat(vat){
  // 1. Πρώτα από /api/repeat_entry/get (ήταν η παλιά πηγή)
  try{
    const r = await fetch('/api/repeat_entry/get' + (vat?('?vat='+encodeURIComponent(vat)):''),
                          {credentials:'same-origin'});
    const j = await r.json();
    if (j && Array.isArray(j.expense_tags) && j.expense_tags.length) {
      return j.expense_tags.filter(t => t !== 'αποδειξακια'); // όχι στα τιμολόγια
    }
  }catch(_){}

  // 2. Fallback από /api/char_profiles
  try{
    const r = await fetch('/api/char_profiles?vat=' + encodeURIComponent(vat||''), {credentials:'same-origin'});
    const j = await r.json();
    if (j && Array.isArray(j.expense_tags) && j.expense_tags.length) {
      return j.expense_tags.filter(t => t !== 'αποδειξακια');
    }
  }catch(_){}

  // 3. Τελευταίο fallback: SERVER variable / global
  try{
    if (Array.isArray({{ customer_categories|tojson|safe }}) && {{ customer_categories|tojson|safe }}.length){
      return {{ customer_categories|tojson|safe }}.filter(t => t !== 'αποδειξακια');
    }
  }catch(_){}
  if (Array.isArray(window.CUSTOMER_CATEGORIES) && window.CUSTOMER_CATEGORIES.length){
    return window.CUSTOMER_CATEGORIES.filter(t => t !== 'αποδειξακια');
  }
  return [];
}
  // Build repeat modal UI given an existing mapping (object)
  

// αντικατάσταση της παλιάς openRepeatModalWithMapping
function openRepeatModalWithMapping(mapping){
  // πέρασε το mapping ως override στο νέο renderer
  window._repeatMappingOverride = mapping ? mapping : null;
  // άνοιξε το modal από τον ενιαίο renderer
  if (typeof window.openRepeatModal === 'function') {
    window.openRepeatModal();
  }
}
  function closeRepeatModal(){ repeatModal.style.display = 'none'; }

  
// --- normalize VAT γραμμής σε ένα από τα κλειδιά 0/6/13/17/24 ---
function normalizeVatKey(s){
  const t = (s || '').toString().toLowerCase().trim().replace(',', '.');

  // τυπικά patterns που επιστρέφει myDATA / scrapers
  if (/\b17\b|17%|17\.0/.test(t)) return '17%';
  if (/\b24\b|24%|24\.0|κανονικ/.test(t)) return '24%';
  if (/\b13\b|13%|13\.0/.test(t)) return '13%';
  if (/\b6\b|6%|6\.0|μειωμ|reduced/.test(t)) return '6%';
  // 0: μηδενικό, απαλλασσόμενο, χωρίς ΦΠΑ
  if (/\b0\b|0%|0\.0|μηδεν|απαλλ|χωρις|χωρίς|exempt|no\s*vat/.test(t)) return '0%';

  return ''; // άγνωστο -> θα αφήσει το modal ανοιχτό
}

// --- εφαρμογή του ενεργού mapping στις γραμμές + auto submit ---
function applyMappingToSummaryAndSubmitUsingMapping(mapping){
  const input = document.getElementById('summaryJsonInput');
  const form  = document.getElementById('saveSummaryForm');
  if (!input || !form) return false;

  let obj;
  try { obj = JSON.parse(input.value || '{}'); } catch(e){ obj = {}; }
  const lines = Array.isArray(obj.lines) ? obj.lines : [];
  if (!lines.length) return false;

  // Βεβαιώσου ότι έχουμε όλα τα κλειδιά ποσοστών
  const M = Object.assign(
    {"0%":"","6%":"","13%":"","17%":"","24%":""},
    mapping || {}
  );

  let missing = false;
  lines.forEach((ln, idx) => {
    // αν λείπει id, φτιάξτο για συνέπεια
    if (!ln.id && ln.line_id !== undefined) ln.id = String(ln.line_id);
    if (!ln.id) ln.id = 'l' + idx;

    const rawVat = (ln.vatCategory || ln.vat_category || ln.vat || '').toString();
    const key    = normalizeVatKey(rawVat);
    const cat    = key ? (M[key] || '') : '';

    ln.category = cat;
    if (!cat) missing = true;
  });

  // γράψε πίσω στο hidden input
  input.value = JSON.stringify(obj);

  // Αν λείπουν κατηγορίες -> άστο να φανεί το modal για χειροκίνητα
  if (missing) return false;

  // Προστασία: μην ξανα-γίνει submit δεύτερη φορά
  if (window.__repeat_auto_submitting) return true;
  window.__repeat_auto_submitting = true;

  // Καθάρισε τυχόν πεδία receipts (για να μην μπερδέψουν το submit)
  const u = document.getElementById('scrapeUrlField');
  const c = document.getElementById('scrapeCategoryField');
  const f = document.getElementById('scrapeForceField');
  if (u) u.value = '';
  if (c) c.value = '';
  if (f) f.value = 'false';

  // Κάνε submit στο υπάρχον flow σου
  try { form.submit(); } catch(_) { window.__repeat_auto_submitting = false; return false; }
  return true;
}
  // ---------- Initialization: load server repeat_entry config ----------
  (async function initRepeatEntry(){
    try {
      const resp = await apiGetRepeatEntry(VAT);
      if(resp && resp.ok){
        const repeat = resp.repeat_entry || { enabled: false, mapping: {} };
        if(resp.expense_tags && Array.isArray(resp.expense_tags) && resp.expense_tags.length){
          CUSTOMER_CATEGORIES = resp.expense_tags.slice();
        }
        const enabled = !!repeat.enabled;
        const mapping = repeat.mapping || {};

        if(repeatSwitch){
          repeatSwitch.checked = enabled;
          setActiveProfileHint(enabled ? ((repeat && repeat.profile_name) || "") : "");

          // show edit button if mapping exists and receipts not selected
          if(mapping && Object.keys(mapping).length && !(useReceiptsSwitch && useReceiptsSwitch.checked)) editRepeatBtn.classList.remove('hidden');
          repeatSwitch.addEventListener('change', async function(){
            const now = this.checked;
            // if enabling and no mapping -> open modal to create mapping
            if(now){
              if(!mapping || Object.keys(mapping).length === 0){
                // open modal letting user create mapping (but only if receipts not selected)
                if(useReceiptsSwitch && useReceiptsSwitch.checked){
                  // do not open — receipts use only αποδειξακια
                  editRepeatBtn.classList.add('hidden');
                } else {
                  openRepeatModalWithMapping({});
                }
              } else {
                if(useReceiptsSwitch && useReceiptsSwitch.checked){
                  // receipts + repeat -> hide edit button
                  editRepeatBtn.classList.add('hidden');
                } else {
                  editRepeatBtn.classList.remove('hidden');
                }
              }
            } else {
              editRepeatBtn.classList.add('hidden');
            }
            // Persist enabled flag immediately (keep mapping as-is)
            const saveResp = await apiSaveRepeatEntry(now, mapping, VAT);
            if(saveResp && saveResp.ok){
              showFlash('Ενημερώθηκε η ρύθμιση επαναληπτικής εισαγωγής.', 'success');
              if(saveResp.expense_tags && Array.isArray(saveResp.expense_tags) && saveResp.expense_tags.length){
                CUSTOMER_CATEGORIES = saveResp.expense_tags.slice();
              }
            } else {
              showFlash('Αποτυχία αποθήκευσης ρύθμισης.', 'error');
            }
          });
        }

        // If repeat enabled and mapping exists and modal_summary present -> auto apply mapping now
        if (enabled && mapping && Object.keys(mapping).length && summaryInput) {
        const receiptsOn = !!(useReceiptsSwitch && useReceiptsSwitch.checked);
          if (!receiptsOn && !FORCE_EDIT) {
            const did = applyMappingToSummaryAndSubmitUsingMapping(mapping);
          if (did) {
            const sm = document.getElementById('summaryModal');
          if (sm) sm.style.display = 'none';
      }
    }
  }

        // Wire edit button
        if(editRepeatBtn){
          editRepeatBtn.classList.toggle('hidden', !mapping || Object.keys(mapping).length===0 || (useReceiptsSwitch && useReceiptsSwitch.checked));
          editRepeatBtn.addEventListener('click', function(){
            openRepeatModalWithMapping(mapping);
          });
        }
      } else {
        if(repeatSwitch) repeatSwitch.checked = false;
      }
    } catch(e){
      console.warn('initRepeatEntry failed', e);
    }
  })();

  // wire receipts switch to show/hide url input and to enforce mapping rule
  if(useReceiptsSwitch){
    useReceiptsSwitch.addEventListener('change', function(){
      const on = !!this.checked;
      // UI: swap inputs
      if(on){
        document.getElementById('markInput')?.classList.add('hidden');
        urlInput?.classList.remove('hidden');
        urlInput?.focus();
        // when receipts are active, edit button must be hidden (even if repeat on)
        if(editRepeatBtn) editRepeatBtn.classList.add('hidden');
      } else {
        document.getElementById('markInput')?.classList.remove('hidden');
        urlInput?.classList.add('hidden');
        document.getElementById('markInput')?.focus();
        // restore edit button visibility based on repeatSwitch/mapping
        // re-init repeat button visibility by calling initRepeatEntry lightly:
        (async function(){
          try {
            const resp = await apiGetRepeatEntry(VAT);
            if(resp && resp.ok){
              const mapping = (resp.repeat_entry && resp.repeat_entry.mapping) ? resp.repeat_entry.mapping : {};
              if(mapping && Object.keys(mapping).length && repeatSwitch && repeatSwitch.checked){
                editRepeatBtn.classList.remove('hidden');
              } else {
                editRepeatBtn.classList.add('hidden');
              }
            }
          } catch(e){}
        })();
      }
    });
  }

  // repeat modal handlers
  repeatModalCloseX?.addEventListener('click', closeRepeatModal);
  repeatModalCancel?.addEventListener('click', closeRepeatModal);

  
  // ---------- existing original JS (dismiss banner, force edit, summary modal wiring, etc) ----------
  const forceBtn = document.getElementById('forceEditBtn');
  const markInput = document.getElementById('markInput');
  const existingBanner = document.getElementById('existingBanner');
  const dismissBannerBtn = document.getElementById('dismissBannerBtn');

  if(dismissBannerBtn){
    dismissBannerBtn.addEventListener('click', function(){ if(existingBanner) existingBanner.style.display = 'none'; });
  }

  if (forceBtn){
    forceBtn.addEventListener('click', function(){
      const markValRaw = (markInput && markInput.value) ? markInput.value.trim() : '{{ mark or "" }}';
      const markVal = encodeURIComponent(markValRaw || '');
      if (!markVal){ alert('Δεν δόθηκε MARK για επιβεβαίωση.'); return; }
      if (confirm('Θες σίγουρα να επαναχαρακτηρίσεις το MARK και να ανοίξει η φόρμα επεξεργασίας;')) {
        if(existingBanner) existingBanner.style.display = 'none';
        window.location = SEARCH_BASE_URL + '?mark=' + markVal + '&force_edit=1';
      }
    });
  }

  const modal = document.getElementById('summaryModal');
  const modalCloseBtns = Array.from(document.querySelectorAll('#modalCloseX, #modalCloseBtn'));
  modalCloseBtns.forEach(b => b?.addEventListener('click', function(){
    if(modal) modal.style.display = 'none';
    removeForceEditParamFromUrl();
  }));

  {% if modal_summary and (request.args.get('force_edit') == '1' or not allow_edit_existing) %}
  setTimeout(()=>{
  const m = document.getElementById('summaryModal');
  if (!m) return;

  // Αν είμαστε σε mode αποδείξεων ΚΑΙ είναι ενεργό το repeat, μην ανοίγεις modal
  // ΕΞΑΙΡΕΣΗ: αν είναι reclassification (force_edit=1), τότε άνοιξέ το για να αλλάξουμε χαρακτηρισμούς.
  const receiptsOn = !!(document.getElementById('useReceiptsSwitch') && document.getElementById('useReceiptsSwitch').checked);
  const repeatOn   = !!(document.getElementById('repeatEntrySwitch') && document.getElementById('repeatEntrySwitch').checked);

  // Επιπλέον έλεγχος: αν το summary είναι σαφώς Απόδειξη, αντιμετώπισέ το ως receipts flow
  let isReceiptSummary = false;
  try {
    const raw = (document.getElementById('summaryJsonInput')?.value || '').trim();
    if (raw) {
      const sobj = JSON.parse(raw);
      const tname = (sobj.type_name || sobj.type || '').toString().toLowerCase();
      const cat   = (sobj.category || sobj.characteristic || sobj['χαρακτηρισμός'] || '').toString().toLowerCase();
      isReceiptSummary = !!(sobj.is_receipt || tname.includes('απόδει') || tname.includes('receipt') || cat === 'αποδειξακια');
    }
  } catch(_){}


  if ((receiptsOn || isReceiptSummary) && repeatOn && !FORCE_EDIT) {
    // auto-flow αποδείξεων όταν είναι ενεργό το "Επαναληψιμη εισαγωγή"
    try {
      let raw = (document.getElementById('summaryJsonInput')?.value || '').trim();
      if (!raw || raw === '{}' || raw === 'null') {
        try { raw = JSON.stringify({{ modal_summary | tojson | safe }}); } catch(_) {}
      }
      const sobj = raw ? JSON.parse(raw) : {};
      // Κανονικοποίησε σαν απόδειξη και επιβεβαίωσε μία φορά
      const url = document.getElementById('scrapeUrlInput')?.value || '';
      (async () => {
        try {
          await RC.confirmReceiptOnce(RC.normalizeReceiptSummary(sobj), url);
          // κράτα το mode σε receipts και κάνε hard redirect για καθαρή κατάσταση
          try { localStorage.setItem('useReceiptsSwitch','1'); } catch(_){}
          const base = location.pathname + '?use_receipts=1';
          location.replace(base);
        } catch(e) {
          console.warn('auto-confirm receipt failed', e);
        }
      })();
    } catch(e) { console.warn('auto-flow receipts error', e); }
    return;
  }


  // Αλλιώς, άνοιξέ το κανονικά
  try {
    const summaryInputEl = document.getElementById('summaryJsonInput');
    if (summaryInputEl && (!summaryInputEl.value || summaryInputEl.value === '{}')) {
      summaryInputEl.value = {{ modal_summary | tojson | safe }};
    }
    const obj = JSON.parse(document.getElementById('summaryJsonInput').value || '{}');
    renderSummaryLinesFromObject(obj);
  } catch(e) { console.warn('renderSummaryLinesFromObject error', e); }

  m.style.display = 'flex';
  removeForceEditParamFromUrl();
}, 80);
{% endif %}



  {% if modal_warning %}
  const afmModal = document.getElementById('afmWarningModal');
  const afmModalBtn = document.getElementById('afmModalConfirm');
  if (afmModal && afmModalBtn){
    setTimeout(()=>{ afmModal.style.display = 'flex'; }, 50);
    afmModalBtn.addEventListener('click', function(){ afmModal.style.display = 'none'; });
  }
  {% endif %}

  // --- the rest of your existing summary wiring (no changes) ---
  if (summaryInput){
  try {
    let summaryData = JSON.parse(summaryInput.value || '{}');
    if (!Array.isArray(summaryData.lines)) summaryData.lines = [];
    summaryData.lines = summaryData.lines.map(l => {
      if (!l) return {id:'', description:'', amount:'', vat:'', category:'', vatCategory:''};
      l.id = (l.id!==undefined)?String(l.id):(l.line_id!==undefined?String(l.line_id):'');
      l.category = l.category || l.cat || l.line_category || l['κατηγορία'] || '';
      return l;
    });

    // multi-line selects
    document.querySelectorAll('#linesTableBody tr[data-line-id]').forEach(tr => {
      const lid = String(tr.dataset.lineId || '');
      const sel = tr.querySelector('select.expense-category');
      if (!sel) return;
      let existing = summaryData.lines.find(x => String(x.id) === lid);
      if (!existing){
        existing = {id: lid, category: ''};
        summaryData.lines.push(existing);
      }
      sel.value = existing.category || '';
      sel.addEventListener('change', function(){ existing.category = sel.value; summaryInput.value = JSON.stringify(summaryData); });
    });

    // single-line buttons
    const singleLine = document.getElementById('singleLine');
    if (singleLine){
      const lid = String(singleLine.dataset.lineId || '');
      let existing = summaryData.lines.find(x => String(x.id) === lid);
      if (!existing){
        existing = {id: lid, category: ''};
        summaryData.lines.push(existing);
      }
      const buttons = document.querySelectorAll('#categoryButtons .category-btn');
      function markActive(cat){
        buttons.forEach(b => {
          b.classList.toggle('bg-sky-600', b.dataset.cat === cat);
          b.classList.toggle('text-white', b.dataset.cat === cat);
        });
      }
      if (existing.category) markActive(existing.category);
      buttons.forEach(btn => {
        btn.addEventListener('click', function(){
          const cat = this.dataset.cat;
          existing.category = (existing.category === cat) ? '' : cat;
          markActive(existing.category);
          summaryInput.value = JSON.stringify(summaryData);
        });
      });
      const clearBtn = document.getElementById('clearCategory');
      clearBtn?.addEventListener('click', function(){
        existing.category = '';
        markActive('');
        summaryInput.value = JSON.stringify(summaryData);
      });
    }
    summaryInput.value = JSON.stringify(summaryData);
  } catch(e){
    console.warn('summary JSON parse/normalize error', e);
  }
}


  // --- the table / datatables logic code (kept unchanged) ---
  const hasTable = document.querySelector('.summary-table') !== null;
  if (hasTable){
    const jq = window.jQuery;
    const dtAvail = jq && jq.fn && jq.fn.dataTable;
    if (dtAvail){
      try {
        const dt = $('.summary-table').DataTable({
          paging: true,
          scrollY: '55vh',
          scrollX: true,
          scrollCollapse: true,
          fixedHeader: { header: true, headerOffset: 0 },
          colReorder: true,
          autoWidth: false,
          columnDefs: [{ orderable: false, targets: 0 }]
        });
        if (typeof dt.colResize === 'function') {
          try { dt.colResize({ resizeMode: 'flex' }); } catch(e){ console.warn('colResize failed', e); }
        }
        const globalSearch = document.getElementById('globalSearch');
        if (globalSearch){
          globalSearch.addEventListener('input', function(){ dt.search(this.value).draw(); });
        }
        setTimeout(()=>{ try{ dt.columns.adjust().draw(); }catch(e){} }, 120);
      } catch(e){
        console.warn('DataTables init failed — falling back', e);
      }
    } else {
      const globalSearch = document.getElementById('globalSearch');
      if (globalSearch){
        globalSearch.addEventListener('input', function(){
          const q = this.value.toLowerCase();
          document.querySelectorAll('.summary-table tbody tr').forEach(tr => {
            tr.style.display = tr.textContent.toLowerCase().indexOf(q) !== -1 ? '' : 'none';
          });
        });
      }
    }

    try {
      const anyCheckbox = document.querySelector('input[name="delete_mark"]');
      if (anyCheckbox){
        const firstTh = document.querySelector('.summary-table thead th');
        if (firstTh && !document.getElementById('selectAll')){
          const chk = document.createElement('input');
          chk.type = 'checkbox'; chk.id = 'selectAll'; chk.title = 'Επιλογή όλων';
          chk.style.marginRight = '6px';
          firstTh.prepend(chk);
          chk.addEventListener('change', function(){ document.querySelectorAll('input[name="delete_mark"]').forEach(cb => cb.checked = this.checked); });
        }
        const headers = Array.from(document.querySelectorAll('.summary-table thead th')).map(h => h.innerText.trim().toLowerCase());
        let markIdx = headers.findIndex(h => h.includes('mark'));
        if (markIdx === -1) markIdx = headers.findIndex(h => h.includes('αφμ') || h.includes('afm'));
        if (markIdx >= 0){
          document.querySelectorAll('.summary-table tbody tr').forEach(row => {
            const cb = row.querySelector('input[name="delete_mark"]');
            if (cb){
              const td = row.querySelectorAll('td')[markIdx];
              if (td){
                const v = td.innerText.trim();
                if (v) cb.value = v;
              }
            }
          });
        }
      }
    } catch(e){ console.warn('select-all / mark mapping error', e); }
  }

  // --- new: restore table / reload when markInput cleared ---
  (function wireRobustClearRestore(){
    const mi = (typeof markInput !== 'undefined' && markInput) ? markInput : document.getElementById('markInput');
    if (!mi) return;

    let t = null;
    let lastVal = mi.value || '';

    function restoreAllRowsAndUi(){
      try {
        if (window.jQuery && jQuery.fn && jQuery.fn.dataTable) {
          try {
            const dt = $('.summary-table').DataTable();
            dt.search('').columns().search('').draw();
            try {
              dt.rows().nodes().to$().each(function(){ this.style.display = ''; });
            } catch(e){ /* ignore */ }
            try { dt.columns.adjust().draw(false); } catch(e){ /* ignore */ }
          } catch(e) {
            console.warn('DataTables restore failed, falling back to DOM restore', e);
            document.querySelectorAll('.summary-table tbody tr').forEach(tr => tr.style.display = '');
          }
        } else {
          document.querySelectorAll('.summary-table tbody tr').forEach(tr => tr.style.display = '');
        }

        const selectAll = document.getElementById('selectAll') || document.querySelector('.summary-table thead input[type="checkbox"]#selectAll');
        if (selectAll) selectAll.checked = false;

        const evt = new Event('tableRestored');
        document.querySelectorAll('.summary-table').forEach(t => t.dispatchEvent(evt));
      } catch(err){
        console.warn('restoreAllRowsAndUi failed', err);
      }
    }


document.addEventListener('DOMContentLoaded', function(){
  try {
    const m = document.getElementById('summaryModal');
    if(m && (m.style.display === 'flex' || getComputedStyle(m).display !== 'none')){
      // small timeout to let template-rendered inner HTML settle
      setTimeout(()=>{ try { prefillSummaryModal(); } catch(e){ console.warn(e); } }, 40);
    }
  } catch(e){ /* ignore */ }
});
    function maybeRestore(){
      clearTimeout(t);
      t = setTimeout(()=>{
        try {
          const v = (mi.value || '').trim();
          if (v === '' && (lastVal && lastVal.trim() !== '')) {
            try {
              if (typeof INITIAL_MARK !== 'undefined' && INITIAL_MARK && INITIAL_MARK.trim() !== '') {
                const cur = new URL(window.location.href);
                if (cur.searchParams.has('mark') || cur.searchParams.has('force_edit')) {
                  window.location = SEARCH_BASE_URL;
                  return;
                }
              }
            } catch(e){ /* ignore URL errors and fallthrough to client restore */ }

            restoreAllRowsAndUi();
          }
          lastVal = v;
        } catch(e){
          console.warn(e);
        }
      }, 150);
    }

    mi.addEventListener('input', maybeRestore);
    mi.addEventListener('keyup', maybeRestore);
    mi.addEventListener('paste', function(){ setTimeout(maybeRestore, 50); });
    mi.addEventListener('cut', function(){ setTimeout(maybeRestore, 50); });
    mi.addEventListener('blur', maybeRestore);

    let pollInterval = null;
    try {
      pollInterval = setInterval(() => {
        const current = (mi.value || '').trim();
        if (current !== (lastVal || '').trim()) {
          maybeRestore();
        }
      }, 300);

      window.addEventListener('beforeunload', () => {
        if (pollInterval) clearInterval(pollInterval);
      });
    } catch(e){
    }
  })();

  // ----- SCRAPER integration: auto call endpoint when URL provided and show modal -----
  // Add a handler: when receipts switch ON and user submits form -> call /api/scrape_receipt and show modal
  // ====================== RECEIPTS SCRAPE FLOW ======================
document.getElementById('markSearchForm')?.addEventListener('submit', async function (evt) {
  if (useReceiptsSwitch && useReceiptsSwitch.checked) {

    // --- de-dupe receipts submit (scrape) ---
    // --- de-dupe receipts submit (scrape) ---
  const form = evt.currentTarget;
  if (form && form.dataset.receiptsSubmitting === '1') {
    evt.preventDefault();
    return;
  }
  if (form) form.dataset.receiptsSubmitting = '';
  if (form) form.dataset.receiptsSubmitting = '1';

evt.preventDefault();
    const url = (urlInput && urlInput.value) ? urlInput.value.trim() : '';
    if (!url) {
      showFlash('Εισάγετε URL για αποδείξεις.', 'error');
      return;
    }

    try {
      const res = await fetch('/api/scrape_receipt', {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        body: JSON.stringify({ url: url })
      });

      const j = await res.json().catch(() => null);
      if (!res.ok || !j || j.ok === false) {
        const msg = j && (j.error || j.message) ? (j.error || j.message) : ('Server ' + (res.status || ''));
        showFlash('Σφάλμα scraper: ' + msg, 'error', 6000);
        return;
      }

      if (j && j.is_invoice === true) {
  openReceiptWarning('Το URL φαίνεται να περιέχει Τιμολόγιο — δεν θα αποθηκευτεί ως Απόδειξη. Έλεγξε το παραστατικό.');
  return; // STOP
        }
        // ---- Έλεγχος έτους απόδειξης vs ενεργή χρήση (modal + STOP)
try {
  // 1) Πάρε ενεργή χρήση από ACTIVE_YEAR ή από το backend (fallback)
  const activeYear = await getActiveFiscalYear();

  // 2) Εξήγαγε issueYear από την απόκριση του scraper
  let issueYear = null;
  if (j && j.issue_year != null && String(j.issue_year).trim() !== '') {
    // δέξου είτε καθαρό έτος είτε π.χ. "2025"
    const m = String(j.issue_year).match(/\b(19|20)\d{2}\b/);
    issueYear = m ? m[0] : String(j.issue_year);
  } else if (j) {
    const anyDate = j.issue_date || j.issueDate || j.date || '';
    if (typeof anyDate === 'string') {
      const m = anyDate.match(/\b(19|20)\d{2}\b/);
      if (m) issueYear = m[0];
    }
  }

  // 3) Αν δεν ταιριάζουν -> δείξε modal και σταμάτα
  if (activeYear && issueYear && String(issueYear) !== String(activeYear)) {
    openReceiptWarning(`Προσοχή: Η απόδειξη είναι του ${issueYear}, ενώ η ενεργή χρήση είναι ${activeYear}. Η διαδικασία μπλοκάρεται.`);
    return; // STOP
  }
} catch (_) {
  /* αν αποτύχει ο έλεγχος, δεν μπλοκάρουμε σιωπηλά */
}


      // Δημιουργία αυξανόμενου MARK 15 ψηφίων (από το backend)
      const markRes = await fetch('/api/next_receipt_mark', { credentials: 'same-origin' });
      const markData = await markRes.json().catch(() => null);
      const nextMark = (markData && markData.mark) ? markData.mark : '';

      // Prepare summary object για modal
      const summaryObj = {
        mark: nextMark,
        AA: j.progressive_aa || '',
        AFM_issuer: j.issuer_vat || '',
        Name: j.issuer_name || '',
        issueDate: j.issue_date || '',
        type_name: 'ΑΠΟΔΕΙΞΗ',
        totalValue: j.total_amount || '',
        totalNetValue: j.total_amount || '',
        totalVatAmount: (j.raw && (j.raw.totalVatAmount || j.raw.totalVat)) || '',
        lines: []
      ,
  type: 'ΑΠΟΔΕΙΞΗ',
  category: 'αποδειξακια',
  is_receipt: true,
  number: (j.progressive_aa || '')};

      if (j.raw && Array.isArray(j.raw.lines) && j.raw.lines.length) {
        j.raw.lines.forEach((l, idx) => {
          summaryObj.lines.push({
            id: l.id || ('r' + idx),
            amount: l.amount || l.lineTotal || '',
            vat: l.vat || l.vatRate || '',
            vatCategory: l.vatCategory || l.vat_category || '',
            description: l.description || l.desc || ''
          });
        });
      } else {
        summaryObj.lines.push({
          id: 'r0',
          amount: j.total_amount || '',
          vat: (j.raw && (j.raw.vat || '')) || '',
          vatCategory: (j.raw && (j.raw.vatCategory || '')) || '',
          description: (j.raw && (j.raw.description || '')) || ''
        });
      }

      // Populate modal inputs
      const summaryInput = document.getElementById('summaryJsonInput');
      if (summaryInput) summaryInput.value = JSON.stringify(summaryObj);


      document.getElementById('scrapeUrlField')?.setAttribute('value', url);
      const desiredCat = CUSTOMER_CATEGORIES.includes('αποδειξακια')
        ? 'αποδειξακια'
        : (CUSTOMER_CATEGORIES[0] || '');
      document.getElementById('scrapeCategoryField')?.setAttribute('value', desiredCat);
      document.getElementById('scrapeForceField')?.setAttribute('value', 'false');

      // Ενημέρωση modal
      const modal = document.getElementById('summaryModal');
      if (modal) {
        // ensure populate code runs (some populate watchers poll or listen for modal display)
        // prefer calling RC_forcePopulateSummaryModal if present
        if (window.RC_forcePopulateSummaryModal) {
          try { window.RC_forcePopulateSummaryModal(); } catch(e){ console.warn('RC_forcePopulateSummaryModal failed', e); }
        }
        if (!(window.__RC_FLAGS && window.__RC_FLAGS.autoHandled)) { modal.style.display = 'flex'; }
        if (!(window.__RC_FLAGS && window.__RC_FLAGS.autoHandled)) { showFlash('Λήφθηκε απόδειξη — ελέγξτε τα στοιχεία και πατήστε "Αποθήκευση στο Cache".', 'success', 5000); }
      }

    } catch (err) {
      console.error('scrape_receipt error', err);
      showFlash('Σφάλμα scraper: ' + (err.message || err), 'error', 6000);
    }
  }
});


  // Intercept "Αποθήκευση στο Cache" to perform AJAX save for scraped receipts
  // intercept saveSummaryForm submit when scrapeUrlField is present
// --- replace the previous payload construction + fetch with this robust version ---
document.getElementById('saveSummaryForm')?.addEventListener('submit', async function(e){
  const scrapeUrl = document.getElementById('scrapeUrlField')?.value || '';
  if(!scrapeUrl) return; // let normal (invoice) flow proceed
  e.preventDefault();

  let summary = {};
  try {
    summary = JSON.parse(document.getElementById('summaryJsonInput').value || '{}');
  } catch(err){
    console.warn('Failed parsing summaryJsonInput', err);
    alert('Σφάλμα: άκυρα δεδομένα παραστατικού.');
    return;
  }

  summary.is_receipt = true;
  if (!summary.category || String(summary.category).trim() === '') summary.category = 'αποδειξακια';
  if (!summary.type || String(summary.type).trim() === '') summary.type = 'ΑΠΟΔΕΙΞΗ';
  if (!summary.type_name || String(summary.type_name).trim() === '') summary.type_name = 'Απόδειξη';

  const aaCoalesce = summary.number || summary.AA || summary.aa || summary.progressive_aa || '';
  summary.number = aaCoalesce;

  if (!Array.isArray(summary.lines)) summary.lines = [];
  summary.lines = summary.lines.map((l, i) => ({
    id: (l && (l.id || l.line_id)) ? String(l.id || l.line_id) : ('r' + i),
    description: (l && (l.description || l.desc)) || '',
    amount: (l && (l.amount || l.lineTotal || l.total)) || '',
    vat: (l && (l.vat || l.vatRate)) || '',
    vatCategory: (l && (l.vatCategory || l.vat_category)) || '',
    category: (l && l.category) || ''
  }));

  try {
    const res = await fetch('/save_summary', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
      body: JSON.stringify(summary)
    });
    if (!res.ok) {
      const t = await res.text().catch(()=>'');
      alert('Αποτυχία αποθήκευσης (HTTP ' + res.status + '): ' + t);
      return;
    }
    try { document.getElementById('summaryModal').style.display = 'none'; } catch(_) {}
    window.location = window.location.pathname;
  } catch (err) {
    console.error('save_summary AJAX error', err);
    alert('Σφάλμα αποθήκευσης: ' + (err.message || err));
  }
});

document.getElementById('saveSummaryForm')?.addEventListener('submit', async function(e){
  const scrapeUrl = document.getElementById('scrapeUrlField')?.value || '';
  if(!scrapeUrl) return; // allow normal server flow for invoice flow
  e.preventDefault();

  // parse summary from hidden input
  let summary = {};
  try {
    summary = JSON.parse(document.getElementById('summaryJsonInput').value || '{}');
  } catch(err){
    console.warn('Failed parsing summaryJsonInput', err);
    showFlash('Σφάλμα: άκυρα δεδομένα παραστατικού.', 'error');
    return;
  }

  // robust AFM extraction (try many variants)
  const afmFromSummary = (summary && (summary.AFM_issuer || summary.AFM || summary.issuer_vat || summary.issuerVat || summary.issuer_vat)) ||
                         (summary && summary.raw && (summary.raw.issuer_vat || summary.raw.issuerVat || summary.raw.AFM || summary.raw.AFM_issuer));
  const afmVal = (typeof VAT !== 'undefined' && VAT) ? VAT : (afmFromSummary ? String(afmFromSummary).trim() : '');

  // robust year extraction: prefer ACTIVE_YEAR, then summary.year, then parse issueDate, then fallback to current year
  let yearVal = null;
  try {
    if (typeof ACTIVE_YEAR !== 'undefined' && ACTIVE_YEAR) yearVal = String(ACTIVE_YEAR);
    else if (summary && (summary.year || summary.Year)) yearVal = String(summary.year || summary.Year);
    else if (summary && summary.issueDate) {
      const parts = (summary.issueDate || '').split('/');
      if (parts.length >= 3) yearVal = parts[2];
    }
    if (!yearVal) yearVal = String((new Date()).getUTCFullYear());
  } catch(e){
    yearVal = String((new Date()).getUTCFullYear());
  }

  // final mark
  const markVal = summary.mark || document.getElementById('scrapeUrlField')?.dataset.mark || '';

  // if afm missing -> abort with client message (server requires AFM or active session)
  if (!afmVal) {
    console.warn('confirm_receipt abort: missing AFM', { summary });
    showFlash('Αδύνατο να αποθηκευτεί: λείπει AFM του ενεργού πελάτη. Επιλέξτε ενεργό πελάτη ή βεβαιωθείτε ότι το παραστατικό περιέχει ΑΦΜ.', 'error', 7000);
    return;
  }

  const payload = {
    url: scrapeUrl,
    summary: summary,
    force: (document.getElementById('scrapeForceField')?.value === 'true'),
    category: 'αποδειξακια',
    afm: afmVal,
    year: String(yearVal),
    mark: (summary.mark || markVal || '')
  };

  console.log('[RC-DEBUG] FETCH -> /api/confirm_receipt called', '/api/confirm_receipt', payload);

  // send to backend
  try {
    const res = await fetch('/api/confirm_receipt', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest'},
      body: JSON.stringify(payload)
    });
    const j = await res.json().catch(()=>null);
    if(!res.ok || !j || !j.ok){
      console.warn('confirm_receipt failed', res.status, j);
      showFlash('Σφάλμα αποθήκευσης: ' + ((j && j.error) ? j.error : ('Server ' + (res.status || ''))) , 'error', 7000);
      return;
    }
    showFlash('Αποθηκεύτηκε η απόδειξη (excel + json).', 'success');
    document.getElementById('summaryModal').style.display = 'none';
    // clean hidden fields
    document.getElementById('scrapeUrlField').value = '';
    document.getElementById('scrapeForceField').value = 'false';
  } catch(err){
    console.error('confirm_receipt fetch error', err);
    showFlash('Σφάλμα δικτύου κατά την αποθήκευση.', 'error');
  }
});

// --- Fix: on page load, populate modal if summaryJsonInput already contains summary JSON ---
// This replaces a missing populateSummaryModal call and uses the populate watcher (RC_forcePopulateSummaryModal) if available.
// Robust startup: only show summary modal if summaryJsonInput actually contains meaningful data
document.addEventListener("DOMContentLoaded", function(){
  try {
    const summaryEl = document.getElementById("summaryJsonInput");
    const modal = document.getElementById("summaryModal");
    if (!summaryEl) return;

    let obj = {};
    try { obj = JSON.parse(summaryEl.value || '{}'); } catch(e){ obj = {}; }

    function isMeaningful(o){
      if (!o || typeof o !== 'object') return false;

      // quick acceptors: important single fields
      const important = ['mark','MARK','AFM_issuer','AFM','totalValue','totalNetValue','total_amount','issueDate','issue_date','progressive_aa','AA'];
      for (const k of important) {
        if (o[k] !== undefined && o[k] !== null && String(o[k]).trim() !== '') return true;
      }

      // if lines array exists and has at least one line with some non-empty field -> accept
      if (Array.isArray(o.lines) && o.lines.length) {
        for (const ln of o.lines) {
          if (!ln) continue;
          if ( (ln.description && String(ln.description).trim() !== '') ||
               (ln.amount && String(ln.amount).trim() !== '') ||
               (ln.id && String(ln.id).trim() !== '') ) return true;
        }
      }

      // fallback: if object has more than one non-empty key -> accept
      const nonEmptyKeys = Object.keys(o).filter(k => {
        try { return o[k] !== null && o[k] !== undefined && String(o[k]).trim() !== ''; } catch(e){ return false; }
      });
      if (nonEmptyKeys.length > 1) return true;

      return false;
    }

    if (isMeaningful(obj)) {
      // ask the populate watcher to run (if available), else run a safe local populate
      if (window.RC_forcePopulateSummaryModal) {
        try { window.RC_forcePopulateSummaryModal(); } catch(e){ console.warn('RC_forcePopulateSummaryModal failed', e); }
      } else {
        // try to populate basic fields if populate function not present
        try {
          if (typeof populateSummaryModal === 'function') try { populateSummaryModal(obj); } catch(_) {}
        } catch(_) {}
      }

      if (modal) if (!(window.__RC_FLAGS && window.__RC_FLAGS.autoHandled)) { modal.style.display = 'flex'; }
    } else {
      // ensure modal remains hidden on load
      if (modal) modal.style.display = 'none';
    }
  } catch(e){
    console.warn('startup populate summary failed', e);
  }
});



  // This expects rows to have 'input[type="radio"][name="active_name"]' and row id pattern cred-row-<name>
  document.querySelectorAll('tr[id^="cred-row-"]').forEach(tr=>{
    tr.addEventListener('dblclick', function(e){
      try {
        const radio = tr.querySelector('input[type="radio"][name="active_name"]');
        if(radio){
          radio.checked = true;
          // also give visual feedback (optional)
          tr.classList.add('bg-gray-100');
          setTimeout(()=>tr.classList.remove('bg-gray-100'), 600);
        }
      } catch(err){ console.warn('dblclick select radio failed', err); }
    });
  });

});

// διαβάζει το mapping από τα 5 select του modal
function readMappingFromUI(){
  const out = {};
  document.querySelectorAll('#repeatMappingList select[data-vat]').forEach(sel=>{
    out[sel.dataset.vat] = sel.value || '';
  });
  return out;
}

async function saveRepeatModal(){
  const mapping = readMappingFromUI();
  const NEED = ["0%","6%","13%","17%","24%"];
  const missing = NEED.filter(k => !mapping[k]);
  const hint = document.getElementById('charMissingHint');
  if (missing.length){
    if(hint){ hint.style.display=''; hint.textContent = 'Συμπλήρωσε κατηγορία για: ' + missing.join(', '); }
    return;
  }

  const sel = document.getElementById('charProfileSelect');
  const profileName = sel && sel.value ? sel.value : "";

  const res = await fetch('/api/repeat_entry/save', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'same-origin',
    body: JSON.stringify({
      vat: VAT,
      enabled: true,
      mapping,
      profile_name: profileName
    })
  });

  const j = await res.json().catch(()=>null);
  if(!j || !j.ok){
    if(hint){ hint.style.display=''; hint.textContent = (j && j.error) ? j.error : 'Αποτυχία αποθήκευσης ρυθμίσεων επαναληπτικής εισαγωγής.'; }
    return;
  }

  // Μήνυμα επιτυχίας
  alert('Ενημερώθηκε η ρύθμιση επαναληπτικής εισαγωγής.');

  // Κλείσε modal
  document.getElementById('repeatMappingModal').style.display = 'none';

  // Αναγραφή ενεργού προφίλ επάνω από το toggle
  const activeName = j.repeat_entry?.profile_name || profileName || "";
  setActiveProfileHint(activeName);
  const sw = document.getElementById('repeatEntrySwitch');
  if (sw) sw.checked = true;
}

document.getElementById('repeatModalSave')?.addEventListener('click', async ()=>{
  const listBox = document.getElementById('repeatMappingList');
  const hint = document.getElementById('charMissingHint');
  const sel  = document.getElementById('charProfileSelect');
  const VAT  = "{{ vat or '' }}";

  // διάβασμα mapping από UI
  const out = {};
  const missing = [];
  listBox.querySelectorAll('select[data-vat]').forEach(sel=>{
    const k = sel.dataset.vat;
    const v = (sel.value || '').trim();
    if(!v) missing.push(k);
    out[k] = v;
  });
  if(missing.length){
    hint.style.display = '';
    hint.textContent = 'Συμπλήρωσε κατηγορία για: ' + missing.join(', ');
    return;
  }
  hint.style.display = 'none'; hint.textContent = '';

  const chosenName = (sel && sel.value) ? sel.value : "";

  // αποθήκευση
  try{
    const res = await fetch('/api/repeat_entry/save', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      credentials: 'same-origin',
      body: JSON.stringify({
        vat: VAT,
        enabled: true,
        mapping: out,              // πάντα 0/6/13/17/24
        profile_name: chosenName   // ζητάμε να το σώσει
      })
    });
    const j = await res.json();
    if(!res.ok || !j.ok){
      const msg = j && j.error ? j.error : 'Αποτυχία αποθήκευσης ρυθμίσεων επαναληπτικής εισαγωγής.';
      hint.style.display = ''; hint.textContent = msg;
      return;
    }

    // κλείσιμο modal
    document.getElementById('repeatMappingModal').style.display = 'none';

    // ενημέρωση hint επάνω από το toggle
    const activeName = (j.repeat_entry && j.repeat_entry.profile_name) || chosenName || "";
    setActiveProfileHint(activeName);

    // μικρό success toast
    if (typeof showFlash === 'function') showFlash('Ενημερώθηκε η ρύθμιση επαναληπτικής εισαγωγής.', 'success');

    // fallback επιμονής επιλογής (αν για οποιονδήποτε λόγο δεν σωθεί server-side)
    try { localStorage.setItem('repeatProfile:'+VAT, activeName); } catch(_){}
  }catch(e){
    hint.style.display=''; hint.textContent='Δικτυακό σφάλμα.';
  }
});
// === DEBUG SNIPPET: paste near end of your existing scripts ===
(function(){
  function safeLog(...a){ try{ console.log('[RC-DEBUG]', ...a); }catch(e){} }

  // Global JS error catcher
  window.addEventListener('error', function(e){
    safeLog('Window error', e.message, e.filename + ':' + e.lineno, e.error);
  });
  window.addEventListener('unhandledrejection', function(ev){
    safeLog('Unhandled promise rejection', ev.reason);
  });

  // Watch important DOM elements existence
  function checkDom(){
    const names = [
      'markSearchForm','useReceiptsSwitch','scrapeUrlInput',
      'summaryModal','summaryJsonInput','saveSummaryForm',
      'scrapeUrlField','scrapeCategoryField','scrapeForceField'
    ];
    const out = {};
    names.forEach(n => out[n] = !!document.getElementById(n));
    safeLog('DOM presence', out);
  }
  document.addEventListener('DOMContentLoaded', function(){ checkDom(); });

  // Hook markSearchForm submit
  const msf = document.getElementById('markSearchForm');
  if(msf){
    msf.addEventListener('submit', function(e){
      try{
        const useReceipts = !!(document.getElementById('useReceiptsSwitch') && document.getElementById('useReceiptsSwitch').checked);
        safeLog('markSearchForm.submit fired', 'useReceipts=', useReceipts, 'mark=', (document.getElementById('markInput')?.value||''), 'urlInput=', (document.getElementById('scrapeUrlInput')?.value||''));
      }catch(err){ safeLog('submit hook error', err); }
    }, true);
  } else safeLog('markSearchForm NOT FOUND');

  // Hook receipts switch changes
  const rs = document.getElementById('useReceiptsSwitch');
  if(rs){
    rs.addEventListener('change', function(e){
      safeLog('useReceiptsSwitch change, checked=', rs.checked);
      // show/hide created url input for visibility
      const ui = document.getElementById('scrapeUrlInput');
      if(ui) ui.style.outline = rs.checked ? '2px solid orange' : 'none';
    });
  } else safeLog('useReceiptsSwitch NOT FOUND');

  // Monitor fetch to /api/scrape_receipt by wrapping fetch (only for debugging)
  const origFetch = window.fetch;
  window.fetch = async function(resource, init){
    try{
      if(typeof resource === 'string' && resource.indexOf('/api/scrape_receipt') !== -1){
        safeLog('FETCH -> /api/scrape_receipt called', resource, init && init.body ? (init.body.length>100 ? init.body.slice(0,100)+'...' : init.body) : init);
      }
      if(typeof resource === 'string' && resource.indexOf('/api/confirm_receipt') !== -1){
        safeLog('FETCH -> /api/confirm_receipt called', resource, init && init.body ? (function(){ try { return JSON.parse(init.body); } catch(e){ return init.body; } })() : init);
        // Visual cue: flash border on modal
        const m = document.getElementById('summaryModal');
        if(m) { m.style.outline = '4px dashed lime'; setTimeout(()=>{ if(m) m.style.outline=''; }, 1200); }
      }
    }catch(e){ safeLog('fetch-wrap log failed', e); }
    return origFetch.apply(this, arguments);
  };

  // Hook the saveSummaryForm submit (the interceptor should already exist in your code)
  const ssf = document.getElementById('saveSummaryForm');
  if(ssf){
    ssf.addEventListener('submit', function(e){
      try{
        // show current fields
        const summaryVal = (document.getElementById('summaryJsonInput')?.value) || null;
        const scrapeUrl = document.getElementById('scrapeUrlField')?.value || null;
        const scrapeCat = document.getElementById('scrapeCategoryField')?.value || null;
        const scrapeForce = document.getElementById('scrapeForceField')?.value || null;
        safeLog('saveSummaryForm.submit (intercept) summaryPresent=', !!summaryVal, 'scrapeUrl=', scrapeUrl, 'scrapeCat=', scrapeCat, 'scrapeForce=', scrapeForce);
        // also pretty-print JSON if small
        if(summaryVal){
          try { safeLog('summary JSON', JSON.parse(summaryVal)); } catch(e){ safeLog('summary raw', summaryVal.slice(0,500)); }
        }
      }catch(err){ safeLog('saveSummaryForm submit hook error', err); }
    }, true);
  } else safeLog('saveSummaryForm NOT FOUND');

  // When modal is shown/hidden, log it
  const observer = new MutationObserver(function(muts){
    try{
      const modal = document.getElementById('summaryModal');
      if(modal){
        const style = window.getComputedStyle(modal);
        if(style.display !== 'none'){
          safeLog('summaryModal is visible');
        } else {
          // optional: safeLog('summaryModal is hidden');
        }
      }
    }catch(e){ safeLog('mutation observer err', e); }
  });
  observer.observe(document.documentElement || document.body, { attributes: true, childList: true, subtree: true });

  // Periodic sanity check: print whether modal and form are present every 2s for 6 checks
  let checks = 0;
  const interval = setInterval(function(){
    checks++;
    const present = {
      modal: !!document.getElementById('summaryModal'),
      summaryInput: !!document.getElementById('summaryJsonInput'),
      saveForm: !!document.getElementById('saveSummaryForm'),
      urlField: !!document.getElementById('scrapeUrlField')
    };
    safeLog('periodic-dom-check', present);
    if(checks>6) clearInterval(interval);
  }, 2000);

  safeLog('RC-DEBUG injected');
})();
(function(){
  function getSummaryData(){
    const input = document.getElementById('summaryJsonInput');
    if(!input) return null;
    try {
      const data = JSON.parse(input.value || '{}');
      if(!Array.isArray(data.lines)) data.lines = [];
      return { input, data };
    } catch(e) {
      return { input, data: { lines: [] } };
    }
  }

  function saveSummaryData(obj){
    if(!obj || !obj.input) return;
    obj.input.value = JSON.stringify(obj.data);
  }

  // Click on category buttons (delegation)
  document.addEventListener('click', function(ev){
    const btn = ev.target.closest && ev.target.closest('.category-btn');
    if(!btn) return;
    ev.preventDefault();
    // prevent other handlers (the "other modal" that opened)
    try { ev.stopImmediatePropagation(); } catch(e){}
    try { ev.stopPropagation(); } catch(e){}

    const lid = btn.dataset.lineId || (btn.closest('[data-line-id]') && btn.closest('[data-line-id]').dataset.lineId) || '';
    const cat = btn.dataset.cat || '';
    if(!lid) return;

    const state = getSummaryData();
    if(!state) return;
    let { data } = state;
    let line = data.lines.find(l => String(l.id || l.line_id || '') === String(lid));
    if(!line){
      line = { id: lid, category: '' };
      data.lines.push(line);
    }

    // toggle: if already set -> clear, else set
    line.category = (String(line.category || '') === String(cat)) ? '' : String(cat);

    // update button classes for that line
    document.querySelectorAll('.category-btn[data-line-id="'+CSSescape(lid)+'"]').forEach(b=>{
      b.classList.toggle('bg-sky-600', (b.dataset.cat === line.category));
      b.classList.toggle('text-white', (b.dataset.cat === line.category));
    });

    // also update corresponding select if present
    const sel = document.querySelector('select.expense-category[data-line-id="'+CSSescape(lid)+'"]');
    if(sel) try { sel.value = line.category || ''; } catch(e){}

    saveSummaryData(state);
  }, true);

  // change on line-selects
  document.addEventListener('change', function(ev){
    const sel = ev.target;
    if(!sel || !sel.matches || !sel.matches('select.expense-category')) return;
    const lid = sel.dataset.lineId || (sel.closest('[data-line-id]') && sel.closest('[data-line-id]').dataset.lineId) || '';
    if(!lid) return;
    const state = getSummaryData();
    if(!state) return;
    let { data } = state;
    let line = data.lines.find(l => String(l.id || l.line_id || '') === String(lid));
    if(!line){
      line = { id: lid, category: '' };
      data.lines.push(line);
    }
    line.category = String(sel.value || '');
    // update any buttons
    document.querySelectorAll('.category-btn[data-line-id="'+CSSescape(lid)+'"]').forEach(b=>{
      b.classList.toggle('bg-sky-600', (b.dataset.cat === line.category));
      b.classList.toggle('text-white', (b.dataset.cat === line.category));
    });
    saveSummaryData(state);
  }, true);

  // clear button (if exists)
  document.addEventListener('click', function(ev){
    const cb = ev.target.closest && ev.target.closest('#clearCategory');
    if(!cb) return;
    ev.preventDefault();
    try { ev.stopImmediatePropagation(); } catch(e){}
    const container = cb.closest('[data-line-id]') || document;
    const lid = container && container.dataset && container.dataset.lineId ? container.dataset.lineId : '';
    if(!lid) return;
    const state = getSummaryData();
    if(!state) return;
    let { data } = state;
    let line = data.lines.find(l => String(l.id || l.line_id || '') === String(lid));
    if(!line){
      line = { id: lid, category: '' };
      data.lines.push(line);
    }
    line.category = '';
    // update UI
    document.querySelectorAll('.category-btn[data-line-id="'+CSSescape(lid)+'"]').forEach(b=>{
      b.classList.remove('bg-sky-600','text-white');
    });
    const sel = document.querySelector('select.expense-category[data-line-id="'+CSSescape(lid)+'"]');
    if(sel) sel.value = '';
    saveSummaryData(state);
  }, true);

  // Ensure hidden input is up-to-date before normal form submit
  const saveForm = document.getElementById('saveSummaryForm');
  if(saveForm){
    saveForm.addEventListener('submit', function(ev){
      // just ensure input is stringified (handlers already update it live)
      const s = getSummaryData();
      if(s) saveSummaryData(s);
      // allow normal submit (server-side will persist)
    });
  }

  // small CSS.escape fallback used above
  function CSSescape(s){
    if(window.CSS && CSS.escape) return CSS.escape(s);
    return String(s).replace(/([ #;?%&,.+*~\':"!^$[\]()=>|\/@])/g,'\\$1');
  }
})();

(function RC_AUTO_INJECT_SUMMARY_MODAL(){
  try {
    console.log('[RC-DEBUG] periodic-dom-check starting');

    function exists(id){ return !!document.getElementById(id); }

    const needs = {
      modal: exists('summaryModal'),
      summaryInput: exists('summaryJsonInput'),
      saveForm: exists('saveSummaryForm'),
      urlField: exists('scrapeUrlField')
    };
    console.log('[RC-DEBUG] DOM presence (before inject)', needs);

    if (needs.modal && needs.summaryInput && needs.saveForm) {
      console.log('[RC-DEBUG] All required DOM elements present, no injection needed');
      return;
    }

    // Build modal HTML (minimal, matches server-side expected IDs)
    const modalHtml = `
<div id="summaryModal" class="fixed inset-0 flex items-center justify-center bg-black/40 z-50 overflow-auto p-4" style="display:none;">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Περίληψη Παραστατικού - <span id="summaryModalMark">MARK</span></h3>
      <button id="modalCloseX" class="text-gray-500 text-xl font-bold">✕</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
      <div><strong>Α/Α Παραστατικού</strong><div id="summary_AA"></div></div>
      <div><strong>ΑΦΜ</strong><div id="summary_AFM"></div></div>
      <div><strong>Επωνυμία</strong><div id="summary_Name"></div></div>
      <div><strong>Ημερομηνία</strong><div id="summary_issueDate"></div></div>
      <div><strong>Τύπος Παραστατικού</strong><div id="summary_type_name"></div></div>
      <div><strong>Καθαρή Αξία</strong><div id="summary_totalNetValue"></div></div>
      <div><strong>ΦΠΑ</strong><div id="summary_totalVatAmount"></div></div>
      <div><strong>Σύνολο</strong><div id="summary_totalValue"></div></div>
    </div>

    <h4 class="font-medium mt-4 mb-2">Γραμμές Παραστατικού (για χαρακτηρισμό)</h4>
    <div id="summaryLinesContainer" class="overflow-auto max-h-96 border rounded p-2"></div>

    <div class="mt-4 flex justify-between items-center">
      <div class="text-sm text-gray-600">Σημείωση: οι κατηγορίες προέρχονται από τα settings του πελάτη.</div>
      <div class="flex justify-end gap-2">
        <form method="POST" action="{{ url_for('save_summary') }}" id="saveSummaryForm">
          <input type="hidden" name="summary_json" id="summaryJsonInput" value='{}'>
          <button type="submit" class="bg-sky-600 text-white px-3 py-2 rounded">Αποθήκευση στο Cache</button>
          <input type="hidden" id="scrapeUrlField" name="scrape_url" value="">
          <input type="hidden" id="scrapeCategoryField" name="scrape_category" value="">
          <input type="hidden" id="scrapeForceField" name="scrape_force" value="false">
        </form>
        <button id="modalCloseBtn" class="px-3 py-2 border rounded">Κλείσιμο</button>
      </div>
    </div>
  </div>
</div>`.trim();

    // Inject into document.body
    const wrapper = document.createElement('div');
    wrapper.innerHTML = modalHtml;
    // append at end of body so it does not break layout
    document.body.appendChild(wrapper.firstChild);

    // wire close buttons to hide modal (same behavior as original)
    function hideModal(){
      const m = document.getElementById('summaryModal');
      if (m) m.style.display = 'none';
      try { history.replaceState(null, '', location.pathname + (location.search || '') + location.hash); } catch(e){}
    }
    document.getElementById('modalCloseX')?.addEventListener('click', hideModal);
    document.getElementById('modalCloseBtn')?.addEventListener('click', hideModal);

    // Re-check presence
    const needs_after = {
      modal: exists('summaryModal'),
      summaryInput: exists('summaryJsonInput'),
      saveForm: exists('saveSummaryForm'),
      urlField: exists('scrapeUrlField')
    };
    console.log('[RC-DEBUG] DOM presence (after inject)', needs_after);
    console.log('[RC-DEBUG] Auto-injection done — the client flow should now find the modal and form.');

  } catch (e) {
    console.error('[RC-DEBUG] auto-inject error', e);
  }
})();
(function RC_POPULATE_SUMMARY_MODAL(){
  try {
    console.log('[RC-DEBUG] summary-populate init');

    const summaryInput = document.getElementById('summaryJsonInput');
    const modal = document.getElementById('summaryModal');
    const markEl = document.getElementById('summaryModalMark');
    const aaEl = document.getElementById('summary_AA');
    const afmEl = document.getElementById('summary_AFM');
    const nameEl = document.getElementById('summary_Name');
    const issueEl = document.getElementById('summary_issueDate');
    const typeEl = document.getElementById('summary_type_name');
    const netEl = document.getElementById('summary_totalNetValue');
    const vatEl = document.getElementById('summary_totalVatAmount');
    const totEl = document.getElementById('summary_totalValue');
    const linesContainer = document.getElementById('summaryLinesContainer');

    if (!summaryInput) {
      console.warn('[RC-DEBUG] summaryJsonInput NOT FOUND — modal will not populate');
      return;
    }
    if (!modal) {
      console.warn('[RC-DEBUG] summaryModal NOT FOUND — abort populate watcher');
      return;
    }

    let lastVal = '';
    function safeText(node, v){
      if(!node) return;
      node.textContent = (v === null || v === undefined) ? '' : String(v);
    }

    function renderLines(lines){
      if(!linesContainer) return;
      linesContainer.innerHTML = '';
      if(!Array.isArray(lines) || lines.length === 0){
        const p = document.createElement('div'); p.className = 'p-2 text-sm text-gray-600'; p.textContent = 'Δεν βρέθηκαν γραμμές.';
        linesContainer.appendChild(p);
        return;
      }

      // build a small table
      const tbl = document.createElement('table');
      tbl.className = 'w-full text-sm';
      tbl.style.borderCollapse = 'collapse';
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr><th class="p-1 border text-left">#</th><th class="p-1 border text-left">Περιγραφή</th><th class="p-1 border text-right">Ποσό</th><th class="p-1 border text-right">ΦΠΑ</th></tr>';
      tbl.appendChild(thead);
      const tbody = document.createElement('tbody');
      lines.forEach((ln, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-1 border text-left">${idx+1}</td>
                        <td class="p-1 border text-left">${(ln.description||ln.desc||'').toString().slice(0,200)}</td>
                        <td class="p-1 border text-right">${ln.amount||ln.lineTotal||''}</td>
                        <td class="p-1 border text-right">${ln.vat||ln.vatRate||''}</td>`;
        tbody.appendChild(tr);
      });
      tbl.appendChild(tbody);
      linesContainer.appendChild(tbl);
    }

    function populateOnce(){
      try {
        const v = (summaryInput.value || '').trim();
        if (!v) {
          // nothing to show
          return;
        }
        if (v === lastVal) return;
        lastVal = v;
        let obj = {};
        try { obj = JSON.parse(v); } catch(err){
          console.warn('[RC-DEBUG] failed parsing summaryJsonInput JSON', err, v);
          return;
        }
        console.log('[RC-DEBUG] populate modal from summary JSON', obj);

        safeText(markEl, obj.mark || obj.MARK || (obj.raw && obj.raw.MARK) || '');
        safeText(aaEl, obj.AA || obj.aa || obj.progressive_aa || (obj.raw && obj.raw.progressive_aa) || '');
        safeText(afmEl, obj.AFM_issuer || obj.AFM || obj.issuer_vat || (obj.raw && obj.raw.issuer_vat) || '');
        safeText(nameEl, obj.Name || obj.Name_issuer || obj.issuer_name || (obj.raw && obj.raw.issuer_name) || '');
        safeText(issueEl, obj.issueDate || obj.issue_date || (obj.raw && obj.raw.issue_date) || '');
        safeText(typeEl, obj.type_name || obj.type || (obj.raw && obj.raw.doc_type) || '');
        safeText(netEl, obj.totalNetValue || obj.total_amount || obj.totalValue || (obj.raw && obj.raw.total_amount) || '');
        safeText(vatEl, obj.totalVatAmount || (obj.raw && obj.raw.totalVatAmount) || '');
        safeText(totEl, obj.totalValue || obj.total_amount || (obj.raw && obj.raw.total_amount) || '');

        // lines
        let lines = [];
        if (Array.isArray(obj.lines) && obj.lines.length) lines = obj.lines;
        else if (obj.raw && Array.isArray(obj.raw.lines) && obj.raw.lines.length) lines = obj.raw.lines;
        else if (obj.lines && typeof obj.lines === 'object') {
          // sometimes backend sends object: try to collect values
          try {
            lines = Object.values(obj.lines).filter(x => x);
          } catch(e){}
        }
        renderLines(lines);

        // if modal is hidden, ensure it's visible when populate invoked by scraper flow
        try {
          if (modal && modal.style.display === 'none') {
            if (!(window.__RC_FLAGS && window.__RC_FLAGS.autoHandled)) { modal.style.display = 'flex'; }
          }
        } catch(e){}

      } catch(e){
        console.error('[RC-DEBUG] populateOnce error', e);
      }
    }

    // Start polling for changes to summaryJsonInput.value
    const poll = setInterval(populateOnce, 250);

    // Also populate when modal opens (observe style attribute)
    const obs = new MutationObserver(muts => {
      for(const m of muts){
        if (m.type === 'attributes' && m.attributeName === 'style'){
          try { if (modal.style.display !== 'none') populateOnce(); } catch(e){}
        }
      }
    });
    try { obs.observe(modal, { attributes: true, attributeFilter: ['style'] }); } catch(e){}

    // expose a debug function on window to force populate
    window.RC_forcePopulateSummaryModal = populateOnce;

    console.log('[RC-DEBUG] summary-populate watcher started');

    // Optional: stop polling after N seconds to be tidy
    setTimeout(()=>{ clearInterval(poll); console.log('[RC-DEBUG] stopped summary-populate polling (timeout)'); }, 60*1000);

  } catch (err) {
    console.error('[RC-DEBUG] summary-populate init failed', err);
  }
})();

(function RC_FORCE_MODAL_GUARD(){
  try {
    const dbg = (...a) => { try { console.log('[RC-MODAL-GUARD]', ...a); } catch(e) {} };

    function parseSummary() {
      const el = document.getElementById('summaryJsonInput');
      if (!el) return {};
      try { return JSON.parse(el.value || '{}') || {}; } catch(e){ dbg('parseSummary JSON error', e); return {}; }
    }

    function hasMeaningfulSummary(obj) {
      if (!obj || typeof obj !== 'object') return false;
      // important single fields that guarantee modal should open
      const keys = ['mark','MARK','AFM_issuer','AFM','totalValue','totalNetValue','total_amount','issueDate','issue_date','progressive_aa','AA'];
      for (const k of keys) {
        if (obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== '') return true;
      }
      // check raw.* fields if present
      if (obj.raw && typeof obj.raw === 'object') {
        for (const k of ['MARK','issuer_vat','total_amount','issue_date','progressive_aa']) {
          if (obj.raw[k] !== undefined && obj.raw[k] !== null && String(obj.raw[k]).trim() !== '') return true;
        }
      }
      // lines array with at least one non-empty line
      if (Array.isArray(obj.lines) && obj.lines.length) {
        for (const ln of obj.lines) {
          if (!ln) continue;
          if ((ln.description && String(ln.description).trim() !== '') ||
              (ln.amount && String(ln.amount).trim() !== '') ||
              (ln.id && String(ln.id).trim() !== '')) return true;
        }
      }
      // fallback: object with >1 non-empty keys
      const nonEmpty = Object.keys(obj).filter(k=>{
        try { return obj[k] !== null && obj[k] !== undefined && String(obj[k]).trim() !== ''; } catch(e){ return false; }
      });
      return nonEmpty.length > 1;
    }

    function ensureModalHiddenUnlessMeaningful() {
      const modal = document.getElementById('summaryModal');
      const summaryEl = document.getElementById('summaryJsonInput');
      if (!modal || !summaryEl) { dbg('no modal/summaryEl present'); return; }

      // Force-hide now (neutralize server/client auto-show)
      try { modal.style.display = 'none'; } catch(_) {}

      // If summary becomes meaningful, show it (and populate watcher should fill fields)
      const checkAndMaybeShow = () => {
        const obj = parseSummary();
        if (hasMeaningfulSummary(obj)) {
          dbg('summary meaningful -> showing modal', obj);
          try {
            // try to trigger your populate logic if present
            if (window.RC_forcePopulateSummaryModal) {
              try { window.RC_forcePopulateSummaryModal(); } catch(e){ dbg('RC_forcePopulateSummaryModal failed', e); }
            } else if (typeof populateSummaryModal === 'function') {
              try { populateSummaryModal(obj); } catch(e){ dbg('populateSummaryModal failed', e); }
            }
            if (!(window.__RC_FLAGS && window.__RC_FLAGS.autoHandled)) { modal.style.display = 'flex'; }
          } catch(e){ dbg('show modal failed', e); }
        } else {
          // keep hidden
          dbg('summary not meaningful -> keep modal hidden');
          try { modal.style.display = 'none'; } catch(_) {}
        }
      };

      // run immediate check after tiny delay (let other init finish)
      setTimeout(checkAndMaybeShow, 60);

      // observe changes to summaryJsonInput.value (detect writes by other code)
      try {
        let lastVal = summaryEl.value || '';
        const poll = setInterval(() => {
          try {
            const cur = summaryEl.value || '';
            if (cur !== lastVal) {
              lastVal = cur;
              dbg('summaryJsonInput changed -> recheck');
              checkAndMaybeShow();
            }
          } catch(e){ dbg('poll error', e); }
        }, 200);
        // auto-stop polling after 60s
        setTimeout(()=>clearInterval(poll), 60*1000);
      } catch(e){ dbg('poll install failed', e); }

      // observe modal style changes by others: if someone tries to open it while summary not meaningful, immediately hide
      try {
        const mo = new MutationObserver(muts => {
          try {
            const obj = parseSummary();
            if (!hasMeaningfulSummary(obj)) {
              const modalEl = document.getElementById('summaryModal');
              if (modalEl) {
                const disp = window.getComputedStyle(modalEl).display;
                if (disp !== 'none') {
                  dbg('modal was opened by other code while summary not meaningful -> hiding it');
                  modalEl.style.display = 'none';
                }
              }
            }
          } catch(e){ dbg('mutation observer callback error', e); }
        });
        const modalNode = document.getElementById('summaryModal');
        if (modalNode) mo.observe(modalNode, { attributes: true, attributeFilter: ['style', 'class'] });
      } catch(e){ dbg('mutation observer install failed', e); }
    }

    // Run after DOM ready (also run if DOM already ready)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', ensureModalHiddenUnlessMeaningful);
    } else {
      setTimeout(ensureModalHiddenUnlessMeaningful, 10);
    }

    dbg('RC_FORCE_MODAL_GUARD installed');
  } catch(err) {
    try { console.error('[RC-MODAL-GUARD] init failed', err); } catch(e){}
  }
})();

document.addEventListener('click', function(ev){
  const btn = ev.target.closest('.category-btn');
  if(!btn) return;

  // 1) Αποτροπή bubbling για να μην ανοίγει άλλο modal
  ev.preventDefault();
  try { ev.stopImmediatePropagation(); } catch(e){}
  try { ev.stopPropagation(); } catch(e){}

  // 2) Ενημέρωση κουμπιών (UI)
  const lineId = btn.dataset.lineId;
  const cat = btn.dataset.cat;
  const siblings = btn.parentElement.querySelectorAll('.category-btn');
  siblings.forEach(s => s.classList.remove('bg-sky-600','text-white'));
  btn.classList.add('bg-sky-600','text-white');

  // 3) Ενημέρωση του select για compatibility
  const sel = document.querySelector('select.expense-category[data-line-id="'+lineId+'"]');
  if(sel) sel.value = cat;

  // 4) Ενημέρωση του hidden JSON input
  const input = document.getElementById('summaryJsonInput');
  if(!input) return;
  let data = {};
  try { data = JSON.parse(input.value || '{}'); } catch(e){ data = {}; }

  // Ensure lines array exists
  if(!Array.isArray(data.lines)) data.lines = [];

  // Update or add line
  let line = data.lines.find(l => String(l.id || l.line_id || '') === lineId);
  if(!line){
    line = {id: lineId};
    data.lines.push(line);
  }
  line.category = cat; // <--- εδώ γράφεται η κατηγορία

  // Save back
  input.value = JSON.stringify(data);
});

document.querySelectorAll('.category-btn').forEach(btn=>{
  btn.addEventListener('click', function(ev){
    ev.preventDefault(); // δεν χρειάζεται stopPropagation

    const lineId = this.dataset.lineId;
    const cat = this.dataset.cat;

    // Αποτύπωση UI
    const siblings = this.parentElement.querySelectorAll('.category-btn');
    siblings.forEach(s => s.classList.remove('bg-sky-600','text-white'));
    this.classList.add('bg-sky-600','text-white');

    // Ενημέρωση select για συμβατότητα
    const sel = document.querySelector('select.expense-category[data-line-id="'+lineId+'"]');
    if(sel) sel.value = cat;

    // Ενημέρωση summaryJsonInput
    const input = document.getElementById('summaryJsonInput');
    if(!input) return;
    let data = {};
    try { data = JSON.parse(input.value || '{}'); } catch(e){ data={}; }
    if(!Array.isArray(data.lines)) data.lines = [];
    let line = data.lines.find(l => String(l.id||l.line_id||'')===lineId);
    if(!line){
      line = {id: lineId};
      data.lines.push(line);
    }
    line.category = cat;
    input.value = JSON.stringify(data);

    // !!! Σημαντικό: μην καλείς stopPropagation εδώ !!!
    // Άλλο modal handler θα πρέπει να φιλτράρει ποιο στοιχείο το ενεργοποιεί
  });
});
document.addEventListener('click', function(ev){
  // Αν το click προέρχεται από κουμπί category, αγνόησε
  if(ev.target.closest('.category-btn')) return;

  // άλλος κώδικας που ανοίγει modal
});





// === Frontend patch: enrich delete_invoices POST + clear client-side cache ===
document.addEventListener('submit', function(ev){
  try{
    const form = ev.target;
    if(!form || !form.action) return;
    // Match delete_invoices endpoint (relative or absolute)
    const a = document.createElement('a'); a.href = form.action;
    const path = (a.pathname || '') + (a.search || '');
    if(!/delete_invoices/.test(path)) return;

    // 1) Ensure active_vat is posted
    const existingHv = form.querySelector('input[name="active_vat"]');
    if(!existingHv){
      const hv = document.createElement('input');
      hv.type = 'hidden';
      hv.name = 'active_vat';
      const activeVat = (document.querySelector('#vatSelector')?.value
                      || document.querySelector('[name="vat"]')?.value
                      || document.body.dataset.activeVat
                      || '').toString().trim();
      hv.value = activeVat;
      form.appendChild(hv);
    }

    // 2) Collect marks to delete
    let marks = Array.from(form.querySelectorAll('input[name="delete_mark"]')).map(i => (i.value||'').trim()).filter(Boolean);
    if(!marks.length){
      marks = Array.from(document.querySelectorAll('input[name="delete_mark"]:checked')).map(i => (i.value||'').trim()).filter(Boolean);
    }

    // 3) Clear client-side caches (localStorage keys that reference these MARKs)
    try{
      marks.forEach(mk => {
        // common per-mark keys
        localStorage.removeItem(`epsilon_summary_${mk}`);
        localStorage.removeItem(`EPSILON:INV:${mk}`);
      });
      // any key containing one of the marks
      for(let i=localStorage.length-1; i>=0; i--){
        const k = localStorage.key(i);
        if(!k) continue;
        if(marks.some(mk => k.includes(mk))){
          localStorage.removeItem(k);
        }
      }
      // also clear any prefilled summary hidden input to avoid stale reopen
      const sumInp = document.getElementById('summaryJsonInput');
      if(sumInp) sumInp.value = '';
    }catch(e){ /* ignore storage errors */ }

  }catch(err){
    console.warn('delete_invoices frontend patch failed', err);
  }
}, true);
(function receiptsRepeatModalGuard(){
  const once = { submitted:false };

  function qs(id){ return document.getElementById(id); }

  function readSummary(){
    try { return JSON.parse(qs('summaryJsonInput')?.value || '{}'); }
    catch(_) { return {}; }
  }

  function isMeaningfulSummary(o){
    try{
      if (!o || typeof o!=='object') return false;
      const mark = String(o.mark || o.MARK || '').trim();
      if (!mark || mark.length<6) return false;
      const lines = Array.isArray(o.lines) ? o.lines : [];
      if (lines.length===0) return false;
      return lines.some(l=>{
        if(!l) return false;
        const desc=(l.description||l.desc||'').toString().trim();
        const amt =(l.amount||l.lineTotal||l.total||'').toString().trim();
        const id  =(l.id||l.line_id||'').toString().trim();
        return !!(desc||amt||id);
      });
    }catch(_){ return false; }
  }

  function isReceiptSummary(o){
    try{
      const t = (o.type_name || o.type || '').toString().toLowerCase();
      const c = (o.category || o.characteristic || o['χαρακτηρισμός'] || '').toString().toLowerCase();
      return !!(o.is_receipt || t.includes('απόδει') || t.includes('receipt') || t.includes('λιαν') || c==='αποδειξακια');
    }catch(_){ return false; }
  }

  function forceEdit(){
    try { return new URLSearchParams(location.search).get('force_edit') === '1'; }
    catch(_){ return false; }
  }

  function shouldOpenSummaryModal(obj){
    const receiptsOn = !!(qs('useReceiptsSwitch') && qs('useReceiptsSwitch').checked);
    const repeatOn   = !!(qs('repeatEntrySwitch') && qs('repeatEntrySwitch').checked);
    // Αν είμαστε σε αποδείξεις (ή το summary είναι απόδειξη) και repeat ON και ΔΕΝ είναι reclassification -> ΜΗΝ ανοίξεις modal
    if ((receiptsOn || isReceiptSummary(obj)) && repeatOn && !forceEdit()) return false;
    return true;
  }

  function autoSubmitReceipt(obj){
    if (once.submitted) return;                       // το στείλαμε ήδη σε αυτόν τον κύκλο
    if (!isMeaningfulSummary(obj)) return;            // ασφαλιστική δικλείδα
    const mark = (obj.mark || obj.MARK || '').toString().trim();
    if (!mark) return;
    const key = 'rc-auto:' + mark;
    if (sessionStorage.getItem(key)) return;          // ήδη υποβλήθηκε μετά από reload

    // Επέβαλε “Αποδειξάκια”
    try{
      if (!Array.isArray(obj.lines)) obj.lines = [];
      obj.is_receipt = true;
      obj.category = 'αποδειξακια';
      obj.characteristic = 'αποδειξακια';
      obj['χαρακτηρισμός'] = 'αποδειξακια';
      qs('summaryJsonInput').value = JSON.stringify(obj);
    }catch(_){}

    const form = qs('saveSummaryForm');
    if (!form) return;
    once.submitted = true;
    sessionStorage.setItem(key,'1');                 // ώστε στο επόμενο reload να ΜΗΝ ξαναστείλει
    form.submit();
  }

  // Φρένο: ΜΗΝ υποβάλλεις την search-form χωρίς mark KAI χωρίς url
  (function guardEmptySearchSubmit(){
    const form = qs('markSearchForm');
    if (!form) return;
    form.addEventListener('submit', (e)=>{
      const mark = (qs('markInput')?.value || '').trim();
      const url  = (qs('scrapeUrlInput')?.value || '').trim();
      if (!mark && !url) e.preventDefault();
    }, true);
  })();

  // Παρακολούθησε το modal: αν πάει να ανοίξει ενώ ΔΕΝ πρέπει, κλείστο και κάνε auto-submit
  const modal = qs('summaryModal');
  if (!modal) return;

  const observer = new MutationObserver(function(){
    try{
      const visible = modal && getComputedStyle(modal).display !== 'none';
      if (!visible) return;
      const obj = readSummary();
      if (!shouldOpenSummaryModal(obj)) {
        // Μπλόκαρε το modal και προχώρησε σε auto-submit
        modal.style.display = 'none';
        autoSubmitReceipt(obj);
      }
    }catch(_){}
  });

  try{
    observer.observe(modal, { attributes:true, attributeFilter:['style','class'] });
  }catch(_){}

  // One-shot check αν τυχόν ξεκινά ήδη ανοιχτό
  setTimeout(()=>{
    try{
      const visible = modal && getComputedStyle(modal).display !== 'none';
      const obj = readSummary();
      if (visible && !shouldOpenSummaryModal(obj)) {
        modal.style.display = 'none';
        autoSubmitReceipt(obj);
      }
    }catch(_){}
  }, 80);
})();

</script>

<style>
    /* minimal styling for the toggle switch */
    /* μόνο για modal */
    .modal-summary-table th {
        background-color: #0d6efd;
        color: white;
        border: 1px solid #ccc;
    }

    .modal-summary-table td {
        border: 1px solid #e2e8f0;
    }

    .modal-summary-table tr:nth-child(even) {
        background-color: #f9fafb;
    }

    .modal-summary-table tr:hover {
        background-color: #e6f0ff;
    }

    .modal-summary-table tfoot td {
        background-color: #f1f5f9;
    }

    /* κλείδωμα κλικ πίσω από modal */
    .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.45);
        z-index: 99998;
    }

    #summaryModal {
        z-index: 99999;
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
    }

        #summaryModal.show {
            display: flex;
        }

    body.modal-open #page-root {
        pointer-events: none;
    }
    /* βάλε id=page-root στο κύριο wrapper της σελίδας */
    body.modal-open #summaryModal,
    body.modal-open #summaryModal * {
        pointer-events: auto;
    }

    .toggle-switch {
        width: 42px;
        height: 24px;
        -webkit-appearance: none;
        appearance: none;
        background: #e5e7eb;
        border-radius: 999px;
        position: relative;
        outline: none;
        cursor: pointer;
        vertical-align: middle;
    }

        .toggle-switch:checked {
            background: #0ea5a4;
        }

        .toggle-switch::after {
            content: "";
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            border-radius: 999px;
            background: white;
            transition: transform .15s ease;
        }

        .toggle-switch:checked::after {
            transform: translateX(18px);
        }
</style>



<script>/* ===== Auto-submit segmented toggle + guarded auto-detect (receipts & invoices) ===== */
(function(){
  try {
    // Globals
    window.__RC_FLAGS  = window.__RC_FLAGS  || {};
    window.__RC_LOCKS  = window.__RC_LOCKS  || {};
    const AUTO_KEY = 'rc:autoSubmitEnabled';

    // UI refs (may be absent in some partial renders)
    const form     = document.getElementById('markSearchForm');
    const markEl   = document.getElementById('markInput');
    const urlEl    = document.getElementById('scrapeUrlInput'); // may be dynamically created in your code
    const btnOn    = document.getElementById('autoSubmitBtnOn');
    const btnOff   = document.getElementById('autoSubmitBtnOff');
    const receiptsSwitch = document.getElementById('useReceiptsSwitch');

    // State helpers
    function getAuto(){ try { return localStorage.getItem(AUTO_KEY) === '1'; } catch(_) { return false; } }
    function setAuto(v){
  try { localStorage.setItem(AUTO_KEY, v ? '1' : '0'); } catch(_) {}
  window.__RC_FLAGS.auto_submit_enabled = !!v;
  updateUi();

  // reload με συγχρονισμό querystring
  try {
    const p = new URLSearchParams(location.search);
    if (v) p.set('auto_submit','1'); else p.delete('auto_submit');
    const newQS = p.toString();
    const cur  = location.pathname + location.search;
    const next = location.pathname + (newQS ? '?' + newQS : '');
    if (next === cur) {
      location.reload();          // αν δεν αλλάζει το URL, αναγκαστικό reload
    } else {
      location.search = newQS;    // αλλάζοντας το query κάνει reload μόνο του
    }
  } catch (e) {
    location.reload();
  }
}

    function updateUi(){
      const on = getAuto();
      if (btnOn && btnOff) {
        btnOn.classList.toggle('bg-sky-600', on);
        btnOn.classList.toggle('text-white', on);
        btnOff.classList.toggle('bg-sky-600', !on);
        btnOff.classList.toggle('text-white', !on);
      }
    }
    updateUi();
    if (btnOn)  btnOn.addEventListener('click', ()=> setAuto(true));
    if (btnOff) btnOff.addEventListener('click', ()=> setAuto(false));

    // Utilities
    function isVisible(el){
      if(!el) return false;
      const cs = getComputedStyle(el);
      return !(cs.display === 'none' || cs.visibility === 'hidden' || cs.opacity === '0');
    }
    function warningOpen(){
      const ids = ['receiptWarn','afmWarningModal','receiptWarningModal','yearWarningModal'];
      for (const id of ids){ const el = document.getElementById(id); if (el && isVisible(el)) return true; }
      // generic: any visible dialog that is not the summary modal
      const nodes = document.querySelectorAll('[role="dialog"],[aria-modal="true"],.modal,.modal-root');
      for (const n of nodes){
        if (!isVisible(n)) continue;
        if (n.id === 'summaryModal' || n.id === 'receiptsModal') continue;
        const t = (n.textContent || '').toLowerCase();
        if (/\bπροειδοπ|\bπροσοχ|warning|σφάλμα|error/.test(t)) return true;
      }
      return false;
    }

    const normMark = v => (v||'').replace(/\D/g,'');
    const isMark   = v => normMark(v).length === 15;
    const isUrl    = v => {
      const s = (v||'').trim();
      return /^https?:\/\/\S+/i.test(s) || /^www\.\S+/i.test(s);
    };
    const extractMark = s => {
      const m = String(s||'').match(/\b(\d{15})\b/);
      return m ? m[1] : '';
    };

    function currentKey(){
      const mv = (markEl && markEl.value) ? markEl.value.trim() : '';
      const uv = (document.getElementById('scrapeUrlInput')?.value || '').trim(); // requery in case it was injected after
      const receipts = !!(receiptsSwitch && receiptsSwitch.checked);

      // For receipts: prefer a URL, but accept MARK inside URL as fallback
      if (receipts) {
        if (isUrl(uv)) return 'url:'+uv.replace(/\/+$/,'');
        const ex = extractMark(uv); if (ex) return 'mark:'+ex;
        // also allow mark typed in markInput if user didn't switch field
        if (isMark(mv)) return 'mark:'+normMark(mv);
        return null;
      }

      // For invoices: prefer MARK; but accept URL too
      if (isMark(mv)) return 'mark:'+normMark(mv);
      if (isUrl(mv)) return 'url:'+mv.replace(/\/+$/,'');
      return null;
    }

    let pending = false;
    const KEY_LAST = 'rc:lastSubmitKey';
    const TTL_MS   = 20000;
    function readLast(){
      try {
        const raw = sessionStorage.getItem(KEY_LAST);
        if(!raw) return null;
        const o = JSON.parse(raw);
        if(!o || !o.ts || (Date.now()-o.ts)>TTL_MS) return null;
        return o.k || null;
      }catch(_){ return null; }
    }
    function writeLast(k){
      try { sessionStorage.setItem(KEY_LAST, JSON.stringify({k, ts: Date.now()})); } catch(_) {}
    }

    const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

    function trySubmit(){
      if (!form || !getAuto()) return;
      if (warningOpen()) return;
      const k = currentKey();
      if (!k) return;

      // prevent collisions with existing receipts lock if present
      if (window.__RC_LOCKS && window.__RC_LOCKS.scrape) return;

      // prevent duplicate submits on same key
      const last = readLast();
      if (last && last === k) return;

      // submit once
      writeLast(k);
      if (pending) return;
      pending = true;
      try {
        if (form.requestSubmit) form.requestSubmit(); else form.submit();
      } finally {
        setTimeout(()=>{ pending=false; }, 500);
      }
    }

    const onChange = debounce(trySubmit, 140);

    // Wire inputs if present
    if (markEl) {
      markEl.addEventListener('input', onChange);
      markEl.addEventListener('keyup', onChange);
      markEl.addEventListener('paste', ()=>setTimeout(onChange,0));
    }
    // url input could be injected later; observe for appearance
    let tries = 30;
    const iv = setInterval(()=>{
      const u = document.getElementById('scrapeUrlInput');
      if (u) {
        u.addEventListener('input', onChange);
        u.addEventListener('keyup', onChange);
        u.addEventListener('paste', ()=>setTimeout(onChange,0));
        clearInterval(iv);
      }
      if(--tries<=0) clearInterval(iv);
    }, 200);

    // Initial pass (for browser autofill)
    window.addEventListener('load', ()=> setTimeout(onChange, 60));

    // Ensure a stub exists to avoid ReferenceError when other code calls it
    if (typeof window.autoSubmitReceipt !== 'function') {
      window.autoSubmitReceipt = function(){ /* stub to avoid ReferenceError; actual flow handled elsewhere */ };
    }
  } catch (err) {
    console.warn('Auto-submit toggle patch failed', err);
  }
})();</script>

<script>/* === Persist Receipts/Invoices toggle across refresh === */
<script>
/* === Persist Receipts/Invoices toggle across refresh (v2) === */
(function persistReceiptsToggle(){
  const KEY = 'rc:useReceipts';
  const sw  = document.getElementById('useReceiptsSwitch');
  const markInput = document.getElementById('markInput');
  function ensureUrlInput(){
    let el = document.getElementById('scrapeUrlInput');
    if (!el) {
      // try to locate after markInput if dynamically created later by other code
      el = document.createElement('input');
      el.id = 'scrapeUrlInput';
      el.placeholder = 'Εισάγετε URL παραστατικού (για αποδείξεις)';
      el.className = 'p-2 border rounded w-2/4 hidden';
      el.type = 'text';
      if (markInput && markInput.parentElement) {
        markInput.parentElement.insertBefore(el, markInput.nextSibling);
      } else {
        document.body.appendChild(el);
      }
    }
    return el;
  }
  function applyUI(isReceipts){
    const urlInput = ensureUrlInput();
    if (isReceipts){
      markInput && markInput.classList.add('hidden');
      urlInput && urlInput.classList.remove('hidden');
    } else {
      markInput && markInput.classList.remove('hidden');
      urlInput && urlInput.classList.add('hidden');
    }
  }

  if (!sw) return;
  // restore saved value
  const saved = localStorage.getItem(KEY);
  if (saved !== null) sw.checked = (saved === '1');
  applyUI(sw.checked);

  // if URL input appears later (other scripts), re-apply for a short window
  let tries = 20;
  const iv = setInterval(()=>{
    applyUI(sw.checked);
    if (--tries <= 0) clearInterval(iv);
  }, 200);

  sw.addEventListener('change', () => {
    localStorage.setItem(KEY, sw.checked ? '1' : '0');
    applyUI(sw.checked);
  });
})();</script>

<script>/* === Lightweight warning detector (client/server modals) === */
(function ensureWarningOpenHelper(){
  if (typeof window.__rc_warningOpen === 'function') return;
  window.__rc_warningOpen = function(){
    function vis(el){ if(!el) return false; const cs=getComputedStyle(el); return !(cs.display==='none'||cs.visibility==='hidden'||cs.opacity==='0'); }
    const ids=['receiptWarn','afmWarningModal','receiptWarningModal','yearWarningModal'];
    for (const id of ids){ const el=document.getElementById(id); if (el && vis(el)) return true; }
    const nodes=document.querySelectorAll('[role="dialog"],[aria-modal="true"],.modal,.modal-root');
    for (const n of nodes){
      if (!vis(n)) continue;
      if (n.id==='summaryModal' || n.id==='receiptsModal') continue;
      const t=(n.textContent||'').toLowerCase();
      if (/(προειδοπ|προσοχ|warning|σφάλμα|error)/.test(t)) return true;
    }
    return false;
  };
})();</script>

<script>
/* === RC helpers μόνο για flow Αποδείξεων === */
window.RC = window.RC || {};

RC.hasWarnings = function(){ return (typeof window.__rc_warningOpen === 'function') ? window.__rc_warningOpen() : false; };

RC.normalizeReceiptSummary = function (summaryObj) {
  summaryObj.is_receipt = true;
  summaryObj.type = summaryObj.type || 'ΑΠΟΔΕΙΞΗ';
  summaryObj.type_name = summaryObj.type_name || 'ΑΠΟΔΕΙΞΗ';
  summaryObj.category = 'αποδειξακια';
  if (!Array.isArray(summaryObj.lines) || !summaryObj.lines.length) {
    const tot = summaryObj.total_amount || summaryObj.totalValue || summaryObj.totalNetValue || '';
    summaryObj.lines = [{ id:'r0', description:'', amount:String(tot||''), vat:'', vatCategory:'', category:'αποδειξακια' }];
  } else {
    summaryObj.lines = summaryObj.lines.map((l,i)=>({
      id: String(l?.id || l?.line_id || ('r'+i)),
      description: String(l?.description || l?.desc || ''),
      amount: String(l?.amount || l?.lineTotal || l?.total || ''),
      vat: String(l?.vat || l?.vatRate || ''),
      vatCategory: String(l?.vatCategory || l?.vat_category || ''),
      category: String(l?.category || '') || 'αποδειξακια'
    }));
  }
  return summaryObj;
};

RC.confirmReceiptOnce = async function(summaryObj, scrapeUrl){
  window.__RC_LOCKS = window.__RC_LOCKS || {};
  if (window.__RC_LOCKS.confirm) return { ok:false, reason:'locked' };
  window.__RC_LOCKS.confirm = true;

  try {
    const VAT = "{{ vat or '' }}";
    const afmVal = (VAT || summaryObj.AFM_issuer || summaryObj.AFM || (summaryObj.raw && summaryObj.raw.issuer_vat) || '').toString().trim();
    if (!afmVal) return { ok:false, reason:'missing_afm' };

    if (!/\b\d{15}\b/.test(String(summaryObj.mark||'').trim())) {
      const r = await fetch('/api/next_receipt_mark', { credentials:'same-origin' });
      const j = await r.json().catch(()=>null);
      if (j && j.mark) summaryObj.mark = j.mark;
    }

    let yearVal = "{{ active_year|default('') }}";
    if (!yearVal) {
      try { const fy = await fetch('/get_fiscal_year', { credentials:'same-origin' }); const fyj = await fy.json(); if (fyj && fyj.exists) yearVal = String(fyj.fiscal_year); } catch(_){}
    }
    if (!yearVal) {
      const any = summaryObj.issueDate || summaryObj.issue_date || (summaryObj.raw && summaryObj.raw.issue_date) || '';
      const m = String(any).match(/\b(19|20)\d{2}\b/);
      yearVal = m ? m[0] : String((new Date()).getUTCFullYear());
    }

    const payload = {
      url: (scrapeUrl||'').trim(),
      summary_json: JSON.stringify(summaryObj),
      force: false,
      category: 'αποδειξακια',
      afm: afmVal,
      year: String(yearVal),
      mark: String(summaryObj.mark||'')
    };

    const res = await fetch('/api/confirm_receipt', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest'},
      body: JSON.stringify(payload)
    });
    const jj = await res.json().catch(()=>null);
    if (!res.ok || !jj || !jj.ok) return { ok:false, reason: (jj&&jj.error) || ('HTTP '+res.status) };

    return { ok:true };
  } finally {
    window.__RC_LOCKS.confirm = false;
  }
};

RC.handleReceiptAfterScrape = async function(summaryObj, scrapeUrl){
  try {
    const repeatOn = !!document.getElementById('repeatEntrySwitch')?.checked;
    const forceEdit = (typeof FORCE_EDIT !== 'undefined') ? !!FORCE_EDIT : false;
    if (!repeatOn || forceEdit || RC.hasWarnings()) return false;

    RC.normalizeReceiptSummary(summaryObj);
    const summaryInput = document.getElementById('summaryJsonInput');
    if (summaryInput) summaryInput.value = JSON.stringify(summaryObj);

    const r = await RC.confirmReceiptOnce(summaryObj, scrapeUrl);
    if (!r.ok) {
      if (r.reason === 'missing_afm') {
        window.openReceiptWarning && openReceiptWarning('Λείπει AFM ενεργού πελάτη.');
      } else {
        showFlash('Σφάλμα αποθήκευσης: ' + (r.reason || 'άγνωστο'), 'error', 6000);
      }
      return false;
    }
    window.__RC_FLAGS = window.__RC_FLAGS || {}; window.__RC_FLAGS.autoHandled = true;
    showFlash('Αποθηκεύτηκε η απόδειξη (repeat).', 'success', 900);
    try { document.getElementById('summaryModal').style.display = 'none'; } catch(_){}
    try { document.getElementById('scrapeUrlInput').value = ''; } catch(_){}
    try { document.getElementById('markInput').value = ''; } catch(_){}
    window.location = window.location.pathname;
    return true;
  } catch (e) {
    console.warn('handleReceiptAfterScrape failed', e);
    return false;
  }
};
document.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(location.search);

  const isReceipts =
    (params.get('use_receipts') === '1') ||
    (localStorage.getItem('pref_use_receipts') === '1');

  const repeatOn =
    (params.get('repeat') === '1') ||
    (localStorage.getItem('pref_repeat') === '1');

  const autoOn = params.has('auto_submit')
    ? (params.get('auto_submit') === '1')
    : (localStorage.getItem('pref_auto_submit') === '1');

  if (!(isReceipts && repeatOn && autoOn)) return;

  // 1) Κρύψε ό,τι modal επιβεβαίωσης υπάρχει για αποδείξεις
  const hideModal = () => {
    ['#receiptsModal', '#summaryModal', '[data-role="modal-warning"]', '#warningModal']
      .forEach(sel => {
        const el = document.querySelector(sel);
        if (!el) return;
        el.classList?.add('hidden');
        el.style.display = 'none';
      });
  };
  hideModal();

  // 2) Βεβαιώσου ότι στο submit περνάει repeat_enabled=1
  const ensureRepeatHidden = (form) => {
    if (!form) return;
    let h = form.querySelector('input[name="repeat_enabled"]');
    if (!h) {
      h = document.createElement('input');
      h.type = 'hidden';
      h.name = 'repeat_enabled';
      form.appendChild(h);
    }
    h.value = '1';
  };

  // 3) Αυτόματο submit μόλις είναι έτοιμη η φόρμα/δεδομένα
  let submitted = false;
  const tryAutoSubmit = () => {
    if (submitted) return;

    // Βρες τη φόρμα αποθήκευσης
    const form = document.querySelector('form[action$="/save_summary"]');
    if (!form) return;

    // Έλεγξε ότι υπάρχει payload: summary_json (input/textarea) ή τουλάχιστον το mark
    const payloadEl = form.querySelector('input[name="summary_json"],textarea[name="summary_json"]');
    const hasPayload = payloadEl ? String(payloadEl.value || '').trim().length > 0 : false;
    const hasMark = String((form.querySelector('[name="mark"]') || {}).value || '').trim().length === 15;

    if (!hasPayload && !hasMark) return;

    ensureRepeatHidden(form);
    submitted = true;
    hideModal();
    form.submit();
  };

  // Δοκίμασε άμεσα & με μικρό retry
  tryAutoSubmit();
  const i1 = setInterval(() => {
    if (submitted) { clearInterval(i1); return; }
    tryAutoSubmit();
  }, 150);

  // Παρακολούθησε DOM changes (όταν γεμίσει το modal/φόρμα από το fetch)
  const mo = new MutationObserver(() => tryAutoSubmit());
  mo.observe(document.body, { subtree: true, childList: true, attributes: false });

  // Safety stop μετά από ~6s για να μην τρέχει για πάντα
  setTimeout(() => mo.disconnect(), 6000);
});

</script>


<script src="{{ url_for('static', filename='receipts_repeat_direct.js') }}"></script>
{% endblock %}

<!-- === BEGIN: Injected fix (v2) for receipts auto-flow & afm_epsilon cleanup === -->
<script><script>
/* RC-REPEAT-STATE bridge για Αποδείξεις & Τιμολόγια
   - Διαβάζει το state από backend (/api/repeat_state/get) στην εκκίνηση
   - Το περνάει και σε localStorage (REPEAT:enabled) & body dataset (data-repeat-enabled)
   - Όταν αλλάζει ο διακόπτης repeatEntrySwitch, κάνει POST στο /api/repeat_state/set
   - Στο submit της φόρμας αναζήτησης, κάνει ένα φρεσκάρισμα του state πριν τη ροή
*/
(function() {
  const LS_KEY_REPEAT_ENABLED = 'REPEAT:enabled';

  async function refreshRepeatState() {
    try {
      const r = await fetch('/api/repeat_state/get', { credentials: 'include' });
      const j = await r.json();
      const enabled = !!(j && j.ok && j.enabled);
      localStorage.setItem(LS_KEY_REPEAT_ENABLED, enabled ? '1' : '0');
      document.body.dataset.repeatEnabled = enabled ? '1' : '0';
      window.REPEAT_ENABLED = enabled;

      // συγχρόνισε και το switch αν υπάρχει
      const sw = document.getElementById('repeatEntrySwitch');
      if (sw) {
        sw.checked = enabled;
      }
      console.debug('[RC-REPEAT-STATE] GET ->', { enabled });
    } catch (e) {
      console.warn('[RC-REPEAT-STATE] GET failed', e);
    }
  }

  async function setRepeatEnabled(enabled) {
    try {
      const r = await fetch('/api/repeat_state/set', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ enabled: !!enabled })
      });
      const j = await r.json();
      if (!j || !j.ok) throw new Error(j && j.error || 'unknown');
      // persist τοπικά
      localStorage.setItem(LS_KEY_REPEAT_ENABLED, enabled ? '1' : '0');
      document.body.dataset.repeatEnabled = enabled ? '1' : '0';
      window.REPEAT_ENABLED = !!enabled;
      console.debug('[RC-REPEAT-STATE] SET ->', { enabled });
    } catch (e) {
      console.warn('[RC-REPEAT-STATE] SET failed', e);
    }
  }

  // bootstrap: στην εκκίνηση
  document.addEventListener('DOMContentLoaded', () => {
    refreshRepeatState();
    const sw = document.getElementById('repeatEntrySwitch');
    if (sw) {
      sw.addEventListener('change', function() {
        setRepeatEnabled(this.checked);
      });
    }

    // στο submit της αναζήτησης: κάνε ένα γρήγορο refresh για να «δει» σωστά το autosave των αποδείξεων
    const form = document.getElementById('markSearchForm');
    if (form) {
      form.addEventListener('submit', () => {
        // fire-and-forget, δεν μπλοκάρουμε το submit
        refreshRepeatState();
      });
    }
  });
})();</script>

 (function(){
  function isDetailed(x){
    try{
      if(!x || typeof x !== 'object') return false;
      if (Array.isArray(x.lines) && x.lines.length) {
        // any non-empty field in a line
        for (const l of x.lines) {
          if (l && (String(l.amount||'').trim() || String(l.description||'').trim() || String(l.vat||'').trim())) {
            return true;
          }
        }
      }
      if (String(x.totalNetValue||'').trim() || String(x.totalValue||'').trim()) return true;
      const t = (x.type||x.type_name||'').toString().toLowerCase();
      if ((t.includes('απόδει') || t.includes('receipt')) && String(x.totalValue||'').trim()) return true;
      return false;
    }catch(e){ return false; }
  }
  function isReceipt(x){
    try{
      if (x && x.is_receipt) return true;
      const t = (x?.type || x?.type_name || '').toString().toLowerCase();
      if (t.includes('απόδει') || t.includes('receipt')) return true;
      const ch = (x?.category || x?.χαρακτηρισμός || x?.characteristic || '');
      return ch === 'αποδειξακια';
    }catch(e){ return false; }
  }
  function prefer(a,b){
    const da = isDetailed(a), db = isDetailed(b);
    if (da && !db) return a;
    if (db && !da) return b;
    const la = Array.isArray(a?.lines) ? a.lines.length : 0;
    const lb = Array.isArray(b?.lines) ? b.lines.length : 0;
    if (lb > la) return b;
    return a;
  }
  function sanitizeAfmEpsilon(arr){
    try{
      if(!Array.isArray(arr)) return arr;
      const byMark = new Map();
      for(const item of arr){
        const m = String(item?.mark || '').trim();
        if(!m) continue;
        if(!byMark.has(m)) byMark.set(m, item);
        else byMark.set(m, prefer(byMark.get(m), item));
      }
      let out = Array.from(byMark.values());
      out = out.filter(isDetailed); // drop placeholders
      return out;
    }catch(e){
      console.warn('sanitizeAfmEpsilon failed', e);
      return arr;
    }
  }

  // Clean global cache once
  try { if (window.afm_epsilon) { window.afm_epsilon = sanitizeAfmEpsilon(window.afm_epsilon); } } catch(e){}

  // Pick ONE receipt to submit when repeat+receipts is ON
  function pickReceiptSummary(){
    try{
      // Priority 1: explicit modal summary if page defines it
      if (window.modal_summary && isReceipt(window.modal_summary)) return window.modal_summary;
      // Priority 2: data attribute on any modal container
      const el = document.querySelector('[data-modal-summary]');
      if (el){
        try{
          const obj = JSON.parse(el.getAttribute('data-modal-summary'));
          if (isReceipt(obj)) return obj;
        }catch(_){}
      }
      // Priority 3: last detailed receipt from afm_epsilon
      const arr = Array.isArray(window.afm_epsilon) ? window.afm_epsilon.slice() : [];
      const receipts = arr.filter(x => isReceipt(x) && isDetailed(x));
      if (receipts.length) return receipts[receipts.length - 1];
    }catch(e){ console.warn('pickReceiptSummary failed', e); }
    return null;
  }

  try {
    const repeatSwitch = document.getElementById('repeatEntrySwitch');
    const useReceipts   = document.getElementById('useReceiptsSwitch');
    const summaryInput  = document.getElementById('summaryJsonInput');
    const saveForm      = document.getElementById('saveSummaryForm');
    const auto = !!(useReceipts && useReceipts.checked) && !!(repeatSwitch && repeatSwitch.checked);
    if (auto && summaryInput && saveForm) {
      const chosen = pickReceiptSummary();
      if (!chosen) {
        console.warn('Auto-submit suppressed: no detailed receipt summary found.');
        return;
      }
      // Ensure per-line category and flags
      try{
        if (!Array.isArray(chosen.lines)) chosen.lines = [];
        if (chosen.lines.length === 0) {
          // synthesize a simple line from totalValue when missing
          const lid = (String(chosen.mark||'') + '_r0').replace(/^_+|_+$/g,'') || 'r0';
          chosen.lines = [{
            id: lid, description: "", amount: String(chosen.totalValue||""), vat: "", category: "αποδειξακια", vatCategory: ""
          }];
        } else {
          chosen.lines = chosen.lines.map(l => (l && typeof l === 'object') ? {
            ...l,
            category: l.category || 'αποδειξακια'
          } : l);
        }
        chosen.is_receipt = true;
        chosen.category = chosen.category || 'αποδειξακια';
        chosen.characteristic = chosen.characteristic || 'αποδειξακια';
      }catch(_){}
      summaryInput.value = JSON.stringify(chosen);
      setTimeout(function(){
        if (!saveForm.dataset._autoSubmitted) {
          saveForm.dataset._autoSubmitted = '1';
          saveForm.requestSubmit ? saveForm.requestSubmit() : saveForm.submit();
        }
      }, 30);
    }
  } catch(e) { console.warn('receipts auto-confirm failed', e); }
})();</script>
<!-- === END: Injected fix (v2) === -->
<!-- RC_RECEIPT_AUTOPILOT_PATCH -->
<script>(function(){'use strict';
  // ====== Robust receipts repeat autopilot (no UI break) ======
  window.__RC_FLAGS = window.__RC_FLAGS || {};

  function lsget(key, fallback){ try{ const v=localStorage.getItem(key); if(v===null) return fallback; if(v==='1') return true; if(v==='0') return false; return v; }catch(_){
    return fallback; } }

  function receiptsSwitchOn(){ try{ return !!document.getElementById('useReceiptsSwitch')?.checked; }catch(_){
    return !!lsget('rc:useReceipts','receipts')==='receipts'; } }

  function autoSubmitOn(){ return !!lsget('rc:autoSubmitEnabled', true); }
  function repeatSwitchOn(){ try{ return !!document.getElementById('repeatEntrySwitch')?.checked; }catch(_){ return !!lsget('rc:repeat_enabled', false); } }

  async function serverRepeatEnabled(){
    try{ const r = await fetch('/api/repeat_entry/get', { credentials:'include' });
         const j = await r.json(); return !!(j && (j.enabled || j.repeat_enabled)); }
    catch(_){ return repeatSwitchOn(); }
  }

  function hideReceiptBanner(){
    const nodes = document.querySelectorAll('#existingBanner, .flash, .alert');
    nodes.forEach(el => {
      try{ if(/Λήφθηκε απόδειξη/i.test(el.textContent||'')) el.style.display='none'; }catch(_){}
    });
  }

  function tryAutoSave(){
    const form = document.getElementById('saveSummaryForm');
    const input = document.getElementById('summaryJsonInput');
    if (!form || !input) return false;
    // mark flags to suppress informational toast
    window.__RC_FLAGS.autoHandled = true;
    hideReceiptBanner();
    // Submit the server form (keeps server-side logic, excel write etc.)
    // Use a microtask so any last-second JSON sync runs first
    setTimeout(() => {
      try { form.submit(); } catch(e) {
        try { form.dispatchEvent(new Event('submit', { cancelable:false })); } catch(_){}
      }
    }, 30);
    return true;
  }

  function observeModalAndAuto(){
    const modal = document.getElementById('summaryModal');
    if (!modal) return;
    let done = false;
    const doIt = () => {
      if (done) return;
      const visible = getComputedStyle(modal).display !== 'none';
      if (!visible) return;
      if (tryAutoSave()) { done = true; modal.style.display = 'none'; }
    };
    try { new MutationObserver(doIt).observe(modal, { attributes:true, attributeFilter:['style','class'] }); } catch(_){}
    setTimeout(doIt, 80);
  }

  // Kickoff when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    // Make search submit more reliable when auto-submit is ON
    const form = document.getElementById('markSearchForm');
    if (form) {
      form.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && autoSubmitOn()) {
          const mark = (document.getElementById('markInput')?.value || '').trim();
          const url  = (document.getElementById('scrapeUrlInput')?.value || document.getElementById('scrapeUrlField')?.value || '').trim();
          if (!mark && !url) e.preventDefault(); // guard empty
        }
      }, true);
    }

    // Always ensure page comes back to a clean state after any save
    const saveForm = document.getElementById('saveSummaryForm');
    if (saveForm) {
      let reloaded = false;
      const reloadSoon = () => { if (!reloaded) { reloaded = true; setTimeout(() => location.reload(), 300); } };
      saveForm.addEventListener('ajax:done', reloadSoon, { once:true });
      saveForm.addEventListener('submit', () => setTimeout(reloadSoon, 1200), { once:true });
    }

    // If receipts + repeat are ON, suppress the "Λήφθηκε..." toast and auto-save
    Promise.resolve(serverRepeatEnabled()).then((rep) => {
      if (receiptsSwitchOn() && rep) {
        window.__RC_FLAGS.repeat_enabled = true;
        window.__RC_FLAGS.autoHandled = true; // prevents info message in existing code
        if (!tryAutoSave()) observeModalAndAuto();
      }
    });
  });
})();</script>


<!-- ===== Receipts repeat auto-confirm SHIM (appended) ===== -->
<script>(function(){
  // small utility: safe JSON parse
  function parseJSON(x){ try{ return JSON.parse(x); }catch(_){ return null; } }
  function getLS(k, d){ try{ const v = localStorage.getItem(k); return (v===null||v===undefined)?d:v; }catch(_){ return d; } }
  function setLS(k, v){ try{ localStorage.setItem(k, v); }catch(_){ } }
  function isTruthy(v){ return v === true || v === '1' || v === 1 || v === 'true'; }

  // Read repeat + receipts mode from both localStorage and globals/switches
  function getRepeatOn(){
    const ls = getLS('REPEAT:enabled', null);
    if (ls !== null) return isTruthy(ls);
    if (window.REPEAT_ENABLED !== undefined) return !!window.REPEAT_ENABLED;
    const sw = document.getElementById('repeatEntrySwitch');
    return !!(sw && sw.checked);
  }
  function getReceiptsModeOn(){
    const ls = getLS('UI:useReceipts', null);
    if (ls !== null) return isTruthy(ls);
    if (window.USE_RECEIPTS !== undefined) return !!window.USE_RECEIPTS;
    const sw = document.getElementById('useReceiptsSwitch');
    return !!(sw && sw.checked);
  }

  function isReceiptSummary(obj){
    if(!obj || typeof obj !== 'object') return false;
    if (obj.is_receipt === true) return true;
    const t = String(obj.type_name || obj.type || '').toLowerCase();
    const cat = String(obj.category || obj.characteristic || obj['χαρακτηρισμός'] || '').toLowerCase();
    return (t.includes('απόδει') || t.includes('receipt') || cat === 'αποδειξακια');
  }

  function hasMeaningfulLines(obj){
    const arr = Array.isArray(obj && obj.lines) ? obj.lines : [];
    if (arr.length === 0) return false;
    // any non-empty amount OR category is enough
    return arr.some(l => {
      const amt = String(l && (l.amount || l.total || l.lineTotal || '')).trim();
      const cat = String(l && (l.category || l.cat || '')).trim();
      return !!(amt || cat);
    });
  }

  function readSummaryObject(){
    const input = document.getElementById('summaryJsonInput');
    if(!input) return null;
    return parseJSON(input.value || '{}') || null;
  }

  function getScrapeUrl(){
    const u = document.getElementById('scrapeUrlInput') || document.getElementById('scrapeUrlField');
    return u ? (u.value || '') : '';
  }

  let lastMarkTried = null;
  let busy = false;

  async function tryAutoConfirm(){
    if (busy) return;
    const rep = getRepeatOn();
    const inRec = getReceiptsModeOn();
    if (!rep || !inRec) return;

    const s = readSummaryObject();
    if (!s || !isReceiptSummary(s) || !hasMeaningfulLines(s)) return;

    // avoid double firing for the same mark
    const mk = String(s.mark || s.MARK || '').trim();
    if (!mk || mk === lastMarkTried) return;
    lastMarkTried = mk;

    // hide modal pre-emptively to avoid flicker
    try {
      const modal = document.getElementById('summaryModal');
      if (modal) modal.style.display = 'none';
    } catch(_){}

    if (!(window.RC && RC.confirmReceiptOnce && RC.normalizeReceiptSummary)) {
      // RC not yet ready; retry later
      return;
    }

    busy = true;
    try {
      await RC.confirmReceiptOnce(RC.normalizeReceiptSummary(s), getScrapeUrl());
      // keep receipts mode sticky on refresh
      setLS('UI:useReceipts', '1');
      // soft reload to clear form quickly
      setTimeout(function(){
        try {
          const base = location.pathname + '?use_receipts=1';
          location.replace(base);
        } catch(_){ location.reload(); }
      }, 120);
    } catch(err){
      console.warn('[RC-AUTOCONFIRM] failed', err);
      // allow another attempt
      lastMarkTried = null;
    } finally {
      busy = false;
    }
  }

  // Poll for summary changes & conditions (fast but lightweight)
  let pollId = null;
  function startPoll(){
    if (pollId) return;
    pollId = setInterval(tryAutoConfirm, 200);
  }
  function stopPoll(){
    if (pollId) { clearInterval(pollId); pollId = null; }
  }

  // Start ASAP
  startPoll();

  // Re-run when user submits the search form (so mode is immediately persisted)
  document.addEventListener('submit', function(e){
    const f = e.target;
    if (f && f.id === 'markSearchForm') {
      // persist current mode for autosave
      try {
        const sw = document.getElementById('useReceiptsSwitch');
        if (sw) setLS('UI:useReceipts', sw.checked ? '1' : '0');
      } catch(_){}
      setTimeout(tryAutoConfirm, 0);
    }
  }, true);

  // Also, when repeat switch toggles, persist immediately
  document.addEventListener('change', function(e){
    const sw = e.target && e.target.id === 'repeatEntrySwitch' ? e.target : null;
    if (sw){
      setLS('REPEAT:enabled', sw.checked ? '1' : '0');
      setTimeout(tryAutoConfirm, 0);
    }
  }, true);

  // One-time bootstrap from server state (if available via endpoint)
  // This is best-effort; if it fails, user toggles or previous LS values will be used.
  (async function bootstrapRepeatOnce(){
    try {
      const r = await fetch('/api/repeat_entry/get', { credentials: 'same-origin' });
      const j = await r.json();
      if (j && j.ok && j.repeat_entry) {
        setLS('REPEAT:enabled', j.repeat_entry.enabled ? '1' : '0');
        // leave mapping to backend; we only need the enabled bit here
        setTimeout(tryAutoConfirm, 0);
      }
    } catch(_){}
  })();
})();</script>
<script>
document.addEventListener('click', function(e){
  const a = e.target.closest('#charProfilesLink');
  if(!a) return;
  e.preventDefault();
  window.location.href = a.getAttribute('href');
});
</script>

<script>
/* Reload όταν ο χρήστης πατάει "Κατάλαβα" στα warning modals */
(function(){
  // AFM warning (server-rendered modal with #afmModalConfirm)
  const afmOk = document.getElementById('afmModalConfirm'); // υπάρχει ήδη στο search.html
  if (afmOk) {
    afmOk.addEventListener('click', function(){
      try { document.getElementById('afmWarningModal').style.display = 'none'; } catch(_){}
      location.reload();
    });
  }

  // Receipt warning (dynamic modal που φτιάχνεται με openReceiptWarning, κουμπί #receiptWarnOk)
  document.addEventListener('click', function(e){
    if (e.target && e.target.id === 'receiptWarnOk') {
      try { document.getElementById('receiptWarn').style.display = 'none'; } catch(_){}
      location.reload();
    }
  }, true);
})();
</script>

<script src="{{ url_for('static', filename='receipts_repeat_direct.js') }}"></script>
<script src="{{ url_for('static', filename='receipts_autosubmit_strict.js') }}"></script>


<!-- ===== end SHIM ===== -->