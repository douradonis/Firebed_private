{% extends "base.html" %}
{% block title %}Αναζήτηση MARK{% endblock %}

{% block content %}
<div class="bg-white rounded shadow p-6">
  <h2 class="text-lg font-semibold mb-2">Αναζήτηση MARK</h2>

  {% if error %}
    <div class="mb-3 p-2 rounded bg-red-50 text-red-800">{{ error }}</div>
  {% endif %}

  <form method="post" class="flex gap-2">
    <input name="mark" type="text" placeholder="15ψήφιο MARK" class="p-2 border rounded" value="{{ mark }}">
    <button type="submit" class="bg-sky-600 text-white px-3 py-2 rounded">Αναζήτηση</button>
  </form>
</div>

{% if modal_summary %}
<div id="summaryModal" class="fixed inset-0 flex items-center justify-center bg-black/40 z-50 overflow-auto p-4">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-5xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">
        Περίληψη Παραστατικού - MARK {{ modal_summary.mark or modal_summary.get('mark','') }}
      </h3>
      <button onclick="closeModal()" class="text-gray-500 text-xl font-bold">✕</button>
    </div>

    <!-- Βασικά στοιχεία παραστατικού -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
      <div><strong>Α/Α Παραστατικού</strong><div>{{ modal_summary.AA or modal_summary.get('AA','') }}</div></div>
      <div><strong>ΑΦΜ</strong><div>{{ modal_summary.get('AFM','') }}</div></div>
      <div><strong>Επωνυμία</strong><div>{{ modal_summary.Name or modal_summary.get('Name','') }}</div></div>
      <div><strong>Ημερομηνία</strong><div>{{ modal_summary.issueDate or modal_summary.get('issueDate','') }}</div></div>
      <div><strong>Τύπος Παραστατικού</strong><div>{{ modal_summary.type_name or modal_summary.get('type_name','') }}</div></div>
      <div><strong>Καθαρή Αξία</strong><div>{{ modal_summary.totalNetValue or modal_summary.get('totalNetValue','') }}</div></div>
      <div><strong>ΦΠΑ</strong><div>{{ modal_summary.totalVatAmount or modal_summary.get('totalVatAmount','') }}</div></div>
      <div><strong>Σύνολο</strong><div>{{ modal_summary.totalValue or modal_summary.get('totalValue','') }}</div></div>
    </div>

    <!-- Αναλυτικές γραμμές -->
    {% if invoice_lines %}
    <h4 class="font-medium mt-4 mb-2">Γραμμές Παραστατικού</h4>
    <div class="overflow-auto max-h-96 border rounded">
      <table class="w-full border-collapse">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="p-2 border">Περιγραφή</th>
            <th class="p-2 border">Ποσό</th>
            <th class="p-2 border">ΦΠΑ</th>
            <th class="p-2 border">Κατηγορία Εξόδου</th>
          </tr>
        </thead>
        <tbody>
          {% for line in invoice_lines %}
          <tr data-line-id="{{ line.id }}">
            <td class="p-2 border">{{ line.description }}</td>
            <td class="p-2 border">{{ line.amount }}</td>
            <td class="p-2 border">{{ line.vat }}</td>
            <td class="p-2 border">
              <select class="expense-category p-1 border rounded w-full" data-line-id="{{ line.id }}">
                {% for cat in customer_categories %}
                  <option value="{{ cat }}" {% if line.category == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    <div class="mt-4 flex justify-end gap-2">
      <form method="POST" action="{{ url_for('save_summary') }}">
        <input type="hidden" name="summary_json" id="summaryJsonInput" value='{{ modal_summary | tojson }}'>
        <button type="submit" class="bg-sky-600 text-white px-3 py-2 rounded">Αποθήκευση στο XLSX & Cache</button>
      </form>
      <button onclick="closeModal()" class="px-3 py-2 border rounded">Κλείσιμο</button>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function closeModal() {
  document.getElementById('summaryModal').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
  const summaryInput = document.getElementById('summaryJsonInput');
  const categories = document.querySelectorAll('.expense-category');

  categories.forEach(sel => {
    sel.addEventListener('change', function() {
      const lineId = this.dataset.lineId;
      const selectedValue = this.value;

      const data = JSON.parse(summaryInput.value);

      data.lines.forEach(line => {
        if(line.id == lineId) {
          line.category = selectedValue;
        }
      });

      summaryInput.value = JSON.stringify(data);
    });
  });

  {% if auto_open_modal %}
    document.getElementById('summaryModal').style.display = 'flex';
  {% endif %}
});
</script>
{% endblock %}
