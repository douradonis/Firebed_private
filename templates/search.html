{% extends "base.html" %}
{% block title %}Αναζήτηση MARK{% endblock %}

{% block content %}
<div class="bg-white rounded shadow p-6">
  <h2 class="text-lg font-semibold mb-2">Αναζήτηση MARK</h2>

  {% if error %}
    <div class="mb-3 p-2 rounded bg-red-50 text-red-800">{{ error }}</div>
  {% endif %}

  <form method="post" class="flex gap-2 items-center" id="markSearchForm">
    <input name="mark" id="markInput" type="text" placeholder="15ψήφιο MARK" class="p-2 border rounded w-2/4" value="{{ mark }}">
    <button type="submit" class="bg-sky-600 text-white px-3 py-2 rounded">Αναζήτηση</button>

    <!-- Toggle επαναληψιμης εισαγωγής + edit button -->
    <div class="flex items-center gap-2 ml-4">
      <label for="repeatEntrySwitch" class="text-sm">Επαναληψιμη εισαγωγή</label>
      <input type="checkbox" id="repeatEntrySwitch" class="toggle-switch">
      <button type="button" id="editRepeatMappingBtn" class="ml-2 px-2 py-1 border rounded text-sm hidden">Επεξεργασία</button>
    </div>
  </form>
</div>

{# --- Yellow box αν υπάρχει MARK ήδη στο Excel --- #}
{% if allow_edit_existing and not request.args.get('force_edit') %}
<div class="mt-4 p-4 bg-yellow-50 rounded border border-yellow-300 text-yellow-800" id="existingBanner">
  Το MARK <strong>{{ mark }}</strong> υπάρχει ήδη στο Excel. Θέλεις να τροποποιήσεις τον χαρακτηρισμό;
  <div class="mt-2 flex gap-2">
    <button id="forceEditBtn" type="button" class="bg-yellow-600 text-white px-3 py-2 rounded hover:bg-yellow-700">
      Επιβεβαίωση
    </button>
    <button id="dismissBannerBtn" type="button" onclick="this.parentElement.parentElement.style.display='none'"
            class="px-3 py-2 border rounded hover:bg-gray-50">
      Άκυρο
    </button>
  </div>
</div>
{% endif %}

{% if modal_summary and (request.args.get('force_edit') == '1' or not allow_edit_existing) %}
<div id="summaryModal" class="fixed inset-0 flex items-center justify-center bg-black/40 z-50 overflow-auto p-4" style="display:none;">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">
        Περίληψη Παραστατικού - MARK {{ modal_summary.mark or modal_summary.get('mark','') }}
      </h3>
      <button id="modalCloseX" class="text-gray-500 text-xl font-bold">✕</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
      <div><strong>Α/Α Παραστατικού</strong><div>{{ modal_summary.AA or modal_summary.get('AA','') }}</div></div>
      <div><strong>ΑΦΜ</strong><div>{{ modal_summary.AFM or modal_summary.get('AFM_issuer','') }}</div></div>
      <div><strong>Επωνυμία</strong><div>{{ modal_summary.Name or modal_summary.get('Name','') }}</div></div>
      <div><strong>Ημερομηνία</strong><div>{{ modal_summary.issueDate or modal_summary.get('issueDate','') }}</div></div>
      <div><strong>Τύπος Παραστατικού</strong><div>{{ modal_summary.type_name or modal_summary.get('type_name','') }}</div></div>
      <div><strong>Καθαρή Αξία</strong><div>{{ modal_summary.totalNetValue or modal_summary.get('totalNetValue','') }}</div></div>
      <div><strong>ΦΠΑ</strong><div>{{ modal_summary.totalVatAmount or modal_summary.get('totalVatAmount','') }}</div></div>
      <div><strong>Σύνολο</strong><div>{{ modal_summary.totalValue or modal_summary.get('totalValue','') }}</div></div>
    </div>

    {% set _lines = invoice_lines if invoice_lines is defined and invoice_lines else (modal_summary.lines if modal_summary.lines is defined and modal_summary.lines else []) %}

    <h4 class="font-medium mt-4 mb-2">Γραμμές Παραστατικού (για χαρακτηρισμό)</h4>

    {% if _lines|length > 1 %}
    <div class="overflow-auto max-h-96 border rounded">
      <table class="w-full border-collapse">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="p-2 border text-left">#</th>
            <th class="p-2 border text-left">ΦΠΑ Κατηγορία</th>
            <th class="p-2 border text-right">Ποσό</th>
            <th class="p-2 border text-right">ΦΠΑ</th>
            <th class="p-2 border text-left">Κατηγορία Εξόδου</th>
          </tr>
        </thead>
        <tbody id="linesTableBody">
          {% for line in _lines %}
          {% set lid = line.id if line.id is defined else (line.line_id if line.line_id is defined else 'l' ~ loop.index0) %}
          {% set amt = line.amount if line.amount is defined else (line.lineTotal if line.lineTotal is defined else '') %}
          {% set vatv = line.vat if line.vat is defined else (line.vatRate if line.vatRate is defined else '') %}
          {% set vat_cat = line.vatCategory if line.vatCategory is defined else (line.vat_category if line.vat_category is defined else '') %}
          {% set cat = line.category if line.category is defined else '' %}
          <tr data-line-id="{{ lid }}" data-vat="{{ vat_cat }}">
            <td class="p-2 border text-sm text-gray-600">{{ loop.index }}</td>
            <td class="p-2 border break-words">{{ vat_cat }}</td>
            <td class="p-2 border text-right">{{ amt }}</td>
            <td class="p-2 border text-right">{{ vatv }}</td>
            <td class="p-2 border">
              <select class="expense-category p-1 border rounded w-full" data-line-id="{{ lid }}">
                <option value="">-- επίλεξε --</option>
                {% for c in customer_categories %}
                  <option value="{{ c }}" {% if c == cat %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% elif _lines|length == 1 %}
      {% set single = _lines[0] %}
      {% set lid = single.id if single.id is defined else (single.line_id if single.line_id is defined else 'l0') %}
      {% set amt = single.amount if single.amount is defined else (single.lineTotal if single.lineTotal is defined else '') %}
      {% set vatv = single.vat if single.vat is defined else (single.vatRate if single.vatRate is defined else '') %}
      {% set vat_cat = single.vatCategory if single.vatCategory is defined else (single.vat_category if single.vat_category is defined else '') %}
      {% set selected_cat = single.category if single.category is defined else '' %}

      <div id="singleLine"
           class="border rounded p-4"
           data-line-id="{{ lid }}"
           data-amount="{{ amt }}"
           data-vat="{{ vatv }}"
           data-vatcat="{{ vat_cat|e }}">
        <div class="mb-3 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div><strong>ΦΠΑ Κατηγορία</strong><div>{{ vat_cat }}</div></div>
          <div><strong>Ποσό</strong><div>{{ amt }}</div></div>
          <div><strong>ΦΠΑ</strong><div>{{ vatv }}</div></div>
        </div>

        <div class="mb-3">
          <strong>Επίλεξε Κατηγορία Εξόδου</strong>
          <div id="categoryButtons" class="mt-2 flex flex-wrap gap-2">
            {% for c in customer_categories %}
              <button type="button"
                      class="category-btn px-3 py-2 border rounded hover:bg-sky-50 {% if c == selected_cat %}bg-sky-600 text-white{% endif %}"
                      data-cat="{{ c }}"
                      data-line-id="{{ lid }}">
                {{ c }}
              </button>
            {% endfor %}
            <button type="button" id="clearCategory" class="px-3 py-2 border rounded text-sm ml-2">Καθαρισμός</button>
          </div>
        </div>
      </div>

    {% else %}
      <div class="mt-4 p-3 bg-yellow-50 rounded">Δεν βρέθηκαν γραμμές για αυτό το MARK.</div>
    {% endif %}

    <div class="mt-4 flex justify-between items-center">
      <div class="text-sm text-gray-600">
        Σημείωση: οι κατηγορίες προέρχονται από τα settings του πελάτη. Μπορείς να ορίσεις/επεξεργαστείς αυτές τις επιλογές στη σελίδα Credentials.
      </div>

      <div class="flex justify-end gap-2">
        <form method="POST" action="{{ url_for('save_summary') }}" id="saveSummaryForm">
          <input type="hidden" name="summary_json" id="summaryJsonInput" value='{{ modal_summary | tojson | safe }}'>
          <button type="submit" class="bg-sky-600 text-white px-3 py-2 rounded">Αποθήκευση στο Cache</button>
        </form>
        <button id="modalCloseBtn" class="px-3 py-2 border rounded">Κλείσιμο</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

{# --- Repeat mapping modal (dynamic, populated by JS) --- #}
<div id="repeatMappingModal" class="fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4" style="display:none;">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Επαναληπτική αντιστοίχιση κατηγοριών</h3>
      <button id="repeatModalCloseX" class="text-gray-500 text-xl font-bold">✕</button>
    </div>

    <div id="repeatModalBody" class="space-y-3">
      <div class="text-sm text-gray-600">Επίλεξε για κάθε ΦΠΑ-κατηγορία ποια κατηγορία εξόδου θέλεις να χρησιμοποιείται επαναληπτικά. Μπορείς επίσης να ορίσεις <em>προεπιλογή</em>.</div>
      <!-- JS θα γεμίσει εδώ -->
      <div id="repeatMappingList" class="space-y-2"></div>
    </div>

    <div class="mt-4 flex justify-end gap-2">
      <button id="repeatModalCancel" class="px-3 py-2 border rounded">Άκυρο</button>
      <button id="repeatModalSave" class="bg-sky-600 text-white px-3 py-2 rounded">Αποθήκευση</button>
    </div>
  </div>
</div>

{% if modal_warning %}
<div id="afmWarningModal" class="fixed inset-0 flex items-center justify-center bg-black/40 z-50 overflow-auto p-4" style="display:none;">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-red-600">Προειδοποίηση AFM</h3>
    </div>
    <div class="mb-4 text-gray-700">
      {{ modal_warning }}
    </div>
    <div class="flex justify-end gap-2">
      <button id="afmModalConfirm" class="bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700">Κατάλαβα</button>
    </div>
  </div>
</div>
{% endif %}

{# Flash container (JS will inject messages here) #}
<div id="clientFlashContainer" class="fixed top-4 right-4 z-60"></div>

{% include 'list_inner.html' %}
{% endblock %}

{% block scripts %}
<script>
const SEARCH_BASE_URL = "{{ url_for('search') }}";
const VAT = "{{ vat or '' }}"; // active vat from server
const INITIAL_MARK = "{{ mark|e }}"; // αρχική τιμή mark (αν υπήρχε)
 // initial categories passed from server as fallback; will be overridden if API returns expense_tags
let CUSTOMER_CATEGORIES = (function(){ try { return {{ customer_categories | tojson | safe }} || []; } catch(e){ return []; } })();

// Helper: show transient flash (client-side)
function showFlash(message, type='info', timeout=3000){
  try {
    const container = document.getElementById('clientFlashContainer');
    if(!container) return;
    const el = document.createElement('div');
    el.className = 'mb-2 p-3 rounded shadow text-sm';
    if(type === 'success') el.classList.add('bg-green-50', 'text-green-800');
    else if(type === 'error') el.classList.add('bg-red-50', 'text-red-800');
    else el.classList.add('bg-gray-50', 'text-gray-800');
    el.innerText = message;
    container.appendChild(el);
    setTimeout(()=>{ try{ el.style.opacity='0'; setTimeout(()=>el.remove(), 300); }catch(e){} }, timeout);
  } catch(e){ console.warn('showFlash failed', e); }
}

// Helper API calls
async function apiGetRepeatEntry(vat){
  try {
    const url = '/api/repeat_entry/get' + (vat ? ('?vat=' + encodeURIComponent(vat)) : '');
    const res = await fetch(url, { credentials: 'same-origin' });
    if (!res.ok) return { ok: false };
    return await res.json();
  } catch(e){
    console.warn('apiGetRepeatEntry failed', e);
    return { ok: false };
  }
}
async function apiSaveRepeatEntry(enabled, mapping, vat){
  try {
    const res = await fetch('/api/repeat_entry/save', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'same-origin',
      body: JSON.stringify({ enabled: !!enabled, mapping: mapping || {}, vat: vat || VAT })
    });
    if(!res.ok) {
      const txt = await res.text().catch(()=>null);
      return { ok: false, status: res.status, body: txt };
    }
    return await res.json();
  } catch(e){
    console.warn('apiSaveRepeatEntry failed', e);
    return { ok: false, error: String(e) };
  }
}

function removeForceEditParamFromUrl(){
  try {
    const url = new URL(window.location.href);
    if (url.searchParams.has('force_edit')) {
      url.searchParams.delete('force_edit');
      history.replaceState(null, '', url.pathname + (url.search ? ('?' + url.searchParams.toString()) : '') + url.hash);
    }
  } catch(e){ console.warn('removeForceEditParamFromUrl failed', e); }
}

document.addEventListener('DOMContentLoaded', function(){
  // ---------- DOM references ----------
  const repeatSwitch = document.getElementById('repeatEntrySwitch');
  const editRepeatBtn = document.getElementById('editRepeatMappingBtn');
  const repeatModal = document.getElementById('repeatMappingModal');
  const repeatModalList = document.getElementById('repeatMappingList');
  const repeatModalSave = document.getElementById('repeatModalSave');
  const repeatModalCancel = document.getElementById('repeatModalCancel');
  const repeatModalCloseX = document.getElementById('repeatModalCloseX');
  const summaryInput = document.getElementById('summaryJsonInput'); // may be null
  const saveSummaryForm = document.getElementById('saveSummaryForm');

  // --- ensure search icon behaves same as input clear/submit ---
(function wireSearchIconBehavior(){
  const mi = document.getElementById('markInput');
  if (!mi) return;

  // πιθανές selectors για το icon — πρόσθεσε εδώ άλλους αν το HTML σου χρησιμοποιεί διαφορετικό
  const possibleSelectors = [
    '.icon-search',      // συνηθισμένο custom class
    '.btn-search',       // γενικό
    '#searchIcon',       // id
    '.fa-search',        // font-awesome icon
    '.magnifier',        // άλλο πιθανό
    'button[aria-label="search"]',
    'button[data-action="search"]'
  ];

  let found = null;
  for (const sel of possibleSelectors) {
    const el = document.querySelector(sel);
    if (el) { found = el; break; }
  }

  // αν δεν βρέθηκε κανένα, δοκίμασε να βρεις το icon δίπλα στο κουμπί "διαγραφή επιλεγμένων"
  if (!found) {
    const delBtn = document.querySelector('button#deleteSelected, button.delete-selected, button[data-action="delete-selected"]');
    if (delBtn && delBtn.parentElement) {
      // ψάχνουμε για ένα button/img/svg δίπλα του
      const sibling = delBtn.parentElement.querySelector('button, a, svg, i');
      if (sibling && sibling !== delBtn) found = sibling;
    }
  }

  if (!found) return; // τίποτα να συλλάβουμε

  found.addEventListener('click', function(e){
    try {
      // Αν το icon πρέπει να *καθαρίσει* το πεδίο:
      // α) καθάρισε την τιμή
      mi.value = '';
      // β) εκπέμπουμε input/keyup events ώστε οποιοδήποτε listener (το maybeRestore) να τρέξει
      mi.dispatchEvent(new Event('input', { bubbles: true }));
      mi.dispatchEvent(new KeyboardEvent('keyup', { bubbles: true, key: 'Backspace' }));

      // γ) επιπλέον: αν υπάρχει DataTables active search, καθάρισε και την DataTables αναζήτηση
      if (window.jQuery && jQuery.fn && jQuery.fn.dataTable) {
        try {
          const dt = $('.summary-table').DataTable();
          dt.search('').columns().search('').draw();
        } catch(ignore){}
      }
    } catch(err){
      console.warn('search icon handler failed', err);
    }
    // αν το icon κανονικά υποβάλλει φόρμα, αφήνουμε την default συμπεριφορά να τρέξει
  });
})();


  // detect vat keys in summary
  function detectVatKeysFromSummary(){
    if(summaryInput && summaryInput.value){
      try {
        const obj = JSON.parse(summaryInput.value || '{}');
        const lines = Array.isArray(obj.lines) ? obj.lines : [];
        const set = new Set();
        lines.forEach(l => {
          const key = (l.vatCategory || l.vat_category || l.vat || '').toString().trim();
          if(key) set.add(key);
        });
        if(set.size) return Array.from(set);
      } catch(e){ /* ignore */ }
    }
    return ['0%','6%','13%','24%'];
  }

  // Build repeat modal UI given an existing mapping (object)
  function buildRepeatModalUI(existingMapping){
    repeatModalList.innerHTML = '';
    const vatKeys = detectVatKeysFromSummary();
    const mapping = existingMapping || {};
    // default row
    const defaultRow = document.createElement('div');
    defaultRow.className = 'flex items-center gap-3';
    defaultRow.innerHTML = `<div class="w-36 text-sm font-medium">Προεπιλογή</div>`;
    const defaultSelect = document.createElement('select');
    defaultSelect.className = 'p-1 border rounded flex-1';
    const opt0 = document.createElement('option'); opt0.value=''; opt0.innerText='-- (κανένα) --'; defaultSelect.appendChild(opt0);
    CUSTOMER_CATEGORIES.forEach(c=>{
      const o = document.createElement('option'); o.value = c; o.innerText = c;
      if(mapping['__default'] === c) o.selected = true;
      defaultSelect.appendChild(o);
    });
    defaultRow.appendChild(defaultSelect);
    repeatModalList.appendChild(defaultRow);

    vatKeys.forEach(vk=>{
      const row = document.createElement('div');
      row.className = 'flex items-center gap-3';
      const label = document.createElement('div');
      label.className = 'w-36 text-sm font-medium';
      label.innerText = vk || '(άγνωστο)';
      const sel = document.createElement('select');
      sel.className = 'p-1 border rounded flex-1';
      const oEmpty = document.createElement('option'); oEmpty.value=''; oEmpty.innerText='-- (προεπιλογή) --'; sel.appendChild(oEmpty);
      CUSTOMER_CATEGORIES.forEach(c=>{
        const o=document.createElement('option'); o.value=c; o.innerText=c;
        if(mapping[vk] === c) o.selected = true;
        sel.appendChild(o);
      });
      row.appendChild(label);
      row.appendChild(sel);
      repeatModalList.appendChild(row);
    });
  }

  function openRepeatModalWithMapping(mapping){
    buildRepeatModalUI(mapping || {});
    repeatModal.style.display = 'flex';
  }
  function closeRepeatModal(){ repeatModal.style.display = 'none'; }

  // collect mapping from modal selects
  function collectMappingFromModal(){
    const mapping = {};
    const selects = repeatModalList.querySelectorAll('select');
    if(selects.length){
      const first = selects[0];
      if(first && first.value) mapping['__default'] = first.value;
      const vatKeys = detectVatKeysFromSummary();
      for(let i=1;i<selects.length;i++){
        const sel = selects[i];
        const vatKey = vatKeys[i-1];
        if(sel && sel.value) mapping[vatKey] = sel.value;
      }
    }
    return mapping;
  }

  // apply given mapping to summary JSON and submit saveSummaryForm
  function applyMappingToSummaryAndSubmitUsingMapping(mapping){
    if(!summaryInput || !saveSummaryForm) return false;
    try {
      const data = JSON.parse(summaryInput.value || '{}');
      if(!Array.isArray(data.lines)) data.lines = [];
      data.lines = data.lines.map(l => {
        const vatKey = (l.vatCategory || l.vat_category || l.vat || '').toString().trim();
        if(mapping && mapping[vatKey]) l.category = mapping[vatKey];
        else if(mapping && mapping.__default) l.category = mapping.__default;
        return l;
      });
      summaryInput.value = JSON.stringify(data);
      saveSummaryForm.submit();
      return true;
    } catch(e){
      console.warn('applyMappingToSummaryAndSubmitUsingMapping error', e);
      return false;
    }
  }

  // ---------- Initialization: load server repeat_entry config ----------
  (async function initRepeatEntry(){
    try {
      const resp = await apiGetRepeatEntry(VAT);
      if(resp && resp.ok){
        const repeat = resp.repeat_entry || { enabled: false, mapping: {} };
        // if server provided expense_tags (e.g. from save), update categories
        if(resp.expense_tags && Array.isArray(resp.expense_tags) && resp.expense_tags.length){
          CUSTOMER_CATEGORIES = resp.expense_tags.slice();
        }
        const enabled = !!repeat.enabled;
        const mapping = repeat.mapping || {};

        if(repeatSwitch){
          repeatSwitch.checked = enabled;
          // show edit button if mapping exists
          if(mapping && Object.keys(mapping).length) editRepeatBtn.classList.remove('hidden');
          repeatSwitch.addEventListener('change', async function(){
            const now = this.checked;
            // if enabling and no mapping -> open modal to create mapping
            if(now){
              if(!mapping || Object.keys(mapping).length === 0){
                // open modal letting user create mapping
                openRepeatModalWithMapping({});
              } else {
                // mapping exists -> keep edit button visible
                editRepeatBtn.classList.remove('hidden');
              }
            } else {
              editRepeatBtn.classList.add('hidden');
            }
            // Persist enabled flag immediately (keep mapping as-is)
            const saveResp = await apiSaveRepeatEntry(now, mapping, VAT);
            if(saveResp && saveResp.ok){
              showFlash('Ενημερώθηκε η ρύθμιση επαναληπτικής εισαγωγής.', 'success');
              // if server returned expense_tags update local categories
              if(saveResp.expense_tags && Array.isArray(saveResp.expense_tags) && saveResp.expense_tags.length){
                CUSTOMER_CATEGORIES = saveResp.expense_tags.slice();
              }
            } else {
              showFlash('Αποτυχία αποθήκευσης ρύθμισης.', 'error');
            }
          });
        }

        // If repeat enabled and mapping exists and modal_summary present -> auto apply mapping now
        if(enabled && mapping && Object.keys(mapping).length && summaryInput){
          const did = applyMappingToSummaryAndSubmitUsingMapping(mapping);
          if(did){
            // hide summary modal if it would open
            const sm = document.getElementById('summaryModal');
            if(sm) sm.style.display = 'none';
          }
        }

        // Wire edit button
        if(editRepeatBtn){
          editRepeatBtn.classList.toggle('hidden', !mapping || Object.keys(mapping).length===0);
          editRepeatBtn.addEventListener('click', function(){
            openRepeatModalWithMapping(mapping);
          });
        }
      } else {
        // fallback: switch off
        if(repeatSwitch) repeatSwitch.checked = false;
      }
    } catch(e){
      console.warn('initRepeatEntry failed', e);
    }
  })();

  // ---------- modal handlers ----------
  repeatModalCloseX?.addEventListener('click', closeRepeatModal);
  repeatModalCancel?.addEventListener('click', closeRepeatModal);

  repeatModalSave?.addEventListener('click', async function(){
    // collect mapping
    const mapping = collectMappingFromModal();
    // persist to backend and enable repeat
    const resp = await apiSaveRepeatEntry(true, mapping, VAT);
    if(resp && resp.ok){
      // update categories if server returned expense_tags
      if(resp.expense_tags && Array.isArray(resp.expense_tags) && resp.expense_tags.length){
        CUSTOMER_CATEGORIES = resp.expense_tags.slice();
      }
      // make sure switch is on and edit button visible
      if(repeatSwitch) repeatSwitch.checked = true;
      editRepeatBtn.classList.remove('hidden');
      showFlash('Αποθηκεύτηκαν οι ρυθμίσεις επαναληπτικής εισαγωγής.', 'success');
      closeRepeatModal();
      // if there's a modal_summary currently open, apply mapping immediately
      if(summaryInput){
        applyMappingToSummaryAndSubmitUsingMapping(mapping);
      }
    } else {
      // log and notify user minimally
      console.warn('Failed saving repeat mapping', resp);
      showFlash('Αποτυχία αποθήκευσης ρυθμίσεων επαναληπτικής εισαγωγής.', 'error');
    }
  });

  // ---------- existing original JS (dismiss banner, force edit, summary modal wiring, etc) ----------
  const forceBtn = document.getElementById('forceEditBtn');
  const markInput = document.getElementById('markInput');
  const existingBanner = document.getElementById('existingBanner');
  const dismissBannerBtn = document.getElementById('dismissBannerBtn');

  if(dismissBannerBtn){
    dismissBannerBtn.addEventListener('click', function(){ if(existingBanner) existingBanner.style.display = 'none'; });
  }

  if (forceBtn){
    forceBtn.addEventListener('click', function(){
      const markValRaw = (markInput && markInput.value) ? markInput.value.trim() : '{{ mark or "" }}';
      const markVal = encodeURIComponent(markValRaw || '');
      if (!markVal){ alert('Δεν δόθηκε MARK για επιβεβαίωση.'); return; }
      if (confirm('Θες σίγουρα να επαναχαρακτηρίσεις το MARK και να ανοίξει η φόρμα επεξεργασίας;')) {
        if(existingBanner) existingBanner.style.display = 'none';
        window.location = SEARCH_BASE_URL + '?mark=' + markVal + '&force_edit=1';
      }
    });
  }

  const modal = document.getElementById('summaryModal');
  const modalCloseBtns = Array.from(document.querySelectorAll('#modalCloseX, #modalCloseBtn'));
  modalCloseBtns.forEach(b => b?.addEventListener('click', function(){
    if(modal) modal.style.display = 'none';
    removeForceEditParamFromUrl();
  }));

  {% if modal_summary and (request.args.get('force_edit') == '1' or not allow_edit_existing) %}
    setTimeout(()=>{
      const m = document.getElementById('summaryModal');
      if (m) { m.style.display = 'flex'; removeForceEditParamFromUrl(); }
    }, 80);
  {% endif %}

  {% if modal_warning %}
  const afmModal = document.getElementById('afmWarningModal');
  const afmModalBtn = document.getElementById('afmModalConfirm');
  if (afmModal && afmModalBtn){
    setTimeout(()=>{ afmModal.style.display = 'flex'; }, 50);
    afmModalBtn.addEventListener('click', function(){ afmModal.style.display = 'none'; });
  }
  {% endif %}

  // --- the rest of your existing summary wiring (no changes) ---
  if (summaryInput){
    try {
      let summaryData = JSON.parse(summaryInput.value || '{}');
      if (!Array.isArray(summaryData.lines)) summaryData.lines = [];
      summaryData.lines = summaryData.lines.map(l => {
        if (!l) return {id:'', description:'', amount:'', vat:'', category:'', vatCategory:''};
        l.id = (l.id!==undefined)?String(l.id):(l.line_id!==undefined?String(l.line_id):'');
        l.category = l.category || l.cat || l.line_category || l['κατηγορία'] || '';
        return l;
      });

      document.querySelectorAll('#linesTableBody tr[data-line-id]').forEach(tr => {
        const lid = String(tr.dataset.lineId || '');
        const sel = tr.querySelector('select.expense-category');
        if (!sel) return;
        let existing = summaryData.lines.find(x => String(x.id) === lid);
        if (!existing){
          existing = {id: lid, category: ''};
          summaryData.lines.push(existing);
        }
        sel.value = existing.category || '';
        sel.addEventListener('change', function(){ existing.category = sel.value; summaryInput.value = JSON.stringify(summaryData); });
      });

      const singleLine = document.getElementById('singleLine');
      if (singleLine){
        const lid = String(singleLine.dataset.lineId || '');
        let existing = summaryData.lines.find(x => String(x.id) === lid);
        if (!existing){
          existing = {id: lid, category: ''};
          summaryData.lines.push(existing);
        }
        const buttons = document.querySelectorAll('#categoryButtons .category-btn');
        function markActive(cat){
          buttons.forEach(b => {
            b.classList.toggle('bg-sky-600', b.dataset.cat === cat);
            b.classList.toggle('text-white', b.dataset.cat === cat);
          });
        }
        if (existing.category) markActive(existing.category);
        buttons.forEach(btn => {
          btn.addEventListener('click', function(){
            const cat = this.dataset.cat;
            existing.category = (existing.category === cat) ? '' : cat;
            markActive(existing.category);
            summaryInput.value = JSON.stringify(summaryData);
          });
        });
        const clearBtn = document.getElementById('clearCategory');
        clearBtn?.addEventListener('click', function(){
          existing.category = '';
          markActive('');
          summaryInput.value = JSON.stringify(summaryData);
        });
      }
      summaryInput.value = JSON.stringify(summaryData);
    } catch(e){
      console.warn('summary JSON parse/normalize error', e);
    }
  }

  // the table / datatables logic code (kept unchanged)
  const hasTable = document.querySelector('.summary-table') !== null;
  if (hasTable){
    const jq = window.jQuery;
    const dtAvail = jq && jq.fn && jq.fn.dataTable;
    if (dtAvail){
      try {
        const dt = $('.summary-table').DataTable({
          paging: true,
          scrollY: '55vh',
          scrollX: true,
          scrollCollapse: true,
          fixedHeader: { header: true, headerOffset: 0 },
          colReorder: true,
          autoWidth: false,
          columnDefs: [{ orderable: false, targets: 0 }]
        });
        if (typeof dt.colResize === 'function') {
          try { dt.colResize({ resizeMode: 'flex' }); } catch(e){ console.warn('colResize failed', e); }
        }
        const globalSearch = document.getElementById('globalSearch');
        if (globalSearch){
          globalSearch.addEventListener('input', function(){ dt.search(this.value).draw(); });
        }
        setTimeout(()=>{ try{ dt.columns.adjust().draw(); }catch(e){} }, 120);
      } catch(e){
        console.warn('DataTables init failed — falling back', e);
      }
    } else {
      const globalSearch = document.getElementById('globalSearch');
      if (globalSearch){
        globalSearch.addEventListener('input', function(){
          const q = this.value.toLowerCase();
          document.querySelectorAll('.summary-table tbody tr').forEach(tr => {
            tr.style.display = tr.textContent.toLowerCase().indexOf(q) !== -1 ? '' : 'none';
          });
        });
      }
    }

    try {
      const anyCheckbox = document.querySelector('input[name="delete_mark"]');
      if (anyCheckbox){
        const firstTh = document.querySelector('.summary-table thead th');
        if (firstTh && !document.getElementById('selectAll')){
          const chk = document.createElement('input');
          chk.type = 'checkbox'; chk.id = 'selectAll'; chk.title = 'Επιλογή όλων';
          chk.style.marginRight = '6px';
          firstTh.prepend(chk);
          chk.addEventListener('change', function(){ document.querySelectorAll('input[name="delete_mark"]').forEach(cb => cb.checked = this.checked); });
        }
        const headers = Array.from(document.querySelectorAll('.summary-table thead th')).map(h => h.innerText.trim().toLowerCase());
        let markIdx = headers.findIndex(h => h.includes('mark'));
        if (markIdx === -1) markIdx = headers.findIndex(h => h.includes('αφμ') || h.includes('afm'));
        if (markIdx >= 0){
          document.querySelectorAll('.summary-table tbody tr').forEach(row => {
            const cb = row.querySelector('input[name="delete_mark"]');
            if (cb){
              const td = row.querySelectorAll('td')[markIdx];
              if (td){
                const v = td.innerText.trim();
                if (v) cb.value = v;
              }
            }
          });
        }
      }
    } catch(e){ console.warn('select-all / mark mapping error', e); }
  }

  // --- new: restore table / reload when markInput cleared ---
// restore full table + selection/checkbox state when search input is cleared
// --- new: restore table / reload when markInput cleared ---
(function wireRobustClearRestore(){
  // reuse already-declared markInput if present, otherwise query it
  const mi = (typeof markInput !== 'undefined' && markInput) ? markInput : document.getElementById('markInput');
  if (!mi) return;

  // debounce timer
  let t = null;
  // store last observed value to detect programmatic clears as well
  let lastVal = mi.value || '';

  function restoreAllRowsAndUi(){
    try {
      if (window.jQuery && jQuery.fn && jQuery.fn.dataTable) {
        try {
          const dt = $('.summary-table').DataTable();
          dt.search('').columns().search('').draw();
          // ensure nodes visible
          try {
            dt.rows().nodes().to$().each(function(){ this.style.display = ''; });
          } catch(e){ /* ignore */ }
          try { dt.columns.adjust().draw(false); } catch(e){ /* ignore */ }
        } catch(e) {
          console.warn('DataTables restore failed, falling back to DOM restore', e);
          document.querySelectorAll('.summary-table tbody tr').forEach(tr => tr.style.display = '');
        }
      } else {
        document.querySelectorAll('.summary-table tbody tr').forEach(tr => tr.style.display = '');
      }

      // reset select-all checkbox if exists
      const selectAll = document.getElementById('selectAll') || document.querySelector('.summary-table thead input[type="checkbox"]#selectAll');
      if (selectAll) selectAll.checked = false;

      // dispatch event so other code can react
      const evt = new Event('tableRestored');
      document.querySelectorAll('.summary-table').forEach(t => t.dispatchEvent(evt));
    } catch(err){
      console.warn('restoreAllRowsAndUi failed', err);
    }
  }

  function maybeRestore(){
    clearTimeout(t);
    t = setTimeout(()=>{
      try {
        const v = (mi.value || '').trim();
        // only trigger when field became empty (either by user or programmatic change)
        if (v === '' && (lastVal && lastVal.trim() !== '')) {
          // If page initially had a server-side MARK, do a reload to fetch full table
          try {
            if (typeof INITIAL_MARK !== 'undefined' && INITIAL_MARK && INITIAL_MARK.trim() !== '') {
              // if current URL already has mark param, go to base search (no params)
              const cur = new URL(window.location.href);
              if (cur.searchParams.has('mark') || cur.searchParams.has('force_edit')) {
                window.location = SEARCH_BASE_URL;
                return;
              }
            }
          } catch(e){ /* ignore URL errors and fallthrough to client restore */ }

          // fallback to client-side restore
          restoreAllRowsAndUi();
        }
        lastVal = v;
      } catch(e){
        console.warn(e);
      }
    }, 150);
  }

  // wire events likely to change input value
  mi.addEventListener('input', maybeRestore);
  mi.addEventListener('keyup', maybeRestore);
  mi.addEventListener('paste', function(){ setTimeout(maybeRestore, 50); });
  mi.addEventListener('cut', function(){ setTimeout(maybeRestore, 50); });
  mi.addEventListener('blur', maybeRestore);

  // also poll occasionally for programmatic changes (lightweight)
  let pollInterval = null;
  try {
    pollInterval = setInterval(() => {
      const current = (mi.value || '').trim();
      if (current !== (lastVal || '').trim()) {
        maybeRestore();
      }
    }, 300);

    window.addEventListener('beforeunload', () => {
      if (pollInterval) clearInterval(pollInterval);
    });
  } catch(e){
    // ignore poll setup errors
  }
})();




});
</script>

{% endblock %}
