{% extends "base.html" %}
{% block title %}Αναζήτηση MARK{% endblock %}

{% block content %}
<div class="bg-white rounded shadow p-6">
  <h2 class="text-lg font-semibold mb-2">Αναζήτηση MARK</h2>

  {% if error %}
    <div class="mb-3 p-2 rounded bg-red-50 text-red-800">{{ error }}</div>
  {% endif %}

  <form method="post" class="flex gap-6 items-center flex-wrap" id="markSearchForm">
    <!-- MARK input + submit -->
    <div class="flex items-center gap-2 flex-1 min-w-[250px]">
      <input name="mark" id="markInput" type="text" placeholder="15ψήφιο MARK"
             class="p-2 border rounded w-full" value="{{ mark }}">
      <button type="submit" class="bg-sky-600 text-white px-3 py-2 rounded">Αναζήτηση</button>
    </div>

    <!-- Toggle switches -->
    <div class="flex items-center gap-6 flex-wrap">
      <!-- Τιμολόγια / Αποδείξεις -->
      <label for="docsToggle" class="flex items-center gap-2 cursor-pointer text-sm">
        <span>Τιμολόγια</span>
        <div class="relative inline-block w-11 h-6">
          <input type="checkbox" id="docsToggle" class="sr-only peer" {% if request.args.get('use_receipts') == '1' %}checked{% endif %}>
          <div class="w-full h-6 bg-gray-200 rounded-full peer-checked:bg-sky-600 transition-colors"></div>
          <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transform transition-transform peer-checked:translate-x-5"></div>
        </div>
        <span>Αποδείξεις</span>
      </label>

      <!-- Επαναληψιμη εισαγωγή -->
      <label for="repeatEntrySwitch" class="flex items-center gap-2 cursor-pointer text-sm">
        <span>Επαναληψιμη εισαγωγή</span>
        <div class="relative inline-block w-11 h-6">
          <input type="checkbox" id="repeatEntrySwitch" class="sr-only peer" {% if repeat_entry_enabled %}checked{% endif %}>
          <div class="w-full h-6 bg-gray-200 rounded-full peer-checked:bg-sky-600 transition-colors"></div>
          <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transform transition-transform peer-checked:translate-x-5"></div>
        </div>
      </label>
      <button type="button" id="editRepeatMappingBtn" class="px-2 py-1 border rounded text-sm hidden">Επεξεργασία</button>
    </div>
  </form>
</div>

{# --- Yellow box αν υπάρχει MARK ήδη στο Excel --- #}
{% if allow_edit_existing and not request.args.get('force_edit') %}
<div class="mt-4 p-4 bg-yellow-50 rounded border border-yellow-300 text-yellow-800" id="existingBanner">
  Το MARK <strong>{{ mark }}</strong> υπάρχει ήδη στο Excel. Θέλεις να τροποποιήσεις τον χαρακτηρισμό;
  <div class="mt-2 flex gap-2">
    <button id="forceEditBtn" type="button" class="bg-yellow-600 text-white px-3 py-2 rounded hover:bg-yellow-700">
      Επιβεβαίωση
    </button>
    <button id="dismissBannerBtn" type="button" onclick="this.parentElement.parentElement.style.display='none'"
            class="px-3 py-2 border rounded hover:bg-gray-50">
      Άκυρο
    </button>
  </div>
</div>
{% endif %}

{# --- Summary modal (invoices) --- #}
{% if modal_summary and (request.args.get('force_edit') == '1' or not allow_edit_existing) %}
<div id="summaryModal" class="fixed inset-0 flex items-center justify-center bg-black/40 z-50 overflow-auto p-4" style="display:none;">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">
        Περίληψη Παραστατικού - MARK {{ modal_summary.mark or modal_summary.get('mark','') }}
      </h3>
      <button id="modalCloseX" class="text-gray-500 text-xl font-bold">✕</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
      <div><strong>Α/Α Παραστατικού</strong><div>{{ modal_summary.AA or modal_summary.get('AA','') }}</div></div>
      <div><strong>ΑΦΜ</strong><div>{{ modal_summary.AFM or modal_summary.get('AFM_issuer','') }}</div></div>
      <div><strong>Επωνυμία</strong><div>{{ modal_summary.Name or modal_summary.get('Name','') }}</div></div>
      <div><strong>Ημερομηνία</strong><div>{{ modal_summary.issueDate or modal_summary.get('issueDate','') }}</div></div>
      <div><strong>Τύπος Παραστατικού</strong><div>{{ modal_summary.type_name or modal_summary.get('type_name','') }}</div></div>
      <div><strong>Καθαρή Αξία</strong><div>{{ modal_summary.totalNetValue or modal_summary.get('totalNetValue','') }}</div></div>
      <div><strong>ΦΠΑ</strong><div>{{ modal_summary.totalVatAmount or modal_summary.get('totalVatAmount','') }}</div></div>
      <div><strong>Σύνολο</strong><div>{{ modal_summary.totalValue or modal_summary.get('totalValue','') }}</div></div>
    </div>

    {% set _lines = invoice_lines if invoice_lines is defined and invoice_lines else (modal_summary.lines if modal_summary.lines is defined and modal_summary.lines else []) %}

    <h4 class="font-medium mt-4 mb-2">Γραμμές Παραστατικού (για χαρακτηρισμό)</h4>

    {% if _lines|length > 1 %}
    <div class="overflow-auto max-h-96 border rounded">
      <table class="w-full border-collapse">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="p-2 border text-left">#</th>
            <th class="p-2 border text-left">ΦΠΑ Κατηγορία</th>
            <th class="p-2 border text-right">Ποσό</th>
            <th class="p-2 border text-right">ΦΠΑ</th>
            <th class="p-2 border text-left">Κατηγορία Εξόδου</th>
          </tr>
        </thead>
        <tbody id="linesTableBody">
          {% for line in _lines %}
          {% set lid = line.id if line.id is defined else (line.line_id if line.line_id is defined else 'l' ~ loop.index0) %}
          {% set amt = line.amount if line.amount is defined else (line.lineTotal if line.lineTotal is defined else '') %}
          {% set vatv = line.vat if line.vat is defined else (line.vatRate if line.vatRate is defined else '') %}
          {% set vat_cat = line.vatCategory if line.vatCategory is defined else (line.vat_category if line.vat_category is defined else '') %}
          {% set cat = line.category if line.category is defined else '' %}
          <tr data-line-id="{{ lid }}" data-vat="{{ vat_cat }}">
            <td class="p-2 border text-sm text-gray-600">{{ loop.index }}</td>
            <td class="p-2 border break-words">{{ vat_cat }}</td>
            <td class="p-2 border text-right">{{ amt }}</td>
            <td class="p-2 border text-right">{{ vatv }}</td>
            <td class="p-2 border">
              <select class="expense-category p-1 border rounded w-full" data-line-id="{{ lid }}">
                <option value="">-- επίλεξε --</option>
                {% for c in customer_categories %}
                  <option value="{{ c }}" {% if c == cat %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% elif _lines|length == 1 %}
      {% set single = _lines[0] %}
      {% set lid = single.id if single.id is defined else (single.line_id if single.line_id is defined else 'l0') %}
      {% set amt = single.amount if single.amount is defined else (single.lineTotal if single.lineTotal is defined else '') %}
      {% set vatv = single.vat if single.vat is defined else (single.vatRate if single.vatRate is defined else '') %}
      {% set vat_cat = single.vatCategory if single.vatCategory is defined else (single.vat_category if single.vat_category is defined else '') %}
      {% set selected_cat = single.category if single.category is defined else '' %}

      <div id="singleLine"
           class="border rounded p-4"
           data-line-id="{{ lid }}"
           data-amount="{{ amt }}"
           data-vat="{{ vatv }}"
           data-vatcat="{{ vat_cat|e }}">
        <div class="mb-3 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div><strong>ΦΠΑ Κατηγορία</strong><div>{{ vat_cat }}</div></div>
          <div><strong>Ποσό</strong><div>{{ amt }}</div></div>
          <div><strong>ΦΠΑ</strong><div>{{ vatv }}</div></div>
        </div>

        <div class="mb-3">
          <strong>Επίλεξε Κατηγορία Εξόδου</strong>
          <div id="categoryButtons" class="mt-2 flex flex-wrap gap-2">
            {% for c in customer_categories %}
              <button type="button"
                      class="category-btn px-3 py-2 border rounded hover:bg-sky-50 {% if c == selected_cat %}bg-sky-600 text-white{% endif %}"
                      data-cat="{{ c }}"
                      data-line-id="{{ lid }}">
                {{ c }}
              </button>
            {% endfor %}
            <button type="button" id="clearCategory" class="px-3 py-2 border rounded text-sm ml-2">Καθαρισμός</button>
          </div>
        </div>
      </div>
    {% else %}
      <div class="mt-4 p-3 bg-yellow-50 rounded">Δεν βρέθηκαν γραμμές για αυτό το MARK.</div>
    {% endif %}

    <div class="mt-4 flex justify-between items-center">
      <div class="text-sm text-gray-600">
        Σημείωση: οι κατηγορίες προέρχονται από τα settings του πελάτη. Μπορείς να ορίσεις/επεξεργαστείς αυτές τις επιλογές στη σελίδα Credentials.
      </div>

      <div class="flex justify-end gap-2">
        <form method="POST" action="{{ url_for('save_summary') }}" id="saveSummaryForm">
          <input type="hidden" name="summary_json" id="summaryJsonInput" value='{{ modal_summary | tojson | safe }}'>
          <button type="submit" class="bg-sky-600 text-white px-3 py-2 rounded">Αποθήκευση στο Cache</button>
        </form>
        <button id="modalCloseBtn" class="px-3 py-2 border rounded">Κλείσιμο</button>
      </div>
    </div>
  </div>
</div>
{% endif %}


{# ---------------- Receipts modal (προβολή & save) ---------------- #}
<div id="receiptsModal" class="fixed inset-0 flex items-center justify-center bg-black/40 z-55 overflow-auto p-4" style="display:none;">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl p-4">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Αποδείξεις — Περίληψη</h3>
      <button id="receiptsModalCloseX" class="text-gray-500 text-xl font-bold">✕</button>
    </div>

    <div class="overflow-auto max-h-[60vh] border rounded">
      <table id="receiptsTable" class="w-full border-collapse text-sm">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="p-2 border text-left">#</th>
            <th class="p-2 border text-left">ΑΦΜ</th>
            <th class="p-2 border text-left">Επωνυμία</th>
            <th class="p-2 border text-left">Ημερομηνία</th>
            <th class="p-2 border text-left">Τύπος</th>
            <th class="p-2 border text-right">Καθαρή Αξία</th>
            <th class="p-2 border text-right">ΦΠΑ</th>
            <th class="p-2 border text-right">Σύνολο</th>
            <th class="p-2 border text-left">Κατηγορία</th>
            <th class="p-2 border text-left">Ενέργειες</th>
          </tr>
        </thead>
        <tbody id="receiptsModalBody"></tbody>
      </table>
    </div>

    <div class="mt-4 flex justify-end gap-2 items-center">
      <form method="POST" action="{{ url_for('save_receipt') }}" id="saveReceiptsForm" class="m-0 p-0">
        <input type="hidden" name="receipts_json" id="receiptsJsonInput" value='{{ modal_receipts | tojson | safe if modal_receipts is defined else "{}" }}'>
        <input type="hidden" name="doc_type" value="receipt">
        <button type="button" id="confirmReceiptsBtn" class="bg-sky-600 text-white px-4 py-2 rounded">Επιβεβαίωση Αποδείξεων</button>
      </form>

      <button id="receiptsModalCloseBtn" class="px-3 py-2 border rounded">Κλείσιμο</button>
    </div>
  </div>
</div>

{# --- Repeat mapping modal (dynamic, populated by JS) --- #}
<div id="repeatMappingModal" class="fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4" style="display:none;">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Επαναληπτική αντιστοίχιση κατηγοριών</h3>
      <button id="repeatModalCloseX" class="text-gray-500 text-xl font-bold">✕</button>
    </div>

    <div id="repeatModalBody" class="space-y-3">
      <div class="text-sm text-gray-600">Επίλεξε για κάθε ΦΠΑ-κατηγορία ποια κατηγορία εξόδου θέλεις να χρησιμοποιείται επαναληπτικά. Μπορείς επίσης να ορίσεις <em>προεπιλογή</em>.</div>
      <!-- JS θα γεμίσει εδώ -->
      <div id="repeatMappingList" class="space-y-2"></div>
    </div>

    <div class="mt-4 flex justify-end gap-2">
      <button id="repeatModalCancel" class="px-3 py-2 border rounded">Άκυρο</button>
      <button id="repeatModalSave" class="bg-sky-600 text-white px-3 py-2 rounded">Αποθήκευση</button>
    </div>
  </div>
</div>

{% if modal_warning %}
<div id="afmWarningModal" class="fixed inset-0 flex items-center justify-center bg-black/40 z-50 overflow-auto p-4" style="display:none;">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-red-600">Προειδοποίηση AFM</h3>
    </div>
    <div class="mb-4 text-gray-700">
      {{ modal_warning }}
    </div>
    <div class="flex justify-end gap-2">
      <button id="afmModalConfirm" class="bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700">Κατάλαβα</button>
    </div>
  </div>
</div>
{% endif %}

{# Flash container (JS will inject messages here) #}
<div id="clientFlashContainer" class="fixed top-4 right-4 z-60"></div>

{% include 'list_inner.html' %}
{% endblock %}

{% block scripts %}
<script>
const SEARCH_BASE_URL = "{{ url_for('search') }}";
const VAT = "{{ vat or '' }}"; // active vat from server (if any)
const INITIAL_MARK = "{{ mark|e }}"; // αρχική τιμή mark (αν υπήρχε)
let CUSTOMER_CATEGORIES = (function(){ try { return {{ customer_categories | tojson | safe }} || []; } catch(e){ return []; } })();

// Helper: show transient flash (client-side)
function showFlash(message, type='info', timeout=3000){
  try {
    const container = document.getElementById('clientFlashContainer');
    if(!container) return;
    const el = document.createElement('div');
    el.className = 'mb-2 p-3 rounded shadow text-sm';
    if(type === 'success') el.classList.add('bg-green-50', 'text-green-800');
    else if(type === 'error') el.classList.add('bg-red-50', 'text-red-800');
    else el.classList.add('bg-gray-50', 'text-gray-800');
    el.innerText = message;
    container.appendChild(el);
    setTimeout(()=>{ try{ el.style.opacity='0'; setTimeout(()=>el.remove(), 300); }catch(e){} }, timeout);
  } catch(e){ console.warn('showFlash failed', e); }
}

// API helpers for repeat mapping
async function apiGetRepeatEntry(vat){
  try {
    const url = '/api/repeat_entry/get' + (vat ? ('?vat=' + encodeURIComponent(vat)) : '');
    const res = await fetch(url, { credentials: 'same-origin' });
    if (!res.ok) return { ok: false };
    return await res.json();
  } catch(e){
    console.warn('apiGetRepeatEntry failed', e);
    return { ok: false };
  }
}
async function apiSaveRepeatEntry(enabled, mapping, vat){
  try {
    const res = await fetch('/api/repeat_entry/save', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'same-origin',
      body: JSON.stringify({ enabled: !!enabled, mapping: mapping || {}, vat: vat || VAT })
    });
    if(!res.ok) {
      const txt = await res.text().catch(()=>null);
      return { ok: false, status: res.status, body: txt };
    }
    return await res.json();
  } catch(e){
    console.warn('apiSaveRepeatEntry failed', e);
    return { ok: false, error: String(e) };
  }
}

function removeForceEditParamFromUrl(){
  try {
    const url = new URL(window.location.href);
    if (url.searchParams.has('force_edit')) {
      url.searchParams.delete('force_edit');
      history.replaceState(null, '', url.pathname + (url.search ? ('?' + url.searchParams.toString()) : '') + url.hash);
    }
  } catch(e){ console.warn('removeForceEditParamFromUrl failed', e); }
}

// safe UI update for edit button
function safeUpdateUI() {
  try {
    const rs = document.getElementById('repeatEntrySwitch');
    const ed = document.getElementById('editRepeatMappingBtn');
    const dt = document.getElementById('docsToggle');
    if (!ed) return;
    if (!rs || !dt) {
      // hide edit by default if switches missing
      ed.style.display = 'none';
      return;
    }
    ed.style.display = (rs.checked && !dt.checked) ? 'inline-block' : 'none';
  } catch(e){
    console.warn('safeUpdateUI error', e);
  }
}

// fetch helper with JSON attempts
async function fetchJson(url, opts){
  try {
    const res = await fetch(url, opts);
    const text = await res.text();
    try { return { ok: res.ok, status: res.status, payload: JSON.parse(text), raw: text }; }
    catch(e){ return { ok: res.ok, status: res.status, payload: null, raw: text }; }
  } catch(e){
    return { ok: false, error: String(e) };
  }
}

document.addEventListener('DOMContentLoaded', function(){
  // DOM references used across code
  const repeatSwitch = document.getElementById('repeatEntrySwitch');
  const editRepeatBtn = document.getElementById('editRepeatMappingBtn');
  const repeatModal = document.getElementById('repeatMappingModal');
  const repeatModalList = document.getElementById('repeatMappingList');
  const repeatModalSave = document.getElementById('repeatModalSave');
  const repeatModalCancel = document.getElementById('repeatModalCancel');
  const repeatModalCloseX = document.getElementById('repeatModalCloseX');
  const summaryInput = document.getElementById('summaryJsonInput'); // may be null
  const saveSummaryForm = document.getElementById('saveSummaryForm');

  const docsToggle = document.getElementById('docsToggle');
  const markForm = document.getElementById('markSearchForm');
  const markInput = document.getElementById('markInput');

  const receiptsModal = document.getElementById('receiptsModal');
  const receiptsModalBody = document.getElementById('receiptsModalBody');
  const receiptsJsonInput = document.getElementById('receiptsJsonInput');
  const receiptsModalCloseX = document.getElementById('receiptsModalCloseX');
  const receiptsModalCloseBtn = document.getElementById('receiptsModalCloseBtn');
  const confirmReceiptsBtn = document.getElementById('confirmReceiptsBtn');

  // endpoints (use url_for to avoid hardcoding)
  const SCRAPER_RECEIPT_URL = "{{ url_for('api_scrape_receipt') }}";
  const NEXT_RECEIPT_MARK_URL = "{{ url_for('api_next_receipt_mark') }}";
  const CONFIRM_RECEIPT_URL = "{{ url_for('api_confirm_receipt') }}";

  // initial UI
  safeUpdateUI();

  if (repeatSwitch) repeatSwitch.addEventListener('change', safeUpdateUI);
  if (docsToggle) docsToggle.addEventListener('change', safeUpdateUI);

  // --- toggle behavior: redirect to same search route with use_receipts=1 (no new backend route needed)
  function buildSearchUrl(params){
    const u = new URL(SEARCH_BASE_URL, window.location.origin);
    Object.keys(params || {}).forEach(k=>{
      if(params[k] !== undefined && params[k] !== null && String(params[k]) !== '') u.searchParams.set(k, params[k]);
    });
    return u.toString();
  }

  if (docsToggle){
    docsToggle.addEventListener('change', function(){
      const markVal = (markInput && markInput.value) ? markInput.value.trim() : '';
      if (docsToggle.checked){
        // append use_receipts=1
        window.location.href = buildSearchUrl({ mark: markVal, use_receipts:'1' });
      } else {
        // go back to search without use_receipts
        window.location.href = buildSearchUrl({ mark: markVal });
      }
    });
  }

  // intercept form submit: if receipts toggle checked -> call scraper and open modal
  markForm?.addEventListener('submit', function(e){
    const isReceiptsMode = (docsToggle && docsToggle.checked) || (new URL(window.location.href).searchParams.get('use_receipts') === '1');
    if (isReceiptsMode){
      e.preventDefault();
      const markVal = (markInput && markInput.value) ? markInput.value.trim() : '';
      if(!markVal){ showFlash('Δώσε MARK ή URL για να αναζητηθούν αποδείξεις.','error'); return; }

      (async ()=>{
        try {
          showFlash('Αναζήτηση αποδείξεων...', 'info', 1200);
          // decide payload shape
          const looksLikeUrl = /^(https?:\/\/)|\/DocViewer\//i.test(markVal) || markVal.indexOf('/') !== -1;
          const bodyObj = looksLikeUrl ? { url: markVal } : { mark: markVal };
          const r = await fetchJson(SCRAPER_RECEIPT_URL, {
            method: 'POST',
            headers: {'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest'},
            credentials: 'include',
            body: JSON.stringify(bodyObj)
          });
          if(!r.ok){
            showFlash('Σφάλμα κατά την ανάκτηση αποδείξεων.', 'error', 4000);
            console.error('scrape error', r);
            return;
          }
          const payload = r.payload || {};
          const linesRaw = payload.receipts || payload.lines || payload.data || [];
          const canon = Array.isArray(linesRaw) ? linesRaw.map(l => ({
            id: l.id || l.line_id || '',
            afm: l.AFM || l.afm || l.vat || l.vatNumber || '',
            name: l.Name || l.name || l.issuer || '',
            date: l.issueDate || l.date || '',
            type: l.type_name || l.type || 'ΑΠΟΔΕΙΞΗ',
            net: l.totalNetValue || l.amount || l.net || '',
            vat_value: l.totalVatAmount || l.vat || l.vatAmount || '',
            total: l.totalValue || l.total || l.gross || '',
            category: l.category || '',
            url: l.url || l.document_url || ''
          })) : [];

          // populate receipts modal and set hidden input for save
          if(receiptsJsonInput) receiptsJsonInput.value = JSON.stringify({ mark: markVal, lines: canon });
          populateReceiptsModal(canon);
          if(receiptsModal) receiptsModal.style.display = 'flex';
          if(docsToggle) docsToggle.checked = true;

          if(payload.message) showFlash(payload.message, payload.ok ? 'success' : 'error');
        } catch(err){
          console.error('scrape exception', err);
          showFlash('Σφάλμα κατά την ανάκτηση αποδείξεων.', 'error');
        }
      })();
    }
  });

  // receipts modal close handlers
  receiptsModalCloseX?.addEventListener('click', function(){ if(receiptsModal) receiptsModal.style.display = 'none'; });
  receiptsModalCloseBtn?.addEventListener('click', function(){ if(receiptsModal) receiptsModal.style.display = 'none'; });

  // populateReceiptsModal function (renders rows + actions)
  function populateReceiptsModal(lines){
    const body = document.getElementById('receiptsModalBody');
    if(!body) return;
    body.innerHTML = '';
    if(!Array.isArray(lines) || lines.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = '<td class="p-2 border" colspan="10">Δεν βρέθηκαν αποδείξεις.</td>';
      body.appendChild(tr);
      return;
    }

    lines.forEach((l, idx) => {
      const tr = document.createElement('tr');

      const categorySelect = document.createElement('select');
      categorySelect.className = 'p-1 border rounded';
      const emptyOpt = document.createElement('option'); emptyOpt.value=''; emptyOpt.innerText='-- επίλεξε --';
      categorySelect.appendChild(emptyOpt);
      CUSTOMER_CATEGORIES.forEach(c => {
        const o = document.createElement('option'); o.value = c; o.innerText = c;
        if(l.category === c) o.selected = true;
        categorySelect.appendChild(o);
      });

      tr.innerHTML = `
        <td class="p-2 border text-sm text-gray-600">${idx+1}</td>
        <td class="p-2 border">${l.afm || ''}</td>
        <td class="p-2 border">${l.name || ''}</td>
        <td class="p-2 border">${l.date || ''}</td>
        <td class="p-2 border">${l.type || ''}</td>
        <td class="p-2 border text-right">${l.net || ''}</td>
        <td class="p-2 border text-right">${l.vat_value || ''}</td>
        <td class="p-2 border text-right">${l.total || ''}</td>
        <td class="p-2 border"></td>
        <td class="p-2 border text-left"></td>
      `;
      // put select into 9th cell
      tr.querySelectorAll('td')[8].appendChild(categorySelect);

      // actions cell (confirm/save single / open external)
      const actionsTd = tr.querySelectorAll('td')[9];
      // open doc button (if url present)
      if(l.url){
        const a = document.createElement('a');
        a.href = l.url;
        a.target = '_blank';
        a.rel = 'noreferrer noopener';
        a.className = 'px-2 py-1 border rounded text-sm mr-1';
        a.innerText = 'Άνοιγμα';
        actionsTd.appendChild(a);
      }
      // confirm single button
      const confirmBtn = document.createElement('button');
      confirmBtn.type = 'button';
      confirmBtn.className = 'px-2 py-1 bg-green-600 text-white rounded text-sm';
      confirmBtn.innerText = 'Επιβεβαίωση';
      confirmBtn.addEventListener('click', async function(){
        // collect summary for this line
        const summary = {
          mark: l.mark || document.getElementById('markInput')?.value || '',
          AA: l.AA || '',
          AFM_issuer: l.afm || l.AFM || '',
          Name: l.name || '',
          issueDate: l.date || '',
          type_name: l.type || 'ΑΠΟΔΕΙΞΗ',
          totalValue: l.total || '',
          totalNetValue: l.net || '',
          totalVatAmount: l.vat_value || '',
          lines: [{ id: l.id || ('r' + idx), amount: l.net || '', vat: l.vat_value || '', vatCategory: l.vatCategory || '', description: l.description || '' }]
        };

        const payload = {
          url: l.url || '',
          summary: summary,
          force: false,
          category: (categorySelect.value || ''),
          afm: summary.AFM_issuer || (typeof VAT !== 'undefined' && VAT ? VAT : ''),
          year: (new Date().getFullYear()).toString(),
          mark: summary.mark || ''
        };

        try {
          const res = await fetch(CONFIRM_RECEIPT_URL , {
            method: 'POST',
            headers: {'Content-Type':'application/json', 'X-Requested-With':'XMLHttpRequest'},
            credentials: 'include',
            body: JSON.stringify(payload)
          });
          if(!res.ok){
            const txt = await res.text().catch(()=>null);
            showFlash('Σφάλμα server: ' + (res.status || ''), 'error');
            console.error('confirm single error:', res.status, txt);
            return;
          }
          const resp = await res.json();
          showFlash(resp.message || 'Αποθηκεύτηκε.', resp.ok ? 'success' : 'error');
          // optionally remove confirmed row or mark it visually
          tr.classList.add('opacity-60');
          // if server returns next_mark update input
          if(resp.next_mark){
            try { document.getElementById('markInput').value = resp.next_mark; } catch(e){}
          }
        } catch(e){
          console.error('confirm single exception', e);
          showFlash('Σφάλμα κατά την επιβεβαίωση.', 'error');
        }
      });
      actionsTd.appendChild(confirmBtn);

      body.appendChild(tr);
    });
  }

  // confirm all receipts in modal (bulk)
  confirmReceiptsBtn?.addEventListener('click', async function(){
    try {
      // read json from hidden input if available, otherwise construct from DOM
      let parsed = null;
      if(receiptsJsonInput && receiptsJsonInput.value){
        try{ parsed = JSON.parse(receiptsJsonInput.value); } catch(e){ parsed = null; }
      }
      const lines = [];
      if(parsed && Array.isArray(parsed.lines) && parsed.lines.length){
        parsed.lines.forEach((l, i) => {
          const row = receiptsModalBody.querySelectorAll('tr')[i];
          const sel = row ? row.querySelector('select') : null;
          const category = sel ? sel.value : (l.category || '');
          lines.push(Object.assign({}, l, { category: category }));
        });
      } else {
        receiptsModalBody.querySelectorAll('tr').forEach((row, i) => {
          const tds = row.querySelectorAll('td');
          if(tds.length < 1) return;
          const afm = tds[1]?.innerText.trim() || '';
          const name = tds[2]?.innerText.trim() || '';
          const date = tds[3]?.innerText.trim() || '';
          const type = tds[4]?.innerText.trim() || '';
          const net = tds[5]?.innerText.trim() || '';
          const vat_value = tds[6]?.innerText.trim() || '';
          const total = tds[7]?.innerText.trim() || '';
          const sel = row.querySelector('select');
          const category = sel ? sel.value : '';
          lines.push({ id: 'r' + i, afm, name, date, type, net, vat_value, total, category });
        });
      }

      if(lines.length === 0){ showFlash('Δεν υπάρχουν γραμμές για επιβεβαίωση.', 'error'); return; }

      const markVal = (markInput?.value || parsed?.mark || '') || '';

      // include afm: prefer first line afm, else VAT template var
      const afmToSend = (lines[0] && lines[0].afm) ? lines[0].afm : ( (typeof VAT !== 'undefined' && VAT) ? VAT : '' );

      const payload = { mark: markVal, lines: lines, doc_type: 'receipt', afm: afmToSend };

      const res = await fetch(CONFIRM_RECEIPT_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'X-Requested-With':'XMLHttpRequest'},
        credentials: 'include',
        body: JSON.stringify(payload)
      });
      if(!res.ok){
        const txt = await res.text().catch(()=>null);
        showFlash('Σφάλμα server κατά την επιβεβαίωση αποδείξεων.', 'error', 5000);
        console.error('confirm receipts error', res.status, txt);
        return;
      }
      const resp = await res.json();
      showFlash(resp.message || 'Αποθηκεύτηκαν οι αποδείξεις.', resp.ok ? 'success' : 'error', 5000);
      if(resp.ok && receiptsModal) receiptsModal.style.display = 'none';

      // fetch next receipt mark if backend provides next_mark
      try {
        const nextRes = await fetch(NEXT_RECEIPT_MARK_URL, { method: 'GET', credentials: 'include', headers: {'X-Requested-With':'XMLHttpRequest'} });
        if(nextRes && nextRes.ok){
          const json = await nextRes.json().catch(()=>null);
          if(json && json.next_mark){
            document.getElementById('markInput').value = json.next_mark;
          } else if(resp.next_mark){
            document.getElementById('markInput').value = resp.next_mark;
          }
        } else if(resp.next_mark){
          document.getElementById('markInput').value = resp.next_mark;
        }
      } catch(e){ /* ignore */ }

    } catch(e){
      console.error('confirmReceipts exception', e);
      showFlash('Σφάλμα κατά την επιβεβαίωση αποδείξεων.', 'error');
    }
  });

  // repeat mapping UI builder (functions defined earlier in larger script)
  function detectVatKeysFromSummary(){
    if(summaryInput && summaryInput.value){
      try {
        const obj = JSON.parse(summaryInput.value || '{}');
        const lines = Array.isArray(obj.lines) ? obj.lines : [];
        const set = new Set();
        lines.forEach(l => {
          const key = (l.vatCategory || l.vat_category || l.vat || '').toString().trim();
          if(key) set.add(key);
        });
        if(set.size) return Array.from(set);
      } catch(e){ /* ignore */ }
    }
    return ['0%','6%','13%','24%'];
  }

  function buildRepeatModalUI(existingMapping){
    repeatModalList.innerHTML = '';
    const vatKeys = detectVatKeysFromSummary();
    const mapping = existingMapping || {};
    const defaultRow = document.createElement('div');
    defaultRow.className = 'flex items-center gap-3';
    defaultRow.innerHTML = `<div class="w-36 text-sm font-medium">Προεπιλογή</div>`;
    const defaultSelect = document.createElement('select');
    defaultSelect.className = 'p-1 border rounded flex-1';
    const opt0 = document.createElement('option'); opt0.value=''; opt0.innerText='-- (κανένα) --'; defaultSelect.appendChild(opt0);
    CUSTOMER_CATEGORIES.forEach(c=>{
      const o = document.createElement('option'); o.value = c; o.innerText = c;
      if(mapping['__default'] === c) o.selected = true;
      defaultSelect.appendChild(o);
    });
    defaultRow.appendChild(defaultSelect);
    repeatModalList.appendChild(defaultRow);

    vatKeys.forEach(vk=>{
      const row = document.createElement('div');
      row.className = 'flex items-center gap-3';
      const label = document.createElement('div');
      label.className = 'w-36 text-sm font-medium';
      label.innerText = vk || '(άγνωστο)';
      const sel = document.createElement('select');
      sel.className = 'p-1 border rounded flex-1';
      const oEmpty = document.createElement('option'); oEmpty.value=''; oEmpty.innerText='-- (προεπιλογή) --'; sel.appendChild(oEmpty);
      CUSTOMER_CATEGORIES.forEach(c=>{
        const o=document.createElement('option'); o.value=c; o.innerText=c;
        if(mapping[vk] === c) o.selected = true;
        sel.appendChild(o);
      });
      row.appendChild(label);
      row.appendChild(sel);
      repeatModalList.appendChild(row);
    });
  }

  function openRepeatModalWithMapping(mapping){
    buildRepeatModalUI(mapping || {});
    if(repeatModal) repeatModal.style.display = 'flex';
  }
  function closeRepeatModal(){ if(repeatModal) repeatModal.style.display = 'none'; }

  function collectMappingFromModal(){
    const mapping = {};
    const selects = repeatModalList.querySelectorAll('select');
    if(selects.length){
      const first = selects[0];
      if(first && first.value) mapping['__default'] = first.value;
      const vatKeys = detectVatKeysFromSummary();
      for(let i=1;i<selects.length;i++){
        const sel = selects[i];
        const vatKey = vatKeys[i-1];
        if(sel && sel.value) mapping[vatKey] = sel.value;
      }
    }
    return mapping;
  }

  function applyMappingToSummaryAndSubmitUsingMapping(mapping){
    if(!summaryInput || !saveSummaryForm) return false;
    try {
      const data = JSON.parse(summaryInput.value || '{}');
      if(!Array.isArray(data.lines)) data.lines = [];
      data.lines = data.lines.map(l => {
        const vatKey = (l.vatCategory || l.vat_category || l.vat || '').toString().trim();
        if(mapping && mapping[vatKey]) l.category = mapping[vatKey];
        else if(mapping && mapping.__default) l.category = mapping.__default;
        return l;
      });
      summaryInput.value = JSON.stringify(data);
      saveSummaryForm.submit();
      return true;
    } catch(e){
      console.warn('applyMappingToSummaryAndSubmitUsingMapping error', e);
      return false;
    }
  }

  // ---------- Initialization: load server repeat_entry config ----------
  (async function initRepeatEntry(){
    try {
      const resp = await apiGetRepeatEntry(VAT);
      if(resp && resp.ok){
        const repeat = resp.repeat_entry || { enabled: false, mapping: {} };
        if(resp.expense_tags && Array.isArray(resp.expense_tags) && resp.expense_tags.length){
          CUSTOMER_CATEGORIES = resp.expense_tags.slice();
        }
        const enabled = !!repeat.enabled;
        const mapping = repeat.mapping || {};

        if(repeatSwitch){
          repeatSwitch.checked = enabled;
          if(mapping && Object.keys(mapping).length) editRepeatBtn.classList.remove('hidden');
          repeatSwitch.addEventListener('change', async function(){
            const now = this.checked;
            if(now){
              if(!mapping || Object.keys(mapping).length === 0){
                openRepeatModalWithMapping({});
              } else {
                editRepeatBtn.classList.remove('hidden');
              }
            } else {
              editRepeatBtn.classList.add('hidden');
            }
            const saveResp = await apiSaveRepeatEntry(now, mapping, VAT);
            if(saveResp && saveResp.ok){
              showFlash('Ενημερώθηκε η ρύθμιση επαναληπτικής εισαγωγής.', 'success');
              if(saveResp.expense_tags && Array.isArray(saveResp.expense_tags) && saveResp.expense_tags.length){
                CUSTOMER_CATEGORIES = saveResp.expense_tags.slice();
              }
            } else {
              showFlash('Αποτυχία αποθήκευσης ρύθμισης.', 'error');
            }
          });
        }

        if(enabled && mapping && Object.keys(mapping).length && summaryInput){
          const did = applyMappingToSummaryAndSubmitUsingMapping(mapping);
          if(did){
            const sm = document.getElementById('summaryModal');
            if(sm) sm.style.display = 'none';
          }
        }

        if(editRepeatBtn){
          editRepeatBtn.classList.toggle('hidden', !mapping || Object.keys(mapping).length===0);
          editRepeatBtn.addEventListener('click', function(){
            openRepeatModalWithMapping(mapping);
          });
        }
      } else {
        if(repeatSwitch) repeatSwitch.checked = false;
      }
    } catch(e){
      console.warn('initRepeatEntry failed', e);
    }
  })();

  // modal wiring
  repeatModalCloseX?.addEventListener('click', closeRepeatModal);
  repeatModalCancel?.addEventListener('click', closeRepeatModal);

  repeatModalSave?.addEventListener('click', async function(){
    const mapping = collectMappingFromModal();
    const resp = await apiSaveRepeatEntry(true, mapping, VAT);
    if (resp && resp.ok) {
      if (resp.expense_tags && Array.isArray(resp.expense_tags) && resp.expense_tags.length) {
        CUSTOMER_CATEGORIES = resp.expense_tags.slice();
      }
      if (repeatSwitch) repeatSwitch.checked = true;
      editRepeatBtn.classList.remove('hidden');
      showFlash('Αποθηκεύτηκαν οι ρυθμίσεις επαναληπτικής εισαγωγής. Η σελίδα θα επαναφορτωθεί...', 'success', 800);
      closeRepeatModal();
      setTimeout(function(){ try { window.location.reload(); } catch(e){ console.warn('reload failed', e); } }, 600);
      return;
    } else {
      console.warn('Failed saving repeat mapping', resp);
      showFlash('Αποτυχία αποθήκευσης ρυθμίσεων επαναληπτικής εισαγωγής.', 'error');
    }
  });

  // existing banner & summary modal wiring
  const forceBtn = document.getElementById('forceEditBtn');
  const existingBanner = document.getElementById('existingBanner');
  const dismissBannerBtn = document.getElementById('dismissBannerBtn');

  if(dismissBannerBtn){
    dismissBannerBtn.addEventListener('click', function(){ if(existingBanner) existingBanner.style.display = 'none'; });
  }

  if (forceBtn){
    forceBtn.addEventListener('click', function(){
      const markValRaw = (markInput && markInput.value) ? markInput.value.trim() : '{{ mark or "" }}';
      const markVal = encodeURIComponent(markValRaw || '');
      if (!markVal){ alert('Δεν δόθηκε MARK για επιβεβαίωση.'); return; }
      if (confirm('Θες σίγουρα να επαναχαρακτηρίσεις το MARK και να ανοίξει η φόρμα επεξεργασίας;')) {
        if(existingBanner) existingBanner.style.display = 'none';
        window.location = SEARCH_BASE_URL + '?mark=' + markVal + '&force_edit=1';
      }
    });
  }

  const modal = document.getElementById('summaryModal');
  const modalCloseBtns = Array.from(document.querySelectorAll('#modalCloseX, #modalCloseBtn'));
  modalCloseBtns.forEach(b => b?.addEventListener('click', function(){
    if(modal) modal.style.display = 'none';
    removeForceEditParamFromUrl();
  }));

  {% if modal_summary and (request.args.get('force_edit') == '1' or not allow_edit_existing) %}
    setTimeout(()=>{
      const m = document.getElementById('summaryModal');
      if (m) { m.style.display = 'flex'; removeForceEditParamFromUrl(); }
    }, 80);
  {% endif %}

  {% if modal_warning %}
  const afmModal = document.getElementById('afmWarningModal');
  const afmModalBtn = document.getElementById('afmModalConfirm');
  if (afmModal && afmModalBtn){
    setTimeout(()=>{ afmModal.style.display = 'flex'; }, 50);
    afmModalBtn.addEventListener('click', function(){ afmModal.style.display = 'none'; });
  }
  {% endif %}

  // summary lines wiring (selects, buttons)
  if (summaryInput){
    try {
      let summaryData = JSON.parse(summaryInput.value || '{}');
      if (!Array.isArray(summaryData.lines)) summaryData.lines = [];
      summaryData.lines = summaryData.lines.map(l => {
        if (!l) return {id:'', description:'', amount:'', vat:'', category:'', vatCategory:''};
        l.id = (l.id!==undefined)?String(l.id):(l.line_id!==undefined?String(l.line_id):'');
        l.category = l.category || l.cat || l.line_category || l['κατηγορία'] || '';
        return l;
      });

      document.querySelectorAll('#linesTableBody tr[data-line-id]').forEach(tr => {
        const lid = String(tr.dataset.lineId || '');
        const sel = tr.querySelector('select.expense-category');
        if (!sel) return;
        let existing = summaryData.lines.find(x => String(x.id) === lid);
        if (!existing){
          existing = {id: lid, category: ''};
          summaryData.lines.push(existing);
        }
        sel.value = existing.category || '';
        sel.addEventListener('change', function(){ existing.category = sel.value; summaryInput.value = JSON.stringify(summaryData); });
      });

      const singleLine = document.getElementById('singleLine');
      if (singleLine){
        const lid = String(singleLine.dataset.lineId || '');
        let existing = summaryData.lines.find(x => String(x.id) === lid);
        if (!existing){
          existing = {id: lid, category: ''};
          summaryData.lines.push(existing);
        }
        const buttons = document.querySelectorAll('#categoryButtons .category-btn');
        function markActive(cat){
          buttons.forEach(b => {
            b.classList.toggle('bg-sky-600', b.dataset.cat === cat);
            b.classList.toggle('text-white', b.dataset.cat === cat);
          });
        }
        if (existing.category) markActive(existing.category);
        buttons.forEach(btn => {
          btn.addEventListener('click', function(){
            const cat = this.dataset.cat;
            existing.category = (existing.category === cat) ? '' : cat;
            markActive(existing.category);
            summaryInput.value = JSON.stringify(summaryData);
          });
        });
        const clearBtn = document.getElementById('clearCategory');
        clearBtn?.addEventListener('click', function(){
          existing.category = '';
          markActive('');
          summaryInput.value = JSON.stringify(summaryData);
        });
      }
      summaryInput.value = JSON.stringify(summaryData);
    } catch(e){
      console.warn('summary JSON parse/normalize error', e);
    }
  }

  // DataTables or fallback search
  const hasTable = document.querySelector('.summary-table') !== null;
  if (hasTable){
    const jq = window.jQuery;
    const dtAvail = jq && jq.fn && jq.fn.dataTable;
    if (dtAvail){
      try {
        const dt = $('.summary-table').DataTable({
          paging: true,
          scrollY: '55vh',
          scrollX: true,
          scrollCollapse: true,
          fixedHeader: { header: true, headerOffset: 0 },
          colReorder: true,
          autoWidth: false,
          columnDefs: [{ orderable: false, targets: 0 }]
        });
        if (typeof dt.colResize === 'function') {
          try { dt.colResize({ resizeMode: 'flex' }); } catch(e){ console.warn('colResize failed', e); }
        }
        const globalSearch = document.getElementById('globalSearch');
        if (globalSearch){
          globalSearch.addEventListener('input', function(){ dt.search(this.value).draw(); });
        }
        setTimeout(()=>{ try{ dt.columns.adjust().draw(); }catch(e){} }, 120);
      } catch(e){
        console.warn('DataTables init failed — falling back', e);
      }
    } else {
      const globalSearch = document.getElementById('globalSearch');
      if (globalSearch){
        globalSearch.addEventListener('input', function(){
          const q = this.value.toLowerCase();
          document.querySelectorAll('.summary-table tbody tr').forEach(tr => {
            tr.style.display = tr.textContent.toLowerCase().indexOf(q) !== -1 ? '' : 'none';
          });
        });
      }
    }
  }

  // restore table when mark cleared (unchanged)
  (function wireRobustClearRestore(){
    const mi = (typeof markInput !== 'undefined' && markInput) ? markInput : document.getElementById('markInput');
    if (!mi) return;
    let t = null;
    let lastVal = mi.value || '';
    function restoreAllRowsAndUi(){
      try {
        if (window.jQuery && jQuery.fn && jQuery.fn.dataTable) {
          try {
            const dt = $('.summary-table').DataTable();
            dt.search('').columns().search('').draw();
            try {
              dt.rows().nodes().to$().each(function(){ this.style.display = ''; });
            } catch(e){ /* ignore */ }
            try { dt.columns.adjust().draw(false); } catch(e){ /* ignore */ }
          } catch(e) {
            document.querySelectorAll('.summary-table tbody tr').forEach(tr => tr.style.display = '');
          }
        } else {
          document.querySelectorAll('.summary-table tbody tr').forEach(tr => tr.style.display = '');
        }
        const selectAll = document.getElementById('selectAll') || document.querySelector('.summary-table thead input[type="checkbox"]#selectAll');
        if (selectAll) selectAll.checked = false;
        const evt = new Event('tableRestored');
        document.querySelectorAll('.summary-table').forEach(t => t.dispatchEvent(evt));
      } catch(err){
        console.warn('restoreAllRowsAndUi failed', err);
      }
    }
    function maybeRestore(){
      clearTimeout(t);
      t = setTimeout(()=>{
        try {
          const v = (mi.value || '').trim();
          if (v === '' && (lastVal && lastVal.trim() !== '')) {
            try {
              if (typeof INITIAL_MARK !== 'undefined' && INITIAL_MARK && INITIAL_MARK.trim() !== '') {
                const cur = new URL(window.location.href);
                if (cur.searchParams.has('mark') || cur.searchParams.has('force_edit')) {
                  window.location = SEARCH_BASE_URL;
                  return;
                }
              }
            } catch(e){ /* ignore */ }
            restoreAllRowsAndUi();
          }
          lastVal = v;
        } catch(e){
          console.warn(e);
        }
      }, 150);
    }
    mi.addEventListener('input', maybeRestore);
    mi.addEventListener('keyup', maybeRestore);
    mi.addEventListener('paste', function(){ setTimeout(maybeRestore, 50); });
    mi.addEventListener('cut', function(){ setTimeout(maybeRestore, 50); });
    mi.addEventListener('blur', maybeRestore);
    let pollInterval = null;
    try {
      pollInterval = setInterval(() => {
        const current = (mi.value || '').trim();
        if (current !== (lastVal || '').trim()) {
          maybeRestore();
        }
      }, 300);
      window.addEventListener('beforeunload', () => { if (pollInterval) clearInterval(pollInterval); });
    } catch(e){}
  })();

}); // DOMContentLoaded
</script>
{% endblock %}
