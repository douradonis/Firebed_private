{% extends "base.html" %}
{% block title %}Αναζήτηση MARK{% endblock %}

{% block content %}

<!-- Search page with integrated receipts flow. This file replaces the old include/redirect behavior and embeds the receipts modal + logic.
     Important: modal elements are hidden by default (inline `display:none !important;`) to avoid CSS conflicts from the base stylesheet. -->

<div class="container mx-auto p-4">
  <h1 class="text-2xl font-semibold mb-4">Αναζήτηση MARK</h1>

  {% if error %}
    <div class="mb-3 p-2 rounded bg-red-50 text-red-800">{{ error }}</div>
  {% endif %}

  <!-- Top controls: MARK input & Receipts toggle -->
  <form id="markSearchForm" method="post" class="mb-4">
    <div class="flex flex-wrap items-center gap-3">
      <label for="markInput" class="sr-only">MARK</label>
      <input id="markInput" name="mark" type="text" placeholder="15 ψηφιο MARK" class="p-2 border rounded w-72" value="{{ request.form.mark if request.form.mark is defined else '' }}">

      <input id="scrapeUrlInput" type="url" placeholder="Εισάγετε URL παραστατικού (για αποδείξεις)" class="p-2 border rounded w-96 hidden" autocomplete="off">

      <div class="flex items-center gap-2">
        <input type="checkbox" id="useReceiptsSwitch" role="switch" aria-checked="false">
        <label for="useReceiptsSwitch" class="text-sm">Επεξεργασία ως Απόδειξη</label>
      </div>

      <button type="submit" class="btn btn-primary">Αναζήτηση</button>
    </div>
  </form>

  <!-- Flash container -->
  <div id="flash-container"></div>

  {% include 'list_inner.html' %}
</div>

<!-- server-side modal for invoice/edit flows (kept as-is) -->
{% if modal_summary and (request.args.get('force_edit') == '1' or not allow_edit_existing) %}
  <div id="serverSummaryModal" class="modal" style="display:block;">
    <div class="modal-content">
      <h3>Περίληψη Παραστατικού - MARK {{ modal_summary.mark or modal_summary.get('mark','') }}</h3>
      <button class="modal-close">✕</button>
      <div>
        <div><strong>Α/Α Παραστατικού</strong> {{ modal_summary.AA or modal_summary.get('AA','') }}</div>
        <div><strong>ΑΦΜ</strong> {{ modal_summary.AFM or modal_summary.get('AFM_issuer','') }}</div>
        <div><strong>Επωνυμία</strong> {{ modal_summary.Name or modal_summary.get('Name','') }}</div>
        <div><strong>Ημερομηνία</strong> {{ modal_summary.issueDate or modal_summary.get('issueDate','') }}</div>
        <div><strong>Τύπος Παραστατικού</strong> {{ modal_summary.type_name or modal_summary.get('type_name','') }}</div>
        <div><strong>Καθαρή Αξία</strong> {{ modal_summary.totalNetValue or modal_summary.get('totalNetValue','') }}</div>
        <div><strong>ΦΠΑ</strong> {{ modal_summary.totalVatAmount or modal_summary.get('totalVatAmount','') }}</div>
        <div><strong>Σύνολο</strong> {{ modal_summary.totalValue or modal_summary.get('totalValue','') }}</div>
      </div>

      {% set _lines = invoice_lines if invoice_lines is defined and invoice_lines else (modal_summary.lines if modal_summary.lines is defined and modal_summary.lines else []) %}
      <h4>Γραμμές Παραστατικού (για χαρακτηρισμό)</h4>
      {% if _lines|length > 1 %}
        <table class="w-full">
          <thead><tr><th>#</th><th>ΦΠΑ Κατηγορία</th><th>Ποσό</th><th>ΦΠΑ</th><th>Κατηγορία Εξόδου</th></tr></thead>
          <tbody>
          {% for line in _lines %}
            {% set lid = line.id if line.id is defined else (line.line_id if line.line_id is defined else 'l' ~ loop.index0) %}
            {% set amt = line.amount if line.amount is defined else (line.lineTotal if line.lineTotal is defined else '') %}
            {% set vatv = line.vat if line.vat is defined else (line.vatRate if line.vatRate is defined else '') %}
            {% set vat_cat = line.vatCategory if line.vatCategory is defined else (line.vat_category if line.vat_category is defined else '') %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ vat_cat }}</td>
              <td>{{ amt }}</td>
              <td>{{ vatv }}</td>
              <td>
                <select name="line_cat_{{ lid }}">
                  <option>-- επίλεξε --</option>
                  {% for c in customer_categories %}
                    <option value="{{ c }}">{{ c }}</option>
                  {% endfor %}
                </select>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% elif _lines|length == 1 %}
        {% set single = _lines[0] %}
        {% set lid = single.id if single.id is defined else (single.line_id if single.line_id is defined else 'l0') %}
        {% set amt = single.amount if single.amount is defined else (single.lineTotal if single.lineTotal is defined else '') %}
        {% set vatv = single.vat if single.vat is defined else (single.vatRate if single.vatRate is defined else '') %}
        {% set vat_cat = single.vatCategory if single.vatCategory is defined else (single.vat_category if single.vat_category is defined else '') %}
        <div><strong>ΦΠΑ Κατηγορία</strong> {{ vat_cat }}</div>
        <div><strong>Ποσό</strong> {{ amt }}</div>
        <div><strong>ΦΠΑ</strong> {{ vatv }}</div>
        <div>
          <label>Επίλεξε Κατηγορία Εξόδου</label>
          <select name="single_line_cat_{{ lid }}">
            <option value="">-- επίλεξε --</option>
            {% for c in customer_categories %}
              <option value="{{ c }}" {% if selected_cat == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
          <button id="clearCategoryServer">Καθαρισμός</button>
        </div>
      {% else %}
        <div>Δεν βρέθηκαν γραμμές για αυτό το MARK.</div>
      {% endif %}

      <div class="mt-3">
        <form method="POST" action="{{ url_for('save_summary') }}">
          <button class="btn btn-primary">Αποθήκευση στο Cache</button>
          <a class="btn" href="#">Κλείσιμο</a>
        </form>
      </div>
    </div>
  </div>
{% endif %}

<!-- Receipts client modal (hidden by default). We force inline none to avoid stylesheet conflicts. -->
<div id="summaryModal" class="fixed inset-0 flex items-center justify-center bg-black/40 z-50 overflow-auto p-4" style="display:none !important;">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Περίληψη Παραστατικού - <span id="summaryModalMark">MARK</span></h3>
      <button id="modalCloseX" class="text-gray-500 text-xl font-bold">✕</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
      <div><strong>Α/Α Παραστατικού</strong><div id="summary_AA"></div></div>
      <div><strong>ΑΦΜ</strong><div id="summary_AFM"></div></div>
      <div><strong>Επωνυμία</strong><div id="summary_Name"></div></div>
      <div><strong>Ημερομηνία</strong><div id="summary_issueDate"></div></div>
      <div><strong>Τύπος Παραστατικού</strong><div id="summary_type_name"></div></div>
      <div><strong>Καθαρή Αξία</strong><div id="summary_totalNetValue"></div></div>
      <div><strong>ΦΠΑ</strong><div id="summary_totalVatAmount"></div></div>
      <div><strong>Σύνολο</strong><div id="summary_totalValue"></div></div>
    </div>

    <h4 class="font-medium mt-4 mb-2">Γραμμές Παραστατικού (για χαρακτηρισμό)</h4>
    <div id="summaryLinesContainer" class="overflow-auto max-h-96 border rounded p-2">
      <!-- JS will render lines here -->
    </div>

    <div class="mt-4 flex justify-between items-center">
      <div class="text-sm text-gray-600">Σημείωση: οι κατηγορίες προέρχονται από τα settings του πελάτη.</div>
      <div class="flex justify-end gap-2">
        <form method="POST" action="{{ url_for('save_summary') }}" id="saveSummaryForm">
          <input type="hidden" id="summaryJsonInput" name="summary_json" value='{}'>
          <button type="submit" class="bg-sky-600 text-white px-3 py-2 rounded">Αποθήκευση στο Cache</button>
          <input type="hidden" id="scrapeUrlField" name="scrape_url" value="">
          <input type="hidden" id="scrapeCategoryField" name="scrape_category" value="">
          <input type="hidden" id="scrapeForceField" name="scrape_force" value="false">
        </form>
        <button id="modalCloseBtn" class="px-3 py-2 border rounded">Κλείσιμο</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}

  {# Export server-side arrays into JS globals so the client receipts logic can use them. If they are not present, provide safe defaults. #}
  <script>
    window.CUSTOMER_CATEGORIES = {{ customer_categories|default([], true)|tojson }};
    window.VAT = {{ VAT|default(None)|tojson }};
    window.ACTIVE_YEAR = {{ ACTIVE_YEAR|default(None)|tojson }};
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    const useReceiptsSwitch = document.getElementById('useReceiptsSwitch');
    const markSearchForm = document.getElementById('markSearchForm');
    const markInput = document.getElementById('markInput');
    const urlInput = document.getElementById('scrapeUrlInput');
    const summaryModal = document.getElementById('summaryModal');
    const summaryInput = document.getElementById('summaryJsonInput');
    const saveSummaryForm = document.getElementById('saveSummaryForm');
    const summaryMarkEl = document.getElementById('summaryModalMark');
    const linesContainer = document.getElementById('summaryLinesContainer');
    const urlField = document.getElementById('scrapeUrlField');
    const categoryField = document.getElementById('scrapeCategoryField');
    const forceField = document.getElementById('scrapeForceField');
    const modalCloseBtns = Array.from(document.querySelectorAll('#modalCloseX, #modalCloseBtn'));
    const customerCategories = Array.isArray(window.CUSTOMER_CATEGORIES) ? window.CUSTOMER_CATEGORIES : [];

    const summaryFields = {
      AA: document.getElementById('summary_AA'),
      AFM: document.getElementById('summary_AFM'),
      Name: document.getElementById('summary_Name'),
      issueDate: document.getElementById('summary_issueDate'),
      type_name: document.getElementById('summary_type_name'),
      totalNetValue: document.getElementById('summary_totalNetValue'),
      totalVatAmount: document.getElementById('summary_totalVatAmount'),
      totalValue: document.getElementById('summary_totalValue')
    };

    let currentSummary = null;

    function flashMessage(message, level = 'info', timeout = 4000) {
      if (typeof window.showFlash === 'function') {
        window.showFlash(message, level, timeout);
      } else {
        alert(message);
      }
    }

    function cloneSummary(data) {
      try {
        return JSON.parse(JSON.stringify(data || {}));
      } catch (error) {
        return {};
      }
    }

    function updateSummaryInput() {
      if (summaryInput) {
        summaryInput.value = currentSummary ? JSON.stringify(currentSummary) : '{}';
      }
    }

    function defaultReceiptCategory() {
      if (!customerCategories.length) {
        return '';
      }
      if (customerCategories.includes('αποδειξακια')) {
        return 'αποδειξακια';
      }
      return customerCategories[0];
    }

    function refreshRepeatButton() {
      const editRepeatBtn = document.getElementById('editRepeatBtn');
      if (!editRepeatBtn) {
        return;
      }
      const repeatSwitch = document.getElementById('repeatSwitch');
      if (typeof window.apiGetRepeatEntry !== 'function') {
        if (repeatSwitch && repeatSwitch.checked) {
          editRepeatBtn.classList.remove('hidden');
        } else {
          editRepeatBtn.classList.add('hidden');
        }
        return;
      }

      (async () => {
        try {
          const resp = await window.apiGetRepeatEntry(typeof window.VAT !== 'undefined' ? window.VAT : null);
          const mapping = resp && resp.repeat_entry && resp.repeat_entry.mapping ? resp.repeat_entry.mapping : {};
          if (mapping && Object.keys(mapping).length && repeatSwitch && repeatSwitch.checked) {
            editRepeatBtn.classList.remove('hidden');
          } else {
            editRepeatBtn.classList.add('hidden');
          }
        } catch (error) {
          // ignore
        }
      })();
    }

    function toggleReceiptsMode(on) {
      if (on) {
        markInput?.classList.add('hidden');
        urlInput?.classList.remove('hidden');
        urlInput?.focus();
        document.getElementById('editRepeatBtn')?.classList.add('hidden');
      } else {
        markInput?.classList.remove('hidden');
        urlInput?.classList.add('hidden');
        markInput?.focus();
        refreshRepeatButton();
      }

      if (useReceiptsSwitch) {
        useReceiptsSwitch.setAttribute('aria-checked', on ? 'true' : 'false');
      }
    }

    function openModal() {
      if (summaryModal) {
        summaryModal.style.display = 'flex';
      }
    }

    function closeModal() {
      if (summaryModal) {
        summaryModal.style.display = 'none';
      }
      if (typeof history.replaceState === 'function') {
        try {
          history.replaceState(null, '', location.pathname + (location.search || '') + location.hash);
        } catch (error) {
          // ignore history errors
        }
      }
    }

    function setLineCategory(lineId, category) {
      if (!currentSummary || !Array.isArray(currentSummary.lines)) {
        return;
      }
      currentSummary.lines = currentSummary.lines.map((line) => {
        if (String(line.id ?? line.line_id ?? '') === String(lineId)) {
          return Object.assign({}, line, { category: category || '' });
        }
        return line;
      });
      updateSummaryInput();
    }

    function renderSingleLine(line) {
      if (!linesContainer) {
        return;
      }
      linesContainer.innerHTML = '';
      const wrapper = document.createElement('div');
      const lineId = line.id || line.line_id || 'l0';
      wrapper.className = 'space-y-2';
      wrapper.dataset.lineId = lineId;

      wrapper.innerHTML = `
        <div><strong>ΦΠΑ Κατηγορία</strong><div>${line.vatCategory || ''}</div></div>
        <div><strong>Ποσό</strong><div>${line.amount || ''}</div></div>
        <div><strong>ΦΠΑ</strong><div>${line.vat || ''}</div></div>
      `;

      const buttonsWrap = document.createElement('div');
      buttonsWrap.className = 'mt-2 flex flex-wrap gap-2';

      if (!customerCategories.length) {
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'text-sm text-gray-500';
        emptyMsg.textContent = 'Δεν υπάρχουν διαθέσιμες κατηγορίες.';
        buttonsWrap.appendChild(emptyMsg);
      } else {
        customerCategories.forEach((cat) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'category-btn px-3 py-2 border rounded';
          btn.dataset.cat = cat;
          btn.textContent = cat;
          if (line.category && line.category === cat) {
            btn.classList.add('active');
          }
          btn.addEventListener('click', function(){
            buttonsWrap.querySelectorAll('button.category-btn').forEach((el) => el.classList.remove('active'));
            this.classList.add('active');
            setLineCategory(lineId, cat);
          });
          buttonsWrap.appendChild(btn);
        });
      }

      wrapper.appendChild(buttonsWrap);

      const clearBtn = document.createElement('button');
      clearBtn.type = 'button';
      clearBtn.id = 'clearCategory';
      clearBtn.className = 'px-3 py-2 border rounded';
      clearBtn.textContent = 'Καθαρισμός';
      clearBtn.addEventListener('click', function(){
        buttonsWrap.querySelectorAll('button.category-btn').forEach((el) => el.classList.remove('active'));
        setLineCategory(lineId, '');
      });

      wrapper.appendChild(clearBtn);
      linesContainer.appendChild(wrapper);
    }

    function renderMultipleLines(lines) {
      if (!linesContainer) {
        return;
      }
      linesContainer.innerHTML = '';

      const table = document.createElement('table');
      table.className = 'w-full border-collapse';
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr><th>#</th><th>ΦΠΑ Κατηγορία</th><th>Ποσό</th><th>ΦΠΑ</th><th>Κατηγορία Εξόδου</th></tr>';
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      lines.forEach((line, index) => {
        const lineId = line.id || line.line_id || `l${index}`;
        const tr = document.createElement('tr');
        tr.dataset.lineId = lineId;
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${line.vatCategory || ''}</td>
          <td style="text-align:right">${line.amount || ''}</td>
          <td style="text-align:right">${line.vat || ''}</td>
        `;

        const tdSelect = document.createElement('td');
        const select = document.createElement('select');
        select.className = 'expense-category border rounded px-2 py-1';

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = '-- επίλεξε --';
        select.appendChild(placeholder);

        customerCategories.forEach((cat) => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          select.appendChild(opt);
        });

        select.value = line.category || '';
        select.addEventListener('change', function(){
          setLineCategory(lineId, this.value);
        });

        tdSelect.appendChild(select);
        tr.appendChild(tdSelect);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      linesContainer.appendChild(table);
    }

    function renderLines() {
      if (!linesContainer) {
        return;
      }
      const lines = Array.isArray(currentSummary && currentSummary.lines) ? currentSummary.lines : [];
      if (!lines.length) {
        linesContainer.innerHTML = '<div class="mt-4 p-3 bg-yellow-50 rounded">Δεν βρέθηκαν γραμμές για αυτό το MARK.</div>';
        return;
      }
      if (lines.length === 1) {
        renderSingleLine(lines[0]);
      } else {
        renderMultipleLines(lines);
      }
    }

    function populateSummaryModal(summary) {
      currentSummary = cloneSummary(summary);
      if (!currentSummary.lines) {
        currentSummary.lines = [];
      }
      updateSummaryInput();

      if (summaryMarkEl) summaryMarkEl.textContent = currentSummary.mark || '';
      if (summaryFields.AA) summaryFields.AA.textContent = currentSummary.AA || '';
      if (summaryFields.AFM) summaryFields.AFM.textContent = currentSummary.AFM_issuer || currentSummary.AFM || '';
      if (summaryFields.Name) summaryFields.Name.textContent = currentSummary.Name || '';
      if (summaryFields.issueDate) summaryFields.issueDate.textContent = currentSummary.issueDate || '';
      if (summaryFields.type_name) summaryFields.type_name.textContent = currentSummary.type_name || '';
      if (summaryFields.totalNetValue) summaryFields.totalNetValue.textContent = currentSummary.totalNetValue || '';
      if (summaryFields.totalVatAmount) summaryFields.totalVatAmount.textContent = currentSummary.totalVatAmount || '';
      if (summaryFields.totalValue) summaryFields.totalValue.textContent = currentSummary.totalValue || '';

      renderLines();
    }

    async function fetchNextReceiptMark() {
      try {
        const res = await fetch('/api/next_receipt_mark', { credentials: 'same-origin' });
        const data = await res.json().catch(() => null);
        if (res.ok && data && data.mark) {
          return data.mark;
        }
      } catch (error) {
        // ignore fetch errors
      }
      return '';
    }

    function buildSummary(scrapeData, nextMark) {
      const summary = {
        mark: nextMark || '',
        AA: scrapeData.progressive_aa || '',
        AFM_issuer: scrapeData.issuer_vat || '',
        Name: scrapeData.issuer_name || '',
        issueDate: scrapeData.issue_date || '',
        type_name: 'ΑΠΟΔΕΙΞΗ',
        totalValue: scrapeData.total_amount || '',
        totalNetValue: scrapeData.total_amount || '',
        totalVatAmount: (scrapeData.raw && (scrapeData.raw.totalVatAmount || scrapeData.raw.totalVat)) || '',
        lines: [],
        raw: scrapeData.raw || null
      };

      const rawLines = scrapeData.raw && Array.isArray(scrapeData.raw.lines) ? scrapeData.raw.lines : [];
      if (rawLines.length) {
        rawLines.forEach((line, index) => {
          summary.lines.push({
            id: line.id || line.line_id || `r${index}`,
            amount: line.amount || line.lineTotal || '',
            vat: line.vat || line.vatRate || '',
            vatCategory: line.vatCategory || line.vat_category || '',
            description: line.description || line.desc || '',
            category: line.category || ''
          });
        });
      } else {
        summary.lines.push({
          id: 'r0',
          amount: scrapeData.total_amount || '',
          vat: (scrapeData.raw && (scrapeData.raw.vat || scrapeData.raw.totalVat)) || '',
          vatCategory: (scrapeData.raw && (scrapeData.raw.vatCategory || scrapeData.raw.vat_category)) || '',
          description: (scrapeData.raw && (scrapeData.raw.description || scrapeData.raw.desc)) || '',
          category: ''
        });
      }

      return summary;
    }

    async function handleReceiptsSubmit(event) {
      if (!(useReceiptsSwitch && useReceiptsSwitch.checked)) {
        return;
      }
      event.preventDefault();
      if (!urlInput) {
        return;
      }
      const url = urlInput.value.trim();
      if (!url) {
        flashMessage('Εισάγετε URL για αποδείξεις.', 'error');
        return;
      }

      let scrapeData = null;
      try {
        const response = await fetch('/api/scrape_receipt', {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ url })
        });
        const payload = await response.json().catch(() => null);
        if (!response.ok || !payload || payload.ok === false) {
          const msg = payload && (payload.error || payload.message) ? (payload.error || payload.message) : `Server ${response.status || ''}`.trim();
          flashMessage('Σφάλμα scraper: ' + msg, 'error', 6000);
          return;
        }
        scrapeData = payload;
      } catch (error) {
        flashMessage('Σφάλμα scraper: ' + (error.message || error), 'error', 6000);
        return;
      }

      if (scrapeData.is_invoice === true) {
        const afmModal = document.getElementById('afmWarningModal');
        if (afmModal) {
          const body = document.getElementById('afmWarningBody');
          if (body) {
            body.innerText = 'Το URL φαίνεται να περιέχει Τιμολόγιο — δεν θα αποθηκευτεί ως Απόδειξη. Έλεγξε το παραστατικό.';
          }
          afmModal.style.display = 'flex';
        } else {
          flashMessage('Το URL φαίνεται να περιέχει Τιμολόγιο — δεν θα αποθηκευτεί ως Απόδειξη.', 'error');
        }
        return;
      }

      const nextMark = await fetchNextReceiptMark();
      const summaryObj = buildSummary(scrapeData, nextMark);
      currentSummary = cloneSummary(summaryObj);
      updateSummaryInput();

      if (urlField) {
        urlField.value = url;
        urlField.dataset.mark = currentSummary.mark || '';
      }
      if (categoryField) {
        categoryField.value = defaultReceiptCategory();
      }
      if (forceField) {
        forceField.value = 'false';
      }

      populateSummaryModal(currentSummary);

      if (typeof window.RC_forcePopulateSummaryModal === 'function') {
        try {
          window.RC_forcePopulateSummaryModal();
        } catch (error) {
          console.warn('RC_forcePopulateSummaryModal failed', error);
        }
      }

      openModal();
      flashMessage('Λήφθηκε απόδειξη — ελέγξτε τα στοιχεία και πατήστε "Αποθήκευση στο Cache".', 'success', 5000);
    }

    async function handleSaveSubmit(event) {
      if (!urlField || !urlField.value) {
        return;
      }
      event.preventDefault();

      let summaryPayload = null;
      if (currentSummary) {
        summaryPayload = cloneSummary(currentSummary);
      } else if (summaryInput) {
        try {
          summaryPayload = JSON.parse(summaryInput.value || '{}');
        } catch (error) {
          summaryPayload = null;
        }
      }

      if (!summaryPayload) {
        flashMessage('Σφάλμα: άκυρα δεδομένα παραστατικού.', 'error');
        return;
      }

      const afmFromSummary = (summaryPayload.AFM_issuer || summaryPayload.AFM || summaryPayload.issuer_vat || summaryPayload.issuerVat) || (summaryPayload.raw && (summaryPayload.raw.issuer_vat || summaryPayload.raw.issuerVat || summaryPayload.raw.AFM));
      const afmVal = (typeof window.VAT !== 'undefined' && window.VAT) ? window.VAT : (afmFromSummary ? String(afmFromSummary).trim() : '');

      if (!afmVal) {
        flashMessage('Αδύνατο να αποθηκευτεί: λείπει AFM του ενεργού πελάτη. Επιλέξτε ενεργό πελάτη ή βεβαιωθείτε ότι το παραστατικό περιέχει ΑΦΜ.', 'error', 7000);
        return;
      }

      let yearVal = null;
      try {
        if (typeof window.ACTIVE_YEAR !== 'undefined' && window.ACTIVE_YEAR) {
          yearVal = String(window.ACTIVE_YEAR);
        } else if (summaryPayload.year || summaryPayload.Year) {
          yearVal = String(summaryPayload.year || summaryPayload.Year);
        } else if (summaryPayload.issueDate) {
          const parts = String(summaryPayload.issueDate).split('/');
          if (parts.length >= 3) {
            yearVal = parts[2];
          }
        }
        if (!yearVal) {
          yearVal = String((new Date()).getUTCFullYear());
        }
      } catch (error) {
        yearVal = String((new Date()).getUTCFullYear());
      }

      const payload = {
        url: urlField.value,
        summary: summaryPayload,
        force: !!(forceField && forceField.value === 'true'),
        category: (categoryField && categoryField.value) ? categoryField.value : defaultReceiptCategory(),
        afm: afmVal,
        year: String(yearVal),
        mark: summaryPayload.mark || (urlField.dataset ? urlField.dataset.mark || '' : '')
      };

      try {
        const response = await fetch('/api/confirm_receipt', {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify(payload)
        });
        const result = await response.json().catch(() => null);
        if (!response.ok || !result || result.ok === false) {
          const msg = result && result.error ? result.error : `Server ${response.status || ''}`.trim();
          flashMessage('Σφάλμα αποθήκευσης: ' + msg, 'error', 7000);
          return;
        }

        flashMessage('Αποθηκεύτηκε η απόδειξη (excel + json).', 'success');
        closeModal();
        if (urlField) {
          urlField.value = '';
          delete urlField.dataset.mark;
        }
        if (forceField) {
          forceField.value = 'false';
        }
        currentSummary = null;
        updateSummaryInput();
        if (urlInput) {
          urlInput.value = '';
          urlInput.focus();
        }
      } catch (error) {
        flashMessage('Σφάλμα δικτύου κατά την αποθήκευση.', 'error');
      }
    }

    useReceiptsSwitch?.addEventListener('change', function(){
      toggleReceiptsMode(!!this.checked);
    });

    markSearchForm?.addEventListener('submit', handleReceiptsSubmit);
    saveSummaryForm?.addEventListener('submit', handleSaveSubmit);

    modalCloseBtns.forEach((btn) => {
      btn?.addEventListener('click', function(){
        closeModal();
      });
    });

    document.addEventListener('keydown', function(event){
      if (event.key === 'Escape' && summaryModal && window.getComputedStyle(summaryModal).display !== 'none') {
        closeModal();
      }
    });

    toggleReceiptsMode(!!(useReceiptsSwitch && useReceiptsSwitch.checked));
    if (!(useReceiptsSwitch && useReceiptsSwitch.checked)) {
      refreshRepeatButton();
    }
    if (categoryField && !categoryField.value) {
      categoryField.value = defaultReceiptCategory();
    }
  });
  </script>

{% endblock %}
