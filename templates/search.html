{% extends "base.html" %}
{% block title %}Αναζήτηση MARK{% endblock %}

{% block content %}
<div class="bg-white rounded shadow p-6">
  <h2 class="text-lg font-semibold mb-2">Αναζήτηση MARK</h2>

  {% if error %}
    <div class="mb-3 p-2 rounded bg-red-50 text-red-800">{{ error }}</div>
  {% endif %}

  <form method="post" class="flex gap-2" id="markSearchForm">
    <input name="mark" id="markInput" type="text" placeholder="15ψήφιο MARK" class="p-2 border rounded w-2/4" value="{{ mark }}">
    <button type="submit" class="bg-sky-600 text-white px-3 py-2 rounded">Αναζήτηση</button>
  </form>
</div>

{% if allow_edit_existing and not request.args.get('force_edit') %}
<div class="mt-4 p-4 bg-yellow-50 rounded border border-yellow-300 text-yellow-800" id="existingBanner">
  Το MARK <strong>{{ mark }}</strong> υπάρχει ήδη στο Excel. Θέλεις να τροποποιήσεις τον χαρακτηρισμό;
  <div class="mt-2 flex gap-2">
    <!-- button που θα χειριστεί JS (επιβεβαίωση) -->
    <button id="forceEditBtn" type="button" class="bg-yellow-600 text-white px-3 py-2 rounded hover:bg-yellow-700">
      Επιβεβαίωση
    </button>
    <button id="dismissBannerBtn" type="button" onclick="this.parentElement.parentElement.style.display='none'"
            class="px-3 py-2 border rounded hover:bg-gray-50">
      Άκυρο
    </button>
  </div>
</div>
{% endif %}

{% if modal_summary and (request.args.get('force_edit') or not allow_edit_existing) %}
<div id="summaryModal" class="fixed inset-0 flex items-center justify-center bg-black/40 z-50 overflow-auto p-4" style="display:none;">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">
        Περίληψη Παραστατικού - MARK {{ modal_summary.mark or modal_summary.get('mark','') }}
      </h3>
      <button id="modalCloseX" class="text-gray-500 text-xl font-bold">✕</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
      <div><strong>Α/Α Παραστατικού</strong><div>{{ modal_summary.AA or modal_summary.get('AA','') }}</div></div>
      <div><strong>ΑΦΜ</strong><div>{{ modal_summary.AFM or modal_summary.get('AFM','') }}</div></div>
      <div><strong>Επωνυμία</strong><div>{{ modal_summary.Name or modal_summary.get('Name','') }}</div></div>
      <div><strong>Ημερομηνία</strong><div>{{ modal_summary.issueDate or modal_summary.get('issueDate','') }}</div></div>
      <div><strong>Τύπος Παραστατικού</strong><div>{{ modal_summary.type_name or modal_summary.get('type_name','') }}</div></div>
      <div><strong>Καθαρή Αξία</strong><div>{{ modal_summary.totalNetValue or modal_summary.get('totalNetValue','') }}</div></div>
      <div><strong>ΦΠΑ</strong><div>{{ modal_summary.totalVatAmount or modal_summary.get('totalVatAmount','') }}</div></div>
      <div><strong>Σύνολο</strong><div>{{ modal_summary.totalValue or modal_summary.get('totalValue','') }}</div></div>
    </div>

    {% set _lines = invoice_lines if invoice_lines is defined and invoice_lines else (modal_summary.lines if modal_summary.lines is defined and modal_summary.lines else []) %}

    <h4 class="font-medium mt-4 mb-2">Γραμμές Παραστατικού (για χαρακτηρισμό)</h4>

    {% if _lines|length > 1 %}
    <div class="overflow-auto max-h-96 border rounded">
      <table class="w-full border-collapse">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="p-2 border text-left">#</th>
            <th class="p-2 border text-left">ΦΠΑ Κατηγορία</th>
            <th class="p-2 border text-right">Ποσό</th>
            <th class="p-2 border text-right">ΦΠΑ</th>
            <th class="p-2 border text-left">Κατηγορία Εξόδου</th>
          </tr>
        </thead>
        <tbody id="linesTableBody">
          {% for line in _lines %}
          {% set lid = line.id if line.id is defined else (line.line_id if line.line_id is defined else 'l' ~ loop.index0) %}
          {% set amt = line.amount if line.amount is defined else (line.lineTotal if line.lineTotal is defined else '') %}
          {% set vatv = line.vat if line.vat is defined else (line.vatRate if line.vatRate is defined else '') %}
          {% set vat_cat = line.vatCategory if line.vatCategory is defined else (line.vat_category if line.vat_category is defined else '') %}
          {% set cat = line.category if line.category is defined else '' %}
          <tr data-line-id="{{ lid }}">
            <td class="p-2 border text-sm text-gray-600">{{ loop.index }}</td>
            <td class="p-2 border break-words">{{ vat_cat }}</td>
            <td class="p-2 border text-right">{{ amt }}</td>
            <td class="p-2 border text-right">{{ vatv }}</td>
            <td class="p-2 border">
              <select class="expense-category p-1 border rounded w-full" data-line-id="{{ lid }}">
                <option value="">-- επίλεξε --</option>
                {% for c in customer_categories %}
                  <option value="{{ c }}" {% if c == cat %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% elif _lines|length == 1 %}
      {% set single = _lines[0] %}
      {% set lid = single.id if single.id is defined else (single.line_id if single.line_id is defined else 'l0') %}
      {% set amt = single.amount if single.amount is defined else (single.lineTotal if single.lineTotal is defined else '') %}
      {% set vatv = single.vat if single.vat is defined else (single.vatRate if single.vatRate is defined else '') %}
      {% set vat_cat = single.vatCategory if single.vatCategory is defined else (single.vat_category if single.vat_category is defined else '') %}
      {% set selected_cat = single.category if single.category is defined else '' %}

      <div id="singleLine"
           class="border rounded p-4"
           data-line-id="{{ lid }}"
           data-amount="{{ amt }}"
           data-vat="{{ vatv }}"
           data-vatcat="{{ vat_cat|e }}">
        <div class="mb-3 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div><strong>ΦΠΑ Κατηγορία</strong><div>{{ vat_cat }}</div></div>
          <div><strong>Ποσό</strong><div>{{ amt }}</div></div>
          <div><strong>ΦΠΑ</strong><div>{{ vatv }}</div></div>
        </div>

        <div class="mb-3">
          <strong>Επίλεξε Κατηγορία Εξόδου</strong>
          <div id="categoryButtons" class="mt-2 flex flex-wrap gap-2">
            {% for c in customer_categories %}
              <button type="button"
                      class="category-btn px-3 py-2 border rounded hover:bg-sky-50 {% if c == selected_cat %}bg-sky-600 text-white{% endif %}"
                      data-cat="{{ c }}"
                      data-line-id="{{ lid }}">
                {{ c }}
              </button>
            {% endfor %}
            <button type="button" id="clearCategory" class="px-3 py-2 border rounded text-sm ml-2">Καθαρισμός</button>
          </div>
        </div>
      </div>

    {% else %}
      <div class="mt-4 p-3 bg-yellow-50 rounded">Δεν βρέθηκαν γραμμές για αυτό το MARK.</div>
    {% endif %}

    <div class="mt-4 flex justify-between items-center">
      <div class="text-sm text-gray-600">
        Σημείωση: οι κατηγορίες προέρχονται από τα settings του πελάτη. Μπορείς να ορίσεις/επεξεργαστείς αυτές τις επιλογές στη σελίδα Credentials.
      </div>

      <div class="flex justify-end gap-2">
        <form method="POST" action="{{ url_for('save_summary') }}" id="saveSummaryForm">
          <input type="hidden" name="summary_json" id="summaryJsonInput" value='{{ modal_summary | tojson | safe }}'>
          <button type="submit" class="bg-sky-600 text-white px-3 py-2 rounded">Αποθήκευση στο Cache</button>
        </form>
        <button id="modalCloseBtn" class="px-3 py-2 border rounded">Κλείσιμο</button>
      </div>
    </div>
  </div>
</div>
{% endif %}
{# --- Νέο AFM Warning Modal --- #}
{% if modal_warning %}
<div id="afmWarningModal" class="fixed inset-0 flex items-center justify-center bg-black/40 z-50 overflow-auto p-4" style="display:none;">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-red-600">Προειδοποίηση AFM</h3>
    </div>
    <div class="mb-4 text-gray-700">
      {{ modal_warning }}
    </div>
    <div class="flex justify-end gap-2">
      <button id="afmModalConfirm" class="bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700">Κατάλαβα</button>
    </div>
  </div>
</div>
{% endif %}
{# Include the list inner (table). Make sure list_inner.html exists and that the search view
   passes the same context variables that list_inner expects (table_html, file_exists, etc.) #}
{% include 'list_inner.html' %}
{% endblock %}

{% block scripts %}
<script>
const SEARCH_BASE_URL = "{{ url_for('search') }}";

function closeModal(){
  const m = document.getElementById('summaryModal');
  if (m) m.style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function(){
  // --- force-edit confirmation behavior ---
  const forceBtn = document.getElementById('forceEditBtn');
  const markInput = document.getElementById('markInput');
  if (forceBtn){
    forceBtn.addEventListener('click', function(){
      const markValRaw = (markInput && markInput.value) ? markInput.value.trim() : '{{ mark or "" }}';
      const markVal = encodeURIComponent(markValRaw || '');
      if (!markVal){
        alert('Δεν δόθηκε MARK για επιβεβαίωση.');
        return;
      }
      if (confirm('Θες σίγουρα να επαναχαρακτηρίσεις το MARK και να ανοίξει η φόρμα επεξεργασίας;')) {
        window.location = SEARCH_BASE_URL + '?mark=' + markVal + '&force_edit=1';
      }
    });
  }

  // modal open/close wiring
  const modal = document.getElementById('summaryModal');
  const modalCloseBtns = Array.from(document.querySelectorAll('#modalCloseX, #modalCloseBtn'));
  modalCloseBtns.forEach(b => b?.addEventListener('click', closeModal));
  {% if modal_summary and (request.args.get('force_edit') or not allow_edit_existing) %}
    // show modal if server provided it
    setTimeout(()=>{ const m = document.getElementById('summaryModal'); if (m) m.style.display = 'flex'; }, 80);
  {% endif %}

  {% if modal_warning %}
  const afmModal = document.getElementById('afmWarningModal');
  const afmModalBtn = document.getElementById('afmModalConfirm');
  if (afmModal && afmModalBtn){
    setTimeout(()=>{ afmModal.style.display = 'flex'; }, 50);
    afmModalBtn.addEventListener('click', function(){
      afmModal.style.display = 'none';
    });
  }
  {% endif %}
  // --- normalize summary JSON & wire modal selects/buttons ---
  const summaryInput = document.getElementById('summaryJsonInput');
  if (summaryInput){
    try {
      let summaryData = JSON.parse(summaryInput.value || '{}');
      if (!Array.isArray(summaryData.lines)) summaryData.lines = [];

      // normalize per-line ids & category keys
      summaryData.lines = summaryData.lines.map(l => {
        if (!l) return {id:'', description:'', amount:'', vat:'', category:'', vatCategory:''};
        l.id = (l.id!==undefined)?String(l.id):(l.line_id!==undefined?String(l.line_id):'');
        l.category = l.category || l.cat || l.line_category || l['κατηγορία'] || '';
        return l;
      });

      // map lines in the modal table
      document.querySelectorAll('#linesTableBody tr[data-line-id]').forEach(tr => {
        const lid = String(tr.dataset.lineId || '');
        const sel = tr.querySelector('select.expense-category');
        if (!sel) return;
        let existing = summaryData.lines.find(x => String(x.id) === lid);
        if (!existing){
          existing = {id: lid, category: ''};
          summaryData.lines.push(existing);
        }
        sel.value = existing.category || '';
        sel.addEventListener('change', function(){ existing.category = sel.value; summaryInput.value = JSON.stringify(summaryData); });
      });

      // single-line buttons
      const singleLine = document.getElementById('singleLine');
      if (singleLine){
        const lid = String(singleLine.dataset.lineId || '');
        let existing = summaryData.lines.find(x => String(x.id) === lid);
        if (!existing){
          existing = {id: lid, category: ''};
          summaryData.lines.push(existing);
        }
        const buttons = document.querySelectorAll('#categoryButtons .category-btn');
        function markActive(cat){
          buttons.forEach(b => {
            b.classList.toggle('bg-sky-600', b.dataset.cat === cat);
            b.classList.toggle('text-white', b.dataset.cat === cat);
          });
        }
        if (existing.category) markActive(existing.category);
        buttons.forEach(btn => {
          btn.addEventListener('click', function(){
            const cat = this.dataset.cat;
            existing.category = (existing.category === cat) ? '' : cat;
            markActive(existing.category);
            summaryInput.value = JSON.stringify(summaryData);
          });
        });
        const clearBtn = document.getElementById('clearCategory');
        clearBtn?.addEventListener('click', function(){
          existing.category = '';
          markActive('');
          summaryInput.value = JSON.stringify(summaryData);
        });
      }

      // write back normalized JSON
      summaryInput.value = JSON.stringify(summaryData);
    } catch(e){
      console.warn('summary JSON parse/normalize error', e);
    }
  }

  // --- DataTables and list interactions ---
  const hasTable = document.querySelector('.summary-table') !== null;
  if (hasTable){
    // only init DataTables if jquery + datatables are available
    const jq = window.jQuery;
    const dtAvail = jq && jq.fn && jq.fn.dataTable;
    if (dtAvail){
      try {
        const dt = $('.summary-table').DataTable({
          paging: true,
          scrollY: '55vh',
          scrollX: true,
          scrollCollapse: true,
          fixedHeader: { header: true, headerOffset: 0 },
          colReorder: true,
          autoWidth: false,
          columnDefs: [{ orderable: false, targets: 0 }]
        });
        if (typeof dt.colResize === 'function') {
          try { dt.colResize({ resizeMode: 'flex' }); } catch(e){ console.warn('colResize failed', e); }
        }
        const globalSearch = document.getElementById('globalSearch');
        if (globalSearch){
          globalSearch.addEventListener('input', function(){ dt.search(this.value).draw(); });
        }
        setTimeout(()=>{ try{ dt.columns.adjust().draw(); }catch(e){} }, 120);
      } catch(e){
        console.warn('DataTables init failed — falling back', e);
      }
    } else {
      // fallback plain filter if datatables not loaded
      const globalSearch = document.getElementById('globalSearch');
      if (globalSearch){
        globalSearch.addEventListener('input', function(){
          const q = this.value.toLowerCase();
          document.querySelectorAll('.summary-table tbody tr').forEach(tr => {
            tr.style.display = tr.textContent.toLowerCase().indexOf(q) !== -1 ? '' : 'none';
          });
        });
      }
    }

    // add select-all checkbox if any delete checkboxes exist
    try {
      const anyCheckbox = document.querySelector('input[name="delete_mark"]');
      if (anyCheckbox){
        const firstTh = document.querySelector('.summary-table thead th');
        if (firstTh && !document.getElementById('selectAll')){
          const chk = document.createElement('input');
          chk.type = 'checkbox'; chk.id = 'selectAll'; chk.title = 'Επιλογή όλων';
          chk.style.marginRight = '6px';
          firstTh.prepend(chk);
          chk.addEventListener('change', function(){ document.querySelectorAll('input[name="delete_mark"]').forEach(cb => cb.checked = this.checked); });
        }
        // try to auto-fill checkbox values from MARK/ΑΦΜ-like column
        const headers = Array.from(document.querySelectorAll('.summary-table thead th')).map(h => h.innerText.trim().toLowerCase());
        let markIdx = headers.findIndex(h => h.includes('mark'));
        if (markIdx === -1) markIdx = headers.findIndex(h => h.includes('αφμ') || h.includes('afm'));
        if (markIdx >= 0){
          document.querySelectorAll('.summary-table tbody tr').forEach(row => {
            const cb = row.querySelector('input[name="delete_mark"]');
            if (cb){
              const td = row.querySelectorAll('td')[markIdx];
              if (td){
                const v = td.innerText.trim();
                if (v) cb.value = v;
              }
            }
          });
        }
      }
    } catch(e){ console.warn('select-all / mark mapping error', e); }
  } // end hasTable
});
</script>
{% endblock %}
