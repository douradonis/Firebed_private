<div class="bg-white rounded-lg shadow p-6 mt-6">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-3">
    <h3 class="text-xl font-semibold text-gray-800">Î›Î¯ÏƒÏ„Î± Î Î±ÏÎ±ÏƒÏ„Î±Ï„Î¹ÎºÏÎ½</h3>

    <div class="flex gap-2 items-center flex-wrap">
      {% if file_exists %}
      <div class="relative">
        <button id="downloadToggle" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-400" type="button" aria-haspopup="true" aria-expanded="false">
          â¬‡ï¸ ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î± .xlsx
        </button>
        <div id="downloadMenu" class="hidden absolute right-0 mt-2 min-w-[220px] bg-white rounded-lg shadow-lg overflow-hidden z-50">
          <a class="block px-4 py-2 hover:bg-gray-100 transition" href="{{ url_for('list_invoices', download=1) }}">Î•Î¾Î¿Î´Î¿Î»ÏŒÎ³Î¹Î¿ (.xlsx)</a>
          <button id="epsilonExport" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition">Epsilon Excel â€” ÎˆÏÏ‡ÎµÏ„Î±Î¹</button>
        </div>
      </div>
      {% endif %}

      <a class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg shadow hover:bg-gray-300 transition" href="{{ url_for('fetch') }}">â¬… Bulk Fetch</a>
    </div>
  </div>

  <div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-4">
    <input id="globalSearch" type="search" placeholder="ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·..." class="p-2 border border-gray-300 rounded-lg w-full sm:w-64 focus:outline-none focus:ring-2 focus:ring-blue-400">
    <button id="deleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 transition">ğŸ—‘ï¸ Î”Î¹Î±Î³ÏÎ±Ï†Î® Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Ï‰Î½</button>
    <div id="deleteSpinner" class="ml-2 hidden text-gray-700">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®â€¦</div>
  </div>

  <div class="overflow-x-auto">
    {% if table_html %}
      {{ table_html | safe }}
    {% else %}
      <div class="p-3 text-gray-500">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚ Ï€ÏÎ¿Ï‚ ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·.</div>
    {% endif %}
  </div>
</div>

<!-- Delete modal -->
<div id="deleteModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-30">
  <div class="bg-white p-6 rounded-lg w-80 shadow-lg text-center">
    <div id="deleteModalMessage" class="mb-4 font-semibold text-gray-800"></div>
    <div class="flex gap-3 justify-center">
      <button id="deleteCancel" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
      <button id="deleteConfirm" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 transition">Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
    </div>
  </div>
</div>

<script>
(function(){
  const qs = (s,r=document)=>r.querySelector(s);
  const qsa = (s,r=document)=>Array.from((r||document).querySelectorAll(s));

  // Download dropdown
  const toggle = qs('#downloadToggle'), menu = qs('#downloadMenu');
  if(toggle && menu){
    toggle.addEventListener('click', e=>{
      e.stopPropagation();
      menu.classList.toggle('hidden');
      toggle.setAttribute('aria-expanded', menu.classList.contains('hidden')?'false':'true');
    });
    document.addEventListener('click', e=>{
      if(!menu.classList.contains('hidden') && !menu.contains(e.target) && !toggle.contains(e.target)){
        menu.classList.add('hidden');
        toggle.setAttribute('aria-expanded','false');
      }
    });
    document.addEventListener('keydown', e=>{if(e.key==='Escape'){menu.classList.add('hidden'); toggle.setAttribute('aria-expanded','false');}});
    qs('#epsilonExport')?.addEventListener('click', e=>{ e.preventDefault(); menu.classList.add('hidden'); alert('Î— ÎµÎ¾Î±Î³Ï‰Î³Î® Epsilon Î¸Î± Ï…Î»Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ ÏƒÏÎ½Ï„Î¿Î¼Î±.'); });
  }

  // Checkbox values from MARK/AFM
  (function mapCheckboxValues(){
    const anyCb=qs('input[name="delete_mark"]'); if(!anyCb) return;
    const headers=qsa('.summary-table thead th').map(th=>th.innerText.trim().toLowerCase());
    let markIdx=headers.findIndex(h=>h.includes('mark') || h.includes('Î±Ï†Î¼') || h.includes('afm'));
    if(markIdx>=0){
      qsa('.summary-table tbody tr').forEach(row=>{
        const cb=row.querySelector('input[name="delete_mark"]');
        const tds=row.querySelectorAll('td');
        if(cb && tds[markIdx]) cb.value=tds[markIdx].innerText.trim();
      });
    }
  })();

  // Select-all checkbox
  (function(){
    const anyCb=qs('input[name="delete_mark"]'); if(!anyCb) return;
    const firstTh=qs('.summary-table thead th'); if(!firstTh) return;
    if(!qs('#selectAll')){
      const chk=document.createElement('input'); chk.type='checkbox'; chk.id='selectAll'; chk.title='Î•Ï€Î¹Î»Î¿Î³Î® ÏŒÎ»Ï‰Î½'; chk.className='mr-2';
      firstTh.prepend(chk);
      chk.addEventListener('change', function(){ qsa('input[name="delete_mark"]').forEach(cb=>cb.checked=this.checked); });
    }
  })();

  // Fallback search (Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ DataTable)
  qs('#globalSearch')?.addEventListener('input', function(){
    const q=this.value.toLowerCase();
    qsa('.summary-table tbody tr').forEach(tr=>tr.style.display=tr.innerText.toLowerCase().includes(q)?'':'none');
  });

  // Delete flow
  (function(){
    const deleteBtn=qs('#deleteBtn'); if(!deleteBtn) return;
    const modal=qs('#deleteModal');
    const modalMsg=qs('#deleteModalMessage');
    const cancelBtn=qs('#deleteCancel');
    const confirmBtn=qs('#deleteConfirm');
    const spinner=qs('#deleteSpinner');
    let toDelete=[];

    deleteBtn.addEventListener('click', ()=>{
      toDelete=qsa('input[name="delete_mark"]:checked').map(cb=>cb.value).filter(v=>v.trim()!=='');
      if(!toDelete.length){ alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ Ï€ÏÏÏ„Î± Î³ÏÎ±Î¼Î¼Î­Ï‚ Î³Î¹Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®.'); return; }
      modalMsg.textContent=`Î˜ÎµÏ‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ ${toDelete.length} ÎµÎ³Î³ÏÎ±Ï†Î®(ÎµÏ‚);`;
      modal.classList.remove('hidden');
    });

    cancelBtn?.addEventListener('click', ()=>modal.classList.add('hidden'));

    confirmBtn?.addEventListener('click', ()=>{
      confirmBtn.disabled=true; spinner?.classList.remove('hidden');
      const form=document.createElement('form'); form.method='POST'; form.action="{{ url_for('delete_invoices') }}";
      const existingCsrf=qs('input[name="csrf_token"]'); 
      if(existingCsrf){ const t=document.createElement('input'); t.type='hidden'; t.name='csrf_token'; t.value=existingCsrf.value; form.appendChild(t); }
      toDelete.forEach(v=>{ const inp=document.createElement('input'); inp.type='hidden'; inp.name='delete_mark'; inp.value=v; form.appendChild(inp); });
      document.body.appendChild(form); form.submit();
    });
  })();
})();
</script>
