<div class="bg-white rounded-lg shadow p-6 mt-6">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-3">
    <h3 class="text-xl font-semibold text-gray-800">Î›Î¯ÏƒÏ„Î± Î Î±ÏÎ±ÏƒÏ„Î±Ï„Î¹ÎºÏÎ½</h3>

    <div class="flex gap-2 items-center flex-wrap">
      {% if file_exists %}
      <div class="relative">
        <button id="downloadToggle" class="px-4 py-2 bg-[#0d6efd] text-white rounded-lg shadow hover:bg-[#0b5ed7] transition flex items-center gap-2" type="button" aria-haspopup="true" aria-expanded="false">
          â¬‡ï¸ ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î± .xlsx
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
          </svg>
        </button>
        <div id="downloadMenu" class="hidden absolute right-0 mt-2 min-w-[220px] bg-white rounded-lg shadow-lg overflow-hidden z-50">
          <a class="block px-4 py-2 hover:bg-gray-100 transition" href="{{ url_for('list_invoices', download=1) }}">Î•Î¾Î¿Î´Î¿Î»ÏŒÎ³Î¹Î¿ (.xlsx)</a>
          <button id="epsilonExport" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition">Epsilon Excel â€” ÎˆÏÏ‡ÎµÏ„Î±Î¹</button>
        </div>
      </div>
      {% endif %}
      <a class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg shadow hover:bg-gray-300 transition" href="{{ url_for('fetch') }}">â¬… Bulk Fetch</a>
    </div>
  </div>

  <div class="flex items-center gap-3 mb-4">
    <input id="globalSearch" type="search" placeholder="ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·..." class="p-2 border border-gray-300 rounded-lg w-64 focus:outline-none focus:ring-2 focus:ring-blue-400">
    <button id="deleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 transition">ğŸ—‘ï¸ Î”Î¹Î±Î³ÏÎ±Ï†Î® Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Ï‰Î½</button>
    <div id="deleteSpinner" class="ml-2 hidden text-gray-700">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®â€¦</div>
  </div>

  <div class="overflow-x-auto">
    {% if table_html %}
      {{ table_html | safe }}
    {% else %}
      <div class="p-3 text-gray-500">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚ Ï€ÏÎ¿Ï‚ ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·.</div>
    {% endif %}
  </div>
</div>

<!-- Delete modal -->
<div id="deleteModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-30">
  <div class="bg-white p-6 rounded-lg w-80 shadow-lg text-center">
    <div id="deleteModalMessage" class="mb-4 font-semibold text-gray-800"></div>
    <div class="flex gap-3 justify-center">
      <button id="deleteCancel" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
      <button id="deleteConfirm" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 transition">Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
    </div>
  </div>
</div>

<style>
.summary-table th {
  background-color: #0d6efd;
  color: white;
  border: 1px solid #ccc;
}
.summary-table td {
  border: 1px solid #e2e8f0;
}
.summary-table tr:nth-child(even) { background-color: #f9fafb; }
.summary-table tr:hover { background-color: #e6f0ff; }
.summary-table tfoot td {
  background-color: #f1f5f9;
}
</style>

<script>
(function(){
  const qs = (s,r=document)=>r.querySelector(s);
  const qsa = (s,r=document)=>Array.from((r||document).querySelectorAll(s));

  function parseLocalizedNumber(str){
    if(!str) return 0;
    return parseFloat(str.replace(/\./g,'').replace(',','.')) || 0;
  }

  function formatGreekNumber(n){
    if(n===null||n===undefined) n=0;
    const sign = n<0?'-':'';
    const absn=Math.abs(Number(n)||0);
    const parts=absn.toFixed(2).split('.');
    const intPart=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    const decPart=parts[1]||'00';
    return sign+intPart+','+decPart;
  }

  function reorderColumns(){
    const table = qs('.summary-table');
    if(!table) return;
    const headers = Array.from(table.querySelectorAll('thead th'));
    const headerTexts = headers.map(h => (h.innerText || h.textContent || '').trim().toLowerCase());
    const moveLast = ['Ï†Ï€Î±_ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹Î±','ÎµÎ¯Î´Î¿Ï‚'];
    const indexesToMove = moveLast.map(name => headerTexts.findIndex(h => h === name.toLowerCase()))
                                  .filter(idx => idx >= 0);
    if(!indexesToMove.length) return;
    const allRows = [ ...qsa('thead tr', table), ...qsa('tbody tr', table) ];
    allRows.forEach(tr => {
      indexesToMove.forEach(idx => {
        const cell = tr.children[idx];
        if(cell) tr.appendChild(cell);
      });
    });
  }

  function computeTableTotals(){
    try {
      const table=qs('.summary-table');
      if(!table) return;
      const thead=table.querySelector('thead');
      const headers=thead?Array.from(thead.querySelectorAll('th')):[];
      const headerTexts=headers.map(h => (h.innerText || h.textContent || '').toString().trim().toLowerCase());

      const netKeys=['ÎºÎ±Î¸Î±ÏÎ®','ÎºÎ±Î¸Î±ÏÎ·','net','netvalue','totalnet','ÎºÎ±Î¸Î±ÏÎ· Î±Î¾Î¹Î±','ÎºÎ±Î¸Î±ÏÎ® Î±Î¾Î¯Î±'];
      const vatKeys=['Ï†Ï€Î±','vat']; 
      const totalKeys=['ÏƒÏÎ½Î¿Î»Î¿','ÏƒÏ…Î½Î¿Î»Î¿','total','totalvalue','sum'];

      function findIndexByKeywords(keys){
        for(let i=0;i<headerTexts.length;i++){
          const t=headerTexts[i];
          if(!t) continue;
          for(const k of keys) if(t===k) return i;
        }
        return -1;
      }

      const netIdx=findIndexByKeywords(netKeys);
      const vatIdx=findIndexByKeywords(vatKeys);
      const totalIdx=findIndexByKeywords(totalKeys);

      let netSum=0, vatSum=0, totalSum=0;
      const tbody=table.querySelector('tbody');
      if(!tbody) return;

      Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
        if(tr.style.display==='none') return; // ÎœÏŒÎ½Î¿ Î¿ÏÎ±Ï„Î­Ï‚ Î³ÏÎ±Î¼Î¼Î­Ï‚
        const tds=Array.from(tr.querySelectorAll('td'));
        if(netIdx>=0 && tds[netIdx]) netSum+=parseLocalizedNumber(tds[netIdx].innerText);
        if(vatIdx>=0 && tds[vatIdx]) vatSum+=parseLocalizedNumber(tds[vatIdx].innerText);
        if(totalIdx>=0 && tds[totalIdx]) totalSum+=parseLocalizedNumber(tds[totalIdx].innerText);
      });

      const existingTfoot=table.querySelector('tfoot');
      if(existingTfoot) existingTfoot.remove();

      const tfoot=document.createElement('tfoot');
      const tr=document.createElement('tr');
      const colCount=headers.length || (table.querySelectorAll('tr:first-child td').length || 0);

      for(let i=0;i<colCount;i++){
        const td=document.createElement('td');
        td.className='p-2 border text-right font-medium';
        if(i===0){
          td.className='p-2 border text-left font-semibold';
          td.innerText='Î£Î¥ÎÎŸÎ›Î‘';
        } else if(i===netIdx) td.innerText=formatGreekNumber(netSum);
        else if(i===vatIdx) td.innerText=formatGreekNumber(vatSum);
        else if(i===totalIdx) td.innerText=formatGreekNumber(totalSum);
        else td.innerText='';
        tr.appendChild(td);
      }
      tfoot.appendChild(tr);
      table.appendChild(tfoot);
    } catch(e){ console.warn('computeTableTotals failed', e); }
  }

  document.addEventListener('DOMContentLoaded', function(){
    reorderColumns();
    computeTableTotals();

    // ÎœÎ¹ÎºÏÏŒÏ„ÎµÏÎ¿ Ï€Î»Î¬Ï„Î¿Ï‚ Î³Î¹Î± checkbox
    const firstTh = qs('.summary-table thead th:first-child');
    if(firstTh) firstTh.style.width = '40px';
    qsa('.summary-table tbody tr').forEach(tr => {
      const firstTd = tr.querySelector('td:first-child');
      if(firstTd) firstTd.style.width = '40px';
    });

    // Toggle checkbox ÏƒÎµ Î´Î¹Ï€Î»ÏŒ ÎºÎ»Î¹Îº
    const tbody = qs('.summary-table tbody');
    if(tbody){
      tbody.addEventListener('dblclick', e => {
        const tr = e.target.closest('tr');
        if(!tr) return;
        const cb = tr.querySelector('input[name="delete_mark"]');
        if(cb) cb.checked = !cb.checked;
      });
    }

    // --- Global Search + dynamic totals ---
    const globalSearch = qs('#globalSearch');

    function applyFilter(){
      const q = (globalSearch.value||'').toLowerCase();

      // DataTables API search
      if(window.jQuery && jQuery.fn && jQuery.fn.dataTable){
        const dt = $('.summary-table').DataTable();
        if(dt){
          dt.search(globalSearch.value).draw();
          computeTableTotals(); // Totals after DataTables filter
          return;
        }
      }

      // fallback manual filtering
      qsa('.summary-table tbody tr').forEach(tr=>{
        tr.style.display = tr.innerText.toLowerCase().includes(q)?'':'none';
      });
      computeTableTotals(); // Totals Î¼ÎµÏ„Î¬ Ï„Î¿ manual filter
    }

    if(globalSearch){
      globalSearch.addEventListener('input', applyFilter);
      globalSearch.addEventListener('keyup', e => {
        if(['Delete','Backspace'].includes(e.key) || (e.metaKey||e.ctrlKey && e.key.toLowerCase()==='a')){
          setTimeout(applyFilter, 10);
        }
      });
      globalSearch.addEventListener('keydown', e=>{
        if(e.key==='Escape'){
          globalSearch.value='';
          applyFilter();
        }
      });
      const mo = new MutationObserver(applyFilter);
      mo.observe(globalSearch, { attributes:true, attributeFilter:['value'] });
      window.addEventListener('beforeunload', ()=>mo.disconnect());
    }

    // --- Download dropdown ---
    const toggle = qs('#downloadToggle'), menu = qs('#downloadMenu');
    if(toggle && menu){
      toggle.addEventListener('click', e=>{
        e.stopPropagation();
        menu.classList.toggle('hidden');
        toggle.setAttribute('aria-expanded', menu.classList.contains('hidden')?'false':'true');
      });
      document.addEventListener('click', e=>{
        if(!menu.classList.contains('hidden') && !menu.contains(e.target) && !toggle.contains(e.target)){
          menu.classList.add('hidden');
          toggle.setAttribute('aria-expanded','false');
        }
      });
      document.addEventListener('keydown', e=>{if(e.key==='Escape'){menu.classList.add('hidden'); toggle.setAttribute('aria-expanded','false');}});
      qs('#epsilonExport')?.addEventListener('click', e=>{ e.preventDefault(); menu.classList.add('hidden'); alert('Î— ÎµÎ¾Î±Î³Ï‰Î³Î® Epsilon Î¸Î± Ï…Î»Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ ÏƒÏÎ½Ï„Î¿Î¼Î±.'); });
    }

    // --- Delete button ---
    const deleteBtn=qs('#deleteBtn'); if(deleteBtn){
      const modal=qs('#deleteModal');
      const modalMsg=qs('#deleteModalMessage');
      const cancelBtn=qs('#deleteCancel');
      const confirmBtn=qs('#deleteConfirm');
      const spinner=qs('#deleteSpinner');
      let toDelete=[];
      deleteBtn.addEventListener('click', ()=>{
        toDelete=qsa('input[name="delete_mark"]:checked').map(cb=>cb.value).filter(v=>v.trim()!=='');
        if(!toDelete.length){ alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ Ï€ÏÏÏ„Î± Î³ÏÎ±Î¼Î¼Î­Ï‚ Î³Î¹Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®.'); return; }
        modalMsg.textContent=`Î˜ÎµÏ‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ ${toDelete.length} ÎµÎ³Î³ÏÎ±Ï†Î®(ÎµÏ‚);`;
        modal.classList.remove('hidden');
      });
      cancelBtn?.addEventListener('click', ()=>modal.classList.add('hidden'));
      confirmBtn?.addEventListener('click', ()=>{
        confirmBtn.disabled=true; spinner?.classList.remove('hidden');
        const form=document.createElement('form'); form.method='POST'; form.action="{{ url_for('delete_invoices') }}";
        const existingCsrf=qs('input[name="csrf_token"]'); 
        if(existingCsrf){ const t=document.createElement('input'); t.type='hidden'; t.name='csrf_token'; t.value=existingCsrf.value; form.appendChild(t); }
        toDelete.forEach(v=>{ const inp=document.createElement('input'); inp.type='hidden'; inp.name='delete_mark'; inp.value=v; form.appendChild(inp); });
        document.body.appendChild(form); form.submit();
      });
    }

  });
})();
</script>

