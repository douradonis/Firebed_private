<div class="bg-white rounded-lg shadow p-4">
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-lg font-semibold">Î›Î¯ÏƒÏ„Î± Î Î±ÏÎ±ÏƒÏ„Î±Ï„Î¹ÎºÏÎ½</h2>
    <div class="flex gap-2 items-center">
      {% if file_exists %}
        <div class="download-dropdown" id="downloadDropdown">
          <button id="downloadToggle" class="download-toggle" type="button" aria-haspopup="true" aria-expanded="false">
            â¬‡ï¸ ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î± .xlsx
          </button>
          <div id="downloadMenu" class="download-menu hidden" role="menu" aria-labelledby="downloadToggle">
            <a href="{{ url_for('list_invoices', download=1) }}" role="menuitem">Î•Î¾Î¿Î´Î¿Î»ÏŒÎ³Î¹Î¿</a>
            <button id="epsilonExport" role="menuitem" type="button">Epsilon Excel â€” ÎˆÏÏ‡ÎµÏ„Î±Î¹ (placeholder)</button>
          </div>
        </div>
      {% endif %}
      <a class="small-btn secondary" href="{{ url_for('fetch') }}">â¬… Bulk Fetch</a>
    </div>
  </div>

  <div class="mb-3 flex gap-2">
    <input id="globalSearch" type="search" placeholder="ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·..." class="p-2 border rounded w-64">
    <button id="deleteBtn" class="small-btn danger">ğŸ—‘ï¸ Î”Î¹Î±Î³ÏÎ±Ï†Î® Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Ï‰Î½</button>
  </div>

  {% if error %}
    <div class="flash-banner flash-error">
      {{ error }}
      <button type="button" class="close-btn" onclick="this.parentElement.remove()">Ã—</button>
    </div>
  {% endif %}
  {% if message %}
    <div class="flash-banner flash-success">
      {{ message }}
      <button type="button" class="close-btn" onclick="this.parentElement.remove()">Ã—</button>
    </div>
  {% endif %}

  <div class="table-wrapper">
    {% if table_html %}
      {{ table_html | safe }}
    {% else %}
      <div class="p-3 text-gray-600">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚ Ï€ÏÎ¿Ï‚ ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·.</div>
    {% endif %}
  </div>
</div>

<script>
$(document).ready(function(){
  // DataTables setup
  try {
    const dt = $('.summary-table').DataTable({
      paging: true,
      scrollY: '55vh',
      scrollX: true,
      scrollCollapse: true,
      fixedHeader: { header: true, headerOffset: 0 },
      colReorder: true,
      autoWidth: false,
      columnDefs: [{ orderable: false, targets: 0 }] 
    });
    dt.colResize({ resizeMode: 'flex' });
    $('#globalSearch').on('input', function(){ dt.search(this.value).draw(); });
  } catch(e){
    console.warn("DataTables not initialized:", e);
    $('#globalSearch').on('input', function(){
      const q = this.value.toLowerCase();
      $('.summary-table tbody tr').each(function(){
        $(this).toggle($(this).text().toLowerCase().indexOf(q) !== -1);
      });
    });
  }

  // select-all checkbox
  $('#selectAll').on('change', function(){
    const checked = this.checked;
    $('input[type="checkbox"][name="delete_mark"]').prop('checked', checked);
  });

  // Delete modal
  const modal = $('#deleteModal');
  let marksToDelete = [];
  $('#deleteBtn').on('click', function(){
    marksToDelete = $('input[type="checkbox"][name="delete_mark"]:checked').map(function(){ return $(this).val(); }).get();
    if(!marksToDelete.length){ alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ Ï€ÏÏÏ„Î± Î³ÏÎ±Î¼Î¼Î­Ï‚ Î³Î¹Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®.'); return; }
    $('#deleteModalMessage').text(`Î˜ÎµÏ‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ ${marksToDelete.length} ÎµÎ³Î³ÏÎ±Ï†Î®(ÎµÏ‚);`);
    modal.show();
  });
  modal.find('.cancel').on('click', function(){ modal.hide(); });
  modal.find('.confirm').on('click', function(){
    const form = $('<form method="POST" action="{{ url_for("delete_invoices") }}"></form>');
    marksToDelete.forEach(function(s){ form.append($('<input>').attr('type','hidden').attr('name','delete_mark').val(s)); });
    $('body').append(form);
    form.submit();
  });

  // Download dropdown
  const toggle = document.getElementById('downloadToggle');
  const menu = document.getElementById('downloadMenu');
  if(toggle && menu){
    toggle.addEventListener('click', e => { e.stopPropagation(); menu.classList.toggle('hidden'); });
    document.addEventListener('click', e => { if(!menu.contains(e.target) && !toggle.contains(e.target)) menu.classList.add('hidden'); });
  }
});
</script>
