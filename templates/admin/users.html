{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>Manage Users</h1>
        </div>
        <div class="col-md-4 text-right">
            <button class="btn btn-success" onclick="showCreateUserModal()">+ Create User</button>
            <a href="/admin" class="btn btn-secondary">← Back to Dashboard</a>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Groups</th>
                    <th>Admin</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                {% for user in users %}
                <tr id="user-row-{{ user.id }}">
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>
                        {% if user.groups %}
                            {% for group in user.groups %}
                                <span class="badge badge-info">{{ group.name }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_admin %}
                            <span class="badge badge-warning">Yes</span>
                        {% else %}
                            <span class="badge badge-light">No</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showEditUserModal({{ user.id }}, '{{ user.username }}', '{{ user.email }}', {{ user.is_admin|lower }})">Edit</button>
                        <button class="btn btn-sm btn-primary" onclick="showUserActivityModal({{ user.id }}, '{{ user.username }}')">Activity</button>
                        {% if user.id != current_user.id %}
                        <button class="btn btn-sm btn-danger" onclick="deleteUserAjax({{ user.id }}, '{{ user.username }}')">Delete</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New User</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" class="form-control" id="newUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="newEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" class="form-control" id="newPassword" required>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="newIsAdmin">
                        <label class="form-check-label" for="newIsAdmin">Make Admin</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createUserAjax()">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" class="form-control" id="editUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="editEmail" required>
                    </div>
                    <div class="form-group">
                        <label>New Password (leave blank to keep current)</label>
                        <input type="password" class="form-control" id="editPassword">
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="editIsAdmin">
                        <label class="form-check-label" for="editIsAdmin">Make Admin</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateUserAjax()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- User Activity Modal -->
<div class="modal fade" id="userActivityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Activity - <span id="activityUsername"></span></h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="userActivityContent">Loading...</div>
            </div>
        </div>
    </div>
</div>

<script>
let currentEditingUserId = null;

function showCreateUserModal() {
    document.getElementById('createUserForm').reset();
    $('#createUserModal').modal('show');
}

function showEditUserModal(userId, username, email, isAdmin) {
    currentEditingUserId = userId;
    document.getElementById('editUsername').value = username;
    document.getElementById('editEmail').value = email;
    document.getElementById('editIsAdmin').checked = isAdmin;
    document.getElementById('editPassword').value = '';
    $('#editUserModal').modal('show');
}

function createUserAjax() {
    const username = document.getElementById('newUsername').value;
    const email = document.getElementById('newEmail').value;
    const password = document.getElementById('newPassword').value;
    const isAdmin = document.getElementById('newIsAdmin').checked;

    if (!username || !email || !password) {
        alert('All fields required');
        return;
    }

    fetch('/admin/api/users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            username: username,
            email: email,
            password: password,
            is_admin: isAdmin
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('User created successfully');
            $('#createUserModal').modal('hide');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function updateUserAjax() {
    const username = document.getElementById('editUsername').value;
    const email = document.getElementById('editEmail').value;
    const password = document.getElementById('editPassword').value;
    const isAdmin = document.getElementById('editIsAdmin').checked;

    fetch(`/admin/api/users/${currentEditingUserId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            username: username,
            email: email,
            password: password || null,
            is_admin: isAdmin
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('User updated successfully');
            $('#editUserModal').modal('hide');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

async function deleteUserAjax(userId, username) {
    if (!await showModalConfirm('Επιβεβαίωση Διαγραφής', `Θέλεις σίγουρα να διαγράψεις τον χρήστη ${username}; Αυτό δεν μπορεί να αναιρεθεί.`, 'Διαγραφή', 'Άκυρο')) return;

    fetch(`/admin/api/users/${userId}`, {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showModalAlert('Επιτυχία', 'Ο χρήστης διαγράφηκε');
            document.getElementById(`user-row-${userId}`).remove();
        } else {
            showErrorModal('Σφάλμα', 'Error: ' + data.error);
        }
    });
}

function showUserActivityModal(userId, username) {
    document.getElementById('activityUsername').textContent = username;
    document.getElementById('userActivityContent').innerHTML = 'Loading...';

    fetch(`/admin/api/user-actions/${userId}`)
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const actions = data.actions;
            let html = '<div class="list-group">';
            
            if (actions.length === 0) {
                html += '<div class="list-group-item">No activity recorded</div>';
            } else {
                actions.forEach(action => {
                    const timestamp = new Date(action.timestamp).toLocaleString();
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <strong>${action.event_type || 'Unknown'}</strong>
                                <small class="text-muted">${timestamp}</small>
                            </div>
                            <small>${action.group_name || 'N/A'}</small>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('userActivityContent').innerHTML = html;
        } else {
            document.getElementById('userActivityContent').innerHTML = 'Error: ' + data.error;
        }
    });

    $('#userActivityModal').modal('show');
}
</script>

{% endblock %}
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<script src="/static/admin_users.js"></script>

{% endblock %}
