<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/colreorder/1.6.2/js/dataTables.colReorder.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables-colresize@1.0.0/dist/dataTables.colResize.min.js"></script>

<script>
$(document).ready(function(){
  // DataTables setup
  try {
    const dt = $('.summary-table').DataTable({
      paging: true,
      scrollY: '55vh',
      scrollX: true,
      scrollCollapse: true,
      fixedHeader: { header: true, headerOffset: 0 },
      colReorder: true,
      autoWidth: false,
      columnDefs: [{ orderable: false, targets: 0 }] 
    });
    dt.colResize({ resizeMode: 'flex' });
    $('#globalSearch').on('input', function(){ dt.search(this.value).draw(); });
  } catch(e){
    console.warn("DataTables not initialized:", e);
    $('#globalSearch').on('input', function(){
      const q = this.value.toLowerCase();
      $('.summary-table tbody tr').each(function(){
        $(this).toggle($(this).text().toLowerCase().indexOf(q) !== -1);
      });
    });
  }

  // select-all checkbox
  $('#selectAll').on('change', function(){
    const checked = this.checked;
    $('input[type="checkbox"][name="delete_mark"]').prop('checked', checked);
  });

  // Delete button -> open modal
  const modal = $('#deleteModal');
  let marksToDelete = [];
  $('#deleteBtn').on('click', function(){
    marksToDelete = $('input[type="checkbox"][name="delete_mark"]:checked').map(function(){ return $(this).val(); }).get();
    if(!marksToDelete.length){
      showModalAlert('Ενημέρωση', 'Επίλεξε πρώτα γραμμές για διαγραφή.');
      return;
    }
    $('#deleteModalMessage').text(`Θες σίγουρα να διαγράψεις ${marksToDelete.length} εγγραφή(ες);`);
    modal.show();
  });

  // Modal buttons
  modal.find('.cancel').on('click', function(){ modal.hide(); });
  modal.find('.confirm').on('click', function(){
    const form = $('<form method="POST" action="{{ url_for("delete_invoices") }}"></form>');
    marksToDelete.forEach(function(s){
      form.append($('<input>').attr('type','hidden').attr('name','delete_mark').val(s));
    });
    $('body').append(form);
    form.submit();
  });

  // Auto fade-out flash banners
  document.querySelectorAll('.flash-banner').forEach(b => {
    setTimeout(() => { b.style.transition = "opacity 0.8s ease"; b.style.opacity = "0"; setTimeout(()=>b.remove(),800); }, 5000);
  });

  // Download dropdown behaviour
  (function(){
    const toggle = document.getElementById('downloadToggle');
    const menu = document.getElementById('downloadMenu');
    const epsilon = document.getElementById('epsilonExport');
    if(!toggle || !menu) return;
    function openMenu(){ menu.classList.remove('hidden'); toggle.setAttribute('aria-expanded','true'); }
    function closeMenu(){ menu.classList.add('hidden'); toggle.setAttribute('aria-expanded','false'); }
    toggle.addEventListener('click', function(e){ e.stopPropagation(); menu.classList.contains('hidden')?openMenu():closeMenu(); });
    document.addEventListener('click', function(e){ if(!menu.classList.contains('hidden') && !menu.contains(e.target) && !toggle.contains(e.target)) closeMenu(); });
    document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeMenu(); });
    if(epsilon){
      epsilon.addEventListener('click', function(e){
        e.preventDefault(); closeMenu();
        if(typeof showBanner==='function'){ showBanner('Η εξαγωγή Epsilon θα υλοποιηθεί σύντομα.','info',6000); } 
        else { showModalAlert('Πληροφορία', 'Η εξαγωγή Epsilon θα υλοποιηθεί σύντομα.'); }
      });
    }
  })();
});
</script>
