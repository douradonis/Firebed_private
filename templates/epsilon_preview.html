{% extends "base.html" %}
{% block title %}Epsilon — Προεπισκόπηση Κινήσεων{% endblock %}

{% block content %}
<style>
.dataTables_wrapper .dataTables_filter input{border:1px solid #ddd;padding:6px 8px;border-radius:6px}
.toggle-cell{cursor:pointer;user-select:none;width:24px;text-align:center}
.badge-warn{display:inline-flex;align-items:center;gap:4px;color:#b45309;background:#fef3c7;border:1px solid #fde68a;padding:2px 6px;border-radius:6px;font-size:12px}
.badge-warn svg{width:14px;height:14px}
.child-table td,.child-table th{padding:6px 8px;border-bottom:1px solid #eee;font-size:12px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:1px solid #d1d5db}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-primary{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
</style>
<style>
  .container { max-width: min(1800px, 96vw); }
</style>

<!-- Strict Issues Modal -->
<div id="issuesModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-xl max-w-3xl w-[92vw] p-4">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-lg font-semibold">Απαιτούνται διορθώσεις</h3>
      <button id="issuesCloseBtn" class="px-2 py-1 border rounded">Κλείσιμο</button>
    </div>
    <div id="issuesList" class="max-h-[60vh] overflow-auto space-y-2 text-sm"></div>
    <div class="mt-3 text-sm text-gray-600">Διόρθωσε τα παραπάνω και ξαναδοκίμασε την εξαγωγή.</div>
  </div>
</div>

<div class="bg-white rounded shadow p-6">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      <a href="javascript:history.back()" class="inline-flex items-center gap-2 px-3 py-2 border rounded hover:bg-gray-50">
        ← Επιστροφή
      </a>
      <h2 class="text-lg font-semibold">Προεπισκόπηση Epsilon (VAT: {{ vat or '' }})</h2>
    </div>

    <div class="flex items-center gap-2">
      <button id="exportBridgeBtn" class="btn btn-primary" disabled
              title="Απενεργό: απαιτείται κάθε γραμμή να έχει CUSTID, Χαρακτηρισμούς & Λογαριασμούς">
        Λήψη Γέφυρας (Strict)
      </button>
    </div>
  </div>

  <div class="text-sm text-gray-500 mb-2">Σύνολα προσαρμόζονται στο φίλτρο αναζήτησης</div>

  <!-- Totals -->
  <div id="totalsBar" class="grid grid-cols-3 md:grid-cols-6 gap-2 mb-4">
    <div class="p-2 rounded bg-gray-50"><div class="text-xs text-gray-500">Σύνολο Καθαρής</div><div id="tNet" class="font-semibold">0,00</div></div>
    <div class="p-2 rounded bg-gray-50"><div class="text-xs text-gray-500">Σύνολο ΦΠΑ</div><div id="tVat" class="font-semibold">0,00</div></div>
    <div class="p-2 rounded bg-gray-50"><div class="text-xs text-gray-500">Σύνολο Μικτό</div><div id="tGross" class="font-semibold">0,00</div></div>
    <div class="p-2 rounded bg-gray-50"><div class="text-xs text-gray-500">Εγγραφές</div><div id="tRows" class="font-semibold">0</div></div>
  </div>

  <div id="emptyState" class="hidden p-4 rounded border border-dashed text-gray-600">
    Δεν βρέθηκαν εγγραφές στο afm_epsilon_invoices.
  </div>

  <table id="epsilonTable" class="display stripe hover w-full">
    <thead>
      <tr>
        <th></th>
        <th>ΜΑΡΚ</th>
        <th>Ημερομηνία</th>
        <th>ΑΦΜ εκδότη</th>
        <th>Όνομα εκδότη</th>
        <th>Κωδικός Συναλλασσόμενου</th>
        <th>Αριθμός παραστατικού</th>
        <th>Συνολική καθαρή αξία</th>
        <th>Συνολικό ΦΠΑ</th>
        <th>Σύνολο Μικτό</th>
        <th>Είδος παραστατικού</th>
        <th>Χαρακτηρισμοί</th>
        <th>Λογαριασμοί</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const TABLE_DATA = {{ table_rows|tojson|safe }};
const ACTIVE_VAT = "{{ vat or '' }}";
const BRIDGE_ISSUES = {{ (bridge_issues or [])|tojson|safe }};

function money(n){
  const v = Number(n)||0;
  return v.toLocaleString('el-GR',{minimumFractionDigits:2, maximumFractionDigits:2});
}

function warnBadge(title){
  return `<span class="badge-warn" title="${title||'Λείπει τιμή'}">
      <svg viewBox="0 0 20 20" fill="currentColor"><path d="M8.257 3.099c.765-1.36 2.72-1.36 3.485 0l6.518 11.6A2 2 0 0 1 16.518 18H3.482a2 2 0 0 1-1.742-3.301l6.517-11.6zM11 14a1 1 0 1 0-2 0 1 1 0 0 0 2 0zm-1-2a1 1 0 0 0 1-1V8a1 1 0 1 0-2 0v3a1 1 0 0 0 1 1z"/></svg>
      !
    </span>`;
}

function warnIfEmpty(val, title){
  if(val === null || val === undefined) return warnBadge(title);
  const s = String(val).trim();
  return s ? s : warnBadge(title);
}

function custidCell(custid){
  if(custid === null || custid === undefined || custid === ''){
    return warnBadge("Δεν βρέθηκε στον client_db");
  }
  return String(custid);
}

function hasMissingCategory(lines){
  return (lines||[]).some(ln => !String((ln && ln.category) || '').trim());
}
function hasMissingVat(lines){
  return (lines||[]).some(ln => {
    const v = (ln && (ln.vat_rate_in ?? ln.vat_rate));
    return v === null || v === undefined || String(v).trim() === '';
  });
}
function hasMissingAccounts(lines){
  return (lines||[]).some(ln => !String((ln && ln.lcode_detail) || '').trim());
}

function childRowsHtml(lines){
  if(!lines || !lines.length) return '<div class="text-sm text-gray-500 p-2">—</div>';
  let rows = lines.map((ln,i)=>`
    <tr>
      <td class="text-gray-500">${i+1}</td>
      <td>${warnIfEmpty(ln.category, 'Λείπει χαρακτηρισμός')}</td>
      <td class="text-right">${money(ln.net)}</td>
      <td class="text-right">${money(ln.vat)}</td>
      <td class="text-right">${money(ln.gross)}</td>
      <td class="text-center">${(ln.vat_rate_in ?? ln.vat_rate ?? '') ? (ln.vat_rate_in ?? ln.vat_rate) + '%' : warnBadge('Λείπει ΦΠΑ')}</td>
    </tr>`).join('');
  return `
    <table class="child-table w-full" style="table-layout:fixed;">
      <colgroup>
        <col style="width:8%">
        <col style="width:42%">
        <col style="width:15%">
        <col style="width:15%">
        <col style="width:15%">
        <col style="width:5%">
      </colgroup>
      <thead><tr>
        <th>#</th><th>Χαρακτηρισμός (γραμμή)</th><th class="text-right">Καθαρή</th><th class="text-right">ΦΠΑ</th><th class="text-right">Μικτό</th><th>ΦΠΑ %</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

function isReceipt(doctxt){
  const t = (doctxt||'').toString().toLowerCase();
  return t.includes('αποδειξ') || t.includes('receipt') || t.includes('λιαν');
}

function allRowsValid(api){
  const data = api.rows({search:'applied'}).data();
  let ok = data.length > 0;
  for(let i=0;i<data.length;i++){
    const r = data[i];
    const hasCust = !(r.CUSTID === null || r.CUSTID === undefined || r.CUSTID === '');
    const hasChar = !r._missChar && !!String(r.CHARACTS||'').trim();
    const hasLcodes = !r._missLcodes && !!String(r.LCODES||'').trim();
    if(!hasCust || !hasChar || !hasLcodes){ ok = false; break; }
  }
  return ok;
}

function updateTotalsAndExportState(api){
  const data = api.rows({search:'applied'}).data();
  let net=0, vat=0, gross=0;
  for(let i=0;i<data.length;i++){
    net += Number(data[i].NET)||0;
    vat += Number(data[i].VAT)||0;
    gross += Number(data[i].GROSS)||0;
  }
  document.getElementById('tNet').textContent = money(net);
  document.getElementById('tVat').textContent = money(vat);
  document.getElementById('tGross').textContent = money(gross);
  document.getElementById('tRows').textContent = data.length;

  const btn = document.getElementById('exportBridgeBtn');
  const ok = allRowsValid(api);
  btn.disabled = !ok;
  btn.title = ok ? "Όλα εντάξει — κάνε λήψη γέφυρας" : "Απενεργό: απαιτείται κάθε γραμμή να έχει CUSTID, Χαρακτηρισμούς & Λογαριασμούς";
}

$(function(){
  if(!TABLE_DATA || !TABLE_DATA.length){
    $('#emptyState').removeClass('hidden');
  }

  const dt = $('#epsilonTable').DataTable({
    data: (TABLE_DATA||[]).map(r => {
      const lines = r.LINES || [];
      const missChar = hasMissingCategory(lines);
      const missVat  = hasMissingVat(lines);
      const missAcc  = hasMissingAccounts(lines) || !String(r.LCODE_DETAIL_SUMMARY||'').trim();
      const isRec    = isReceipt(r.DOCTYPE);
      return {
        _expand: lines.length>1 ? '+' : '',
        MARK: r.MARK || '',
        DATE: r.DATE || '',
        AFM: r.AFM_ISSUER || '',
        NAME: r.ISSUER_NAME || '',
        CUSTID: r.CUSTID,
        AA: r.AA || '',
        NET: Number(r.NET)||0,
        VAT: Number(r.VAT)||0,
        GROSS: Number(r.GROSS)||0,
        DOCTYPE: r.DOCTYPE || '',
        CHARACTS: r.CHARACTS || '',
        LCODES: r.LCODE_DETAIL_SUMMARY || '',
        _lines: lines,
        _missChar: missChar,
        _missVat: missVat,
        _missLcodes: missAcc,
        _isReceipt: isRec
      };
    }),
    columns: [
      { data: '_expand', className:'toggle-cell', orderable:false, searchable:false,
        render: (d,t,row)=> row._lines && row._lines.length>1 ? '<span class="text-sky-700 font-bold">+</span>' : ''
      },
      { data: 'MARK', visible:false },     // hide MARK
      { data: 'DATE' },
      { data: 'AFM' },
      { data: 'NAME', render:(d,t,row)=> row._isReceipt ? (d||'') : warnIfEmpty(d,'Λείπει όνομα εκδότη') },
      { data: 'CUSTID', render:(d)=> custidCell(d) },
      { data: 'AA', render:(d)=> warnIfEmpty(d,'Λείπει Α/Α') },
      { data: 'NET', className:'text-right', render:(d)=> money(d) },
      { data: 'VAT', className:'text-right', render:(d)=> money(d) },
      { data: 'GROSS', className:'text-right', render:(d)=> money(d) },
      { data: 'DOCTYPE', render:(d,t,row)=> {
          if(row._isReceipt){
            return d||''; // για αποδείξεις: χωρίς badges
          }
          const base = warnIfEmpty(d,'Λείπει είδος');
          return row._missVat ? (base + ' ' + warnBadge('Λείπει ΦΠΑ σε γραμμές')) : base;
        } 
      },
      { data: 'CHARACTS', render:(d,t,row)=> {
          const baseTxt = String(d||'').trim();
          if(row._isReceipt){
            return baseTxt; // για αποδείξεις: χωρίς badges στους χαρακτηρισμούς
          }
          if(row._missChar){
            const b = warnBadge('Λείπουν χαρακτηρισμοί σε γραμμές');
            return baseTxt ? (baseTxt + ' ' + b) : b;
          }
          return warnIfEmpty(baseTxt,'Λείπουν χαρακτηρισμοί');
        } 
      },
      { data: 'LCODES', render:(d,t,row)=> {
          const baseTxt = String(d||'').trim();
          if(row._missLcodes){
            const b = warnBadge('Λείπουν λογαριασμοί σε γραμμές');
            return baseTxt ? (baseTxt + ' ' + b) : b;
          }
          return warnIfEmpty(baseTxt,'Λείπουν λογαριασμοί');
        } 
      },
    ],
    order: [[2,'desc']],
    pageLength: 25,
    deferRender: true,
    drawCallback: function(){ updateTotalsAndExportState(this.api()); }
  });

  // expand/collapse child rows
  $('#epsilonTable tbody').on('click', 'td.toggle-cell', function(){
    const tr = $(this).closest('tr');
    const row = dt.row(tr);
    const rdata = row.data();
    if(!rdata._lines || rdata._lines.length<=1) return;
    if(row.child.isShown()){
      row.child.hide(); tr.removeClass('shown');
      $(this).html('<span class="text-sky-700 font-bold">+</span>');
    } else {
      row.child(childRowsHtml(rdata._lines)).show(); tr.addClass('shown');
      $(this).html('<span class="text-sky-700 font-bold">−</span>');
    }
  });

  // initial compute
  updateTotalsAndExportState(dt);

  // Export
  document.getElementById('exportBridgeBtn')?.addEventListener('click', function(){
    if(this.disabled) return;
    window.location.href = "/export/fastimport/kinitseis?vat=" + encodeURIComponent(ACTIVE_VAT);
  });

  // Show issues modal immediately if there are issues
  (function(){
    const issues = Array.isArray(BRIDGE_ISSUES) ? BRIDGE_ISSUES : [];
    if(!issues.length) return;
    const wrap = document.getElementById('issuesModal');
    const list = document.getElementById('issuesList');
    list.innerHTML = issues.map((i,idx)=>{
      const msg = (i.message || '').toString().replace(/</g,'&lt;');
      const code = i.code ? `<span class="text-xs text-gray-500">(${i.code})</span>` : '';
      return `<div class="p-2 rounded border bg-amber-50 border-amber-200">${idx+1}. ${msg} ${code}</div>`;
    }).join('');
    wrap.classList.remove('hidden'); wrap.classList.add('flex');
    document.getElementById('issuesCloseBtn')?.addEventListener('click', ()=> wrap.classList.add('hidden'));
  })();
});
</script>
{% endblock %}