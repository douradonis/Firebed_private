{% extends "base.html" %}
{% block title %}Epsilon — Προεπισκόπηση Κινήσεων{% endblock %}

{% block content %}
<style>
.dataTables_wrapper .dataTables_filter input{border:1px solid #ddd;padding:6px 8px;border-radius:6px}
.toggle-cell{cursor:pointer;user-select:none}
.badge-warn{display:inline-flex;align-items:center;gap:4px;color:#b45309;background:#fef3c7;border:1px solid #fde68a;padding:2px 6px;border-radius:6px;font-size:12px}
.badge-warn svg{width:14px;height:14px}
.child-table td,.child-table th{padding:6px 8px;border-bottom:1px solid #eee;font-size:12px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:1px solid #d1d5db}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-primary{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
</style>
<style>
  /* ΜΟΝΟ για αυτή τη σελίδα: άνοιξε το container */
  .container {
    max-width: min(1800px, 96vw); /* παίξε με 1800px -> 2000px αν θες περισσότερο */
  }
</style>

<div class="bg-white rounded shadow p-6">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      <a href="javascript:history.back()" class="inline-flex items-center gap-2 px-3 py-2 border rounded hover:bg-gray-50">
        ← Επιστροφή
      </a>
      <h2 class="text-lg font-semibold">Προεπισκόπηση Epsilon (VAT: {{ vat or '' }})</h2>
    </div>

    <div class="flex items-center gap-2">
      <button id="exportBridgeBtn" class="btn btn-primary" disabled
              title="Απενεργό: απαιτείται κάθε γραμμή να έχει CUSTID και Χαρακτηρισμούς">
        Λήψη Γέφυρας (Strict)
      </button>
    </div>
  </div>

  <div class="text-sm text-gray-500 mb-2">Σύνολα προσαρμόζονται στο φίλτρο αναζήτησης</div>

  <!-- Totals -->
  <div id="totalsBar" class="grid grid-cols-3 md:grid-cols-6 gap-2 mb-4">
    <div class="p-2 rounded bg-gray-50"><div class="text-xs text-gray-500">Σύνολο Καθαρής</div><div id="tNet" class="font-semibold">0,00</div></div>
    <div class="p-2 rounded bg-gray-50"><div class="text-xs text-gray-500">Σύνολο ΦΠΑ</div><div id="tVat" class="font-semibold">0,00</div></div>
    <div class="p-2 rounded bg-gray-50"><div class="text-xs text-gray-500">Σύνολο Μικτό</div><div id="tGross" class="font-semibold">0,00</div></div>
    <div class="p-2 rounded bg-gray-50"><div class="text-xs text-gray-500">Εγγραφές</div><div id="tRows" class="font-semibold">0</div></div>
  </div>

  <div id="emptyState" class="hidden p-4 rounded border border-dashed text-gray-600">
    Δεν βρέθηκαν εγγραφές στο afm_epsilon_invoices.
  </div>

  <table id="epsilonTable" class="display stripe hover w-full">
    <thead>
      <tr>
        <th></th>
        <th>ΜΑΡΚ</th>
        <th>Ημερομηνία</th>
        <th>ΑΦΜ εκδότη</th>
        <th>Όνομα εκδότη</th> <!-- ΝΕΑ ΣΤΗΛΗ -->
        <th>Κωδικός Συναλλασσόμενου</th>
        <th>Αριθμός παραστατικού</th>
        <th>Συνολική καθαρή αξία</th>
        <th>Συνολικό ΦΠΑ</th>
        <th>Σύνολο Μικτό</th>
        <th>Είδος παραστατικού</th>
        <th>Χαρακτηρισμοί</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const TABLE_DATA = {{ table_rows|tojson|safe }};
const ACTIVE_VAT = "{{ vat or '' }}";

function money(n){
  const v = Number(n)||0;
  return v.toLocaleString('el-GR',{minimumFractionDigits:2, maximumFractionDigits:2});
}

function childRowsHtml(lines){
  if(!lines || !lines.length) return '<div class="text-sm text-gray-500 p-2">—</div>';
  let rows = lines.map((ln,i)=>`
    <tr>
      <td class="text-gray-500">${i+1}</td>
      <td>${(ln.category||'').replaceAll('<','&lt;')}</td>
      <td class="text-right">${money(ln.net)}</td>
      <td class="text-right">${money(ln.vat)}</td>
      <td class="text-right">${money(ln.gross)}</td>
      <td class="text-center">${ln.vat_rate ?? ''}%</td>
    </tr>`).join('');
  return `
    <table class="child-table w-full">
      <thead><tr>
        <th>#</th><th>Χαρακτηρισμός (γραμμή)</th><th>Καθαρή</th><th>ΦΠΑ</th><th>Μικτό</th><th>ΦΠΑ %</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

function custidCell(custid){
  if(custid === null || custid === undefined || custid === ''){
    return `<span class="badge-warn" title="Δεν βρέθηκε στον client_db">
      <svg viewBox="0 0 20 20" fill="currentColor"><path d="M8.257 3.099c.765-1.36 2.72-1.36 3.485 0l6.518 11.6A2 2 0 0 1 16.518 18H3.482a2 2 0 0 1-1.742-3.301l6.517-11.6zM11 14a1 1 0 1 0-2 0 1 1 0 0 0 2 0zm-1-2a1 1 0 0 0 1-1V8a1 1 0 1 0-2 0v3a1 1 0 0 0 1 1z"/></svg>
      !
    </span>`;
  }
  return String(custid);
}

function allRowsHaveCustidAndCharacts(api){
  const data = api.rows({search:'applied'}).data();
  for(let i=0;i<data.length;i++){
    const r = data[i];
    const hasCust = !(r.CUSTID === null || r.CUSTID === undefined || r.CUSTID === '');
    const hasChar = !!String(r.CHARACTS||'').trim();
    if(!hasCust || !hasChar) return false;
  }
  return data.length > 0; // και να μην είναι άδειο το φίλτρο
}

function updateTotalsAndExportState(api){
  // ΔΥΝΑΜΙΚΑ ΣΥΝΟΛΑ με βάση το search (όλες οι φιλτραρισμένες σειρές, όχι μόνο το page)
  const data = api.rows({search:'applied'}).data();
  let net=0, vat=0, gross=0;
  for(let i=0;i<data.length;i++){
    net += Number(data[i].NET)||0;
    vat += Number(data[i].VAT)||0;
    gross += Number(data[i].GROSS)||0;
  }
  document.getElementById('tNet').textContent = money(net);
  document.getElementById('tVat').textContent = money(vat);
  document.getElementById('tGross').textContent = money(gross);
  document.getElementById('tRows').textContent = data.length;

  // Enable/disable export button
  const btn = document.getElementById('exportBridgeBtn');
  const ok = allRowsHaveCustidAndCharacts(api);
  btn.disabled = !ok;
  btn.title = ok ? "Όλα εντάξει — κάνε λήψη γέφυρας" : "Απενεργό: απαιτείται κάθε γραμμή να έχει CUSTID και Χαρακτηρισμούς";
}

$(function(){
  if(!TABLE_DATA || !TABLE_DATA.length){
    $('#emptyState').removeClass('hidden');
    return;
  }

  const dt = $('#epsilonTable').DataTable({
    data: TABLE_DATA.map(r => ({
      _expand: r.LINES && r.LINES.length>1 ? '+' : '',
      MARK: r.MARK || '',
      DATE: r.DATE || '',
      AFM: r.AFM_ISSUER || '',
      NAME: r.ISSUER_NAME || '',            // ΝΕΟ
      CUSTID: r.CUSTID,
      AA: r.AA || '',
      NET: Number(r.NET)||0,
      VAT: Number(r.VAT)||0,
      GROSS: Number(r.GROSS)||0,
      DOCTYPE: r.DOCTYPE || '',
      CHARACTS: r.CHARACTS || '',
      _lines: r.LINES || []
    })),
    columns: [
      { data: '_expand', className:'toggle-cell', orderable:false, searchable:false, width:"24px",
        render: (d,t,row)=> row._lines && row._lines.length>1 ? '<span class="text-sky-700 font-bold">+</span>' : ''
      },
      { data: 'MARK' },
      { data: 'DATE' },
      { data: 'AFM' },
      { data: 'NAME' },                          <!-- ΝΕΑ ΣΤΗΛΗ -->
      { data: 'CUSTID', render:(d)=> custidCell(d) },
      { data: 'AA' },
      { data: 'NET', className:'text-right', render:(d)=> money(d) },
      { data: 'VAT', className:'text-right', render:(d)=> money(d) },
      { data: 'GROSS', className:'text-right', render:(d)=> money(d) },
      { data: 'DOCTYPE' },
      { data: 'CHARACTS', render:(d,t,row)=>{
          const s = String(d||'').trim();
          if (!s && row._lines && row._lines.length>1) {
            return '<span class="badge-warn">Πολλαπλές κατηγορίες ΦΠΑ</span>';
          }
          if (/^Πολλαπλές κατηγορίες ΦΠΑ/.test(s)) {
            return `<span class="badge-warn">${s}</span>`;
          }
          return s || '';
        }
      },
    ],
    order: [[2,'desc']],
    pageLength: 25,
    deferRender: true,
    drawCallback: function(){ updateTotalsAndExportState(this.api()); } // <-- δυναμικά σύνολα & enable state
  });

  // Αναδίπλωση/child rows
  $('#epsilonTable tbody').on('click', 'td.toggle-cell', function(){
    const tr = $(this).closest('tr');
    const row = dt.row(tr);
    const rdata = row.data();
    if(!rdata._lines || rdata._lines.length<=1) return;
    if(row.child.isShown()){
      row.child.hide(); tr.removeClass('shown');
      $(this).html('<span class="text-sky-700 font-bold">+</span>');
    } else {
      row.child(childRowsHtml(rdata._lines)).show(); tr.addClass('shown');
      $(this).html('<span class="text-sky-700 font-bold">−</span>');
    }
  });

  // Πυροδότησε αρχικό compute (χωρίς να περιμένεις χειρισμό)
  updateTotalsAndExportState(dt);

  // Export bridge button
  document.getElementById('exportBridgeBtn')?.addEventListener('click', function(){
    if(this.disabled) return;
    // ίδιο tab — route exporter (που ήδη έχεις από το strict module)
    window.location.href = "/export/fastimport/kinitseis?vat=" + encodeURIComponent(ACTIVE_VAT);
  });
});
</script>
<script>
const BRIDGE_OK = {{ 1 if bridge_ok else 0 }};
const BRIDGE_ISSUES = {{ (bridge_issues or [])|tojson|safe }};
</script>

{% endblock %}
