{% extends "base.html" %}
{% block title %}Epsilon â€” Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· ÎšÎ¹Î½Î®ÏƒÎµÏ‰Î½{% endblock %}

{% block content %}
<style>
.dataTables_wrapper .dataTables_filter input{border:1px solid #ddd;padding:6px 8px;border-radius:6px}
.toggle-cell{cursor:pointer;user-select:none;width:24px;text-align:center}
.badge-warn{display:inline-flex;align-items:center;gap:4px;color:#b45309;background:#fef3c7;border:1px solid #fde68a;padding:2px 6px;border-radius:6px;font-size:12px}
.badge-warn svg{width:14px;height:14px}
.child-table td,.child-table th{padding:6px 8px;border-bottom:1px solid #eee;font-size:12px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:1px solid #d1d5db}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-primary{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
</style>
<style>
  .container { max-width: min(1800px, 96vw); }
</style>

<!-- Strict Issues Modal -->
<div id="issuesModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-xl max-w-3xl w-[92vw] p-4">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-lg font-semibold">Î‘Ï€Î±Î¹Ï„Î¿ÏÎ½Ï„Î±Î¹ Î´Î¹Î¿ÏÎ¸ÏÏƒÎµÎ¹Ï‚</h3>
      <button id="issuesCloseBtn" class="px-2 py-1 border rounded">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
    <div id="issuesList" class="max-h-[60vh] overflow-auto space-y-2 text-sm"></div>
    <div class="mt-3 text-sm text-gray-600">Î”Î¹ÏŒÏÎ¸Ï‰ÏƒÎµ Ï„Î± Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰ ÎºÎ±Î¹ Î¾Î±Î½Î±Î´Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Ï„Î·Î½ ÎµÎ¾Î±Î³Ï‰Î³Î®.</div>
  </div>
</div>

<div class="bg-white rounded shadow p-6">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      <a href="javascript:history.back()" class="inline-flex items-center gap-2 px-3 py-2 border rounded hover:bg-gray-50">
        â† Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î®
      </a>
      <h2 class="text-lg font-semibold">Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Epsilon (VAT: {{ vat or '' }})</h2>
    </div>

    <div class="flex items-center gap-2">
      <button id="exportBridgeBtn" class="btn btn-primary" disabled
              title="Î‘Ï€ÎµÎ½ÎµÏÎ³ÏŒ: Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ ÎºÎ¬Î¸Îµ Î³ÏÎ±Î¼Î¼Î® Î½Î± Î­Ï‡ÎµÎ¹ CUSTID, Î§Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÎ¼Î¿ÏÏ‚ & Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿ÏÏ‚">
        Î›Î®ÏˆÎ· Î“Î­Ï†Ï…ÏÎ±Ï‚ (Strict)
      </button>
    </div>
  </div>

  <div class="text-sm text-gray-500 mb-2">Î£ÏÎ½Î¿Î»Î± Ï€ÏÎ¿ÏƒÎ±ÏÎ¼ÏŒÎ¶Î¿Î½Ï„Î±Î¹ ÏƒÏ„Î¿ Ï†Î¯Î»Ï„ÏÎ¿ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚</div>

  <!-- Totals -->
  <div id="totalsBar" class="grid grid-cols-3 md:grid-cols-6 gap-2 mb-4">
    <div class="p-2 rounded bg-gray-50"><div class="text-xs text-gray-500">Î£ÏÎ½Î¿Î»Î¿ ÎšÎ±Î¸Î±ÏÎ®Ï‚</div><div id="tNet" class="font-semibold">0,00</div></div>
    <div class="p-2 rounded bg-gray-50"><div class="text-xs text-gray-500">Î£ÏÎ½Î¿Î»Î¿ Î¦Î Î‘</div><div id="tVat" class="font-semibold">0,00</div></div>
    <div class="p-2 rounded bg-gray-50"><div class="text-xs text-gray-500">Î£ÏÎ½Î¿Î»Î¿ ÎœÎ¹ÎºÏ„ÏŒ</div><div id="tGross" class="font-semibold">0,00</div></div>
    <div class="p-2 rounded bg-gray-50"><div class="text-xs text-gray-500">Î•Î³Î³ÏÎ±Ï†Î­Ï‚</div><div id="tRows" class="font-semibold">0</div></div>
  </div>

  <div id="emptyState" class="hidden p-4 rounded border border-dashed text-gray-600">
    Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚ ÏƒÏ„Î¿ afm_epsilon_invoices.
  </div>

  <div class="flex justify-end mb-3">
    <input id="epsilonSearch" type="search" placeholder="ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÎºÎ¹Î½Î®ÏƒÎµÏ‰Î½" class="px-3 py-2 border rounded-md w-full md:w-72 focus:outline-none focus:ring-2 focus:ring-sky-500">
  </div>

  <table id="epsilonTable" class="display stripe hover w-full">
    <thead>
      <tr>
        <th></th>
        <th>ÎœÎ‘Î¡Îš</th>
        <th>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th>
        <th>Î‘Î¦Îœ ÎµÎºÎ´ÏŒÏ„Î·</th>
        <th>ÎŒÎ½Î¿Î¼Î± ÎµÎºÎ´ÏŒÏ„Î·</th>
        <th>ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Î£Ï…Î½Î±Î»Î»Î±ÏƒÏƒÏŒÎ¼ÎµÎ½Î¿Ï…</th>
        <th>Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï€Î±ÏÎ±ÏƒÏ„Î±Ï„Î¹ÎºÎ¿Ï</th>
        <th>Î£Ï…Î½Î¿Î»Î¹ÎºÎ® ÎºÎ±Î¸Î±ÏÎ® Î±Î¾Î¯Î±</th>
        <th>Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î¦Î Î‘</th>
        <th>Î£ÏÎ½Î¿Î»Î¿ ÎœÎ¹ÎºÏ„ÏŒ</th>
        <th>Î•Î¯Î´Î¿Ï‚ Ï€Î±ÏÎ±ÏƒÏ„Î±Ï„Î¹ÎºÎ¿Ï</th>
        <th>Î§Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÎ¼Î¿Î¯</th>
        <th>Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Î¯</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
// Î•Ï€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏÎ¿Î® Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚ ÏƒÏ…Î½Î±Î»Î»Î±ÏƒÏƒÎ¿Î¼Î­Î½Ï‰Î½ ÏŒÏ„Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¼ÏŒÎ½Î¿ custid_missing
function hasCustIdMissing(){
  return Array.isArray(BRIDGE_ISSUES) && BRIDGE_ISSUES.some(i => String(i.code||'') === 'custid_missing');
}

// "ÎŒÎ»Î± Î­Ï„Î¿Î¹Î¼Î±" ÎµÎºÏ„ÏŒÏ‚ Î±Ï€ÏŒ CUSTID (Î´Î·Î». Ï‡Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÎ¼Î¿Î¯ & Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Î¯ Î¿Îº)
function allRowsValidExceptCust(api){
  const data = api.rows({search:'applied'}).data();
  if (data.length === 0) return false;
  for (let i=0;i<data.length;i++){
    const r = data[i];
    const hasChar   = !r._missChar   && !!String(r.CHARACTS||'').trim();
    const hasLcodes = !r._missLcodes && !!String(r.LCODES  ||'').trim();
    if (!hasChar || !hasLcodes) return false;
  }
  return true;
}

function ensureFlashContainer(){
  let container = document.getElementById('flashContainer');
  if (container) return container;
  const root = document.querySelector('.container') || document.body;
  container = document.createElement('div');
  container.id = 'flashContainer';
  container.className = 'space-y-2 mb-4';
  if (root.firstChild){
    root.insertBefore(container, root.firstChild);
  } else {
    root.appendChild(container);
  }
  return container;
}

function showFlash(message, type='info', timeout=3000){
  try {
    const container = ensureFlashContainer();
    if (!container) return;
    const selector = `[data-flash-dynamic="1"][data-message="${message}"][data-type="${type}"]`;
    const duplicate = container.querySelector(selector);
    if (duplicate) duplicate.remove();
    const el = document.createElement('div');
    el.className = 'flash-banner text-sm';
    if (type === 'success') el.classList.add('flash-success');
    else if (type === 'error') el.classList.add('flash-error');
    else {
      el.classList.add('flash-info');
      el.style.background = '#eff6ff';
      el.style.color = '#1e3a8a';
      el.style.border = '1px solid #bfdbfe';
    }
    el.dataset.flashDynamic = '1';
    el.dataset.message = message;
    el.dataset.type = type;
    if (timeout) el.setAttribute('data-ttl', String(timeout));
    el.textContent = message;
    container.appendChild(el);
  } catch (err) {
    console.warn('showFlash failed', err);
  }
}
</script>

<script>
const TABLE_DATA = {{ table_rows|tojson|safe }};
const ACTIVE_VAT = "{{ vat or '' }}";
const BRIDGE_ISSUES = {{ (bridge_issues or [])|tojson|safe }};
const CATEGORY_LABELS = {{ (category_labels or {})|tojson|safe }};

function money(n){
  const v = Number(n)||0;
  return v.toLocaleString('el-GR',{minimumFractionDigits:2, maximumFractionDigits:2});
}

function labelCategory(cat){
  const key = (cat ?? '').toString().trim();
  if(!key) return '';
  const map = (CATEGORY_LABELS && typeof CATEGORY_LABELS === 'object') ? CATEGORY_LABELS : {};
  return Object.prototype.hasOwnProperty.call(map, key) ? map[key] : key;
}

function labelCharList(text){
  if(!text) return '';
  return text.split(',').map(part => labelCategory(part)).filter(Boolean).join(', ');
}

function warnBadge(title){
  return `<span class="badge-warn" title="${title||'Î›ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¹Î¼Î®'}">
      <svg viewBox="0 0 20 20" fill="currentColor"><path d="M8.257 3.099c.765-1.36 2.72-1.36 3.485 0l6.518 11.6A2 2 0 0 1 16.518 18H3.482a2 2 0 0 1-1.742-3.301l6.517-11.6zM11 14a1 1 0 1 0-2 0 1 1 0 0 0 2 0zm-1-2a1 1 0 0 0 1-1V8a1 1 0 1 0-2 0v3a1 1 0 0 0 1 1z"/></svg>
      !
    </span>`;
}

function warnIfEmpty(val, title){
  if(val === null || val === undefined) return warnBadge(title);
  const s = String(val).trim();
  return s ? s : warnBadge(title);
}

function custidCell(custid){
  if(custid === null || custid === undefined || custid === ''){
    return warnBadge("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î¿Î½ client_db");
  }
  return String(custid);
}

function hasMissingCategory(lines){
  return (lines||[]).some(ln => !String((ln && ln.category) || '').trim());
}
function hasMissingVat(lines){
  return (lines||[]).some(ln => {
    const v = (ln && (ln.vat_rate_in ?? ln.vat_rate));
    return v === null || v === undefined || String(v).trim() === '';
  });
}
function hasMissingAccounts(lines){
  return (lines||[]).some(ln => !String((ln && ln.lcode_detail) || '').trim());
}

function childRowsHtml(lines){
  if(!lines || !lines.length) return '<div class="text-sm text-gray-500 p-2">â€”</div>';
  let rows = lines.map((ln,i)=>`
    <tr>
      <td class="text-gray-500">${i+1}</td>
      <td>${warnIfEmpty(labelCategory(ln.category || ln._label || ''), 'Î›ÎµÎ¯Ï€ÎµÎ¹ Ï‡Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÎ¼ÏŒÏ‚')}</td>
      <td class="text-right">${money(ln.net)}</td>
      <td class="text-right">${money(ln.vat)}</td>
      <td class="text-right">${money(ln.gross)}</td>
      <td class="text-center">${(ln.vat_rate_in ?? ln.vat_rate ?? '') ? (ln.vat_rate_in ?? ln.vat_rate) + '%' : warnBadge('Î›ÎµÎ¯Ï€ÎµÎ¹ Î¦Î Î‘')}</td>
    </tr>`).join('');
  return `
    <table class="child-table w-full" style="table-layout:fixed;">
      <colgroup>
        <col style="width:8%">
        <col style="width:42%">
        <col style="width:15%">
        <col style="width:15%">
        <col style="width:15%">
        <col style="width:5%">
      </colgroup>
      <thead><tr>
        <th>#</th><th>Î§Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÎ¼ÏŒÏ‚ (Î³ÏÎ±Î¼Î¼Î®)</th><th class="text-right">ÎšÎ±Î¸Î±ÏÎ®</th><th class="text-right">Î¦Î Î‘</th><th class="text-right">ÎœÎ¹ÎºÏ„ÏŒ</th><th>Î¦Î Î‘ %</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

function isReceipt(doctxt){
  const t = (doctxt||'').toString().toLowerCase();
  return t.includes('Î±Ï€Î¿Î´ÎµÎ¹Î¾') || t.includes('receipt') || t.includes('Î»Î¹Î±Î½');
}

function allRowsValid(api){
  const data = api.rows({search:'applied'}).data();
  let ok = data.length > 0;
  for(let i=0;i<data.length;i++){
    const r = data[i];
    const hasCust = !(r.CUSTID === null || r.CUSTID === undefined || r.CUSTID === '');
    const hasChar = !r._missChar && !!String(r.CHARACTS||'').trim();
    const hasLcodes = !r._missLcodes && !!String(r.LCODES||'').trim();
    if(!hasCust || !hasChar || !hasLcodes){ ok = false; break; }
  }
  return ok;
}

function updateTotalsAndExportState(api){
  const data = api.rows({search:'applied'}).data();
  let net=0, vat=0, gross=0;
  for(let i=0;i<data.length;i++){
    net += Number(data[i].NET)||0;
    vat += Number(data[i].VAT)||0;
    gross += Number(data[i].GROSS)||0;
  }
  document.getElementById('tNet').textContent = money(net);
  document.getElementById('tVat').textContent = money(vat);
  document.getElementById('tGross').textContent = money(gross);
  document.getElementById('tRows').textContent = data.length;

  const btn = document.getElementById('exportBridgeBtn');
  const allowPartnersFlow = hasCustIdMissing();                    // Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ custid_missing;
  const okStrict           = allRowsValid(api);                    // ÏŒÎ»Î± Î¿Îº (Ï€Î±ÏÎ±Î´Î¿ÏƒÎ¹Î±ÎºÎ¬)
  const okExceptCust       = allRowsValidExceptCust(api);          // Ï„Î± Ï€Î¬Î½Ï„Î± Î¿Îº ÎµÎºÏ„ÏŒÏ‚ Î±Ï€ÏŒ CUSTID

  const canExport = okStrict || (allowPartnersFlow && okExceptCust);
  btn.disabled = !canExport;
  if (btn){
    btn.dataset.exportMode = (allowPartnersFlow && okExceptCust && !okStrict) ? 'partners' : 'strict';
    btn.dataset.exportReady = canExport ? '1' : '0';
  }

  if (allowPartnersFlow && okExceptCust && !okStrict){
    // ÎœÏŒÎ½Î¿ Ï„Î± CUSTID Î»ÎµÎ¯Ï€Î¿Ï…Î½ -> Î¸Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ modal Î³Î¹Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±
    btn.textContent = "Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± & Î›Î®ÏˆÎ· Î“Î­Ï†Ï…ÏÎ±Ï‚";
    btn.title = "Î˜Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Î³Î¹Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î½Î­Ï‰Î½ ÏƒÏ…Î½Î±Î»Î»Î±ÏƒÏƒÎ¿Î¼Î­Î½Ï‰Î½ (AFM mode)";
  } else {
    btn.textContent = "Î›Î®ÏˆÎ· Î“Î­Ï†Ï…ÏÎ±Ï‚ (Strict)";
    btn.title = canExport
      ? "ÎŒÎ»Î± ÎµÎ½Ï„Î¬Î¾ÎµÎ¹ â€” ÎºÎ¬Î½Îµ Î»Î®ÏˆÎ· Î³Î­Ï†Ï…ÏÎ±Ï‚"
      : "Î‘Ï€ÎµÎ½ÎµÏÎ³ÏŒ: Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ ÎºÎ¬Î¸Îµ Î³ÏÎ±Î¼Î¼Î® Î½Î± Î­Ï‡ÎµÎ¹ CUSTID, Î§Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÎ¼Î¿ÏÏ‚ & Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿ÏÏ‚";
  }
}

function extractFilenameFromDisposition(disposition){
  if (!disposition) return null;
  let match = disposition.match(/filename\*=UTF-8''([^;]+)/i);
  if (match && match[1]){
    try { return decodeURIComponent(match[1]); }
    catch (_) {}
  }
  match = disposition.match(/filename="?([^";]+)"?/i);
  if (match && match[1]){
    return match[1];
  }
  return null;
}

function extractMessageFromHtml(html){
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const flash = doc.querySelector('[data-flash], .flash-banner, .alert');
    if (flash && flash.textContent){
      return flash.textContent.trim();
    }
    const title = doc.querySelector('title');
    if (title && title.textContent){
      return title.textContent.trim();
    }
  } catch (err){
    console.warn('extractMessageFromHtml failed', err);
  }
  return '';
}

async function performBridgeDownload(url, options){
  options = options || {};
  const btn = document.getElementById('exportBridgeBtn');
  const wasDisabled = btn ? btn.disabled : false;
  if (btn){
    btn.disabled = true;
    btn.dataset.busy = '1';
  }
  try {
    const res = await fetch(url, { credentials: 'same-origin' });
    const contentType = (res.headers.get('content-type') || '').toLowerCase();
    if (!res.ok){
      let message = 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎµÎ¾Î±Î³Ï‰Î³Î®Ï‚ Î³Î­Ï†Ï…ÏÎ±Ï‚.';
      if (contentType.includes('application/json')){
        try {
          const data = await res.json();
          if (data && (data.error || data.message)){
            message = data.error || data.message;
          }
        } catch (err){ console.warn('bridge json error', err); }
      } else {
        const text = await res.text();
        const extracted = extractMessageFromHtml(text) || text.slice(0, 180).trim();
        if (extracted) message = extracted;
      }
      showFlash(message, 'error', 6000);
      return false;
    }

    if (contentType.includes('text/html')){
      const html = await res.text();
      const message = extractMessageFromHtml(html) || 'Î— ÎµÎ¾Î±Î³Ï‰Î³Î® Î´ÎµÎ½ Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ. Î•Î»Î­Î³Î¾Ï„Îµ Ï„Ï…Ï‡ÏŒÎ½ ÏƒÏ†Î¬Î»Î¼Î±Ï„Î±.';
      showFlash(message, 'error', 6000);
      return false;
    }

    const blob = await res.blob();
    let filename = extractFilenameFromDisposition(res.headers.get('content-disposition') || '');
    if (!filename){
      const ext = contentType.includes('zip') ? '.zip' : '.xlsx';
      filename = 'epsilon_bridge' + ext;
    }

    const link = document.createElement('a');
    const blobUrl = URL.createObjectURL(blob);
    link.href = blobUrl;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    setTimeout(() => {
      try { URL.revokeObjectURL(blobUrl); } catch (_) {}
      try { link.remove(); } catch (_) {}
    }, 0);

    const mode = options.mode || 'strict';
    const baseMsg = mode === 'partners'
      ? 'Î— Î³Î­Ï†Ï…ÏÎ± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ ÎºÎ±Î¹ Î»Î®Ï†Î¸Î·ÎºÎµ (Î¼Îµ Î½Î­Î¿Ï…Ï‚ ÏƒÏ…Î½Î±Î»Î»Î±ÏƒÏƒÏŒÎ¼ÎµÎ½Î¿Ï…Ï‚).'
      : 'Î— Î³Î­Ï†Ï…ÏÎ± Î»Î®Ï†Î¸Î·ÎºÎµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±.';
    if (filename.toLowerCase().endsWith('.zip')){
      showFlash(baseMsg + ' Î£Ï…Î¼Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÏ„Î±Î¹ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ b_kat.ect.', 'success', 6000);
    } else {
      showFlash(baseMsg, 'success', 5000);
    }
    return true;
  } catch (err){
    console.error('performBridgeDownload failed', err);
    showFlash('Î ÏÎ¿Î­ÎºÏ…ÏˆÎµ ÏƒÏ†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î»Î®ÏˆÎ· Ï„Î·Ï‚ Î³Î­Ï†Ï…ÏÎ±Ï‚.', 'error', 6000);
    return false;
  } finally {
    if (btn){
      btn.disabled = wasDisabled;
      delete btn.dataset.busy;
    }
  }
}

$(function(){
  if(!TABLE_DATA || !TABLE_DATA.length){
    $('#emptyState').removeClass('hidden');
  }

  const dt = $('#epsilonTable').DataTable({
    data: (TABLE_DATA||[]).map(r => {
      const lines = r.LINES || [];
      const missChar = hasMissingCategory(lines);
      const missVat  = hasMissingVat(lines);
      const missAcc  = hasMissingAccounts(lines) || !String(r.LCODE_DETAIL_SUMMARY||'').trim();
      const isRec    = isReceipt(r.DOCTYPE);
      const labeledLines = (lines||[]).map(ln => ({ ...ln, _label: labelCategory(ln.category) }));
      const charLabel = labelCharList(r.CHARACTS || '');
      return {
        _expand: lines.length>1 ? '+' : '',
        MARK: r.MARK || '',
        DATE: r.DATE || '',
        AFM: r.AFM_ISSUER || '',
        NAME: r.ISSUER_NAME || '',
        CUSTID: r.CUSTID,
        AA: r.AA || '',
        NET: Number(r.NET)||0,
        VAT: Number(r.VAT)||0,
        GROSS: Number(r.GROSS)||0,
        DOCTYPE: r.DOCTYPE || '',
        CHARACTS: charLabel,
        CHARACTS_ORIG: r.CHARACTS || '',
        LCODES: r.LCODE_DETAIL_SUMMARY || '',
        _lines: labeledLines,
        _missChar: missChar,
        _missVat: missVat,
        _missLcodes: missAcc,
        _isReceipt: isRec
      };
    }),
    columns: [
      { data: '_expand', className:'toggle-cell', orderable:false, searchable:false,
        render: (d,t,row)=> row._lines && row._lines.length>1 ? '<span class="text-sky-700 font-bold">+</span>' : ''
      },
      { data: 'MARK', visible:false },     // hide MARK
      { data: 'DATE' },
      { data: 'AFM' },
      { data: 'NAME', render:(d,t,row)=> row._isReceipt ? (d||'') : warnIfEmpty(d,'Î›ÎµÎ¯Ï€ÎµÎ¹ ÏŒÎ½Î¿Î¼Î± ÎµÎºÎ´ÏŒÏ„Î·') },
      { data: 'CUSTID', render:(d)=> custidCell(d) },
      { data: 'AA', render:(d)=> warnIfEmpty(d,'Î›ÎµÎ¯Ï€ÎµÎ¹ Î‘/Î‘') },
      { data: 'NET', className:'text-right', render:(d)=> money(d) },
      { data: 'VAT', className:'text-right', render:(d)=> money(d) },
      { data: 'GROSS', className:'text-right', render:(d)=> money(d) },
      { data: 'DOCTYPE', render:(d,t,row)=> {
          if(row._isReceipt){
            return d||''; // Î³Î¹Î± Î±Ï€Î¿Î´ÎµÎ¯Î¾ÎµÎ¹Ï‚: Ï‡Ï‰ÏÎ¯Ï‚ badges
          }
          const base = warnIfEmpty(d,'Î›ÎµÎ¯Ï€ÎµÎ¹ ÎµÎ¯Î´Î¿Ï‚');
          return row._missVat ? (base + ' ' + warnBadge('Î›ÎµÎ¯Ï€ÎµÎ¹ Î¦Î Î‘ ÏƒÎµ Î³ÏÎ±Î¼Î¼Î­Ï‚')) : base;
        } 
      },
      { data: 'CHARACTS', render:(d,t,row)=> {
          const baseTxt = String(d||'').trim();
          if(row._isReceipt){
            return baseTxt; // Î³Î¹Î± Î±Ï€Î¿Î´ÎµÎ¯Î¾ÎµÎ¹Ï‚: Ï‡Ï‰ÏÎ¯Ï‚ badges ÏƒÏ„Î¿Ï…Ï‚ Ï‡Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÎ¼Î¿ÏÏ‚
          }
          if(row._missChar){
            const b = warnBadge('Î›ÎµÎ¯Ï€Î¿Ï…Î½ Ï‡Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÎ¼Î¿Î¯ ÏƒÎµ Î³ÏÎ±Î¼Î¼Î­Ï‚');
            return baseTxt ? (baseTxt + ' ' + b) : b;
          }
          return warnIfEmpty(baseTxt,'Î›ÎµÎ¯Ï€Î¿Ï…Î½ Ï‡Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÎ¼Î¿Î¯');
        } 
      },
      { data: 'LCODES', render:(d,t,row)=> {
          const baseTxt = String(d||'').trim();
          if(row._missLcodes){
            const b = warnBadge('Î›ÎµÎ¯Ï€Î¿Ï…Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Î¯ ÏƒÎµ Î³ÏÎ±Î¼Î¼Î­Ï‚');
            return baseTxt ? (baseTxt + ' ' + b) : b;
          }
          return warnIfEmpty(baseTxt,'Î›ÎµÎ¯Ï€Î¿Ï…Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Î¯');
        } 
      },
    ],
    order: [[2,'desc']],
    pageLength: 25,
    deferRender: true,
    dom: 'lrtip',
    drawCallback: function(){ updateTotalsAndExportState(this.api()); }
  });

  // expand/collapse child rows
  $('#epsilonTable tbody').on('click', 'td.toggle-cell', function(){
    const tr = $(this).closest('tr');
    const row = dt.row(tr);
    const rdata = row.data();
    if(!rdata._lines || rdata._lines.length<=1) return;
    if(row.child.isShown()){
      row.child.hide(); tr.removeClass('shown');
      $(this).html('<span class="text-sky-700 font-bold">+</span>');
    } else {
      row.child(childRowsHtml(rdata._lines)).show(); tr.addClass('shown');
      $(this).html('<span class="text-sky-700 font-bold">âˆ’</span>');
    }
  });

  // initial compute
  updateTotalsAndExportState(dt);

  const searchInput = document.getElementById('epsilonSearch');
  if(searchInput){
    searchInput.addEventListener('input', function(){ dt.search(this.value).draw(); });
  }

  // Export
  const exportBtn = document.getElementById('exportBridgeBtn');
  exportBtn?.addEventListener('click', async function(){
    if (this.disabled || this.dataset.busy === '1') return;
    const baseUrl = "/export/fastimport/kinitseis?vat=" + encodeURIComponent(ACTIVE_VAT);
    const mode = this.dataset.exportMode || 'strict';
    let targetUrl = baseUrl;
    if (mode === 'partners'){
      const proceed = await showModalConfirm(
        'Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚ ÏƒÏ…Î½Î±Î»Î»Î±ÏƒÏƒÏŒÎ¼ÎµÎ½Ï‰Î½',
        'Î˜Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸Î¿ÏÎ½ Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¿Î¯ ÏƒÏ…Î½Î±Î»Î»Î±ÏƒÏƒÏŒÎ¼ÎµÎ½Î¿Î¹ Î³Î¹Î± Î±Ï€Î¿Î´ÎµÎ¯Î¾ÎµÎ¹Ï‚ Ï‡Ï‰ÏÎ¯Ï‚ CUSTID. Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÎ¹Ï‚;',
        'Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·',
        'Î†ÎºÏ…ÏÎ¿'
      );
      if (!proceed) return;
      targetUrl += '&confirm_new_partners=1';
    }
    await performBridgeDownload(targetUrl, { mode });
  });

  // Show issues modal immediately if there are issues
  (function(){
    const issues = Array.isArray(BRIDGE_ISSUES) ? BRIDGE_ISSUES : [];
    if(!issues.length) return;
    const wrap = document.getElementById('issuesModal');
    const list = document.getElementById('issuesList');
    list.innerHTML = issues.map((i,idx)=>{
      const msg = (i.message || '').toString().replace(/</g,'&lt;');
      const code = i.code ? `<span class="text-xs text-gray-500">(${i.code})</span>` : '';
      return `<div class="p-2 rounded border bg-amber-50 border-amber-200">${idx+1}. ${msg} ${code}</div>`;
    }).join('');
    wrap.classList.remove('hidden'); wrap.classList.add('flex');
    document.getElementById('issuesCloseBtn')?.addEventListener('click', ()=> wrap.classList.add('hidden'));
  })();
});
</script>
{% endblock %}