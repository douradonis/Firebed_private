<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}myDATA{% endblock %}</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='dialogs.css') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="{{ url_for('static', filename='modal_utils.js') }}"></script>
  <script src="{{ url_for('static', filename='dialogs.js') }}"></script>

  <style>
    :root { --device-font-scale: 1; }
    html { font-size: calc(16px * var(--device-font-scale, 1)); }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #f3f4f6; }
    .container { max-width: 1100px; margin: 28px auto; padding: 16px; }
    .content-wrap { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }

    body[data-device='mobile'] .container {
      max-width: 100%;
      margin: 16px auto;
      padding: 12px;
    }

    body[data-device='tablet'] .container {
      max-width: 1000px;
      padding: 16px;
    }

    body[data-device='mobile'] .content-wrap {
      padding: 12px;
      border-radius: 16px;
    }

    body[data-device='mobile'] h1 {
      font-size: 1.75rem;
    }

    .layout-header__nav {
      flex-wrap: wrap;
    }

    body[data-device='tablet'] .layout-header__right {
      align-items: stretch;
      width: 100%;
    }

    body[data-device='tablet'] .layout-header__nav {
      flex-wrap: wrap;
      justify-content: flex-start;
    }

    body[data-device='tablet'] .layout-header__top-row {
      align-items: stretch;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    body[data-device='tablet'] .layout-header__year-row {
      width: 100%;
      justify-content: flex-start;
    }

    body[data-device='mobile'] .layout-header {
      flex-direction: column;
      align-items: stretch;
      gap: 1rem;
    }

    body[data-device='mobile'] .layout-header__brand {
      width: 100%;
    }

    body[data-device='mobile'] .layout-header__right {
      width: 100%;
      align-items: stretch;
      gap: 0.75rem;
    }

    body[data-device='mobile'] .layout-header__top-row {
      flex-direction: column;
      align-items: stretch;
      gap: 0.75rem;
      width: 100%;
    }

    body[data-device='mobile'] .layout-header__nav {
      width: 100%;
      overflow-x: auto;
      flex-wrap: nowrap;
      justify-content: flex-start;
      gap: 0.5rem;
    }

    body[data-device='mobile'] .layout-header__nav a {
      flex: 0 0 auto;
      white-space: nowrap;
      font-size: 0.95rem;
      padding: 0.55rem 0.75rem;
    }

    body[data-device='mobile'] .layout-header__nav::-webkit-scrollbar {
      height: 6px;
    }

    body[data-device='mobile'] .layout-header__nav::-webkit-scrollbar-thumb {
      background: rgba(14,165,233,0.45);
      border-radius: 999px;
    }

    body[data-device='mobile'] .layout-header__active {
      justify-content: space-between;
    }

    body[data-device='mobile'] .layout-header__year-row {
      width: 100%;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: flex-start;
    }

    body[data-device='mobile'] .layout-header__year-row label {
      flex: 1 1 100%;
    }

    body[data-device='mobile'] .layout-header__year-row select,
    body[data-device='mobile'] .layout-header__year-row button,
    body[data-device='mobile'] .layout-header__year-row span {
      flex: 1 1 calc(50% - 0.5rem);
      min-width: 0;
    }

    .flash-banner { border-radius: 8px; padding: 10px 14px; font-weight:500; box-shadow:0 1px 2px rgba(0,0,0,0.05); }
    .flash-success { background:#ecfdf5; color:#065f46; border:1px solid #bbf7d0; }
    .flash-error   { background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; }
    .flash-warning { background:#fef3c7; color:#92400e; border:1px solid #fde68a; }
    .flash-info    { background:#e0f2fe; color:#075985; border:1px solid #bae6fd; }

    /* Warning modal styling (shared look & feel) */
    [data-role="modal-warning"] { display: none; }
    [data-role="modal-warning"].flex,
    [data-role="modal-warning"].grid { display: flex; }

    .modal-warning-panel {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.15);
      width: 100%;
      max-width: 420px;
      padding: 24px;
      position: relative;
    }

    .modal-warning-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 1.125rem;
      color: #b91c1c;
    }

    .modal-warning-body {
      margin-top: 12px;
      margin-bottom: 22px;
      color: #374151;
      font-size: 0.95rem;
      line-height: 1.55;
    }

    .modal-warning-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .modal-warning-btn {
      border-radius: 10px;
      padding: 9px 16px;
      font-weight: 500;
      font-size: 0.95rem;
      transition: background-color .18s ease, color .18s ease, border-color .18s ease;
    }

    .modal-warning-btn--muted {
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #374151;
    }

    .modal-warning-btn--muted:hover {
      background: #f3f4f6;
    }

    .modal-warning-btn--danger {
      background: #dc2626;
      color: #ffffff;
      border: 1px solid transparent;
    }

    .modal-warning-btn--danger:hover {
      background: #b91c1c;
    }

    .modal-warning-btn--confirm {
      background: #b91c1c;
      color: #ffffff;
      border: 1px solid transparent;
    }

    .modal-warning-btn--confirm:hover {
      background: #9f1239;
    }

    .modal-warning-close {
      position: absolute;
      top: 18px;
      right: 18px;
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 1.25rem;
      line-height: 1;
      cursor: pointer;
    }

    .modal-warning-close:hover {
      color: #6b7280;
    }

    /* optional, Œ±ŒΩ Œ∏Œ≠ŒªŒµŒπœÇ Œ∫Œ±Œπ warning/info:
    .flash-warning { background:#fef3c7; color:#92400e; border:1px solid #fde68a; }
    .flash-info    { background:#e0f2fe; color:#075985; border:1px solid #bae6fd; } */
  </style>

  {% block head_extra %}{% endblock %}
</head>
<body>
  <div class="container">
    <header class="mb-6">
      <div class="layout-header flex items-center justify-between">
        <div class="layout-header__brand">
          <a href="{{ url_for('home') }}" class="inline-block">
            <h1 class="text-2xl font-semibold text-sky-700">myDATA</h1>
            <p class="text-sm text-gray-600">Firebed - myDATA tools</p>
          </a>
        </div>

        <div class="layout-header__right flex flex-col items-end gap-2">
          <!-- 1Œ∑ Œ≥œÅŒ±ŒºŒºŒÆ: Menu buttons + Active credential -->
          <div class="layout-header__top-row flex items-center gap-4">
            <nav class="layout-header__nav flex gap-3 items-center">
              <a href="{{ url_for('fetch') }}" class="px-3 py-2 rounded-md text-sm font-medium {% if active_page=='fetch' %}bg-sky-600 text-white{% else %}bg-white border hover:bg-gray-100 text-gray-700{% endif %}">üì• Bulk Fetch</a>
              <a href="{{ url_for('search') }}" class="px-3 py-2 rounded-md text-sm font-medium {% if active_page=='search' %}bg-sky-600 text-white{% else %}bg-white border hover:bg-gray-100 text-gray-700{% endif %}">üîç ŒëŒΩŒ±Œ∂ŒÆœÑŒ∑œÉŒ∑ MARK</a>
              <a href="{{ url_for('credentials') }}" class="px-3 py-2 rounded-md text-sm font-medium {% if active_page=='credentials' %}bg-sky-600 text-white{% else %}bg-white border hover:bg-gray-100 text-gray-700{% endif %}">üîê Credentials</a>
              {% if current_user.is_authenticated and (current_user.is_admin or current_user.id == ADMIN_USER_ID) %}
                <a href="{{ url_for('admin_dashboard') }}" class="px-3 py-2 rounded-md text-sm font-medium bg-red-600 text-white hover:bg-red-700">‚öôÔ∏è Admin</a>
              {% endif %}
            </nav>

            <!-- Active credential badge moved to second row -->
            <div class="ml-4">
              <button id="sideMenuToggle" class="px-3 py-1 rounded text-sm bg-white border hover:bg-gray-100 text-gray-700">‚ò∞ ŒúŒµŒΩŒøœç</button>
              {% if current_user.is_authenticated %}
                <span class="text-sm text-gray-700 ml-2">{{ display_username or current_user.username }}</span>
              {% endif %}
            </div>
          </div>

          <!-- 2Œ∑ Œ≥œÅŒ±ŒºŒºŒÆ: ŒïŒΩŒµœÅŒ≥œåœÇ œÄŒµŒªŒ¨œÑŒ∑œÇ + Fiscal year selector -->
          <div class="layout-header__year-row flex items-center gap-4 w-max">
            <div class="layout-header__active-customer flex items-center gap-2">
              <span class="text-sm text-gray-500">ŒïŒΩŒµœÅŒ≥œåœÇ œÄŒµŒªŒ¨œÑŒ∑œÇ:</span>
              {% if active_credential %}
                {% if active_credential_vat %}
                  <span class="px-3 py-1 rounded-full text-sm font-medium bg-sky-600 text-white">{{ active_credential }} ({{ active_credential_vat }})</span>
                {% else %}
                  <span class="px-3 py-1 rounded-full text-sm font-medium bg-sky-600 text-white">{{ active_credential }}</span>
                {% endif %}
              {% else %}
                <span class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600">‚Äî</span>
              {% endif %}
            </div>

            <div class="layout-header__active-group flex items-center gap-2">
              <span class="text-sm text-gray-500">ŒïŒΩŒµœÅŒ≥ŒÆ ŒøŒºŒ¨Œ¥Œ±:</span>
              {% if active_group %}
                <span class="px-3 py-1 rounded-full text-sm font-medium bg-emerald-600 text-white">{{ active_group }}</span>
              {% else %}
                <span class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600">‚Äî</span>
              {% endif %}
            </div>

            <label for="fiscalYearSelect" class="text-sm text-gray-500">ŒßœÅŒÆœÉŒ∑:</label>
            <select id="fiscalYearSelect" class="px-2 py-1 rounded border text-sm"></select>
            <button id="fiscalYearSaveBtn" class="px-3 py-1 rounded bg-sky-600 text-white text-sm">ŒëœÄŒøŒ∏ŒÆŒ∫ŒµœÖœÉŒ∑</button>
            <span id="fiscalYearMsg" class="text-sm text-gray-500 ml-2"></span>
          </div>
        </div>
      </div>
    </header>

    <!-- Side Menu (toggleable) -->
    <div id="sideMenu" class="fixed inset-y-0 right-0 w-72 bg-white shadow-lg z-50 overflow-y-auto transform translate-x-full transition-transform duration-300 ease-in-out">
      <div class="p-6 space-y-6">
        <!-- Header -->
        <div class="flex justify-between items-center">
          <h2 class="text-lg font-semibold text-gray-900">ŒúŒµŒΩŒøœç</h2>
          <button id="sideMenuClose" class="text-2xl text-gray-500 hover:text-gray-700">√ó</button>
        </div>

        <!-- User Info -->
        {% if current_user.is_authenticated %}
        <div class="border-b pb-4">
          <div class="mb-2 flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-medium text-gray-700">ŒßœÅŒÆœÉœÑŒ∑œÇ</p>
              <p class="text-lg font-semibold text-sky-600">{{ current_user.username }}</p>
            </div>
            <a href="{{ url_for('auth.account_settings') }}" class="inline-flex items-center justify-center w-9 h-9 rounded-full border border-gray-200 text-gray-500 hover:text-gray-700 hover:border-gray-300" title="Œ°œÖŒ∏ŒºŒØœÉŒµŒπœÇ ŒªŒøŒ≥Œ±œÅŒπŒ±œÉŒºŒøœç" aria-label="Œ°œÖŒ∏ŒºŒØœÉŒµŒπœÇ ŒªŒøŒ≥Œ±œÅŒπŒ±œÉŒºŒøœç">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.573-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
            </a>
          </div>
          <a href="{{ url_for('auth.logout') }}" class="block px-4 py-2 rounded text-sm bg-red-100 text-red-700 hover:bg-red-200 text-center">ŒëœÄŒøœÉœçŒΩŒ¥ŒµœÉŒ∑</a>
        </div>

        <!-- Groups Selector -->
        <div class="border-b pb-4">
          <p class="text-sm font-medium text-gray-700 mb-3">ŒüŒºŒ¨Œ¥ŒµœÇ</p>
          <div id="groupsList" class="space-y-2 max-h-64 overflow-y-auto"></div>
          <a href="{{ url_for('auth.list_groups') }}" class="block mt-3 px-4 py-2 rounded text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 text-center">ŒîŒπŒ±œáŒµŒØœÅŒπœÉŒ∑ ŒøŒºŒ¨Œ¥œâŒΩ</a>
        </div>

        <!-- Quick Links -->
        <div>
          <p class="text-sm font-medium text-gray-700 mb-3">Œ£œçŒΩŒ¥ŒµœÉŒºŒøŒπ</p>
            <div class="space-y-2">
            <a href="{{ url_for('home') }}" class="block px-3 py-2 rounded text-sm hover:bg-gray-100 text-gray-700">üè† ŒëœÅœáŒπŒ∫ŒÆ</a>
            <a href="{{ url_for('fetch') }}" class="block px-3 py-2 rounded text-sm hover:bg-gray-100 text-gray-700">üì• Bulk Fetch</a>
            <a href="{{ url_for('search') }}" class="block px-3 py-2 rounded text-sm hover:bg-gray-100 text-gray-700">üîç ŒëŒΩŒ±Œ∂ŒÆœÑŒ∑œÉŒ∑</a>
            <a href="{{ url_for('credentials') }}" class="block px-3 py-2 rounded text-sm hover:bg-gray-100 text-gray-700">üîê Credentials</a>
          </div>
        </div>
        {% else %}
        <div class="space-y-2">
          <a href="{{ url_for('auth.login') }}" class="block px-4 py-2 rounded text-sm bg-sky-600 text-white hover:bg-sky-700 text-center">Œ£œçŒΩŒ¥ŒµœÉŒ∑</a>
          <a href="{{ url_for('auth.signup') }}" class="block px-4 py-2 rounded text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 text-center">ŒîŒ∑ŒºŒπŒøœÖœÅŒ≥ŒØŒ± ŒªŒøŒ≥Œ±œÅŒπŒ±œÉŒºŒøœç</a>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Side Menu Overlay (uses backdrop blur) -->
    <div id="sideMenuOverlay" class="fixed inset-0 bg-black/10 backdrop-blur-sm opacity-0 invisible z-40 transition-all duration-300"></div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="space-y-2 mb-4" id="flashContainer">
          {% for cat, msg in messages %}
            {% set normalized = (cat or '')|lower %}
            {% if normalized in ['error', 'danger'] %}
              {% set flash_class = 'flash-error' %}
            {% elif normalized in ['warning'] %}
              {% set flash_class = 'flash-warning' %}
            {% elif normalized in ['info'] %}
              {% set flash_class = 'flash-info' %}
            {% else %}
              {% set flash_class = 'flash-success' %}
            {% endif %}
            <div class="flash-banner {{ flash_class }}" role="alert" data-flash data-ttl="6000">{{ msg|safe }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </div>

  <!-- WAIT OVERLAY (global) -->
  <div id="globalWait"
       class="fixed inset-0 z-[100000] hidden items-center justify-center"
       style="background:rgba(0,0,0,.4);display:none;">
    <div class="bg-white rounded-lg shadow-lg px-6 py-5 text-center">
      <div class="text-base font-medium mb-2">Œ†Œ±œÅŒ±Œ∫Œ±Œªœé œÄŒµœÅŒπŒºŒ≠ŒΩŒµœÑŒµ‚Ä¶</div>
      <div class="text-gray-400 animate-pulse" aria-hidden="true">‚óè ‚óè ‚óè</div>
    </div>
  </div>

  {% block scripts %}{% endblock %}

  <script>
    // Dismissable + auto-close (5-6s) ONLY for .flash-banner
    document.addEventListener('DOMContentLoaded', function(){
      const AUTO_TTL = 6000; // ms

      function makeDismissable(el){
        if (!el || el.dataset.dismissable === '1') return;
        el.dataset.dismissable = '1';

        // add small √ó button
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.setAttribute('aria-label','Close');
        btn.textContent = '√ó';
        btn.style.cssText = 'position:absolute;top:.4rem;right:.5rem;line-height:1;font-size:20px;opacity:.75;cursor:pointer;background:transparent;border:0;padding:0;z-index:1';

        const cs = getComputedStyle(el);
        if (cs.position === 'static') el.style.position = 'relative';
        if (!el.style.paddingRight) {
          const pr = parseFloat(cs.paddingRight || '0');
          if (pr < 22) el.style.paddingRight = '28px';
        }

        btn.addEventListener('click', ()=> { try{ el.remove(); }catch(_){ } });
        el.appendChild(btn);

        const ttlAttr = parseInt(el.getAttribute('data-ttl') || AUTO_TTL, 10);
        if (ttlAttr > 0) setTimeout(()=>{ try{ el.remove(); }catch(_){ } }, ttlAttr);
      }

      document.querySelectorAll('.flash-banner').forEach(makeDismissable);

      // Also observe for dynamically added flashes
      const mo = new MutationObserver(muts=>{
        muts.forEach(m=> m.addedNodes && m.addedNodes.forEach(n=>{
          if (n.nodeType===1) {
            if (n.matches && n.matches('.flash-banner')) makeDismissable(n);
            n.querySelectorAll && n.querySelectorAll('.flash-banner').forEach(makeDismissable);
          }
        }));
      });
      mo.observe(document.body, { childList:true, subtree:true });

      // Support existing close buttons if present
      document.addEventListener('click', function(e){
        const b = e.target.closest && e.target.closest('[data-dismiss="flash"], .btn-close, .close');
        if (!b) return;
        const host = b.closest('.flash-banner') || b.parentElement;
        if (host) { e.preventDefault(); try{ host.remove(); }catch(_){ } }
      }, true);
    });
  </script>

  <!-- ‚úÖ Fiscal Year logic (ŒµŒΩœÉœâŒºŒ¨œÑœâœÉŒ∑ Œ±œÄœå œÑŒ∑ŒΩ ŒµŒ∫Œ¥ŒøœáŒÆ œÄŒøœÖ ¬´Œ¥ŒøœçŒªŒµœÖŒµ œÑŒ≠ŒªŒµŒπŒ±¬ª) -->
  <script>
    (function(){
      const thisYear = new Date().getFullYear();

      function populateFiscalSelect(selected){
        const sel = document.getElementById('fiscalYearSelect');
        if(!sel) return;
        sel.innerHTML = '';
        for(let y=thisYear-1; y<=thisYear+2; y++){
          const opt = document.createElement('option');
          opt.value = String(y);
          opt.textContent = String(y);
          if(Number(selected) === y) opt.selected = true;
          sel.appendChild(opt);
        }
      }

      async function loadFiscalYearIntoUi(){
        try{
          const r = await fetch('/get_fiscal_year', { credentials:'same-origin' });
          const j = await r.json();
          populateFiscalSelect(j.fiscal_year || thisYear);
          const msg = document.getElementById('fiscalYearMsg');
          if (msg) msg.textContent = j.fiscal_year ? `ŒïŒΩŒµœÅŒ≥œå: ${j.fiscal_year}` : 'ŒîŒµŒΩ Œ≠œáŒµŒπ ŒøœÅŒπœÉœÑŒµŒØ œáœÅŒÆœÉŒ∑';
        } catch {
          populateFiscalSelect(thisYear);
          const msg = document.getElementById('fiscalYearMsg');
          if (msg) msg.textContent = 'Œ£œÜŒ¨ŒªŒºŒ± Œ±ŒΩŒ¨Œ≥ŒΩœâœÉŒ∑œÇ œáœÅŒÆœÉŒ∑œÇ';
        }
      }

      async function saveFiscalYear(e){
        e.preventDefault();
        const year = Number(document.getElementById('fiscalYearSelect').value);
        try{
          const r = await fetch('/set_fiscal_year', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fiscal_year: year })
          });
          const j = await r.json();
          if (j.success){
            location.reload(); // ŒæŒ±ŒΩŒ±œÜŒøœÅœÑœéŒΩŒøœÖŒºŒµ ŒºŒµ œÑŒ∑ ŒΩŒ≠Œ± œáœÅŒÆœÉŒ∑
          } else {
            const msg = document.getElementById('fiscalYearMsg');
            if (msg) msg.textContent = j.message || 'ŒëœÄŒøœÑœÖœáŒØŒ± Œ±œÄŒøŒ∏ŒÆŒ∫ŒµœÖœÉŒ∑œÇ œáœÅŒÆœÉŒ∑œÇ';
          }
        } catch {
          const msg = document.getElementById('fiscalYearMsg');
          if (msg) msg.textContent = 'Œ£œÜŒ¨ŒªŒºŒ± Œ¥ŒπŒ∫œÑœçŒøœÖ';
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        loadFiscalYearIntoUi();
        const btn = document.getElementById('fiscalYearSaveBtn');
        if (btn) btn.addEventListener('click', saveFiscalYear);
      });
    })();
  </script>

  <script>
    (function(){
      const SCALE_MIN = 0.96;
      const SCALE_MAX = 1.18;
      const WIDTH_MIN = 360;
      const WIDTH_MAX = 1600;
      let lastType = null;
      let lastScale = null;
      let resizeTimer = null;

      function detectDeviceType(){
        const ua = (navigator.userAgent || '').toLowerCase();
        const width = window.innerWidth || document.documentElement.clientWidth || 0;
        if (width <= 768 || /mobile|android|iphone|ipod/.test(ua)) return 'mobile';
        if (width <= 1200 || /ipad|tablet/.test(ua)) return 'tablet';
        return 'desktop';
      }

      function assignBody(type){
        if (!document.body){
          document.addEventListener('DOMContentLoaded', () => assignBody(type), { once:true });
          return;
        }
        document.body.dataset.device = type;
      }

      function computeScale(width){
        const w = Math.min(Math.max(width || WIDTH_MIN, WIDTH_MIN), WIDTH_MAX);
        const ratio = (w - WIDTH_MIN) / (WIDTH_MAX - WIDTH_MIN);
        const scale = SCALE_MAX - ratio * (SCALE_MAX - SCALE_MIN);
        return Number(scale.toFixed(3));
      }

      function applyDeviceType(){
        const type = detectDeviceType();
        const width = window.innerWidth || document.documentElement.clientWidth || screen.width || WIDTH_MAX;
        const scale = computeScale(width);
        if (type !== lastType) {
          lastType = type;
          assignBody(type);
        }
        if (lastScale !== scale) {
          lastScale = scale;
          document.documentElement.style.setProperty('--device-font-scale', String(scale));
        }
      }

      function schedule(){
        if (resizeTimer){
          clearTimeout(resizeTimer);
        }
        resizeTimer = setTimeout(applyDeviceType, 90);
      }

      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', applyDeviceType, { once:true });
      } else {
        applyDeviceType();
      }

      window.addEventListener('resize', schedule);
      window.addEventListener('orientationchange', schedule);
      if (window.ResizeObserver){
        try {
          const ro = new ResizeObserver(() => schedule());
          ro.observe(document.documentElement);
        } catch(_){}
      }
    })();
  </script>

  <script>
    (function(){
      // ====== WAIT OVERLAY ======
      const waitEl = document.getElementById('globalWait');
      let waitCount = 0;
      let suspendWait = 0; // œåœÑŒ±ŒΩ >0, Œ¥ŒµŒΩ Œ∏Œ± ŒµŒºœÜŒ±ŒΩŒØŒ∂ŒµœÑŒ±Œπ œÑŒø overlay

      function showWait(){ if(!waitEl || suspendWait>0) return; waitCount++; waitEl.style.display='flex'; }
      function hideWait(){ if(!waitEl) return; waitCount = Math.max(0, waitCount-1); if(!waitCount) waitEl.style.display='none'; }
      function forceHide(){ if(!waitEl) return; waitCount = 0; waitEl.style.display='none'; }
      function suspend(on){ suspendWait = Math.max(0, suspendWait + (on?1:-1)); if (suspendWait>0) forceHide(); }
      window.WaitOverlay = { show: showWait, hide: hideWait, suspend, forceHide };

      // Patch fetch (AJAX)
      const _fetch = window.fetch;

      function shouldSkipWait(args){
        try {
          const [input, init] = args || [];

          function readUrl(target){
            if (!target) return '';
            if (typeof target === 'string') return target;
            if (typeof Request !== 'undefined' && target instanceof Request) return target.url || '';
            if (typeof target.url === 'string') return target.url;
            return '';
          }

          function hasSkipHeader(options){
            if (!options || !options.headers) return false;
            const headers = options.headers;

            try {
              if (typeof headers.get === 'function'){
                const direct = headers.get('X-Wait-Overlay') || headers.get('x-wait-overlay');
                if (typeof direct === 'string' && direct.toLowerCase() === 'skip') return true;
              }
            } catch (_) {}

            if (headers && typeof headers === 'object'){
              const entries = Array.isArray(headers) ? headers : Object.entries(headers);
              for (const entry of entries){
                if (!entry) continue;
                let key, value;
                if (Array.isArray(entry)){
                  [key, value] = entry;
                } else {
                  key = entry[0];
                  value = entry[1];
                }
                if (typeof key === 'string' && key.toLowerCase() === 'x-wait-overlay'){
                  if (String(value).toLowerCase() === 'skip') return true;
                }
              }
            }
            return false;
          }

          const url = readUrl(input);
          if (url && /\/api\/qr\/remote\//.test(url)) return true;
          if (hasSkipHeader(init)) return true;
          if (input && typeof input === 'object'){
            const maybeRequestHeaders = input.headers;
            if (hasSkipHeader({ headers: maybeRequestHeaders })) return true;
          }
        } catch (_) {}
        return false;
      }

      window.fetch = async function(...args){
        const skip = shouldSkipWait(args);
        if (!skip) showWait();
        try { return await _fetch(...args); }
        finally { if (!skip) hideWait(); }
      };

      // Patch XHR (œÄŒπŒ¨ŒΩŒµŒπ jQuery/DataTables)
      const XHROpen = XMLHttpRequest.prototype.open;
      const XHRSend = XMLHttpRequest.prototype.send;
      XMLHttpRequest.prototype.open = function(...a){ this.__withWait = true; return XHROpen.apply(this,a); };
      XMLHttpRequest.prototype.send = function(...a){
        if (this.__withWait){ showWait(); this.addEventListener('loadend', hideWait, { once:true }); }
        return XHRSend.apply(this,a);
      };

      // Form submits (œÄŒªŒøŒÆŒ≥Œ∑œÉŒ∑)
      document.addEventListener('submit', function(){ showWait(); setTimeout(hideWait, 15000); }, true);

          
    // ====== WARNING MODALS INTEGRATION (Reload after ANY warning modal ack) ======
    (function(){
      const WARN_HOST_SELECTORS = [
        '#afmWarningModal', '#receiptWarn', '#receiptWarningModal', '#receiptWarning',
        '[id$="WarningModal"]', '.warning-modal', '[data-role="modal-warning"]'
      ];

      function isVisible(el){
        if(!el) return false;
        const st = window.getComputedStyle(el);
        return st.display!=='none' && st.visibility!=='hidden' && st.opacity!=='0';
      }
      function toggleWaitByWarnings(){
        try {
          const anyOpen = WARN_HOST_SELECTORS.some(sel => {
            const node = document.querySelector(sel);
            return node && isVisible(node);
          });
          if (window.WaitOverlay && typeof window.WaitOverlay.suspend === 'function') {
            window.WaitOverlay.suspend(anyOpen);
          }
        } catch(_) {}
      }
      const moWarn = new MutationObserver(toggleWaitByWarnings);
      moWarn.observe(document.documentElement, { attributes:true, childList:true, subtree:true });
      toggleWaitByWarnings();

      function closeModalHost(host){
        try {
          if (typeof bootstrap !== 'undefined' && host) {
            const inst = bootstrap.Modal.getOrCreateInstance(host);
            inst.hide();
            return;
          }
        } catch(_) {}
        try { host.style.display = 'none'; } catch(_){}
      }

      function isAckButton(el){
        if (!el) return false;
        if (el.id === 'afmModalConfirm' || el.id === 'receiptWarnOk') return true;
        if (el.matches && el.matches('[data-ack="1"], [data-role="warning-ack"], .js-warning-ack')) return true;
        const txt = (el.textContent || '').trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
        return (txt === 'œÑŒø Œ∫Œ±œÑŒ±ŒªŒ±Œ≤Œ±' || txt === 'Œ∫Œ±œÑŒ±ŒªŒ±Œ≤Œ±' || txt === 'ŒµŒΩœÑŒ±ŒæŒµŒπ' || txt === 'ok');
      }

      function findWarningHost(el){
        if (!el || !el.closest) return null;
        for (const sel of WARN_HOST_SELECTORS){
          const host = el.closest(sel);
          if (host) return host;
        }
        return null;
      }

      document.addEventListener('click', function(ev){
        const btn = ev.target && ev.target.closest && ev.target.closest('button, [role="button"], a');
        if (!btn) return;
        if (!isAckButton(btn)) return;
        const host = findWarningHost(btn);
        if (!host) return;

        ev.preventDefault();
        try { btn.type = 'button'; } catch(_){}
        try { closeModalHost(host); } catch(_){}
        setTimeout(function(){
          if (window.WaitOverlay && typeof window.WaitOverlay.suspend === 'function') {
            window.WaitOverlay.suspend(true);
            setTimeout(function(){ window.WaitOverlay.suspend(false); }, 250);
          }
          if (typeof window._wipeAndReload === 'function') {
            window._wipeAndReload();
          } else {
            location.reload();
          }
        }, 60);
      }, true);

      const moBtns = new MutationObserver(function(muts){
        muts.forEach(function(m){
          m.addedNodes && m.addedNodes.forEach(function(n){
            if (n.nodeType !== 1) return;
            const btns = n.matches && isAckButton(n) ? [n] : (n.querySelectorAll ? Array.from(n.querySelectorAll('button, [role="button"], a')) : []);
            btns.forEach(function(b){
              if (!isAckButton(b)) return;
              const host = findWarningHost(b);
              if (!host) return;
              b.type = 'button';
              b.onclick = function(e){ e.preventDefault(); closeModalHost(host); setTimeout(function(){ window._wipeAndReload(); }, 40); return false; };
            });
          });
        });
      });
      moBtns.observe(document.body, { childList:true, subtree:true });
    })();

  </script>

  <!-- Dismissable ŒºœåŒΩŒø Œ≥ŒπŒ± flash/alerts (hook Œ≥ŒπŒ± Œ¥œÖŒΩŒ±ŒºŒπŒ∫Œ¨) -->
  <script>
    (function(){
      const SELECTORS = ['[data-flash]', '.flash', '.alert', '[role="alert"]'];
      const AUTO_HIDE_MS = 0; // Œ≤Œ¨ŒªŒµ 6000 Œ±ŒΩ Œ∏Œ≠ŒªŒµŒπœÇ Œ±œÖœÑŒøŒºŒ¨œÑœâœÇ ŒΩŒ± Œ∫ŒªŒµŒØŒΩŒøœÖŒΩ

      function makeDismissable(el){
        if (!el || el.dataset.dismissable === '1') return;
        el.dataset.dismissable = '1';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.setAttribute('aria-label','Close');
        btn.textContent = '√ó';
        btn.style.cssText =
          'position:absolute;top:.4rem;right:.5rem;line-height:1;font-size:20px;' +
          'opacity:.75;cursor:pointer;background:transparent;border:0;padding:0;z-index:1';

        const cs = getComputedStyle(el);
        if (cs.position === 'static') el.style.position = 'relative';
        if (!el.style.paddingRight) {
          const pr = parseFloat(cs.paddingRight || '0');
          if (pr < 22) el.style.paddingRight = '28px';
        }
        btn.addEventListener('click', ()=> { try{ el.remove(); }catch(_){ } });
        el.appendChild(btn);

        if (AUTO_HIDE_MS > 0) setTimeout(()=>{ try{ el.remove(); }catch(_){ } }, AUTO_HIDE_MS);
      }

      function scan(root=document){
        root.querySelectorAll(SELECTORS.join(',')).forEach(makeDismissable);
      }

      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', ()=>scan(), { once:true });
      } else {
        scan();
      }

      const mo = new MutationObserver(muts=>{
        for (const m of muts) m.addedNodes && m.addedNodes.forEach(n=>{
          if (n.nodeType===1) scan(n);
        });
        });
      mo.observe(document.body, { childList:true, subtree:true });

      document.addEventListener('click', (e)=>{
        const b = e.target.closest && e.target.closest('[data-dismiss="flash"], .btn-close, .close');
        if (!b) return;
        const host = b.closest(SELECTORS.join(',')) || b.parentElement;
        if (host) { e.preventDefault(); try{ host.remove(); }catch(_){ } }
      }, true);
    })();

    // Side menu toggle functionality
    document.addEventListener('DOMContentLoaded', function(){
      const sideMenu = document.getElementById('sideMenu');
      const sideMenuOverlay = document.getElementById('sideMenuOverlay');
      const sideMenuToggle = document.getElementById('sideMenuToggle');
      const sideMenuClose = document.getElementById('sideMenuClose');
      const groupsList = document.getElementById('groupsList');

      if (!sideMenu || !sideMenuToggle) return;

      // Toggle side menu open/close (right-side menu)
      function toggleMenu() {
        sideMenu.classList.toggle('translate-x-full');
        sideMenuOverlay.classList.toggle('opacity-0');
        sideMenuOverlay.classList.toggle('invisible');
      }

      if (sideMenuToggle) {
        sideMenuToggle.addEventListener('click', toggleMenu);
      }

      if (sideMenuClose) {
        sideMenuClose.addEventListener('click', toggleMenu);
      }

      if (sideMenuOverlay) {
        sideMenuOverlay.addEventListener('click', toggleMenu);
      }

      // Populate groups list from page
      if (groupsList) {
        try {
          fetch('/api/user_groups')
            .then(r => r.json())
            .then(data => {
              if (data.groups && Array.isArray(data.groups)) {
                groupsList.innerHTML = data.groups.map(g => `
                  <button type="button" onclick="selectGroup('${g.name.replace(/'/g,"\\'") }')" 
                          class="w-full text-left px-3 py-2 rounded text-sm hover:bg-sky-100 text-gray-700 border border-gray-200">
                    ${g.name === data.active_group ? '‚úì ' : ''}${escapeHtml(g.name)}
                  </button>
                `).join('');
              }
            })
            .catch(err => console.warn('Failed to load groups:', err));
        } catch (e) {
          console.warn('Groups list error:', e);
        }
      }

      // Helper to select a group
      // Select a group without interactive warning
      window.selectGroup = function(groupName) {
        fetch('/groups/select', {
          method: 'POST',
          credentials: 'same-origin',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({group: groupName})
        })
        .then(async r => {
          const j = await r.json().catch(()=> ({}));
          if (r.ok && j.ok) {
            // close menu and reload
            try { toggleMenu(); } catch(_) {}
            window.location.reload();
          } else if (j && j.error) {
            showModalAlert('Œ£œÜŒ¨ŒªŒºŒ±', j.error);
          } else {
            showModalAlert('Œ£œÜŒ¨ŒªŒºŒ±', 'Failed to select group');
          }
        })
        .catch(err => showModalAlert('Œ£œÜŒ¨ŒªŒºŒ±', 'Request failed: ' + err));
      };
    });
  </script></body>
</html>
