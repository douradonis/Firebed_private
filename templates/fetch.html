<!-- templates/fetch.html -->
{% extends "base.html" %}
{% block content %}
<div class="card p-4">
  <h4>Bulk Fetch Παραστατικών</h4>
  <p class="text-muted">Επιλέξτε διάστημα (μόνο μορφή <strong>dd/mm/YYYY</strong>) και credential set.</p>

  {% if message %}
    <div class="alert alert-success">{{ message }}</div>
  {% endif %}
  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <form method="post" class="row g-3">
    <div class="col-md-3">
      <label class="form-label">Ημερομηνία από (dd/mm/YYYY)</label>
      <input id="date_from" name="date_from" class="form-control" placeholder="π.χ. 01/09/2025" value="{{ request.form.date_from or '' }}" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Ημερομηνία έως (dd/mm/YYYY)</label>
      <input id="date_to" name="date_to" class="form-control" placeholder="π.χ. 07/09/2025" value="{{ request.form.date_to or '' }}" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Use credential set</label>
      <select name="use_credential" class="form-select">
        <option value="">(ENV / Default)</option>
        {% for c in credentials %}
          <option value="{{ c.name }}">{{ c.name }} {% if c.vat %}({{ c.vat }}){% endif %}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-primary w-100" type="submit">Λήψη & Αποθήκευση Cache</button>
    </div>
  </form>

  <hr>

  <h6>Preview cache (περιορισμένο)</h6>
  <div style="max-height:360px; overflow:auto; background:#fbfdff; padding:10px; border-radius:8px;">
    {% if preview %}
      {% for d in preview %}
        <pre class="small">{{ d | tojson(indent=2) }}</pre>
      {% endfor %}
    {% else %}
      <div class="text-muted">Δεν υπάρχουν cached παραστατικά.</div>
    {% endif %}
  </div>
</div>

<script>
  // small client helper: enforce dd/mm/YYYY format on blur
  function valid_ddmmyyyy(s){
    return /^([0-2]\d|3[01])\/(0\d|1[0-2])\/\d{4}$/.test(s);
  }
  document.addEventListener('DOMContentLoaded', function(){
    ["date_from","date_to"].forEach(function(id){
      const el = document.getElementById(id);
      el && el.addEventListener('blur', function(){
        if (!valid_ddmmyyyy(this.value)) {
          this.classList.add('is-invalid');
        } else {
          this.classList.remove('is-invalid');
        }
      });
    });
  });
</script>
{% endblock %}
