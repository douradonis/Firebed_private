{% extends "base.html" %}
{% block title %}Custom Κατηγορίες{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto mt-6 space-y-6">
  <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-gray-800">Custom κατηγορίες χαρακτηρισμών</h1>
      <p class="text-sm text-gray-600 mt-1">Οι κατηγορίες αυτές είναι διαθέσιμες επιπλέον των γενικών και χρησιμοποιούνται αποκλειστικά για τιμολόγια.</p>
    </div>
    <a href="{{ return_url or url_for('credentials') }}" class="self-start inline-flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50 transition" id="backToCredentials">
      <span class="text-lg">⬅</span>
      <span>Επιστροφή</span>
    </a>
  </div>

  {% if not vat %}
    <div class="bg-yellow-50 border border-yellow-200 text-yellow-900 rounded p-4">
      Δεν έχει επιλεγεί ενεργός πελάτης. Ενεργοποίησε κάποιο credential και δοκίμασε ξανά.
    </div>
  {% else %}
    <div class="bg-slate-50 border border-slate-200 rounded p-4 text-sm text-slate-700">
      <p><strong>Πελάτης:</strong> {{ credential_name or vat }}</p>
      <p class="mt-2">Οι παρακάτω κατηγορίες είναι διαθέσιμες επιπλέον των γενικών:<br>
        <span class="italic">{{ default_labels.values() | list | join(', ') }}</span>
      </p>
      <p class="mt-2 text-xs text-slate-500">Μία custom κατηγορία εμφανίζεται σε επιλογές ΦΠΑ μόνο για τα ποσοστά στα οποία έχει συμπληρωμένο λογαριασμό.</p>
    </div>

    <div class="grid gap-6 md:grid-cols-2">
      <!-- CRUD form -->
      <div class="space-y-4">
        <div class="border border-gray-200 rounded-lg bg-white shadow-sm p-5">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 id="formTitle" class="text-lg font-semibold">Νέα κατηγορία</h2>
              <p class="text-xs text-gray-500">Συμπλήρωσε τίτλο, ενεργοποίηση και λογαριασμούς ΦΠΑ.</p>
            </div>
            <span id="formMode" class="inline-flex items-center rounded-full bg-sky-100 text-sky-700 text-xs font-semibold px-2 py-1">Νέα</span>
          </div>

          <form id="categoryForm" method="post" action="{{ url_for('custom_categories_save') }}" class="space-y-4">
            <input type="hidden" name="vat" value="{{ vat }}">
            <input type="hidden" name="id" id="catIdInput" value="">

            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">Τίτλος</label>
              <input type="text" name="label" id="catLabelInput" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring focus:ring-sky-200" placeholder="π.χ. Καύσιμα" required>
            </div>

            <label class="inline-flex items-center text-sm font-medium text-gray-700">
              <input type="checkbox" name="enabled" id="catEnabledInput" class="mr-2 rounded" checked>
              Ενεργή για τιμολόγια
            </label>

            <div class="space-y-3">
              <div class="text-sm font-medium text-gray-700">Λογαριασμοί ανά ΦΠΑ</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                {% for rate in vat_rates %}
                  <div class="border rounded-md p-3 bg-slate-50">
                    <label class="block text-xs uppercase tracking-wide text-slate-500 mb-1">ΦΠΑ {{ rate }}%</label>
                    <input type="text" name="account_{{ rate }}" data-account-rate="{{ rate }}" class="w-full border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-sky-100" placeholder="Λογαριασμός">
                  </div>
                {% endfor %}
              </div>
            </div>

            <div class="flex flex-wrap gap-2 justify-end pt-2 border-t border-gray-100">
              <button type="button" id="resetFormBtn" class="px-3 py-2 border border-gray-300 rounded text-sm hover:bg-gray-50">Νέα κατηγορία</button>
              <button type="button" id="deleteBtn" class="px-3 py-2 bg-red-600 text-white rounded text-sm hidden">Διαγραφή</button>
              <button type="submit" id="saveBtn" class="px-3 py-2 bg-sky-600 text-white rounded text-sm">Προσθήκη</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Saved categories -->
      <div>
        <div class="border border-gray-200 rounded-lg bg-white shadow-sm p-5 h-full flex flex-col">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Αποθηκευμένες κατηγορίες</h2>
            <span class="text-xs text-gray-500">Κάνε κλικ για επεξεργασία</span>
          </div>

          <div id="savedCategories" class="space-y-3 overflow-y-auto">
            {% for cat in categories %}
              <div class="saved-category group relative w-full border border-gray-200 rounded-md p-4 pr-12 bg-white hover:border-sky-400 hover:shadow-sm transition focus-within:ring-2 focus-within:ring-sky-200 cursor-pointer"
                   tabindex="0" role="button"
                   data-cat='{{ cat | tojson | safe }}'>
                <div class="flex items-center justify-between gap-3">
                  <div class="flex-1 min-w-0">
                    <div class="font-semibold text-gray-800 truncate">{{ cat.label }}</div>
                    <div class="text-xs text-gray-500 truncate">Slug: {{ cat.id }}</div>
                  </div>
                  {% if cat.enabled %}
                    <span class="inline-flex items-center text-xs font-semibold text-green-700 bg-green-100 rounded-full px-2 py-0.5">Ενεργή</span>
                  {% else %}
                    <span class="inline-flex items-center text-xs font-semibold text-gray-600 bg-gray-200 rounded-full px-2 py-0.5">Ανενεργή</span>
                  {% endif %}
                </div>

                <div class="mt-3 space-y-2 text-sm text-gray-600">
                  <div class="flex flex-wrap gap-2 text-xs">
                    {% set allowed = cat.allowed_vat_keys or [] %}
                    {% if allowed %}
                      {% for key in allowed %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full bg-sky-100 text-sky-700 font-medium">ΦΠΑ {{ key }}</span>
                      {% endfor %}
                    {% else %}
                      <span class="inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-gray-500">Χωρίς λογαριασμούς ΦΠΑ</span>
                    {% endif %}
                  </div>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-xs">
                    {% for rate, code in cat.accounts.items() %}
                      {% if code %}
                        <div><span class="font-semibold">ΦΠΑ {{ rate }}%</span>: {{ code }}</div>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>

                <button type="button"
                        class="saved-delete-btn absolute top-3 right-3 opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto inline-flex items-center gap-1 px-2 py-1 rounded-md border border-red-200 bg-red-50 text-xs font-semibold text-red-700 transition hover:bg-red-600 hover:text-white hover:border-red-600"
                        title="Διαγραφή"
                        data-action="delete"
                        data-id="{{ cat.id }}"
                        data-label="{{ cat.label }}">
                  ✖
                </button>
              </div>
            {% else %}
              <div class="text-sm text-gray-600">Δεν υπάρχουν custom κατηγορίες ακόμη.</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div id="deleteCategoryModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4" data-role="modal-warning">
      <div class="modal-warning-panel" role="dialog" aria-modal="true" aria-labelledby="deleteCategoryTitle">
        <button type="button" class="modal-warning-close" data-close-modal="deleteCategoryModal">×</button>
        <div class="modal-warning-title" id="deleteCategoryTitle">Διαγραφή κατηγορίας;</div>
        <div class="modal-warning-body">
          Θέλεις σίγουρα να διαγράψεις την κατηγορία <span id="categoryDeleteName" class="font-semibold"></span>; Η ενέργεια δεν μπορεί να αναιρεθεί.
        </div>
        <div class="modal-warning-actions">
          <button type="button" id="categoryDeleteCancel" class="modal-warning-btn modal-warning-btn--muted">Άκυρο</button>
          <button type="button" id="categoryDeleteConfirm" class="modal-warning-btn modal-warning-btn--danger">Διαγραφή</button>
        </div>
      </div>
    </div>

    <form id="deleteForm" method="post" action="{{ url_for('custom_categories_delete') }}" class="hidden">
      <input type="hidden" name="vat" value="{{ vat }}">
      <input type="hidden" name="id" id="deleteCatId" value="">
    </form>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const savedList = document.getElementById('savedCategories');
  const form = document.getElementById('categoryForm');
  if(!form) return;

  const idInput = document.getElementById('catIdInput');
  const labelInput = document.getElementById('catLabelInput');
  const enabledInput = document.getElementById('catEnabledInput');
  const deleteBtn = document.getElementById('deleteBtn');
  const resetBtn = document.getElementById('resetFormBtn');
  const saveBtn = document.getElementById('saveBtn');
  const modeBadge = document.getElementById('formMode');
  const titleEl = document.getElementById('formTitle');
  const deleteForm = document.getElementById('deleteForm');
  const deleteIdInput = document.getElementById('deleteCatId');
  const deleteModal = document.getElementById('deleteCategoryModal');
  const deleteModalName = document.getElementById('categoryDeleteName');
  const deleteModalCancel = document.getElementById('categoryDeleteCancel');
  const deleteModalConfirm = document.getElementById('categoryDeleteConfirm');
  const deleteModalCloseBtn = deleteModal?.querySelector('[data-close-modal="deleteCategoryModal"]');
  const accountInputs = {};
  form.querySelectorAll('[data-account-rate]').forEach(input => {
    accountInputs[input.dataset.accountRate] = input;
  });

  let pendingDeleteId = null;

  function openDeleteModal(cat){
    if(!deleteModal || !deleteModalName) return;
    const label = (cat && (cat.label || cat.id)) || '';
    pendingDeleteId = (cat && cat.id) || '';
    deleteModalName.textContent = label;
    deleteModal.classList.remove('hidden');
    deleteModal.classList.add('flex');
  }

  function closeDeleteModal(){
    pendingDeleteId = null;
    if(deleteModal){
      deleteModal.classList.add('hidden');
      deleteModal.classList.remove('flex');
    }
  }

  deleteModalCancel?.addEventListener('click', function(ev){ ev.preventDefault(); closeDeleteModal(); });
  deleteModalCloseBtn?.addEventListener('click', function(ev){ ev.preventDefault(); closeDeleteModal(); });
  deleteModal?.addEventListener('click', function(ev){ if(ev.target === deleteModal) closeDeleteModal(); });
  document.addEventListener('keydown', function(ev){ if(ev.key === 'Escape' && deleteModal && !deleteModal.classList.contains('hidden')) closeDeleteModal(); });

  deleteModalConfirm?.addEventListener('click', function(ev){
    ev.preventDefault();
    if(!pendingDeleteId || !deleteForm || !deleteIdInput) return;
    deleteIdInput.value = pendingDeleteId;
    closeDeleteModal();
    deleteForm.submit();
  });

  function highlightCard(id){
    if(!savedList) return;
    savedList.querySelectorAll('.saved-category').forEach(btn => {
      const data = btn.dataset.cat ? JSON.parse(btn.dataset.cat) : null;
      if(data && data.id === id){
        btn.classList.add('border-sky-400','ring-2','ring-sky-100','bg-sky-50');
      }else{
        btn.classList.remove('border-sky-400','ring-2','ring-sky-100','bg-sky-50');
      }
    });
  }

  function setModeNew(){
    idInput.value = '';
    labelInput.value = '';
    enabledInput.checked = true;
    Object.values(accountInputs).forEach(input => { input.value = ''; });
    saveBtn.textContent = 'Προσθήκη';
    deleteBtn.classList.add('hidden');
    modeBadge.textContent = 'Νέα';
    modeBadge.classList.remove('bg-amber-100','text-amber-700');
    modeBadge.classList.add('bg-sky-100','text-sky-700');
    titleEl.textContent = 'Νέα κατηγορία';
    highlightCard(null);
    form.dataset.currentCat = '{}';
  }

  function setModeEdit(cat){
    idInput.value = cat.id || '';
    labelInput.value = cat.label || '';
    enabledInput.checked = !!cat.enabled;
    const accounts = (cat && cat.accounts) || {};
    Object.entries(accountInputs).forEach(([rate, input]) => {
      input.value = accounts[rate] || '';
    });
    saveBtn.textContent = 'Αποθήκευση';
    deleteBtn.classList.remove('hidden');
    modeBadge.textContent = 'Επεξεργασία';
    modeBadge.classList.remove('bg-sky-100','text-sky-700');
    modeBadge.classList.add('bg-amber-100','text-amber-700');
    titleEl.textContent = 'Επεξεργασία κατηγορίας';
    highlightCard(cat.id || null);
    form.dataset.currentCat = JSON.stringify(cat || {});
  }

  if(savedList){
    savedList.addEventListener('click', function(ev){
      const del = ev.target.closest('[data-action="delete"]');
      if(del){
        ev.preventDefault();
        ev.stopPropagation();
        const card = del.closest('.saved-category');
        if(!card) return;
        try{
          const data = JSON.parse(card.dataset.cat || '{}');
          if(data && data.id){ openDeleteModal(data); }
        }catch(err){ console.warn('Αποτυχία προετοιμασίας διαγραφής', err); }
        return;
      }

      const btn = ev.target.closest('.saved-category');
      if(!btn) return;
      try{
        const data = JSON.parse(btn.dataset.cat || '{}');
        if(data && data.id){
          setModeEdit(data);
        }
      }catch(err){ console.warn('Δεν ήταν δυνατή η ανάγνωση της κατηγορίας', err); }
    });

    savedList.addEventListener('dblclick', function(ev){
      if(ev.target.closest('[data-action="delete"]')) return;
      if(ev.target.closest('.saved-category')){
        ev.preventDefault();
        setModeNew();
      }
    });
  }

  if(resetBtn){
    resetBtn.addEventListener('click', function(ev){
      ev.preventDefault();
      setModeNew();
    });
  }

  if(deleteBtn && deleteForm && deleteIdInput){
    deleteBtn.addEventListener('click', function(ev){
      ev.preventDefault();
      const currentId = (idInput.value || '').trim();
      if(!currentId) return;
      let currentCat = {};
      try{ currentCat = JSON.parse(form.dataset.currentCat || '{}'); }catch(_){ currentCat = {}; }
      if(!currentCat.id){ currentCat.id = currentId; }
      openDeleteModal(currentCat);
    });
  }

  setModeNew();
})();
</script>
{% endblock %}
