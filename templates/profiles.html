{% extends "base.html" %}
{% block title %}Προφίλ Χαρακτηρισμών{% endblock %}

{% block content %}
<div class="bg-white rounded shadow p-6">
  <h2 class="text-lg font-semibold mb-4">Προφίλ Χαρακτηρισμών (Τιμολόγια)</h2>

  <div class="grid md:grid-cols-2 gap-6">
    <!-- Αριστερή στήλη: Δημιουργία/Ενημέρωση -->
    <div>
      <h3 class="font-medium mb-2">Δημιουργία / Ενημέρωση</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1">Όνομα προφίλ</label>
          <input id="profName" class="border rounded px-3 py-2 w-full" placeholder="π.χ. Υλικά κατασκευής">
        </div>

        <div class="grid grid-cols-1 gap-2">
          <label class="text-sm font-medium">Αντιστοίχιση κατηγοριών</label>

          <div class="flex items-center gap-3">
            <div class="w-24 text-sm font-medium">0%</div>
            <select id="kat_fpa_a" class="border rounded px-2 py-1 flex-1" required></select>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-24 text-sm font-medium">6%</div>
            <select id="kat_fpa_b" class="border rounded px-2 py-1 flex-1" required></select>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-24 text-sm font-medium">ΦΠΑ Γ</div>
            <select id="kat_fpa_g" class="border rounded px-2 py-1 flex-1" required></select>
          </div>
          <!-- 17% -->
          <div class="flex items-center gap-3">
            <div class="w-24 text-sm font-medium">17%</div>
            <select id="kat_fpa_e" class="border rounded px-2 py-1 flex-1" required></select>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-24 text-sm font-medium">ΦΠΑ Δ</div>
            <select id="kat_fpa_d" class="border rounded px-2 py-1 flex-1" required></select>
          </div>
        </div>

        <div id="profMsg" class="text-sm"></div>

        <div class="flex gap-2">
          <button id="btnSaveProf" class="bg-sky-600 text-white px-3 py-2 rounded">Αποθήκευση</button>
          <!-- (Μεταφέρθηκε το Επιστροφή πάνω-δεξιά στη λίστα) -->
        </div>
      </div>
    </div>

    <!-- Δεξιά στήλη: Λίστα Προφίλ -->
    <div>
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-medium">Αποθηκευμένα Προφίλ</h3>

        <!-- ΕΠΙΣΤΡΟΦΗ: πάνω-δεξιά, ανοίγει το modal στο /search -->
        <a id="backToRepeat"
           href="{{ url_for('search', vat=vat, open_repeat='1') }}"
           class="inline-flex items-center gap-1 text-sm px-3 py-1.5 rounded-md border border-gray-300 hover:border-gray-400 hover:bg-gray-50 transition">
          <!-- βελάκι -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
            <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4A1 1 0 1110.707 6.707L8.414 9H16a1 1 0 110 2H8.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
          </svg>
          Επιστροφή
        </a>
      </div>

      <div class="border rounded">
        <div id="profList" class="divide-y max-h-80 overflow-y-auto pr-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal επιβεβαίωσης διαγραφής -->
<div id="confirmDeleteModal" class="fixed inset-0 z-50 hidden items-center justify-center">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative bg-white rounded-lg shadow p-6 w-full max-w-md">
    <h4 class="text-lg font-semibold mb-2">Διαγραφή προφίλ;</h4>
    <p class="text-sm text-gray-700 mb-4">Θέλεις σίγουρα να διαγράψεις το προφίλ <span id="delProfileName" class="font-medium"></span>; Η ενέργεια δεν μπορεί να αναιρεθεί.</p>
    <div class="flex justify-end gap-2">
      <button id="delCancel" class="px-3 py-2 border rounded">Άκυρο</button>
      <button id="delConfirm" class="px-3 py-2 rounded bg-red-600 text-white">Διαγραφή</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const VAT = "{{ vat }}";
  const listEl = document.getElementById('profList');
  const msgEl  = document.getElementById('profMsg');

  

  // modal διαγραφής
  const delModal   = document.getElementById('confirmDeleteModal');
  const delNameEl  = document.getElementById('delProfileName');
  const delCancel  = document.getElementById('delCancel');
  const delConfirm = document.getElementById('delConfirm');
  let pendingDelete = null;

  function opt(x){ const o=document.createElement('option'); o.value=o.textContent=x; return o; }

  function openDelModal(name){
    pendingDelete = name;
    delNameEl.textContent = '"' + name + '"';
    delModal.classList.remove('hidden');
    delModal.classList.add('flex');
  }
  function closeDelModal(){
    pendingDelete = null;
    delModal.classList.add('hidden');
    delModal.classList.remove('flex');
  }

  delCancel.addEventListener('click', closeDelModal);
  delConfirm.addEventListener('click', async ()=>{
    if(!pendingDelete) return;
    await fetch('/api/char_profiles/delete', {
      method:'POST', headers:{'Content-Type':'application/json'},
      credentials:'same-origin', body:JSON.stringify({vat:VAT, name: pendingDelete})
    });
    closeDelModal();
    // αν σβήστηκε το επιλεγμένο, καθάρισε φόρμα
    if(currentSelected === pendingDelete){
      currentSelected = null;
      document.getElementById('profName').value = '';
      ['a','b','g','e','d'].forEach(sfx=>{
        const sel = document.getElementById(`kat_fpa_${sfx}`);
        if(sel) sel.value = '';
      });
    }
    loadData();
  });

  // κρατάμε το επιλεγμένο για highlight
  let currentSelected = null;

  function setSelection(name){
    currentSelected = name || null;
    // highlight γραμμής
    document.querySelectorAll('.profile-row').forEach(row=>{
      if(row.dataset.name === currentSelected){
        row.classList.add('bg-sky-600','text-white');
      } else {
        row.classList.remove('bg-sky-600','text-white');
      }
    });
  }

  async function loadData(){
    const r = await fetch(`/api/char_profiles?vat=${encodeURIComponent(VAT)}`, {credentials:'same-origin'});
    const j = await r.json();

    // Γέμισμα dropdowns από ενεργές κατηγορίες
    ['a','b','g','e','d'].forEach(sfx=>{
      const sel = document.getElementById(`kat_fpa_${sfx}`);
      if(!sel) return;
      sel.innerHTML = '';
      (j.expense_tags || []).forEach(t=> sel.appendChild(opt(t)));
    });

    // Απόδοση λίστας προφίλ (scrollable container υπάρχει ήδη)
    listEl.innerHTML='';
    (j.profiles||[]).forEach(p=>{
      const row = document.createElement('div');
      row.className = "group profile-row p-3 flex items-center justify-between cursor-pointer";
      row.dataset.name = p.name;
      row.dataset.mapping = JSON.stringify(p.mapping || {});
      row.innerHTML = `
        <div class="min-w-0">
          <div class="font-medium truncate">${p.name}</div>
          <div class="text-xs text-gray-600 truncate">
            Α: ${p.mapping.kat_fpa_a || '-'} ·
            Β: ${p.mapping.kat_fpa_b || '-'} ·
            Γ: ${p.mapping.kat_fpa_g || '-'} ·
            Ε: ${p.mapping.kat_fpa_e || '-'} ·
            Δ: ${p.mapping.kat_fpa_d || '-'}
          </div>
        </div>
        <button class="deleteProfileBtn opacity-0 group-hover:opacity-100 absolute right-2 top-2
                       bg-red-50 text-red-700 border border-red-300 rounded-md px-2 py-1 shadow-sm
                       hover:bg-red-600 hover:text-white hover:border-red-600
                       focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-400
                       transition"
                data-act="del" data-name="${p.name}" title="Διαγραφή">
          Διαγραφή
        </button>
      `;
      // για το absolute του delete, ο wrapper πρέπει να είναι relative
      row.style.position = 'relative';
      listEl.appendChild(row);
    });

    // αν υπήρχε επιλογή πριν το refresh, ξαναπέρασέ την στο UI (αν υπάρχει)
    if(currentSelected && Array.from(listEl.children).some(el => el.dataset.name === currentSelected)){
      setSelection(currentSelected);
    }
  }

  // κλικ στη λίστα: είτε επιλέγεις προφίλ (μπλε + γεμίζει φόρμα), είτε ανοίγεις modal διαγραφής
  listEl.addEventListener('click', async (e)=>{
    const delBtn = e.target.closest('button[data-act="del"]');
    if(delBtn){
      openDelModal(delBtn.dataset.name);
      return;
    }
    const row = e.target.closest('.profile-row');
    if(!row) return;

    // Επιλογή/Highlight
    setSelection(row.dataset.name);

    // Γέμισμα φόρμας
    const name = row.dataset.name;
    const m = JSON.parse(row.dataset.mapping || "{}");
    document.getElementById('profName').value = name;
    document.getElementById('kat_fpa_a').value = m.kat_fpa_a || '';
    document.getElementById('kat_fpa_b').value = m.kat_fpa_b || '';
    document.getElementById('kat_fpa_g').value = m.kat_fpa_g || '';
    document.getElementById('kat_fpa_e').value = m.kat_fpa_e || '';
    document.getElementById('kat_fpa_d').value = m.kat_fpa_d || '';
  });

  // Αποθήκευση
  document.getElementById('btnSaveProf').addEventListener('click', async ()=>{
    const name = (document.getElementById('profName').value||'').trim();
    const mapping = {
      kat_fpa_a: document.getElementById('kat_fpa_a').value,
      kat_fpa_b: document.getElementById('kat_fpa_b').value,
      kat_fpa_g: document.getElementById('kat_fpa_g').value,
      kat_fpa_e: document.getElementById('kat_fpa_e').value, // 17%
      kat_fpa_d: document.getElementById('kat_fpa_d').value,
    };
    if(!name || !mapping.kat_fpa_a || !mapping.kat_fpa_b || !mapping.kat_fpa_g || !mapping.kat_fpa_e || !mapping.kat_fpa_d){
      msgEl.className="text-sm text-red-600"; msgEl.textContent="Συμπλήρωσε όνομα και όλες τις τιμές ΦΠΑ."; return;
    }
    const r = await fetch('/api/char_profiles/save', {
      method:'POST', headers:{'Content-Type':'application/json'},
      credentials:'same-origin', body:JSON.stringify({vat:VAT, name, mapping})
    });
    const j = await r.json();
    if(j && j.ok){
      msgEl.className="text-sm text-green-600";
      msgEl.textContent="Αποθηκεύτηκε.";
      currentSelected = name; // κράτα το ενεργό για να μείνει μπλε μετά το refresh
      loadData();
    } else {
      msgEl.className="text-sm text-red-600"; msgEl.textContent=j.error||"Σφάλμα.";
    }
  });

  loadData();
})();
</script>

<!-- Αν ο server περνά ενεργές κατηγορίες, γεμίζουν και από εδώ χωρίς διπλοεγγραφές -->
<script>
  window.CUSTOMER_CATEGORIES = {{ (customer_categories or []) | tojson | safe }};
  (function(){
    const tags = Array.isArray(window.CUSTOMER_CATEGORIES) ? window.CUSTOMER_CATEGORIES : [];
    ['kat_fpa_a','kat_fpa_b','kat_fpa_g','kat_fpa_e','kat_fpa_d'].forEach(id=>{
      const sel = document.getElementById(id);
      if(!sel || !tags.length) return;
      sel.innerHTML = '';
      tags.forEach(t => {
        const o = document.createElement('option');
        o.value=t; o.textContent=t;
        sel.appendChild(o);
      });
    });
  })();
</script>
{% endblock %}
