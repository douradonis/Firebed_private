{% extends "base.html" %}
{% block title %}Προφίλ Χαρακτηρισμών{% endblock %}

{% block content %}
<div id="flashBanners" class="max-w-6xl mx-auto mt-4 px-4"></div>
<style>
.flash-banner { border-radius:8px; padding:10px 14px; margin-bottom:10px; display:flex; align-items:center; gap:10px; box-shadow:0 2px 6px rgba(0,0,0,0.06); font-weight:500; }
.flash-success { background:#ecfdf5; color:#065f46; border:1px solid #bbf7d0; }
.flash-error { background:#fff1f2; color:#7f1d1d; border:1px solid #fecaca; }
.flash-info { background:#eff6ff; color:#1e3a8a; border:1px solid #bfdbfe; }
.flash-close { margin-left:auto; background:transparent; border:none; cursor:pointer; font-weight:700; font-size:16px; line-height:1; color:inherit; padding:0 6px; }
</style>

<div class="bg-white rounded shadow p-6">
  <h2 class="text-lg font-semibold mb-4">Προφίλ Χαρακτηρισμών (Τιμολόγια)</h2>

  <div class="grid md:grid-cols-2 gap-6">
    <!-- Αριστερή στήλη: Δημιουργία/Ενημέρωση -->
    <div>
      <h3 class="font-medium mb-2">Δημιουργία / Ενημέρωση</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1">Όνομα προφίλ</label>
          <input id="profName" class="border rounded px-3 py-2 w-full" placeholder="π.χ. Υλικά κατασκευής">
        </div>

        <div class="grid grid-cols-1 gap-2">
          <label class="text-sm font-medium">Αντιστοίχιση κατηγοριών</label>

          <div class="flex items-center gap-3">
  <div class="w-24 text-sm font-medium">0%</div>
  <select id="kat_fpa_a" class="border rounded px-2 py-1 flex-1" required></select>
</div>
<div class="flex items-center gap-3">
  <div class="w-24 text-sm font-medium">6%</div>
  <select id="kat_fpa_b" class="border rounded px-2 py-1 flex-1" required></select>
</div>
<div class="flex items-center gap-3">
  <div class="w-24 text-sm font-medium">13%</div>
  <select id="kat_fpa_g" class="border rounded px-2 py-1 flex-1" required></select>
</div>
<div class="flex items-center gap-3">
  <div class="w-24 text-sm font-medium">17%</div>
  <select id="kat_fpa_d" class="border rounded px-2 py-1 flex-1" required></select>
</div>
<div class="flex items-center gap-3">
  <div class="w-24 text-sm font-medium">24%</div>
  <select id="kat_fpa_e" class="border rounded px-2 py-1 flex-1" required></select>
</div>


        </div>

        <div id="profMsg" class="text-sm"></div>

        <div class="flex gap-2">
          <button id="btnSaveProf" class="bg-sky-600 text-white px-3 py-2 rounded" type="button">Αποθήκευση</button>
          <!-- (Μεταφέρθηκε το Επιστροφή πάνω-δεξιά στη λίστα) -->
        </div>
      </div>
    </div>

    <!-- Δεξιά στήλη: Λίστα Προφίλ -->
    <div>
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-medium">Αποθηκευμένα Προφίλ</h3>

        <!-- ΕΠΙΣΤΡΟΦΗ: πάνω-δεξιά, ανοίγει το modal στο /search -->
        <a id="backToRepeat"
           href="{{ url_for('search', vat=vat, open_repeat='1') }}"
           class="inline-flex items-center gap-1 text-sm px-3 py-1.5 rounded-md border border-gray-300 hover:border-gray-400 hover:bg-gray-50 transition">
          <!-- βελάκι -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
            <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4A1 1 0 1110.707 6.707L8.414 9H16a1 1 0 110 2H8.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
          </svg>
          Επιστροφή
        </a>
      </div>

      <div class="border rounded">
        <div id="profList" class="divide-y max-h-80 overflow-y-auto pr-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal επιβεβαίωσης διαγραφής -->
<div id="confirmDeleteModal" class="fixed inset-0 z-50 hidden items-center justify-center">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative bg-white rounded-lg shadow p-6 w-full max-w-md">
    <h4 class="text-lg font-semibold mb-2">Διαγραφή προφίλ;</h4>
    <p class="text-sm text-gray-700 mb-4">Θέλεις σίγουρα να διαγράψεις το προφίλ <span id="delProfileName" class="font-medium"></span>; Η ενέργεια δεν μπορεί να αναιρεθεί.</p>
    <div class="flex justify-end gap-2">
      <button id="delCancel" class="px-3 py-2 border rounded">Άκυρο</button>
      <button id="delConfirm" class="px-3 py-2 rounded bg-red-600 text-white">Διαγραφή</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ID-first profiles: list from /api/profiles; save uses id when present
(function(){
  const VAT = "{{ vat }}";
  const listEl = document.getElementById('profList');
  const msgEl  = document.getElementById('profMsg');
  const saveBtn = document.getElementById('btnSaveProf');

  let currentSelected = null;
  let currentSelectedId = null;

  const CATEGORY_LABELS = (function(){
    try {
      return {{ (category_labels or {}) | tojson | safe }} || {};
    } catch(e){ return {}; }
  })();

  function labelForCategory(value){
    if(!value) return '';
    const key = String(value);
    if(Object.prototype.hasOwnProperty.call(CATEGORY_LABELS, key)){
      return CATEGORY_LABELS[key];
    }
    return key;
  }

  function escapeHtml(unsafe){ return String(unsafe).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }
  function showBanner(message, kind='success', ttl=6000) {
    const container=document.getElementById('flashBanners'); if(!container) return;
    let cls='flash-success'; if(kind==='error'||kind==='danger') cls='flash-error'; else if(kind==='info') cls='flash-info';
    const el=document.createElement('div'); el.className='flash-banner '+cls; el.innerHTML=`<div class="flash-text">${escapeHtml(String(message))}</div>`;
    const btn=document.createElement('button'); btn.className='flash-close'; btn.type='button'; btn.innerHTML='&times;'; btn.addEventListener('click',()=>{el.remove();});
    el.appendChild(btn); container.insertBefore(el, container.firstChild);
    if(ttl>0) setTimeout(()=>{try{el.remove();}catch(e){}},ttl);
  }
  function opt(x){
    const o=document.createElement('option');
    o.value = x;
    o.textContent = labelForCategory(x);
    return o;
  }

  function showMappingLabel(val){
    const lbl = labelForCategory(val);
    return lbl ? lbl : '-';
  }

  function updateSaveButton(){
    const btn = document.getElementById('btnSaveProf');
    if(!btn) return;
    if(currentSelectedId){
      btn.textContent = 'Ενημέρωση';
      btn.classList.remove('bg-sky-600'); btn.classList.add('bg-green-600');
    }else{
      btn.textContent = 'Αποθήκευση';
      btn.classList.remove('bg-green-600'); btn.classList.add('bg-sky-600');
    }
  }

  function setSelection(name, id){
    try{
      currentSelected = name || null;
      currentSelectedId = id || null;
      document.querySelectorAll('#profList .profile-row').forEach(row=>{
        const isSel = (row.dataset && row.dataset.name === currentSelected);
        row.setAttribute('aria-selected', isSel ? 'true' : 'false');
        if (isSel){
          row.classList.add('bg-sky-600','text-white');
          row.classList.remove('bg-sky-100');
        } else {
          row.classList.remove('bg-sky-600','text-white','bg-sky-100');
        }
      });
      updateSaveButton();
    }catch(_){}
  }

  function clearSelection(){
    try{
      currentSelected = null;
      currentSelectedId = null;
      const nameEl = document.getElementById('profName'); if(nameEl) nameEl.value='';
      ['a','b','g','e','d'].forEach(sfx=>{ const sel=document.getElementById(`kat_fpa_${sfx}`); if(sel){ try{sel.value='';}catch(_){ sel.selectedIndex=0; } }});
      if(listEl){
        listEl.querySelectorAll('.profile-row').forEach(el=>{
          el.classList.remove('bg-sky-600','text-white','bg-sky-100','selected','active');
          el.setAttribute('aria-selected','false'); el.removeAttribute('data-selected');
        });
      }
      updateSaveButton();
    }catch(_){}
  }

  async function fetchCharProfiles(){
    const r = await fetch(`/api/char_profiles?vat=${encodeURIComponent(VAT)}`, {credentials:'same-origin'});
    return r.json();
  }
  async function fetchCanonicalProfiles(){
    try{
      const r = await fetch('/api/profiles', {credentials:'same-origin'});
      const j = await r.json();
      return (j && j.profiles) ? j.profiles : [];
    }catch(_){ return []; }
  }

  function buildMappingFromForm(){
    return {
      kat_fpa_a: document.getElementById('kat_fpa_a').value,
      kat_fpa_b: document.getElementById('kat_fpa_b').value,
      kat_fpa_g: document.getElementById('kat_fpa_g').value,
      kat_fpa_e: document.getElementById('kat_fpa_e').value,
      kat_fpa_d: document.getElementById('kat_fpa_d').value,
    };
  }

  async function loadData(){
    const [j, profs] = await Promise.all([ fetchCharProfiles(), fetchCanonicalProfiles() ]);

    ['a','b','g','e','d'].forEach(sfx=>{
      const sel = document.getElementById(`kat_fpa_${sfx}`);
      if(!sel) return;
      sel.innerHTML = '';
      sel.appendChild(new Option('-επιλέξτε-',''));
      const tags = (j && (j.options || j.expense_tags)) || [];
      (tags||[]).forEach(t=> sel.appendChild(opt(t)));
    });

    listEl.innerHTML='';
    (profs||[]).forEach(p=>{
      const row = document.createElement('div');
      row.className = "group profile-row p-3 flex items-center justify-between cursor-pointer";
      row.dataset.name = p.name;
      row.dataset.id   = p.id || '';
      const mapping = p.map || {};
      row.dataset.mapping = JSON.stringify(mapping || {});
      row.innerHTML = `
        <div class="min-w-0">
          <div class="font-medium truncate">${p.name}</div>
          <div class="text-xs text-gray-600 truncate">
            Α: ${showMappingLabel(mapping.kat_fpa_a)} ·
            Β: ${showMappingLabel(mapping.kat_fpa_b)} ·
            Γ: ${showMappingLabel(mapping.kat_fpa_g)} ·
            Ε: ${showMappingLabel(mapping.kat_fpa_e)} ·
            Δ: ${showMappingLabel(mapping.kat_fpa_d)}
          </div>
        </div>
        <button class="deleteProfileBtn opacity-0 group-hover:opacity-100 absolute right-2 top-2
                       bg-red-50 text-red-700 border border-red-300 rounded-md px-2 py-1 shadow-sm
                       hover:bg-red-600 hover:text-white hover:border-red-600
                       focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-400
                       transition"
                data-act="del" data-name="${p.name}" title="Διαγραφή">
          Διαγραφή
        </button>
      `;
      row.style.position = 'relative';
      listEl.appendChild(row);
    });

    if(currentSelectedId){
      const row = Array.from(listEl.children).find(el => (el.dataset.id||'') === currentSelectedId);
      if(row){ setSelection(row.dataset.name, row.dataset.id); }
    } else if(currentSelected){
      const row = Array.from(listEl.children).find(el => el.dataset.name === currentSelected);
      if(row){ setSelection(row.dataset.name, row.dataset.id||null); }
    }
  }

  listEl.addEventListener('click', (e)=>{
    const delBtn = e.target.closest('button[data-act="del"]');
    if(delBtn){
      openDelModal(delBtn.dataset.name);
      return;
    }
    const row = e.target.closest('.profile-row');
    if(!row) return;

    const name = row.dataset.name;
    const id   = row.dataset.id || null;
    setSelection(name, id);

    const m = JSON.parse(row.dataset.mapping || "{}");
    document.getElementById('profName').value = name;
    try{ document.getElementById('profName').dispatchEvent(new Event('input', {bubbles:true})); }catch(_){ }
    document.getElementById('kat_fpa_a').value = m.kat_fpa_a || '';
    document.getElementById('kat_fpa_b').value = m.kat_fpa_b || '';
    document.getElementById('kat_fpa_g').value = m.kat_fpa_g || '';
    document.getElementById('kat_fpa_e').value = m.kat_fpa_e || '';
    document.getElementById('kat_fpa_d').value = m.kat_fpa_d || '';
  });

  if(listEl){
    listEl.addEventListener('dblclick', function(ev){
      const item = ev.target && ev.target.closest ? ev.target.closest('.profile-row') : null;
      if(item){ clearSelection(); }
    });
  }

  const delModal   = document.getElementById('confirmDeleteModal');
  const delNameEl  = document.getElementById('delProfileName');
  const delCancel  = document.getElementById('delCancel');
  const delConfirm = document.getElementById('delConfirm');
  let pendingDeleteName = null;
  let pendingDeleteId   = null;

  function openDelModal(name){
    pendingDeleteName = name;
    const row = Array.from(document.querySelectorAll('#profList .profile-row')).find(r => r.dataset.name === name);
    pendingDeleteId = row ? (row.dataset.id||null) : null;
    delNameEl.textContent = '"' + name + '"';
    delModal.classList.remove('hidden'); delModal.classList.add('flex');
  }
  function closeDelModal(){ pendingDeleteName=null; pendingDeleteId=null; delModal.classList.add('hidden'); delModal.classList.remove('flex'); }
  delCancel.addEventListener('click', closeDelModal);
  delConfirm.addEventListener('click', async ()=>{
    if(!pendingDeleteName) return;
    try{
      if(pendingDeleteId){
        await fetch('/api/profiles/delete', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'same-origin', body: JSON.stringify({ id: pendingDeleteId }) });
      }else{
        await fetch('/api/char_profiles/delete', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'same-origin', body: JSON.stringify({ vat: VAT, name: pendingDeleteName }) });
      }
      closeDelModal();
      if(currentSelected===pendingDeleteName){ clearSelection(); }
      await loadData();
      showBanner('Το προφίλ διαγράφηκε.', 'success', 4000);
    }catch(e){ showBanner('Αποτυχία διαγραφής.', 'error', 6000); }
  });

  saveBtn.addEventListener('click', async ()=>{
    const name = (document.getElementById('profName').value||'').trim();
    const mapping = {
      kat_fpa_a: document.getElementById('kat_fpa_a').value,
      kat_fpa_b: document.getElementById('kat_fpa_b').value,
      kat_fpa_g: document.getElementById('kat_fpa_g').value,
      kat_fpa_e: document.getElementById('kat_fpa_e').value,
      kat_fpa_d: document.getElementById('kat_fpa_d').value,
    };
    if(!name || !mapping.kat_fpa_a || !mapping.kat_fpa_b || !mapping.kat_fpa_g || !mapping.kat_fpa_e || !mapping.kat_fpa_d){
      msgEl.className="text-sm text-red-600"; msgEl.textContent="Συμπλήρωσε όνομα και όλες τις τιμές ΦΠΑ."; return;
    }
    try{
      const payload = currentSelectedId ? { id: currentSelectedId, name, map: mapping }
                                        : { name, map: mapping };
      const resp = await fetch('/api/profiles/save', {
        method:'POST', headers:{'Content-Type':'application/json'}, credentials:'same-origin',
        body: JSON.stringify(payload)
      });
      const j = await resp.json();
      if(j && j.ok){
        showBanner('Το προφίλ αποθηκεύτηκε επιτυχώς.', 'success', 6000);
        clearSelection();
        await loadData();
      }else{
        showBanner((j && j.error) || 'Σφάλμα αποθήκευσης.', 'error', 7000);
      }
    }catch(e){
      showBanner('Σφάλμα αποθήκευσης.', 'error', 7000);
    }
  });

  (function(){ const el=document.getElementById('profName'); if(el){ el.addEventListener('input', updateSaveButton); }})();

  loadData();
  updateSaveButton();
})();
</script>
{% endblock %}
