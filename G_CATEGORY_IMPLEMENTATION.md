# Υλοποίηση Γ Κατηγορίας Βιβλίων - FastImport Bridge

## Επισκόπηση

Προστέθηκε πλήρης υποστήριξη για εξαγωγή γέφυρας FastImport για **Γ Κατηγορίας** βιβλία, παράλληλα με την υπάρχουσα υποστήριξη Β Κατηγορίας.

## Βασικές Διαφορές Γ από Β Κατηγορία

### 1. **Κωδικός Κίνησης (MTYPE) - ΥΠΟΧΡΕΩΤΙΚΟ**
- Στη Β Κατηγορία το MTYPE είναι προαιρετικό
- Στη Γ Κατηγορία το **MTYPE είναι ΥΠΟΧΡΕΩΤΙΚΟ**
- Προκαθορισμένοι κωδικοί:
  - `1` = Αγορές Εμπορευμάτων
  - `2` = Αγορές Α' Υλών
  - `3` = Γενικά Έξοδα
  - `4` = Αμοιβές Τρίτων
  - `5` = Δαπάνες χωρίς ΦΠΑ

### 2. **Λογαριασμοί**
- **Β Κατηγορία**: Μορφή `ΧΧ-ΧΧΧΧ` (π.χ. `64-0087`)
- **Γ Κατηγορία**: Μορφή `ΧΧ-ΧΧ-ΧΧ-ΧΧΧΧ` (π.χ. `64-00-01-0087`)
- Χρήση prefix `account_g_` για τους λογαριασμούς

### 3. **ARTICLE_DETAIL Επεκτάσεις**
Υποχρεωτικά πεδία στη Γ Κατηγορία:
- `NETAMT`: Καθαρή αξία γραμμής
- `VATAMT`: Ποσό ΦΠΑ γραμμής
- `INVOICE`: Στοιχείο παραστατικού
- `REASON`: Περιγραφή

### 4. **Πρόσθετα Πεδία Κίνησης**
- `SUMKEPYONOTYP`: Σύνολο μη υποκείμενου
- `SUMKEPYOFPA`: Σύνολο ΦΠΑ

## Αρχεία που Προστέθηκαν/Τροποποιήθηκαν

### Νέα Αρχεία
1. **`epsilon_bridge_g_category.py`**
   - Module για Γ Κατηγορία
   - Επεκτείνει το `epsilon_bridge_multiclient_strict.py`
   - Κύριες συναρτήσεις:
     - `build_preview_rows_for_ui_g()`: Preview για Γ
     - `export_g_category()`: Export Excel για Γ
     - `_get_mtype_for_category()`: Εύρεση MTYPE
     - `_get_account_for_g()`: Εύρεση λογαριασμών Γ

2. **`Γ.ect`** (στο `example/`)
   - Template FastImport για Γ Κατηγορία
   - Ορισμός δομής Excel

### Τροποποιημένα Αρχεία

1. **`app.py`**
   - Route `export_fastimport_kinitseis()`: Dynamic module selection
   - Route `epsilon_preview()`: Υποστήριξη Γ preview
   - Αυτόματη επιλογή module βάσει `book_category`
   - Bundling με `Γ.ect` για Γ Κατηγορία

2. **`templates/credentials_list.html`**
   - Νέο section "Κωδικοί Κίνησης (MTYPE)"
   - Εμφανίζεται μόνο όταν επιλεγεί Γ Κατηγορία
   - Πεδία για κάθε κατηγορία δαπάνης
   - Auto-formatting για λογαριασμούς Γ

## Ρυθμίσεις Χρήστη

### Κωδικοί Κίνησης (Settings)
Στις ρυθμίσεις, tab "Γενικοί Λογαριασμοί", όταν Γ Κατηγορία:

```
mtype_code_αγορες_εμπορευματων = "1"
mtype_code_αγορες_α_υλων = "2"
mtype_code_γενικες_δαπανες_με_φπα = "3"
mtype_code_αμοιβες_τριτων = "4"
mtype_code_δαπανες_χωρις_φπα = "5"
mtype_code_εγγυοδοσια = "3"
mtype_code_αποδειξακια = "3"
```

### Λογαριασμοί Γ Κατηγορίας
```
account_g_αγορες_εμπορευματων_fpa_kat_24% = "60-00-00-0000"
account_g_supplier_wholesale = "50-00-00-0000"
account_g_supplier_retail = "50-01-00-0000"
```

## Λειτουργία

### 1. Επιλογή Κατηγορίας
Ο χρήστης επιλέγει `book_category = "Γ"` στα credentials του πελάτη.

### 2. Αυτόματη Δρομολόγηση
Το σύστημα ανιχνεύει την κατηγορία και χρησιμοποιεί:
- **Β Κατηγορία**: `epsilon_bridge_multiclient_strict.py`
- **Γ Κατηγορία**: `epsilon_bridge_g_category.py`

### 3. Validation
- Έλεγχος μορφής λογαριασμών (ΧΧ-ΧΧ-ΧΧ-ΧΧΧΧ)
- Έλεγχος ύπαρξης MTYPE
- Έλεγχος NETAMT/VATAMT

### 4. Export
- Δημιουργία Excel με 2 sheets (Κινήσεις, Συναλλασσόμενοι)
- Bundling με `Γ.ect` αν υπάρχει
- Logging με `book_category = "Γ"`

## Παράδειγμα Excel Output (Γ Κατηγορία)

### Sheet: Φύλλο1 (Κινήσεις)
```
ARTID | MTYPE | CUSTID | MDATE | LCODE | NETAMT_DETAIL | VATAMT_DETAIL
1     | 3     | 100    | 01/12/2025 | 64-00-01-0087 | 100.00 | 24.00
```

### Sheet: Φύλλο2 (Συναλλασσόμενοι)
```
CUSTID | NAME | VAT
100    | Προμηθευτής Α | 123456789
```

## Troubleshooting

### Σφάλμα: "Λείπει MTYPE"
- Βεβαιωθείτε ότι έχετε ορίσει κωδικούς κίνησης στις ρυθμίσεις
- Ελέγξτε ότι η κατηγορία δαπάνης αντιστοιχεί σε MTYPE

### Σφάλμα: "Δεν βρέθηκε λογαριασμός Γ"
- Ελέγξτε ότι οι λογαριασμοί έχουν prefix `account_g_`
- Βεβαιωθείτε ότι η μορφή είναι `ΧΧ-ΧΧ-ΧΧ-ΧΧΧΧ`

### Σφάλμα: "Invalid account format"
- Οι λογαριασμοί Γ πρέπει να είναι 10 ψηφία με 3 παύλες
- Παράδειγμα: `64-00-01-0087`

## Μελλοντικές Επεκτάσεις

1. **UI για MTYPE επιλογή** στην επαναληπτική/χειρατή εισαγωγή
2. **Validation κατά την εισαγωγή** για Γ Κατηγορία
3. **Προεπισκόπηση MTYPE** στο preview table
4. **Bulk edit MTYPE** για πολλαπλές εγγραφές

## Testing

Για να δοκιμάσετε τη Γ Κατηγορία:

1. Επιλέξτε πελάτη με `book_category = "Γ"`
2. Ορίστε λογαριασμούς Γ στις ρυθμίσεις
3. Ορίστε κωδικούς κίνησης
4. Κάντε preview στο `/epsilon/preview`
5. Export από `/export/fastimport/kinitseis`
6. Ελέγξτε ότι το Excel έχει τα σωστά πεδία
